<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>假新闻检测系统</title>
    <link rel="icon" href="../ico/Detect.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Color Palette - Refined */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f1f3f5;
            --text-primary: #1a1d20;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            
            --accent-color: #4361ee;
            --accent-hover: #3a56d4;
            --accent-light: rgba(67, 97, 238, 0.1);
            
            --success-color: #2ec4b6;
            --warning-color: #ff9f1c;
            --danger-color: #e71d36;
            
            /* Shadows - Smoother */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.12);
            
            /* Transitions */
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            
            --bg-glass: rgba(255, 255, 255, 0.65);
            --bg-menu: rgba(255, 255, 255, 0.95);
            --shadow-accent: 0 4px 12px rgba(67, 97, 238, 0.25);
        }

        [data-theme="dark"] {
            --bg-primary: #111315;
            --bg-secondary: #1a1d20;
            --bg-tertiary: #212529;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --border-color: #2d3238;
            
            --accent-color: #4cc9f0;
            --accent-hover: #48bfe3;
            --accent-light: rgba(76, 201, 240, 0.15);
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.3);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.4);
            
            --bg-glass: rgba(17, 19, 21, 0.65);
            --bg-menu: rgba(25, 28, 32, 0.95);
            --shadow-accent: 0 4px 12px rgba(76, 201, 240, 0.25);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            user-select: none; /* 禁止选中 */
            -webkit-user-select: none;
            transition: background-color var(--transition-fast), color var(--transition-fast);
            animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        
        html {
            height: 100%;
            background: var(--bg-primary);
            overflow: hidden;
            transition: background-color var(--transition-fast);
        }

        /* 允许选中的区域 */
        .text-input, .parsed-text, .parsed-title, .analysis-text, .custom-tooltip {
            user-select: text;
            -webkit-user-select: text;
        }

        /* 自定义标题栏 */
        #title-bar {
            height: 34px;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            padding: 0 16px;
            -webkit-app-region: drag;
            position: relative;
            z-index: 1000;
            transition: background-color var(--transition-fast);
            font-size: 12px;
            color: var(--text-secondary);
        }

        #title-bar .app-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            background-image: url('../ico/Detect.ico'); /* 假设图标路径 */
            background-size: contain;
            background-repeat: no-repeat;
        }

        #title-bar .app-title {
            font-weight: 500;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .title-bar-actions {
            position: absolute;
            right: 150px;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            gap: 4px;
            -webkit-app-region: no-drag;
        }

        #title-bar .toolbar-btn {
            width: 32px;
            height: 28px;
            border-radius: 4px;
        }

        /* 全屏模式样式 */
        body.fullscreen-mode #title-bar {
            display: flex; /* Keep visible in fullscreen per request */
        }
        
        body.fullscreen-mode .title-bar-actions {
            right: 10px; /* Move to edge in fullscreen */
        }
        
        body.fullscreen-mode .icon-enter-fullscreen {
            display: none !important;
        }
        
        body.fullscreen-mode .icon-exit-fullscreen {
            display: block !important;
        }
        
        body.fullscreen-mode .container {
            height: calc(100vh - 32px); /* Keep title bar space */
        }

        /* Selection Color */
        ::selection {
            background: var(--accent-color);
            color: #fff;
        }

        /* 沉浸式滚动条样式 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
            transition: background 0.3s;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        ::-webkit-scrollbar-corner {
            background: transparent;
        }

        .container {
            display: flex;
            height: calc(100vh - 32px); /* 减去标题栏高度 */
            position: relative;
        }

        /* 主布局容器（包含左右面板和分隔线） */
        .main-layout {
            display: flex;
            flex: 1;
            min-width: 0;
            height: 100%;
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 左侧面板 */
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            min-width: 0 !important; /* Force min-width 0 to allow full collapse */
            max-width: none; /* Removed max-width limit */
            transition: background-color 0.3s, flex 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden; /* Ensure content doesn't force width */
        }

        /* Left Sidebar & Content Wrapper */
        .left-sidebar {
            width: 48px; /* Reduced width for collapsed state */
            display: flex;
            flex-direction: column;
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            /* Half rounded rectangle: flat on left, rounded on right */
            border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
            border-left: none; /* Remove left border as it sticks to edge */
            margin: 4px 4px 4px 0; /* Stick to left edge */
            height: calc(100% - 8px);
            z-index: 20;
            align-items: center;
            padding-top: 16px;
            flex-shrink: 0;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.4s, opacity 0.4s, margin 0.4s, border-radius 0.4s;
            box-shadow: var(--shadow-sm);
        }

        .left-sidebar.expanded {
            width: 200px;
            align-items: stretch; /* Stretch items to fill width */
            padding-left: 12px;
            padding-right: 12px;
            /* Restore floating appearance when expanded */
            margin: 4px;
            border-radius: var(--radius-lg);
            border-left: 1px solid var(--border-color);
            transition-delay: 0s; /* No delay when manually expanded */
        }

        .sidebar-header {
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding-bottom: 16px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .left-sidebar.expanded .sidebar-header {
            display: flex;
        }

        .sidebar-header h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: var(--text-primary);
        }

        .sidebar-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .left-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            min-width: 0;
        }

        /* 拖拽遮罩层 */
        .drag-overlay {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            bottom: 16px;
            background: rgba(67, 97, 238, 0.15);
            border: 2px dashed var(--accent-color);
            border-radius: var(--radius-lg);
            z-index: 99;
            pointer-events: none;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-color);
            backdrop-filter: blur(8px);
            transition: all 0.2s ease;
        }
        .drag-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .drag-overlay.error {
            border-color: var(--danger-color);
            background: rgba(231, 29, 54, 0.15);
            color: var(--danger-color);
        }
        .drag-overlay.success {
            border-color: var(--success-color);
            background: rgba(46, 196, 182, 0.15);
            color: var(--success-color);
        }
        .drag-overlay.full {
            border-color: var(--warning-color);
            background: rgba(255, 159, 28, 0.15);
            color: var(--warning-color);
        }

        /* 工具栏 */
        .toolbar {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: auto;
            min-height: min-content; /* Ensure it takes up necessary space */
            padding: 0;
            background: transparent;
            border-bottom: none;
            gap: 16px;
            position: relative;
            z-index: 20;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .toolbar-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .toolbar-btn:hover {
            background: var(--accent-light);
            color: var(--accent-color);
            box-shadow: var(--shadow-accent);
            transform: translateY(-1px);
        }

        /* Disable hover transform for more-menu to prevent shaking */
        .toolbar-btn.more-menu:hover {
            transform: none;
        }

        .toolbar-btn:active {
            transform: translateY(0) scale(0.95);
        }

        /* Disable scale effect for more-menu to prevent dropdown shrinking */
        .toolbar-btn.more-menu:active {
            transform: none;
        }

        .toolbar-btn.active {
            background: var(--accent-light);
            color: var(--accent-color);
        }

        .toolbar-btn[disabled] {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
            box-shadow: none;
            transform: none;
        }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        @keyframes ripple {
            to { transform: scale(4); opacity: 0; }
        }

        .toolbar-separator {
            width: 24px;
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* 历史记录列表 */
        .history-section {
            display: none;
            flex-direction: column;
            width: 100%;
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
            overflow: hidden;
            flex: 1;
            min-height: 0; /* Allow shrinking if needed, but flex:1 should take available space */
            position: relative; /* Ensure z-index works if needed */
            z-index: 10;
            background: transparent;
        }

        .left-sidebar.expanded .history-section {
            display: flex;
        }

        .history-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding: 0 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            padding-right: 4px;
            flex: 1;
        }

        .history-item {
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .history-item:hover {
            background: var(--accent-light);
            border-color: var(--accent-color);
            transform: translateX(4px);
        }

        .history-item-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .history-item-preview {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }



        /* Dropdown Menu */
        .more-menu .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 240px;
            display: none;
            background: var(--bg-menu);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius-md);
            padding: 8px;
            z-index: 999;
            border: 1px solid var(--border-color);
            transform-origin: top right;
            animation: menuPopup 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .more-menu .dropdown-menu.show {
            display: block;
        }

        .more-menu .dropdown-item {
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .more-menu .dropdown-item:hover {
            background: var(--accent-light);
            color: var(--accent-color);
            box-shadow: var(--shadow-accent);
        }

        /* Edit Options - Refactored for Edit Mode */
        .edit-options {
            position: fixed;
            top: 48px; /* Anchor position; avoid layout thrash */
            left: 50%;
            transform: translate(-50%, -50px); /* Default hidden state */
            opacity: 0;
            pointer-events: none;
            background: var(--bg-glass);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 8px 12px;
            gap: 4px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: flex;
            align-items: center;
            will-change: transform, opacity;
            transition: opacity 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        body.edit-mode .edit-options {
            opacity: 1;
            transform: translate(-50%, 0);
            pointer-events: auto;
            /* 丝滑回弹动画：0.6s 配合过冲贝塞尔曲线 */
            animation: editOptionsPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        [data-theme="dark"] .edit-options {
            background: var(--bg-glass);
        }

        @keyframes editOptionsPop {
            0% { opacity: 0; transform: translate(-50%, -50px); }
            100% { opacity: 1; transform: translate(-50%, 0); }
        }

        @media (prefers-reduced-motion: reduce) {
            .edit-options { transition: none; }
            body.edit-mode .edit-options { animation: none; }
        }

        body.edit-mode .edit-options {
            top: 48px;
        }

        .edit-btn {
            width: 40px;
            height: 40px;
            padding: 6px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .edit-btn[disabled] {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
            box-shadow: none;
        }
        .edit-btn:hover {
            background: var(--accent-light);
            color: var(--accent-color);
            box-shadow: var(--shadow-accent);
        }
        .edit-btn.active {
            background: var(--accent-light);
            color: var(--accent-color);
        }

        .close-edit-btn {
            color: var(--success-color);
            background: rgba(46, 196, 182, 0.1);
            margin-left: 8px;
        }
        .close-edit-btn:hover {
            background: var(--success-color);
            color: white;
            transform: scale(1.05);
        }

        /* Edit Mode Global Transitions */
        body.edit-mode .left-panel {
            max-width: 100%;
            flex: 1 0 100% !important; /* Force full width */
            z-index: 100;
        }
        
        .right-panel, .resizer, .toolbar, .bottom-area, .image-preview-container {
            transition: var(--transition);
            opacity: 1;
            transform: translateY(0);
        }

        body.edit-mode .right-panel {
            flex: 0 0 0 !important;
            min-width: 0;
            opacity: 0;
            overflow: hidden;
            transform: translateX(20px);
        }
        
        body.edit-mode .resizer {
            display: none;
        }

        body.edit-mode .toolbar {
            height: 0;
            padding: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-20px);
            border: none;
        }

        body.edit-mode .bottom-area {
            height: 0;
            padding: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            border: none;
        }
        
        body.edit-mode .image-preview-container {
            display: flex;
            justify-content: flex-start; /* Left align images */
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 20px; /* Space between text and images */
            padding-top: 0;
            border-top: none;
            margin-bottom: 0;
        }
        
        body.edit-mode .image-preview-item {
            width: 120px;
            height: 120px;
            flex: 0 0 auto;
        }
        
        body.edit-mode .image-preview-container:empty {
            display: none;
            margin-top: 0;
            padding-top: 0;
            margin-bottom: 0;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-glass);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            padding: 6px;
            min-width: 180px;
            z-index: 9999;
            display: none;
            animation: menuPopup 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden; /* Disable horizontal scroll */
        }
        .context-menu::-webkit-scrollbar {
            width: 4px;
        }
        .context-menu::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }
        .context-menu::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        .context-menu.active { display: block; }

        .context-menu-item {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Changed from space-between */
            gap: 8px; /* Added gap */
            transition: background 0.2s;
            position: relative;
        }
        .context-menu-item .shortcut-hint {
            margin-left: auto;
        }
        #ctxSearchText, #ctxGoToUrl {
            margin-left: 8px;
        }
        /* Target the arrow icon for submenus */
        .context-menu-item > svg:not(:first-child) {
            margin-left: auto;
        }
        .context-menu-item:hover {
            background: var(--accent-light);
            color: var(--accent-color);
            box-shadow: var(--shadow-accent);
        }
        .context-menu-item.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .context-menu-separator {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        .context-submenu {
            display: none !important; /* Hide original submenu always */
        }
        
        /* Floating submenu style */
        .floating-submenu {
            position: fixed;
            z-index: 10000;
            background: var(--bg-menu);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            padding: 6px;
            min-width: 160px;
            display: block;
            animation: menuPopup 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        .floating-submenu .context-menu-item {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            transition: background 0.2s;
        }
        
        .floating-submenu .context-menu-item:hover {
            background: var(--accent-light);
            color: var(--accent-color);
            box-shadow: var(--shadow-accent);
        }

        /* Left-side submenu when near right edge */
        .context-submenu.left-side {
            left: auto;
            right: 100%;
            margin-left: 0;
            margin-right: 8px;
            transform-origin: top right;
        }
        /* Invisible bridge to prevent menu closing */
        .context-submenu::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 0;
            bottom: 0;
            width: 12px;
            background: transparent;
        }
        .context-submenu.left-side::before {
            left: auto;
            right: -12px;
        }
        .context-menu-item:hover .context-submenu {
            display: none;
        }

        .shortcut-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 16px;
        }

        /* Dropdown Menu Styles */
        .edit-btn-group {
            position: relative;
            display: inline-block;
        }
        
        /* Hover to expand for format and heading dropdowns */
        .edit-btn-group:hover .dropdown-menu {
            display: block;
            animation: dropdownPopup 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-menu);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            padding: 4px;
            min-width: 100px;
            display: none;
            z-index: 1005;
            margin-top: 8px;
        }
        /* Bridge the gap between button and menu */
        .dropdown-menu::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 0;
            width: 100%;
            height: 10px;
            background: transparent;
        }
        .dropdown-menu.format-menu {
            /* Reset to vertical list style */
            min-width: 140px;
            padding: 6px;
        }
        .dropdown-menu.format-menu .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            text-align: left;
        }
        
        /* More Menu Specifics */
        #moreDropdown {
            left: auto;
            right: 0;
            transform: none;
            transform-origin: top right;
            min-width: 200px;
            padding: 6px;
        }
        #moreDropdown .dropdown-item {
            text-align: left;
            padding: 8px 12px;
            font-size: 13px;
        }
        .dropdown-menu.show {
            display: block;
            animation: dropdownPopup 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        /* Specific animation for right-aligned menu to prevent jumping */
        #moreDropdown.show {
            animation: dropdownPopupRight 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .dropdown-item {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: background 0.2s;
            text-align: center;
        }
        .dropdown-item:hover {
            background: var(--accent-light);
            color: var(--accent-color);
            box-shadow: var(--shadow-accent);
        }
        
        .dropdown-separator {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        .dropdown-item-row {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 8px 12px;
            font-size: 13px;
            color: var(--text-primary);
            gap: 8px;
            white-space: nowrap;
        }
        .dropdown-item-row > :last-child {
            margin-left: auto;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 2px;
        }

        .zoom-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            font-size: 14px;
        }

        .zoom-btn:hover {
            background: var(--bg-secondary);
        }

        .zoom-val {
            min-width: 40px;
            text-align: center;
            font-size: 12px;
            font-variant-numeric: tabular-nums;
        }

        /* Toggle Switch */
        .toggle-switch {
            width: 36px;
            height: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            position: relative;
            transition: background 0.3s;
            cursor: pointer;
        }
        .toggle-switch.active {
            background: var(--accent-color);
        }
        .toggle-knob {
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .toggle-switch.active .toggle-knob {
            transform: translateX(16px);
        }

        @keyframes menuPopup {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes dropdownPopup {
            from { opacity: 0; transform: translateX(-50%) scale(0.95); }
            to { opacity: 1; transform: translateX(-50%) scale(1); }
        }

        @keyframes dropdownPopupRight {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Edit mode text entrance — light lift without layout shift */
        @keyframes editModeTextIn {
            0% { opacity: 0.92; transform: translateY(8px) scale(0.995); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Content Area */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 12px 4px 10px 4px; /* 缩小左右边距 */
            overflow: hidden; /* Prevent outer scroll */
            gap: 12px;
            transition: padding 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .editor-status-bar {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 12px;
            font-size: 12px;
            color: var(--text-secondary);
            background: transparent;
            margin-top: auto;
            opacity: 0.7;
            min-height: 20px;
        }
        .status-separator {
            margin: 0 8px;
            opacity: 0.5;
        }

        /* Text Container - The visual box */
        .text-container {
            flex: 1;
            min-height: 0; /* Allow shrinking */
            display: flex;
            flex-direction: column;
            background: var(--bg-glass);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden; /* Clip children */
            position: relative;
            transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;
        }

        [data-theme="dark"] .text-container {
            border-color: rgba(255,255,255,0.05);
        }

        .text-container:focus-within {
            border-color: var(--accent-color);
            box-shadow: var(--shadow-md);
            background: var(--bg-glass);
        }

        /* Text Input - The scrollable content */
        .text-input {
            flex: 1;
            width: 100%;
            height: 100%;
            padding: 32px 24px 24px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.8;
            outline: none;
            overflow-y: auto; /* Scroll inside */
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            transition: font-size 0.4s cubic-bezier(0.4, 0, 0.2, 1), line-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Edit Mode Overrides */
        body.edit-mode .content-area {
            overflow-y: auto; /* Enable scroll on container */
            display: flex; /* Use flex layout to allow order property */
            flex-direction: column;
            padding: 100px 4% 40px 4%; /* Increased bottom padding for status bar */
            /* Add mask to fade out text at the very top */
            mask-image: linear-gradient(to bottom, transparent 0px, black 80px, black 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0px, black 80px, black 100%);
            transition: padding 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.edit-mode .text-container {
            background: transparent;
            border: none;
            box-shadow: none;
            overflow: visible; /* Allow expansion */
            flex: 0 0 auto; /* Let it grow with content */
            min-height: 60vh;
            animation: editModeTextIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        body.edit-mode .editor-status-bar {
            position: fixed;
            bottom: 12px;
            right: 24px;
            background: var(--bg-glass);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 4px 12px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            z-index: 100;
            border: 1px solid rgba(0,0,0,0.05);
        }

        body.edit-mode .text-input {
            height: 100%;
            min-height: 200px;
            border: none;
            box-shadow: none;
            background: transparent; /* Transparent in edit mode to use body bg */
            font-size: 18px;
            line-height: 2;
            padding-top: 20px; /* Reduced padding as images now push text down */
            padding-bottom: 20px;
            overflow: visible; /* No internal scroll */
            transition: font-size 0.4s cubic-bezier(0.4, 0, 0.2, 1), line-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: editModeTextIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .text-input:empty:before {
            content: attr(placeholder);
            color: var(--text-secondary);
            opacity: 0.6;
        }

        /* Image Preview */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            padding: 4px;
            margin-bottom: 0;
            transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.35s ease, height 0.35s ease, margin 0.35s ease;
            flex-shrink: 0; /* Prevent shrinking */
            z-index: 2;
        }

        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            flex: 0 0 auto;
            border-radius: var(--radius-md);
            overflow: hidden;
            background: var(--bg-tertiary);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: width 0.35s ease, height 0.35s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }

        .image-preview-item:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-md);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s; /* Only animate on hover */
        }

        .image-preview-item.selected {
            border: 2px solid var(--accent-color);
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-md);
        }
        
        .image-preview-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--accent-color);
        }

        .image-placeholder {
            border: 2px dashed var(--accent-color);
            background: rgba(67, 97, 238, 0.1);
            border-radius: var(--radius-md);
            aspect-ratio: 1;
            transition: all 0.1s;
            box-sizing: border-box;
        }

        .image-delete-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition-fast);
            backdrop-filter: blur(8px);
        }

        .image-preview-item:hover .image-delete-btn {
            opacity: 1;
        }
        .image-delete-btn:hover {
            background: var(--danger-color);
            transform: scale(1.1);
        }

        /* Bottom Area - Floating Action Button Container */
        .bottom-area {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            padding: 0;
            background: transparent;
            border: none;
            pointer-events: none;
            z-index: 50;
            width: auto;
        }

        .detect-btn {
            width: auto;
            min-width: 120px;
            padding: 12px 24px;
            background: rgba(67, 97, 238, 0.15); /* Semi-transparent accent */
            color: var(--accent-color);
            border: 1px solid rgba(67, 97, 238, 0.2);
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            pointer-events: auto;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .detect-btn:hover {
            background: rgba(67, 97, 238, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3);
            border-color: var(--accent-color);
        }

        .detect-btn:active {
            transform: translateY(0);
        }

        /* Resizer */
        .resizer {
            width: 5px;
            background: var(--bg-tertiary);
            cursor: col-resize;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        .resizer::after {
            content: '';
            width: 3px;
            height: 32px;
            background: var(--text-secondary);
            border-radius: 2px;
            opacity: 0.3;
            transition: all 0.3s;
        }
        .resizer:hover {
            background: var(--accent-light);
            border-color: var(--accent-light);
        }
        .resizer:hover::after {
            background: var(--accent-color);
            opacity: 1;
            height: 48px;
        }

        /* Disable transitions during resize to prevent lag */
        body.resizing .left-panel,
        body.resizing .right-panel {
            transition: none !important;
        }

        /* Right Panel */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            min-width: 300px;
        }

        .result-header {
            height: 64px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            background: var(--bg-glass);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border-color);
            transition: background-color var(--transition-fast), border-color var(--transition-fast);
            z-index: 20;
            position: relative; /* For absolute positioning of exit button */
        }

        .result-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            transition: transform 0.3s ease;
            margin: 0 0 16px 0;
            padding-top: 8px;
        }

        body.detection-fullscreen .result-title {
            transform: translateX(40px); /* Make space for exit button */
        }

        .result-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: transparent;
            transition: background-color var(--transition-fast), border-color var(--transition-fast);
        }

        /* Initial State */
        .initial-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            overflow: hidden;
            text-align: center;
            color: var(--text-secondary);
            animation: scaleIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .initial-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.5;
            filter: grayscale(100%);
            transition: var(--transition);
        }
        .initial-state:hover .initial-icon {
            opacity: 1;
            filter: grayscale(0%);
            transform: scale(1.1);
        }

        .initial-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .initial-description {
            font-size: 15px;
            line-height: 1.6;
            max-width: 420px;
        }

            /* Heading Dropdown Items */
        #headingDropdown {
            min-width: 140px;
            white-space: nowrap;
        }
        .heading-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            text-align: left;
        }
        .heading-icon {
            width: 24px;
            text-align: center;
            color: var(--text-secondary);
            /* Removed fixed font-family/weight to match context menu style */
        }
        .heading-item:hover .heading-icon {
            color: var(--accent-color);
        }

        /* Result Item */
        .result-item {
            display: none;
            animation: slideInRight 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        /* .result-item.active { display: block; }  Removed to rely on inline style for explicit control */

        .result-score {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 24px;
            background: var(--bg-glass);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-fast), border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        /* SVG Score Circle */
        .score-circle-container {
            position: relative;
            width: 100px;
            height: 100px;
        }
        .score-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .score-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 8;
        }
        .score-progress {
            fill: none;
            stroke: var(--accent-color);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 283; /* 2 * PI * 45 */
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1.5s cubic-bezier(0.2, 0.8, 0.2, 1), stroke 0.3s;
        }
        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Score Colors */
        .score-circle-container.real .score-progress { stroke: var(--success-color); }
        .score-circle-container.fake .score-progress { stroke: var(--danger-color); }
        .score-circle-container.uncertain .score-progress { stroke: var(--warning-color); }

        .score-details { flex: 1; }

        .score-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .score-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -1px;
        }

        .score-description {
            font-size: 15px;
            color: var(--text-secondary);
            margin-top: 6px;
            line-height: 1.5;
        }

        /* Analysis List */
        .result-analysis {
            background: var(--bg-glass);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-fast), border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .analysis-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .analysis-title::before {
            content: '';
            width: 4px;
            height: 18px;
            background: var(--accent-color);
            border-radius: 2px;
        }

        .analysis-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 12px;
            padding: 16px;
            background: var(--bg-glass);
            border-radius: var(--radius-md);
            transition: var(--transition);
            border-left: 4px solid transparent;
            border: 1px solid var(--border-color);
        }

        .analysis-item:hover {
            transform: translateX(4px);
            background: var(--bg-glass);
            box-shadow: var(--shadow-sm);
        }

        .analysis-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
            font-weight: bold;
        }

        /* Analysis Status Styles */
        .analysis-item.positive { border-left-color: var(--success-color); }
        .analysis-item.positive .analysis-icon { color: var(--success-color); background: rgba(46, 196, 182, 0.1); }
        
        .analysis-item.negative { border-left-color: var(--danger-color); }
        .analysis-item.negative .analysis-icon { color: var(--danger-color); background: rgba(231, 29, 54, 0.1); }
        
        .analysis-item.warning { border-left-color: var(--warning-color); }
        .analysis-item.warning .analysis-icon { color: var(--warning-color); background: rgba(255, 159, 28, 0.1); }

        .analysis-text {
            flex: 1;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 32px;
            left: 0; 
            width: 100%; 
            height: calc(100% - 32px);
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        .image-modal.active { display: flex; }

        .modal-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            animation: zoomIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .modal-close {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 28px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }

        /* Custom Modal */
        .custom-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }
        .custom-modal.active { display: flex; }
        
        .custom-modal-content {
            background: var(--bg-glass);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            padding: 32px;
            min-width: 360px;
            max-width: 90vw;
            text-align: center;
            animation: zoomIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            border: 1px solid var(--border-color);
        }
        
        .custom-modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .custom-modal-message {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.5;
        }
        
        .custom-modal-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }
        
        .custom-modal-btn {
            padding: 10px 32px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(0,0,0,0.05);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            
            /* Deeper glass effect for unselected */
            background: rgba(0, 0, 0, 0.06);
            color: var(--text-primary);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            
            transition: var(--transition-fast);
        }
        
        [data-theme="dark"] .custom-modal-btn {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255,255,255,0.1);
        }

        .custom-modal-btn:hover {
            /* Theme color frosted glass for selected */
            background: var(--accent-light);
            color: var(--accent-color);
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-accent);
        }
        
        .custom-modal-btn.secondary {
            background: transparent;
            border-color: var(--border-color);
            opacity: 0.8;
        }
        .custom-modal-btn.secondary:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--text-secondary);
            box-shadow: var(--shadow-sm);
            opacity: 1;
        }

        /* Loading State */
        .loading-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            animation: fadeIn 0.3s ease;
            background: transparent;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }
        .loading-state.active { display: flex; }

        .loading-spinner-large {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        .progress-container {
            width: 240px;
            height: 6px;
            background-color: var(--bg-tertiary);
            border-radius: 3px;
            margin-top: 16px;
            overflow: hidden;
            transition: background-color var(--transition-fast);
        }

        .progress-bar {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        /* Parsed Content */
        .parsed-content {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
            animation: slideInRight 0.5s ease;
            background: transparent;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }

        .parsed-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .parsed-text {
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
            text-align: justify;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .parsed-text.is-html {
            white-space: normal;
        }
        .parsed-text.is-html p {
            margin-bottom: 1em;
        }
        .parsed-text.is-html img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
        }
        .parsed-text.is-html h1, 
        .parsed-text.is-html h2, 
        .parsed-text.is-html h3, 
        .parsed-text.is-html h4, 
        .parsed-text.is-html h5, 
        .parsed-text.is-html h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
            line-height: 1.3;
        }
        .parsed-text.is-html ul, 
        .parsed-text.is-html ol {
            padding-left: 2em;
            margin-bottom: 1em;
        }
        .parsed-text.is-html li {
            margin-bottom: 0.5em;
        }
        .parsed-text.is-html blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 1em;
            margin-left: 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        .parsed-text.is-html pre {
            background: var(--bg-tertiary);
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre;
        }
        .parsed-text.is-html code {
            font-family: monospace;
            background: var(--bg-tertiary);
            padding: 0.2em 0.4em;
            border-radius: 4px;
        }

        /* Parsed Images */
        .parsed-images-container {
            margin-top: 20px;
        }
        
        #parsedImages .parsed-images-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        #parsedImages {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .parsed-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
        }

        #parsedImages .parsed-image-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: var(--transition-bounce);
            flex-shrink: 0; /* Prevent shrinking */
        }

        #parsedImages .parsed-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #parsedImages .parsed-image-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Fake Highlight */
        .fake-highlight {
            background-color: rgba(255, 159, 28, 0.2);
            border-bottom: 2px solid var(--warning-color);
            color: inherit;
            cursor: pointer;
            border-radius: 4px;
            padding: 0 2px;
            transition: background-color 0.2s;
        }
        .fake-highlight:hover {
            background-color: rgba(255, 159, 28, 0.4);
        }
        .fake-highlight.active {
            background-color: rgba(255, 159, 28, 0.5);
            box-shadow: 0 0 0 2px rgba(255, 159, 28, 0.3);
        }

        /* Animations */
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes menuPopup {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) and (orientation: portrait) {
            .container { flex-direction: column; }
            .left-panel, .right-panel { max-width: 100%; min-width: 100%; }
            .resizer { display: none; }
            .image-preview-container { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
        }

        /* Landscape Mode Optimization */
        @media (max-height: 600px) and (orientation: landscape) {
            .left-panel {
                min-width: 200px;
            }
            .right-panel {
                min-width: 200px;
            }
            .toolbar, .result-header {
                height: 48px;
            }
        }

        /* 虚假内容高亮样式 */
        .fake-highlight {
            background-color: rgba(255, 190, 11, 0.3);
            border-bottom: 2px solid var(--warning-color);
            color: inherit;
            cursor: pointer;
            border-radius: 4px;
            padding: 0 2px;
            transition: background-color 0.2s;
        }
        
        .fake-highlight:hover {
            background-color: rgba(255, 190, 11, 0.5);
        }

        .fake-highlight.active {
            background-color: rgba(255, 190, 11, 0.6);
        }

        /* 详细分析列表项样式 */
        .analysis-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            transition: var(--transition);
        }

        .analysis-item:hover {
            transform: translateX(4px);
        }

        .analysis-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-weight: bold;
            font-size: 14px;
        }

        .analysis-icon.positive {
            background: rgba(6, 255, 165, 0.15);
            color: var(--success-color);
        }

        .analysis-icon.warning {
            background: rgba(255, 190, 11, 0.15);
            color: var(--warning-color);
        }

        .analysis-icon.negative {
            background: rgba(251, 86, 7, 0.15);
            color: var(--danger-color);
        }

        .analysis-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
        }

        /* 错误状态 */
        .error-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--danger-color);
            animation: fadeIn 0.3s ease;
            background: transparent;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }

        .error-state.active {
            display: flex;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .error-message {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .error-detail {
            font-size: 14px;
            color: var(--text-secondary);
            max-width: 300px;
        }

        .toolbar-btn.more-menu {
            overflow: visible; /* 允许下拉菜单超出按钮范围 */
        }

        /* 优化下拉菜单样式 */
        .more-menu .dropdown-menu {
            background: var(--bg-menu);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 6px;
            min-width: 200px;
            border-radius: 12px;
            transform-origin: top right;
        }
        
        [data-theme="dark"] .more-menu .dropdown-menu {
            background: var(--bg-menu);
            border-color: rgba(255,255,255,0.1);
        }

        .more-menu .dropdown-item {
            border-radius: 8px;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 保持比例填充，裁剪多余部分 */
            display: block;
            transition: transform 0.3s;
        }
        .image-preview-item:hover img {
            transform: scale(1.1);
        }

        .cancel-extract-btn {
            margin-top: 20px;
            padding: 10px 28px;
            background: transparent;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            border-radius: 30px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .cancel-extract-btn:hover {
            background: var(--danger-color);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 29, 54, 0.3);
            transform: translateY(-1px);
        }
        
        .cancel-extract-btn:active {
            transform: translateY(0);
        }
        
        .cancel-extract-btn::before {
            content: '';
            display: inline-block;
            width: 10px;
            height: 10px;
            background: currentColor;
            border-radius: 2px;
        }

        /* 自定义 Tooltip 样式 */
        .custom-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            max-width: 300px;
            z-index: 3000;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s, transform 0.2s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            backdrop-filter: blur(8px);
        }
        .custom-tooltip.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 48px; /* Moved down to avoid title bar overlap */
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            z-index: 10000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            pointer-events: none;
            box-shadow: var(--shadow-lg);
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: auto;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Toast Variants - Transparent Background */
        .toast.success { 
            background: rgba(46, 196, 182, 0.15); 
            color: var(--success-color);
            border-color: rgba(46, 196, 182, 0.2);
        }
        .toast.error { 
            background: rgba(231, 29, 54, 0.15); 
            color: var(--danger-color);
            border-color: rgba(231, 29, 54, 0.2);
        }
        .toast.warning { 
            background: rgba(255, 159, 28, 0.15); 
            color: var(--warning-color);
            border-color: rgba(255, 159, 28, 0.2);
        }
        .toast.info { 
            background: rgba(67, 97, 238, 0.15); 
            color: var(--accent-color);
            border-color: rgba(67, 97, 238, 0.2);
        }

        @media (prefers-reduced-motion: reduce) {
            .left-panel, .right-panel, .toolbar, .content-area, .bottom-area, .result-header, .initial-state {
                animation: none;
                opacity: 1;
                transform: none;
                transition: none;
            }
        }

        /* Detection Fullscreen Mode */
        body.detection-fullscreen .left-sidebar {
            width: 0 !important;
            padding: 0 !important;
            border: none !important;
            overflow: hidden !important;
            opacity: 0 !important;
        }

        body.detection-fullscreen .left-panel {
            flex: 0 0 0 !important;
            min-width: 0 !important;
            opacity: 0;
            overflow: hidden;
            transform: translateX(-20px);
        }

        body.detection-fullscreen .right-panel {
            flex: 1 0 100% !important;
            max-width: 100%;
        }

        body.detection-fullscreen .resizer {
            display: none;
        }

        /* Exit Button for Detection Fullscreen */
        .exit-detection-btn {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            background: var(--bg-glass);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transform: translateX(-10px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            color: var(--text-secondary);
            box-shadow: var(--shadow-sm);
        }

        body.detection-fullscreen .exit-detection-btn {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
        }

        .exit-detection-btn:hover {
            background: var(--accent-light);
            color: var(--accent-color);
            box-shadow: var(--shadow-accent);
            transform: translateY(-1px);
        }

        /* Squeeze Masks */
        .squeeze-mask {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Prevent icon compression */
        .toolbar {
            flex-wrap: nowrap;
            overflow: visible; /* Changed from hidden to allow dropdowns */
            gap: var(--toolbar-gap, 12px); /* Dynamic gap */
        }
        .toolbar-btn {
            flex-shrink: 0;
        }
        
        /* Ensure toolbar is above mask */
        .toolbar {
            z-index: 60; /* Higher than squeeze-mask (50) */
            transition: opacity 0.2s ease, transform 0.2s ease;
            padding-right: 0; /* Removed padding to fix centering */
            box-sizing: border-box;
            width: 100%;
            flex-shrink: 0; /* Prevent shrinking to avoid overlap */
        }

        .toolbar.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
        }

        /* Collapsed Indicator Removed */

        .sidebar-toggle-btn .icon-collapse {
            display: none;
        }

        body.sidebar-expanded .sidebar-toggle-btn .icon-expand {
            display: none;
        }

        body.sidebar-expanded .sidebar-toggle-btn .icon-collapse {
            display: block;
        }

        .sidebar-toggle-btn {
            width: 32px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-app-region: no-drag;
            margin-left: 8px;
        }

        .sidebar-toggle-btn:hover {
            background: var(--accent-light);
            color: var(--accent-color);
        }

        /* 侧边栏展开时隐藏历史记录图标 */
        body.sidebar-expanded #historyBtn {
            display: none;
        }

        .btn-label {
            display: none;
            margin-left: 12px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            transition-delay: 0s;
        }

        .left-sidebar.expanded .btn-label {
            display: inline-block;
            opacity: 1;
            transition-delay: 0.4s;
        }

        .left-sidebar.expanded .toolbar-btn {
            width: 100%;
            justify-content: flex-start;
            padding-left: 12px;
            border-radius: var(--radius-md);
            transition: all 0.3s;
            transition-delay: 0s;
        }

        .left-sidebar.expanded .toolbar {
            align-items: stretch;
            padding: 0 8px; /* Add some horizontal padding to toolbar container */
        }

        /* Edit Mode - Completely Hide Sidebar */
        body.edit-mode .left-sidebar {
            width: 0 !important;
            padding: 0 !important;
            border: none !important;
            overflow: hidden !important;
            opacity: 0 !important;
            margin: 0 !important;
            pointer-events: none !important;
        }

        .edit-options .toolbar-separator {
            width: 1px;
            height: 24px;
            margin: 0 8px;
        }
    </style>
</head>
<body>
    <div id="title-bar">
        <div class="app-icon"></div>
        <button class="sidebar-toggle-btn" id="sidebarToggleBtn" title="展开/收起">
            <!-- Dock To Right (Expand) -->
            <svg class="icon-expand" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H10V6h10v12z"/>
            </svg>
            <!-- Dock To Left (Collapse) -->
            <svg class="icon-collapse" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 18V6h6v12H4z"/>
            </svg>
        </button>
        <button class="sidebar-toggle-btn" id="previewBtn" title="页面预览" style="margin-left: 4px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
            </svg>
        </button>
        <button class="sidebar-toggle-btn" id="themeBtn" title="切换主题" style="margin-left: 4px;">
            <span id="themeIconWrapper">
                <svg id="themeIconLight" width="20" height="20" viewBox="0 -960 960 960" fill="currentColor" style="display: none;">
                    <path d="M480-360q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35Zm0 80q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM200-440H40v-80h160v80Zm720 0H760v-80h160v80ZM440-760v-160h80v160h-80Zm0 720v-160h80v160h-80ZM256-650l-101-97 57-59 96 100-52 56Zm492 496-97-101 53-55 101 97-57 59Zm-98-550 97-101 59 57-100 96-56-52ZM154-212l101-97 55 53-97 101-59-57Zm326-268Z"/>
                </svg>
                <svg id="themeIconDark" width="20" height="20" viewBox="0 -960 960 960" fill="currentColor" style="display: none;">
                    <path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Zm-10-270Z"/>
                </svg>
            </span>
        </button>
        <div class="app-title">假新闻检测系统</div>
        <div class="title-bar-actions">
            <div class="toolbar-btn more-menu" id="moreBtn" title="更多操作" tabindex="0">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
                <div class="dropdown-menu" id="moreDropdown">
                    
                    <div class="dropdown-item-row">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 4v3h5v12h3V7h5V4H9zm-6 8h3v7h3v-7h3V9H3v3z"/>
                        </svg>
                        <span>字体缩放</span>
                        <div class="zoom-controls">
                            <button class="zoom-btn" id="fontDec">-</button>
                            <span class="zoom-val" id="fontVal">16px</span>
                            <button class="zoom-btn" id="fontInc">+</button>
                        </div>
                    </div>
                    <div class="dropdown-item-row">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM12 10h-2v2H9v-2H7V9h2V7h1v2h2v1z"/>
                        </svg>
                        <span>UI缩放</span>
                        <div class="zoom-controls">
                            <button class="zoom-btn" id="zoomDec">-</button>
                            <span class="zoom-val" id="zoomVal">100%</span>
                            <button class="zoom-btn" id="zoomInc">+</button>
                        </div>
                    </div>
                    <div class="dropdown-item" id="clearBrowserDataBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                        <span>清除浏览器数据</span>
                    </div>
                    <div class="dropdown-separator"></div>
                    <div class="dropdown-item-row" id="browserToggleRow" style="cursor: pointer;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                        </svg>
                        <span>使用系统浏览器</span>
                        <div class="toggle-switch" id="browserToggle">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                </div>
            </div>
            <button class="toolbar-btn" id="fullScreenBtn" title="全屏显示">
                <svg class="icon-enter-fullscreen" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                </svg>
                <svg class="icon-exit-fullscreen" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                    <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
                </svg>
            </button>
        </div>
    </div>
    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
    <div class="container">
        <div class="left-sidebar" id="leftSidebar">
            <!-- 工具栏 -->
            <div class="toolbar">
                <button class="toolbar-btn" id="newChatBtn" title="新对话">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                    </svg>
                    <span class="btn-label">新对话</span>
                </button>
                <button class="toolbar-btn" id="editBtn" title="编辑模式">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14.06 9.02l.92.92L5.92 19H5v-.92l9.06-9.06M17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29zm-3.6 3.19L3 17.25V21h3.75L17.81 9.94l-3.75-3.75z"/>
                    </svg>
                    <span class="btn-label">编辑模式</span>
                </button>
                <button class="toolbar-btn" id="imageBtn" title="添加图片">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86l-3 3.87L9 13.14 6 17h12l-3.86-5.14z"/>
                    </svg>
                    <span class="btn-label">添加图片</span>
                </button>
                <button class="toolbar-btn" id="clearBtn" title="清空内容">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM8 9h8v10H8V9zm7.5-5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    <span class="btn-label">清空内容</span>
                </button>
                    <button class="toolbar-btn" id="historyBtn" title="历史记录">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                    </svg>
                    <span class="btn-label">历史记录</span>
                </button>
            </div>
            <div class="history-section">
                <div class="history-header" style="display: flex; justify-content: space-between; align-items: center; padding-right: 8px; margin-bottom: 12px;">
                    <div class="history-title" style="margin-bottom: 0; display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.8;">
                            <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                        </svg>
                        <span>历史记录</span>
                    </div>
                    <button class="icon-btn" id="clearHistoryBtn" title="清空历史" style="width: 24px; height: 24px;">
                        <svg viewBox="0 0 24 24" width="14" height="14">
                            <path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
                <div class="history-list" id="historyList">
                    <!-- 历史记录项将在这里动态生成 -->
                </div>

            </div>
        </div>
        <div class="main-layout" id="mainLayout">
            <!-- 左侧面板 -->
            <div class="left-panel" id="leftPanel">
            <div class="left-content">
                <div class="squeeze-mask" id="leftMask"></div>
                <div class="drag-overlay" id="dragOverlay">拖入图片以添加</div>
                
                <!-- 编辑选项 -->
                <div class="edit-options" id="editOptions">
                <button class="edit-btn" id="editCutBtn" title="剪切" disabled>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9.64 7.64c.23-.5.36-1.05.36-1.64 0-2.21-1.79-4-4-4S2 3.79 2 6s1.79 4 4 4c.59 0 1.14-.13 1.64-.36L10 12l-2.36 2.36C7.14 14.13 6.59 14 6 14c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4c0-.59-.13-1.14-.36-1.64L12 14l7 7h3v-1L9.64 7.64zM6 8c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm0 12c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-7.5c-.28 0-.5-.22-.5-.5s.22-.5.5-.5.5.22.5.5-.22.5-.5.5zM19 3l-6 6 2 2 7-7V3z"/>
                    </svg>
                </button>
                <button class="edit-btn" id="editOptionsPasteBtn" title="粘贴">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/>
                    </svg>
                </button>
                <button class="edit-btn" id="editUndoBtn" title="撤销" disabled>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.69 2.81l1.46 1.46C19.49 16.08 20 14.6 20 13c0-4.42-3.58-8-8-8z"/>
                    </svg>
                </button>
                <button class="edit-btn" id="editRedoBtn" title="重做" disabled>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 5V1l5 5-5 5V7c-3.31 0-6 2.69-6 6 0 1.01.25 1.97.69 2.81L5.23 17.27C4.51 16.08 4 14.6 4 13c0-4.42 3.58-8 8-8z"/>
                    </svg>
                </button>
                <div class="toolbar-separator"></div>
                <button class="edit-btn" id="editFormatPainterBtn" title="清除格式">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3.27 5L2 6.27l6.97 6.97L6.5 19h3l1.57-3.66L16.73 21 18 19.73 3.55 5.27 3.27 5zM6 5v.18L8.82 8h2.4l-.72 1.68 2.1 2.1L14.21 8H20V5H6z"/>
                    </svg>
                </button>
                <div class="edit-btn-group" id="editFormatGroup">
                    <button class="edit-btn" id="editFormatBtn" title="文本格式">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M5 17v2h14v-2H5zm4.5-4.2h5l.9 2.2h2.1L12.75 4h-1.5L6.5 15h2.1l.9-2.2zM12 5.98L13.87 11h-3.74L12 5.98z"/>
                        </svg>
                    </button>
                    <div class="dropdown-menu format-menu" id="formatDropdown">
                        <div class="dropdown-item-row" style="padding: 4px 6px;">
                            <div class="zoom-controls" style="display: flex; gap: 6px; width: 100%; background: transparent; padding: 0;">
                                <div class="dropdown-item" id="editFontDec" title="减小字号" style="flex: 1; display: flex; align-items: center; justify-content: center;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M0.99 19h2.42l1.27-3.58h5.65L11.59 19h2.42L8.75 5h-2.5L0.99 19zM7.5 7.62L9.38 13.5h-3.76L7.5 7.62zM19 13h-8v-2h8v2z"/></svg>
                                </div>
                                <div class="dropdown-item" id="editFontInc" title="增大字号" style="flex: 1; display: flex; align-items: center; justify-content: center;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M0.99 19h2.42l1.27-3.58h5.65L11.59 19h2.42L8.75 5h-2.5L0.99 19zM7.5 7.62L9.38 13.5h-3.76L7.5 7.62zM19 13h-3v3h-2v-3h-3v-2h3V8h2v3h3v2z"/></svg>
                                </div>
                            </div>
                        </div>
                        <div class="dropdown-item" data-command="bold" title="加粗">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/>
                            </svg>
                            <span>加粗</span>
                        </div>
                        <div class="dropdown-item" data-command="italic" title="斜体">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/>
                            </svg>
                            <span>斜体</span>
                        </div>
                        <div class="dropdown-item" data-command="underline" title="下划线">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 17c3.31 0 6-2.69 6-6V3h-2.5v8c0 1.93-1.57 3.5-3.5 3.5S8.5 12.93 8.5 11V3H6v8c0 3.31 2.69 6 6 6zm-7 2v2h14v-2H5z"/>
                            </svg>
                            <span>下划线</span>
                        </div>
                    </div>
                </div>
                <div class="edit-btn-group" id="editHeadingGroup">
                    <button class="edit-btn" id="editHeadingBtn" title="段落格式">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3 3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"/>
                        </svg>
                    </button>
                    <div class="dropdown-menu" id="headingDropdown">
                        <div class="dropdown-item heading-item" data-cmd="formatBlock" data-val="H1">
                            <span class="heading-icon" style="font-weight: 800; font-size: 16px;">H1</span>
                            <span>标题 1</span>
                        </div>
                        <div class="dropdown-item heading-item" data-cmd="formatBlock" data-val="H2">
                            <span class="heading-icon" style="font-weight: 700; font-size: 15px;">H2</span>
                            <span>标题 2</span>
                        </div>
                        <div class="dropdown-item heading-item" data-cmd="formatBlock" data-val="H3">
                            <span class="heading-icon" style="font-weight: 600; font-size: 14px;">H3</span>
                            <span>标题 3</span>
                        </div>
                        <div class="dropdown-item heading-item" data-cmd="formatBlock" data-val="P">
                            <span class="heading-icon" style="font-size: 14px;">¶</span>
                            <span>正文</span>
                        </div>
                    </div>
                </div>
                <div class="toolbar-separator"></div>
                <button class="edit-btn" data-command="justifyLeft" title="左对齐">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/>
                    </svg>
                </button>
                <button class="edit-btn" data-command="justifyCenter" title="居中">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/>
                    </svg>
                </button>
                <button class="edit-btn" data-command="justifyRight" title="右对齐">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/>
                    </svg>
                </button>
                <div class="toolbar-separator"></div>
                <button class="edit-btn" id="editAddImageBtn" title="添加图片">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86l-3 3.87L9 13.14 6 17h12l-3.86-5.14z"/>
                    </svg>
                </button>
                <div class="toolbar-separator"></div>
                <button class="edit-btn close-edit-btn" id="closeEditBtn" title="完成编辑">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>

            <div class="context-menu" id="editContextMenu">
                <div class="context-menu-item" id="ctxSearch">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                    <span>搜索</span>
                    <span class="shortcut-hint" id="ctxSearchText"></span>
                </div>
                <div class="context-menu-item" id="ctxGoTo">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
                    </svg>
                    <span>转到</span>
                    <span class="shortcut-hint" id="ctxGoToUrl"></span>
                </div>
                <div class="context-menu-separator" id="ctxSearchSep"></div>
                <div class="context-menu-item" id="ctxCut">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9.64 7.64c.23-.5.36-1.05.36-1.64 0-2.21-1.79-4-4-4S2 3.79 2 6s1.79 4 4 4c.59 0 1.14-.13 1.64-.36L10 12l-2.36 2.36C7.14 14.13 6.59 14 6 14c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4c0-.59-.13-1.14-.36-1.64L12 14l7 7h3v-1L9.64 7.64zM6 8c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm0 12c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm6-7.5c-.28 0-.5-.22-.5-.5s.22-.5.5-.5.5.22.5.5-.22.5-.5.5zM19 3l-6 6 2 2 7-7V3z"/>
                    </svg>
                    <span>剪切</span>
                    <span class="shortcut-hint">Ctrl+X</span>
                </div>
                <div class="context-menu-item" id="ctxCopy">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                    </svg>
                    <span>复制</span>
                    <span class="shortcut-hint">Ctrl+C</span>
                </div>
                <div class="context-menu-item" id="ctxPaste">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/>
                    </svg>
                    <span>粘贴</span>
                    <span class="shortcut-hint">Ctrl+V</span>
                </div>
                <div class="context-menu-item" id="ctxPastePlain">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/>
                        <text x="8" y="17" font-size="10" font-weight="bold" fill="currentColor">T</text>
                    </svg>
                    <span>仅粘贴文本</span>
                    <span class="shortcut-hint">Ctrl+Shift+V</span>
                </div>
                <div class="context-menu-item" id="ctxDelete">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    <span>删除</span>
                    <span class="shortcut-hint">Del</span>
                </div>
                <div class="context-menu-item" id="ctxSaveAs">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/>
                    </svg>
                    <span>另存为</span>
                </div>
                <div class="context-menu-separator ctx-format-group"></div>
                <div class="context-menu-item ctx-format-group">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M5 17v2h14v-2H5zm4.5-4.2h5l.9 2.2h2.1L12.75 4h-1.5L6.5 15h2.1l.9-2.2zM12 5.98L13.87 11h-3.74L12 5.98z"/>
                    </svg>
                    <span>文本格式</span>
                    
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                    <div class="context-submenu">
                        <div class="context-menu-item" data-cmd="bold">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/>
                            </svg>
                            <span>加粗</span>
                            <span class="shortcut-hint">Ctrl+B</span>
                        </div>
                        <div class="context-menu-item" data-cmd="italic">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/>
                            </svg>
                            <span>斜体</span>
                            <span class="shortcut-hint">Ctrl+I</span>
                        </div>
                        <div class="context-menu-item" data-cmd="underline">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 17c3.31 0 6-2.69 6-6V3h-2.5v8c0 1.93-1.57 3.5-3.5 3.5S8.5 12.93 8.5 11V3H6v8c0 3.31 2.69 6 6 6zm-7 2v2h14v-2H5z"/>
                            </svg>
                            <span>下划线</span>
                            <span class="shortcut-hint">Ctrl+U</span>
                        </div>
                        <div class="context-menu-item" data-cmd="removeFormat">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3.27 5L2 6.27l6.97 6.97L6.5 19h3l1.57-3.66L16.73 21 18 19.73 3.55 5.27 3.27 5zM6 5v.18L8.82 8h2.4l-.72 1.68 2.1 2.1L14.21 8H20V5H6z"/>
                            </svg>
                            <span>清除格式</span>
                        </div>
                    </div>
                </div>
                <div class="context-menu-item ctx-format-group">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4 19h6v-2H4v2zM20 5H4v2h16V5zm-3 6H4v2h13.25c1.1 0 2 .9 2 2s-.9 2-2 2H15v-2l-3 3 3 3v-2h2c2.21 0 4-1.79 4-4s-1.79-4-4-4z"/>
                    </svg>
                    <span>段落级别</span>
                    
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                    <div class="context-submenu">
                        <div class="context-menu-item" data-cmd="formatBlock" data-val="H1">
                            <span style="font-weight: 800; font-size: 16px;">H1</span>
                            <span>标题 1</span>
                        </div>
                        <div class="context-menu-item" data-cmd="formatBlock" data-val="H2">
                            <span style="font-weight: 700; font-size: 15px;">H2</span>
                            <span>标题 2</span>
                        </div>
                        <div class="context-menu-item" data-cmd="formatBlock" data-val="H3">
                            <span style="font-weight: 600; font-size: 14px;">H3</span>
                            <span>标题 3</span>
                        </div>
                        <div class="context-menu-item" data-cmd="formatBlock" data-val="P">
                            <span style="font-size: 14px;">¶</span>
                            <span>正文</span>
                        </div>
                    </div>
                </div>
                <div class="context-menu-separator ctx-format-group"></div>
                <div class="context-menu-item" id="ctxSelectAll">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 5h2V3c-1.1 0-2 .9-2 2zm0 8h2v-2H3v2zm4 8h2v-2H7v2zM3 9h2V7H3v2zm10-6h-2v2h2V3zm6 0v2h2c0-1.1-.9-2-2-2zM5 21v-2H3c0 1.1.9 2 2 2zm-2-4h2v-2H3v2zM9 3H7v2h2V3zm2 18h2v-2h-2v2zm8-8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2zm0-12h2V7h-2v2zm0 8h2v-2h-2v2zm-4 4h2v-2h-2v2zm0-16h2V3h-2v2zM7 17h10V7H7v10zm2-8h6v6H9V9z"/>
                    </svg>
                    <span>全选</span>
                    <span class="shortcut-hint">Ctrl+A</span>
                </div>
                <div class="context-menu-item" id="ctxAddImage">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                    </svg>
                    <span>添加图片</span>
                </div>
            </div>

            <!-- 内容区域 -->
            <div class="content-area">
                <!-- 文本容器（视觉矩形框） -->
                <div class="text-container">
                    <!-- 文本输入 -->
                    <div contenteditable="true" class="text-input" id="textInput" placeholder="请输入要检测的新闻内容..."></div>
                </div>
                <!-- 图片预览 -->
                <div class="image-preview-container" id="imagePreview"></div>
                
                <!-- 状态栏 -->
                <div class="editor-status-bar">
                    <span id="wordCount">0 字</span>
                    <span class="status-separator">|</span>
                    <span id="imageCount">0 图片</span>
                </div>
            </div>

            <!-- 底部操作区 -->
            <div class="bottom-area">
                <!-- 检测按钮 -->
                <button class="detect-btn" id="detectBtn">开始检测</button>
            </div>
            </div>
        </div>

        <!-- 分隔线 -->
        <div class="resizer" id="resizer"></div>

        <!-- 右侧面板 -->
        <div class="right-panel" id="rightPanel">
            <div class="squeeze-mask" id="rightMask"></div>
            <button class="exit-detection-btn" id="exitDetectionBtn" title="退出">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
            </button>
            <div class="result-content">

                <!-- 初始状态 -->
                <div class="initial-state" id="initialState">
                    <div class="initial-icon">
                        <!-- 彩色放大镜SVG -->
                                                <!-- 在线彩色放大镜图标，线性风格，主色蓝辅色黄 -->
                                                <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <circle cx="28" cy="28" r="16" stroke="#2196f3" stroke-width="3" fill="#e3f6fd"/>
                                                    <circle cx="28" cy="28" r="8" stroke="#2196f3" stroke-width="2" fill="#fff"/>
                                                    <circle cx="28" cy="28" r="3" fill="#4fc3f7"/>
                                                    <rect x="38" y="38" width="12" height="5" rx="2.5" transform="rotate(45 38 38)" fill="#fffde7" stroke="#ffc107" stroke-width="2"/>
                                                    <line x1="36" y1="36" x2="48" y2="48" stroke="#2196f3" stroke-width="2.5" stroke-linecap="round"/>
                                                </svg>
                    </div>
                    <div class="initial-title">准备就绪</div>
                    <div class="initial-description">
                        在左侧输入新闻内容或上传相关图片，点击"开始检测"按钮即可进行假新闻分析。
                        系统将综合评估内容的真实性，为您提供详细的检测报告。
                    </div>
                </div>

                <!-- 检测结果 -->
                <div class="result-item" id="resultItem">
                    <div class="result-header-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="result-title" style="margin-bottom: 0;">检测结果</h2>
                        <button class="toolbar-btn" id="exportBtn" title="导出结果">
                            <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/></svg>
                        </button>
                    </div>
                    <div class="result-score">
                        <div class="score-circle-container" id="scoreCircleContainer">
                            <svg class="score-svg" viewBox="0 0 100 100">
                                <circle class="score-bg" cx="50" cy="50" r="45"></circle>
                                <circle class="score-progress" id="scoreProgress" cx="50" cy="50" r="45"></circle>
                            </svg>
                            <div class="score-text" id="scoreText">0%</div>
                        </div>
                        <div class="score-details">
                            <div class="score-label">真实性评分</div>
                            <div class="score-value" id="scoreValue">0%</div>
                            <div class="score-description" id="scoreDescription">等待检测...</div>
                        </div>
                    </div>

                    <div class="result-analysis">
                        <div class="analysis-title">详细分析</div>
                        <div class="analysis-item">
                            <div class="analysis-icon positive">✓</div>
                            <div class="analysis-text">内容来源可靠，引用了权威媒体的数据</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-icon positive">✓</div>
                            <div class="analysis-text">语言表达客观，无明显情绪化倾向</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-icon neutral">!</div>
                            <div class="analysis-text">部分信息需要进一步核实</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-icon positive">✓</div>
                            <div class="analysis-text">图片内容与文字描述相符</div>
                        </div>
                    </div>

                    <!-- 解析内容 -->
                    <div class="parsed-content" id="parsedContent" style="display: none;">
                        <h3 class="parsed-title" id="parsedTitle"></h3>
                        <div class="parsed-images-container" id="parsedImages"></div>
                        <div class="parsed-text" id="parsedText"></div>
                    </div>
                </div>

                <!-- 加载状态 -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner-large"></div>
                    <div class="loading-text" id="loadingText">正在解析网页内容...</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <button class="cancel-extract-btn" id="cancelExtractBtn" style="display: none;"></button>
                </div>

                <!-- 错误状态 -->
                <div class="error-state" id="errorState">
                    <div class="error-icon">⚠️</div>
                    <div class="error-message">解析失败</div>
                    <div class="error-detail" id="errorDetail">无法获取网页内容，请检查链接是否有效</div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Context Menu for Result (Moved to body level) -->
    <div class="context-menu" id="resultContextMenu">
        <div class="context-menu-item" id="ctxResultSearch">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <span>搜索</span>
            <span class="shortcut-hint" id="ctxResultSearchText"></span>
        </div>
        <div class="context-menu-item" id="ctxResultGoTo">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
            </svg>
            <span>转到</span>
            <span class="shortcut-hint" id="ctxResultGoToUrl"></span>
        </div>
        <div class="context-menu-separator" id="ctxResultSearchSep"></div>
        <div class="context-menu-item" id="ctxResultCopy">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
            </svg>
            <span>复制</span>
            <span class="shortcut-hint">Ctrl+C</span>
        </div>
        <div class="context-menu-item" id="ctxResultSelectAll">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 5h2V3c-1.1 0-2 .9-2 2zm0 8h2v-2H3v2zm4 8h2v-2H7v2zM3 9h2V7H3v2zm10-6h-2v2h2V3zm6 0v2h2c0-1.1-.9-2-2-2zM5 21v-2H3c0 1.1.9 2 2 2zm-2-4h2v-2H3v2zM9 3H7v2h2V3zm2 18h2v-2h-2v2zm8-8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2zm0-12h2V7h-2v2zm0 8h2v-2h-2v2zm-4 4h2v-2h-2v2zm0-16h2V3h-2v2zM7 17h10V7H7v10zm2-8h6v6H9V9z"/>
            </svg>
            <span>全选</span>
            <span class="shortcut-hint">Ctrl+A</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="ctxExportResult">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/></svg>
            <span>导出检测结果</span>
        </div>
    </div>

    <!-- Context Menu for History -->
    <div class="context-menu" id="historyContextMenu">
        <div class="context-menu-item" id="ctxHistoryView">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
            </svg>
            <span>查看</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="ctxHistoryDelete">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
            <span>删除</span>
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div class="image-modal" id="imageModal">
        <button class="modal-close" id="modalClose">×</button>
        <img class="modal-image" id="modalImage" src="" alt="预览图片">
    </div>

    <!-- Toast 提示 -->
    <div class="toast" id="toast"></div>

    <!-- 自定义确认弹窗 -->
    <div class="custom-modal" id="customModal">
        <div class="custom-modal-content">
            <div class="custom-modal-title">清空内容</div>
            <div class="custom-modal-message">确定要清空页面吗？</div>
            <div class="custom-modal-actions">
                <button class="custom-modal-btn" id="modalConfirm">确定</button>
                <button class="custom-modal-btn" id="modalCancel">取消</button>
            </div>
        </div>
    </div>

    <script>
                // 更多按钮下拉菜单逻辑
                (function initMoreMenu() {
                    const moreBtn = document.getElementById('moreBtn');
                    const dropdown = document.getElementById('moreDropdown');

                    function toggleDropdown(forceState) {
                        const shouldShow = typeof forceState === 'boolean' ? forceState : !dropdown.classList.contains('show');
                        dropdown.classList.toggle('show', shouldShow);
                    }

                    moreBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleDropdown();
                    });

                    moreBtn.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            toggleDropdown();
                        } else if (e.key === 'Escape') {
                            toggleDropdown(false);
                        }
                    });

                    // Prevent clicks inside the dropdown from closing it (by bubbling to moreBtn)
                    dropdown.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });

                    document.addEventListener('pointerdown', function(e) {
                        if (!moreBtn.contains(e.target)) {
                            toggleDropdown(false);
                        }
                    });

                    // 暴露关闭方法供其他逻辑复用
                    window.__hideMoreDropdown = () => toggleDropdown(false);
                })();

                // 全屏显示功能
                const __fullScreenBtnEl = document.getElementById('fullScreenBtn');
                const __updateFullScreenLabel = () => {
                    const isFullScreen = !!document.fullscreenElement;
                    
                    // 更新按钮标题
                    if (__fullScreenBtnEl) {
                        __fullScreenBtnEl.title = isFullScreen ? '退出全屏' : '全屏显示';
                    }
                    
                    // 更新全屏样式类
                    if (isFullScreen) {
                        document.body.classList.add('fullscreen-mode');
                    } else {
                        document.body.classList.remove('fullscreen-mode');
                    }
                };
                // 初始化与状态变更监听（ESC/系统触发退出时也能更新）
                document.addEventListener('fullscreenchange', __updateFullScreenLabel);
                __updateFullScreenLabel();

                document.getElementById('fullScreenBtn').addEventListener('click', function() {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(err => {
                            console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                        });
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        }
                    }
                    // 点击后立即刷新文案，避免部分平台事件延迟
                    __updateFullScreenLabel();
                });

                // 清除浏览器数据功能
                document.getElementById('clearBrowserDataBtn').addEventListener('click', async function() {
                    if (window.electronAPI) {
                        const res = await window.electronAPI.invoke('clear-browser-data');
                        if (res && res.success) {
                            showToast('浏览器数据已清除', 'success');
                        } else {
                            showToast('清除失败: ' + (res && res.error ? res.error : '未知错误'), 'error');
                        }
                    } else {
                        showToast('当前环境不支持清除浏览器数据', 'warning');
                    }
                    window.__hideMoreDropdown && window.__hideMoreDropdown();
                });
        // 全局变量
        let isResizing = false;
        let uploadedImages = [];
        let selectedImages = new Set();
        let draggedItem = null;
        const maxImages = 4;
        let detectedUrls = [];

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            initResizable();
            initTextEditor();
            initImageUpload();
            initButtons();
            initExport();
            initModal();
            initIPC();
            initZoomControls();

            // Global context menu for images - REMOVED to use custom menu
            /* 
            document.addEventListener('contextmenu', function(e) {
                if (e.target.tagName === 'IMG') {
                    // ...
                }
            }); 
            */
        });

        // Zoom & Font Size Logic
        function initZoomControls() {
            let currentZoom = 100;
            let currentFontSize = 16;
            const textInput = document.getElementById('textInput');
            const contentArea = document.querySelector('.content-area');
            
            // Font Size
            const updateFontDisplay = () => {
                const val = `${currentFontSize}px`;
                // Update More Menu display
                const fontVal = document.getElementById('fontVal');
                if (fontVal) fontVal.textContent = val;
                
                // Update Edit Toolbar display
                const editFontVal = document.getElementById('editFontVal');
                if (editFontVal) editFontVal.textContent = val;

                // Update Editor Font
                textInput.style.fontSize = val;
                
                // Update Right Panel Font (Parsed Text)
                const parsedText = document.getElementById('parsedText');
                if (parsedText) parsedText.style.fontSize = val;
                
                // Update Parsed Content container to ensure inherited styles work
                const parsedContent = document.getElementById('parsedContent');
                if (parsedContent) parsedContent.style.fontSize = val;

                localStorage.setItem('editorFontSize', currentFontSize);
            };

            // Load saved font size
            const savedFont = localStorage.getItem('editorFontSize');
            if (savedFont) {
                currentFontSize = parseInt(savedFont);
                updateFontDisplay();
            }

            // More Menu Controls
            document.getElementById('fontInc').addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentFontSize < 48) { // Increased max size range
                    currentFontSize += 2;
                    updateFontDisplay();
                }
            });

            document.getElementById('fontDec').addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentFontSize > 12) {
                    currentFontSize -= 2;
                    updateFontDisplay();
                }
            });
            
            // Edit Toolbar Controls - Local Selection
            // const editFontVal = document.getElementById('editFontVal'); // Removed

            function getSelectionFontSize() {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    let node = range.commonAncestorContainer;
                    
                    // Fix: Check if selection wraps a single element (e.g. span created by us)
                    if (node.nodeType === 1 && range.startContainer === node && range.endContainer === node) {
                        const child = node.childNodes[range.startOffset];
                        if (child && child.nodeType === 1 && range.endOffset - range.startOffset === 1) {
                            return parseFloat(window.getComputedStyle(child).fontSize);
                        }
                    }

                    if (node.nodeType === 3) node = node.parentNode;
                    if (document.getElementById('textInput').contains(node)) {
                        return parseFloat(window.getComputedStyle(node).fontSize);
                    }
                }
                return currentFontSize; 
            }

            function applySelectionFontSize(newSize) {
                const textInput = document.getElementById('textInput');
                textInput.focus();
                
                // Use fontName hack to wrap selection
                const uuid = 'fs-' + Date.now();
                document.execCommand('fontName', false, uuid);
                
                const fonts = textInput.querySelectorAll(`font[face="${uuid}"]`);
                const newSpans = [];
                fonts.forEach(font => {
                    const span = document.createElement('span');
                    span.style.fontSize = newSize + 'px';
                    while (font.firstChild) {
                        span.appendChild(font.firstChild);
                    }
                    font.parentNode.replaceChild(span, font);
                    newSpans.push(span);
                });

                // Restore selection to cover the newly created spans
                if (newSpans.length > 0) {
                    const range = document.createRange();
                    range.setStartBefore(newSpans[0]);
                    range.setEndAfter(newSpans[newSpans.length - 1]);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }

            function updateFontButtonsState() {
                const editFontInc = document.getElementById('editFontInc');
                const editFontDec = document.getElementById('editFontDec');
                if (!editFontInc || !editFontDec) return;

                const sel = window.getSelection();
                const textInput = document.getElementById('textInput');
                let isDisabled = true;

                if (sel.rangeCount > 0 && !sel.isCollapsed) {
                    // Check if selection intersects with textInput
                    let node = sel.anchorNode;
                    if (node.nodeType === 3) node = node.parentNode;
                    
                    // Fix: Ensure we are checking against the textInput element correctly
                    // Use closest to find if the node is inside textInput
                    if (node.nodeType === 1 && node.closest('#textInput')) {
                         isDisabled = false;
                    } else if (node.parentNode && node.parentNode.closest && node.parentNode.closest('#textInput')) {
                         isDisabled = false;
                    } else if (textInput.contains(node)) {
                        isDisabled = false;
                    }
                }
                
                editFontInc.disabled = isDisabled;
                editFontDec.disabled = isDisabled;
                editFontInc.style.opacity = isDisabled ? '0.5' : '1';
                editFontDec.style.opacity = isDisabled ? '0.5' : '1';
                editFontInc.style.cursor = isDisabled ? 'not-allowed' : 'pointer';
                editFontDec.style.cursor = isDisabled ? 'not-allowed' : 'pointer';
            }

            const editFontInc = document.getElementById('editFontInc');
            if (editFontInc) {
                editFontInc.addEventListener('mousedown', e => e.preventDefault());
                editFontInc.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (editFontInc.disabled) return;
                    const current = getSelectionFontSize();
                    if (current < 72) {
                        applySelectionFontSize(current + 2);
                    }
                });
            }
            
            const editFontDec = document.getElementById('editFontDec');
            if (editFontDec) {
                editFontDec.addEventListener('mousedown', e => e.preventDefault());
                editFontDec.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (editFontDec.disabled) return;
                    const current = getSelectionFontSize();
                    if (current > 12) {
                        applySelectionFontSize(current - 2);
                    }
                });
            }

            // Update font size display on selection change
            document.addEventListener('selectionchange', () => {
                if (document.body.classList.contains('edit-mode')) {
                    updateFontButtonsState();
                }
            });
            
            // Initial check
            updateFontButtonsState();

            // UI Zoom
            const updateZoomDisplay = () => {
                document.getElementById('zoomVal').textContent = `${currentZoom}%`;
                if (window.electronAPI && window.electronAPI.setZoomFactor) {
                    window.electronAPI.setZoomFactor(currentZoom / 100);
                } else {
                    // Fallback for dev/browser
                    document.body.style.zoom = `${currentZoom}%`;
                }
                localStorage.setItem('appZoom', currentZoom);
            };

            // Load saved zoom
            const savedZoom = localStorage.getItem('appZoom');
            if (savedZoom) {
                currentZoom = parseInt(savedZoom);
                updateZoomDisplay();
            }

            document.getElementById('zoomInc').addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentZoom < 150) {
                    currentZoom += 10;
                    updateZoomDisplay();
                }
            });

            document.getElementById('zoomDec').addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentZoom > 80) {
                    currentZoom -= 10;
                    updateZoomDisplay();
                }
            });

            // Browser Toggle Logic
            const browserToggle = document.getElementById('browserToggle');
            const browserToggleRow = document.getElementById('browserToggleRow');
            let useSystemBrowser = localStorage.getItem('useSystemBrowser') === 'true';

            const updateToggle = () => {
                if (useSystemBrowser) {
                    browserToggle.classList.add('active');
                } else {
                    browserToggle.classList.remove('active');
                }
                localStorage.setItem('useSystemBrowser', useSystemBrowser);
            };
            
            // Initialize toggle state
            updateToggle();

            browserToggleRow.addEventListener('click', (e) => {
                e.stopPropagation();
                useSystemBrowser = !useSystemBrowser;
                updateToggle();
            });
        }

        // 主题切换
        function initTheme() {
            const themeBtn = document.getElementById('themeBtn');
            const themeIconLight = document.getElementById('themeIconLight');
            const themeIconDark = document.getElementById('themeIconDark');
            
            // 检查系统主题偏好
            const systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            // 优先使用本地存储的主题，如果没有则跟随系统
            const savedTheme = localStorage.getItem('theme');
            const isDark = savedTheme ? (savedTheme === 'dark') : systemDark;

            function updateThemeIcon(isDark) {
                if (isDark) {
                    themeIconLight.style.display = 'none';
                    themeIconDark.style.display = 'inline';
                } else {
                    themeIconLight.style.display = 'inline';
                    themeIconDark.style.display = 'none';
                }
            }

            // 应用初始主题
            if (isDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon(true);
                if (window.electronAPI) {
                    window.electronAPI.invoke('set-theme', true);
                }
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                updateThemeIcon(false);
                if (window.electronAPI) {
                    window.electronAPI.invoke('set-theme', false);
                }
            }

            // 监听系统主题变化
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    // 只有在用户没有手动设置过主题的情况下才跟随系统变化
                    if (!localStorage.getItem('theme')) {
                        const newIsDark = e.matches;
                        if (newIsDark) {
                            document.documentElement.setAttribute('data-theme', 'dark');
                            updateThemeIcon(true);
                        } else {
                            document.documentElement.setAttribute('data-theme', 'light');
                            updateThemeIcon(false);
                        }
                        if (window.electronAPI) {
                            window.electronAPI.invoke('set-theme', newIsDark);
                        }
                    }
                });
            }

            themeBtn.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                const isDarkMode = newTheme === 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(isDarkMode);

                if (window.electronAPI) {
                    window.electronAPI.invoke('set-theme', isDarkMode)
                        .then(result => {
                            if (!result.success) {
                                console.error('主题设置失败:', result.error);
                            }
                        });
                }

                showToast(`已切换到${isDarkMode ? '深色' : '浅色'}模式`, 'success');
            });
        }

        // 可调整大小的分隔线
        function initResizable() {
            const resizer = document.getElementById('resizer');
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const container = document.getElementById('mainLayout');
            const leftMask = document.getElementById('leftMask');
            const rightMask = document.getElementById('rightMask');
            const exitDetectionBtn = document.getElementById('exitDetectionBtn');
            let isResizing = false;
            let lastClientX = 0;
            let currentPercentage = 50;

            // Exit Detection Fullscreen
            if (exitDetectionBtn) {
                exitDetectionBtn.addEventListener('click', () => {
                    // Smooth transition back
                    leftPanel.style.flex = `1`;
                    rightPanel.style.flex = `1`;
                    
                    requestAnimationFrame(() => {
                        document.body.classList.remove('detection-fullscreen');
                    });
                    
                    currentPercentage = 50;
                });
            }

            function handleResizeMove(clientX) {
                const containerRect = container.getBoundingClientRect();
                let leftWidth = clientX - containerRect.left;
                leftWidth = Math.max(0, Math.min(containerRect.width, leftWidth));
                currentPercentage = (leftWidth / containerRect.width) * 100;
                
                lastClientX = clientX;

                // Mask Opacity Logic
                const percentage = currentPercentage;
                if (percentage < 40) {
                    const opacity = (40 - percentage) / 10;
                    if (leftMask) leftMask.style.opacity = Math.min(Math.max(opacity, 0), 1);
                } else {
                    if (leftMask) leftMask.style.opacity = 0;
                }

                if (percentage > 55) {
                    const opacity = (percentage - 55) / 10;
                    if (rightMask) rightMask.style.opacity = Math.min(Math.max(opacity, 0), 1);
                } else {
                    if (rightMask) rightMask.style.opacity = 0;
                }

                // Use percentage for left panel to maintain ratio on resize
                leftPanel.style.flex = `0 0 ${currentPercentage}%`;
                rightPanel.style.flex = `1`;
            }

            // Mouse Events
            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                lastClientX = e.clientX;
                document.body.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                e.preventDefault();
                handleResizeMove(e.clientX);
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.classList.remove('resizing');
                    document.body.style.cursor = 'default';
                    
                    const minPercent = 30;
                    const maxPercent = 65;

                    // Trigger Logic on Release
                    if (currentPercentage <= minPercent) {
                        // Trigger Detection Fullscreen
                        document.body.classList.add('detection-fullscreen');
                        if (leftMask) leftMask.style.opacity = 0;
                    } else if (currentPercentage >= maxPercent) {
                        // Trigger Edit Mode
                        const editBtn = document.getElementById('editBtn');
                        if (editBtn && !document.body.classList.contains('edit-mode')) {
                            editBtn.click();
                        }
                        if (rightMask) rightMask.style.opacity = 0;
                    } else {
                        if (leftMask) leftMask.style.opacity = 0;
                        if (rightMask) rightMask.style.opacity = 0;
                    }
                }
            });

            // Touch Events (复用逻辑)
            resizer.addEventListener('touchstart', function(e) {
                isResizing = true;
                lastClientX = e.touches[0].clientX;
                document.body.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            }, { passive: false });

            document.addEventListener('touchmove', function(e) {
                if (!isResizing) return;
                e.preventDefault();
                handleResizeMove(e.touches[0].clientX);
            }, { passive: false });

            document.addEventListener('touchend', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.classList.remove('resizing');
                    document.body.style.cursor = 'default';
                    
                    const minPercent = 30;
                    const maxPercent = 65;

                    if (currentPercentage <= minPercent) {
                        document.body.classList.add('detection-fullscreen');
                        if (leftMask) leftMask.style.opacity = 0;
                    } else if (currentPercentage >= maxPercent) {
                        const editBtn = document.getElementById('editBtn');
                        if (editBtn && !document.body.classList.contains('edit-mode')) {
                            editBtn.click();
                        }
                        if (rightMask) rightMask.style.opacity = 0;
                    } else {
                        if (leftMask) leftMask.style.opacity = 0;
                        if (rightMask) rightMask.style.opacity = 0;
                    }
                }
            });
        }

        // 更新编辑器统计信息
        function updateEditorStats() {
            const textInput = document.getElementById('textInput');
            const wordCountEl = document.getElementById('wordCount');
            const imageCountEl = document.getElementById('imageCount');
            
            if (textInput && wordCountEl) {
                const text = textInput.innerText || '';
                // 简单字数统计：去除空白字符后的长度
                const count = text.replace(/\s+/g, '').length;
                wordCountEl.textContent = `${count} 字`;
            }
            
            if (imageCountEl) {
                imageCountEl.textContent = `${uploadedImages.length} 图片`;
            }
            
            updateClearButtonState();
        }

        // Update Clear Button State
        function updateClearButtonState() {
            const clearBtn = document.getElementById('clearBtn');
            if (!clearBtn) return;

            const textInput = document.getElementById('textInput');
            const hasText = textInput && textInput.innerText.trim().length > 0;
            const hasImages = typeof uploadedImages !== 'undefined' && uploadedImages.length > 0;
            
            // Check if right panel is in initial state (ready)
            const initialState = document.getElementById('initialState');
            const isInitialState = initialState && getComputedStyle(initialState).display !== 'none';

            // Disable if (No Text AND No Images AND Is Initial State)
            const shouldDisable = (!hasText && !hasImages) && isInitialState;
            
            clearBtn.disabled = shouldDisable;
            if (shouldDisable) {
                clearBtn.classList.add('disabled');
                clearBtn.style.opacity = '0.4';
                clearBtn.style.pointerEvents = 'none';
            } else {
                clearBtn.classList.remove('disabled');
                clearBtn.style.opacity = '1';
                clearBtn.style.pointerEvents = 'auto';
            }
        }

        // 文本编辑器
        function initTextEditor() {
            const textInput = document.getElementById('textInput');
            const contentArea = document.querySelector('.content-area');
            const editBtn = document.getElementById('editBtn');
            const closeEditBtn = document.getElementById('closeEditBtn');
            // const editOptions = document.getElementById('editOptions'); // Controlled via CSS now

            // 粘贴纯文本处理
            textInput.addEventListener('paste', function(e) {
                e.preventDefault();
                let text = (e.clipboardData || window.clipboardData).getData('text/plain');
                if (!text) return;

                e.stopPropagation(); // 阻止冒泡，表示文本已处理

                // 检查字数限制
                const currentLength = this.innerText.length; // innerText is more accurate for visible text
                const maxLength = 20000;
                
                if (currentLength >= maxLength) {
                    showToast('字数已超过最大限制 (20000字)', 'warning');
                    return;
                }

                if (currentLength + text.length > maxLength) {
                    const remaining = maxLength - currentLength;
                    if (remaining > 0) {
                        // 截断文本
                        text = text.substring(0, remaining);
                        document.execCommand('insertText', false, text);
                    }
                    showToast('字数已超过最大限制 (20000字)', 'warning');
                } else {
                    document.execCommand('insertText', false, text);
                }
            });

            // 键盘输入限制
            textInput.addEventListener('keydown', function(e) {
                // 允许的功能键
                const allowedKeys = [
                    'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 
                    'Home', 'End', 'PageUp', 'PageDown', 'Tab'
                ];
                
                // 允许组合键 (Ctrl/Cmd + A/C/V/X/Z)
                if (e.ctrlKey || e.metaKey) return;
                
                if (allowedKeys.includes(e.key)) return;

                if (this.innerText.length >= 20000) {
                    // 如果有选中文本，允许输入（因为会替换）
                    const selection = window.getSelection();
                    if (selection.toString().length > 0) return;

                    e.preventDefault();
                    showToast('字数已超过最大限制 (20000字)', 'warning');
                }
            });

            // 自动识别链接与字数统计
            textInput.addEventListener('input', function() {
                updateEditorStats();
                const text = this.innerText;
                const urlRegex = /(https?:\/\/|www\.)[^\s<]+/g;
                const matches = text.match(urlRegex);
                
                if (matches && matches.length > 0) {
                    // 检查是否有新的链接
                    const newUrls = matches.filter(url => !detectedUrls.includes(url));
                    if (newUrls.length > 0) {
                        detectedUrls = [...detectedUrls, ...newUrls];
                        showToast(`检测到 ${newUrls.length} 个网址链接`, 'info');
                    }
                }
            });

            // Preserve scroll position when toggling edit mode
            const editScrollState = { content: 0, text: 0 };
            const captureEditScrollState = () => {
                if (contentArea) editScrollState.content = contentArea.scrollTop;
                if (textInput) editScrollState.text = textInput.scrollTop;
            };
            const restoreEditScrollState = () => {
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        if (contentArea) contentArea.scrollTop = editScrollState.content;
                        if (textInput) textInput.scrollTop = editScrollState.text;
                    });
                });
            };

            // Toggle Edit Mode
            function toggleEditMode(active) {
                // Preserve scroll positions
                const textScrollBefore = textInput.scrollTop;
                const contentScrollBefore = contentArea.scrollTop;
                const leftPanel = document.getElementById('leftPanel');
                const rightPanel = document.getElementById('rightPanel');
                const toolbar = document.querySelector('.toolbar');
                const collapsedIndicator = document.getElementById('collapsedIndicator');

                if (active) {
                    document.body.classList.add('edit-mode');
                    editBtn.classList.add('active');
                    textInput.focus();
                    
                    // In edit mode the container scrolls; align it with the previous text scroll
                    requestAnimationFrame(() => {
                        contentArea.scrollTop = textScrollBefore;
                        textInput.scrollTop = textScrollBefore;
                    });
                } else {
                    document.body.classList.remove('edit-mode');
                    editBtn.classList.remove('active');
                    
                    // Reset divider to middle
                    if (leftPanel && rightPanel) {
                        leftPanel.style.flex = '0 0 50%';
                        rightPanel.style.flex = '0 0 50%';
                        // Reset internal state if accessible, or just rely on UI update
                        // We need to update the toolbar gap and visibility too
                        if (toolbar) {
                            toolbar.classList.remove('hidden');
                            toolbar.style.setProperty('--toolbar-gap', '12px'); // Reset gap
                        }
                        if (collapsedIndicator) collapsedIndicator.classList.remove('visible');
                    }

                    // Restore the original text scroll after leaving edit mode
                    requestAnimationFrame(() => {
                        textInput.scrollTop = contentScrollBefore;
                        contentArea.scrollTop = 0;
                    });
                }
            }

            // 编辑选项切换
            editBtn.addEventListener('click', function() {
                const isEditMode = document.body.classList.contains('edit-mode');
                toggleEditMode(!isEditMode);
            });

            if (closeEditBtn) {
                closeEditBtn.addEventListener('click', function() {
                    toggleEditMode(false);
                });
            }

            // 编辑按钮功能（通用 data-command）
            document.querySelectorAll('.edit-btn:not(.close-edit-btn)').forEach(btn => {
                btn.addEventListener('click', function() {
                    const command = this.dataset.command;
                    if (command) {
                        document.execCommand(command, false, null);
                        textInput.focus();
                        refreshUndoRedo && refreshUndoRedo();
                    }
                });
            });

            // New Toolbar Buttons Logic
            const editPasteBtn = document.getElementById('editPasteBtn');
            const editCutBtn = document.getElementById('editCutBtn');
            const editFormatPainterBtn = document.getElementById('editFormatPainterBtn');
            const editHeadingBtn = document.getElementById('editHeadingBtn');
            const editAddImageBtn = document.getElementById('editAddImageBtn');
            const headingDropdown = document.getElementById('headingDropdown');
            const editUndoBtn = document.getElementById('editUndoBtn');
            const editRedoBtn = document.getElementById('editRedoBtn');
            const editFormatBtn = document.getElementById('editFormatBtn');
            const formatDropdown = document.getElementById('formatDropdown');

            if (editPasteBtn) {
                editPasteBtn.addEventListener('click', async () => {
                    await handlePaste();
                    textInput.focus();
                });
            }

            const editOptionsPasteBtn = document.getElementById('editOptionsPasteBtn');
            if (editOptionsPasteBtn) {
                editOptionsPasteBtn.addEventListener('click', async () => {
                    await handlePaste();
                    textInput.focus();
                });
            }

            if (editCutBtn) {
                editCutBtn.addEventListener('click', () => {
                    document.execCommand('cut');
                    textInput.focus();
                    refreshUndoRedo();
                });
            }

            if (editFormatPainterBtn) {
                editFormatPainterBtn.addEventListener('click', () => {
                    document.execCommand('removeFormat', false, null);
                    textInput.focus();
                    refreshUndoRedo && refreshUndoRedo();
                });
            }

            // 撤销/重做逻辑
            function refreshUndoRedo() {
                if (!editUndoBtn || !editRedoBtn) return;
                let canUndo = false, canRedo = false;
                try {
                    canUndo = document.queryCommandEnabled('undo');
                    canRedo = document.queryCommandEnabled('redo');
                } catch (e) {
                    // ignore
                }
                editUndoBtn.disabled = !canUndo;
                editRedoBtn.disabled = !canRedo;

                if (editCutBtn) {
                    let canCut = false;
                    try {
                        canCut = document.queryCommandEnabled('cut');
                    } catch (e) {}
                    // Fallback: check selection if queryCommandEnabled returns false (sometimes unreliable)
                    if (!canCut) {
                        const sel = window.getSelection();
                        canCut = sel && sel.toString().length > 0;
                    }
                    editCutBtn.disabled = !canCut;
                }
            }
            if (editUndoBtn) {
                editUndoBtn.addEventListener('click', () => {
                    textInput.focus();
                    document.execCommand('undo');
                    refreshUndoRedo();
                });
            }
            if (editRedoBtn) {
                editRedoBtn.addEventListener('click', () => {
                    textInput.focus();
                    document.execCommand('redo');
                    refreshUndoRedo();
                });
            }
            ['input','keyup','mouseup','paste','cut'].forEach(ev => {
                textInput.addEventListener(ev, () => {
                    refreshUndoRedo();
                });
            });
            textInput.addEventListener('focus', refreshUndoRedo);
            document.addEventListener('selectionchange', refreshUndoRedo);

            // Heading Dropdown Logic
            if (editHeadingBtn && headingDropdown) {
                editHeadingBtn.addEventListener('click', (e) => {
                    // e.stopPropagation(); // Removed to allow other dropdowns to close
                    headingDropdown.classList.toggle('show');
                });

                // Dropdown items click
                headingDropdown.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        // e.stopPropagation();
                        const cmd = item.dataset.cmd;
                        const val = item.dataset.val;
                        document.execCommand(cmd, false, val);
                        headingDropdown.classList.remove('show');
                        textInput.focus();
                    });
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!editHeadingBtn.contains(e.target) && !headingDropdown.contains(e.target)) {
                        headingDropdown.classList.remove('show');
                    }
                });
            }

            // 文本格式菜单逻辑
            if (editFormatBtn && formatDropdown) {
                editFormatBtn.addEventListener('click', (e) => {
                    // e.stopPropagation(); // Removed
                    formatDropdown.classList.toggle('show');
                });
                // 在菜单内点击格式按钮后自动收起
                formatDropdown.addEventListener('click', (e) => {
                    const item = e.target.closest('.dropdown-item');
                    if (item && item.dataset && item.dataset.command) {
                        document.execCommand(item.dataset.command, false, null);
                        textInput.focus();
                        refreshUndoRedo && refreshUndoRedo();
                        // 延迟以便 execCommand 先执行
                        setTimeout(() => formatDropdown.classList.remove('show'), 0);
                    }
                });
                // 点击外部关闭
                document.addEventListener('click', (e) => {
                    if (!editFormatBtn.contains(e.target) && !formatDropdown.contains(e.target)) {
                        formatDropdown.classList.remove('show');
                    }
                });
            }

            // Prevent overlapping dropdowns on hover
            document.querySelectorAll('.edit-btn-group').forEach(group => {
                group.addEventListener('mouseenter', () => {
                    // Close all other open dropdowns in the toolbar
                    document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                        // Don't close if it's the one we are hovering (though hover handles display)
                        // Also don't close the More Menu (id="moreDropdown") as it's not an edit group
                        if (!group.contains(menu) && menu.id !== 'moreDropdown') {
                            menu.classList.remove('show');
                        }
                    });
                });
            });

            if (editAddImageBtn) {
                editAddImageBtn.addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });
            }

            // Context Menu Logic
            const contextMenu = document.getElementById('editContextMenu');
            
            // Submenu Logic (Floating)
            let activeSubmenu = null;
            let submenuCloseTimer = null;

            function closeSubmenu() {
                if (activeSubmenu) {
                    activeSubmenu.remove();
                    activeSubmenu = null;
                }
            }

            document.querySelectorAll('.context-menu-item').forEach(item => {
                const originalSubmenu = item.querySelector('.context-submenu');
                
                item.addEventListener('mouseenter', () => {
                    if (submenuCloseTimer) {
                        clearTimeout(submenuCloseTimer);
                        submenuCloseTimer = null;
                    }

                    // If hovering a different item, close existing submenu
                    if (activeSubmenu && activeSubmenu.dataset.parent !== item.innerText) {
                        closeSubmenu();
                    }

                    if (originalSubmenu) {
                        if (activeSubmenu) return; // Already open

                        // Create floating submenu
                        const floating = document.createElement('div');
                        floating.className = 'floating-submenu';
                        floating.innerHTML = originalSubmenu.innerHTML;
                        floating.dataset.parent = item.innerText;
                        
                        document.body.appendChild(floating);
                        activeSubmenu = floating;

                        // Positioning
                        const rect = item.getBoundingClientRect();
                        const winWidth = window.innerWidth;
                        const winHeight = window.innerHeight;
                        const subRect = floating.getBoundingClientRect();
                        
                        let left = rect.right;
                        let top = rect.top - 4; // Align top

                        // Horizontal flip
                        if (left + subRect.width > winWidth) {
                            left = rect.left - subRect.width;
                        }

                        // Vertical adjustment
                        if (top + subRect.height > winHeight) {
                            top = winHeight - subRect.height - 10;
                        }
                        
                        floating.style.left = left + 'px';
                        floating.style.top = top + 'px';

                        // Events for floating menu
                        floating.addEventListener('mouseenter', () => {
                            if (submenuCloseTimer) {
                                clearTimeout(submenuCloseTimer);
                                submenuCloseTimer = null;
                            }
                        });

                        floating.addEventListener('mouseleave', () => {
                            submenuCloseTimer = setTimeout(closeSubmenu, 200);
                        });

                        // Re-bind click events
                        floating.querySelectorAll('[data-cmd]').forEach(subItem => {
                            subItem.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const cmd = subItem.dataset.cmd;
                                const val = subItem.dataset.val || null;
                                document.execCommand(cmd, false, val);
                                closeSubmenu();
                                contextMenu.classList.remove('active');
                            });
                        });
                    }
                });

                item.addEventListener('mouseleave', () => {
                    submenuCloseTimer = setTimeout(closeSubmenu, 200);
                });
            });

            // Global context menu handler
            document.addEventListener('contextmenu', (e) => {
                // Close result context menu if open
                const resultContextMenu = document.getElementById('resultContextMenu');
                if (resultContextMenu) resultContextMenu.classList.remove('active');

                e.preventDefault(); // Always prevent default to block native menu

                // Close any open toolbar dropdowns
                document.querySelectorAll('.dropdown-menu.show').forEach(el => el.classList.remove('show'));

                // Determine context
                const isInput = e.target.closest('#textInput') || e.target.closest('.content-area');
                const isRightPanel = e.target.closest('.right-panel');
                const isImage = e.target.tagName === 'IMG';
                
                // Only show custom menu for main areas or images
                if (!isInput && !isRightPanel && !isImage) return;

                // Check if right panel is active (has result or preview)
                if (isRightPanel) {
                    const resultItem = document.getElementById('resultItem');
                    if (!resultItem.classList.contains('active')) return;
                }

                // If right clicking an image, clear any text selection
                if (isImage) {
                    window.getSelection().removeAllRanges();
                }

                // Selection Logic for Right Panel (Text only)
                if (isRightPanel && !isImage) {
                    // Clear left panel selection to avoid confusion
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        if (document.getElementById('textInput').contains(range.commonAncestorContainer)) {
                            selection.removeAllRanges();
                        }
                    }
                }

                // Get selected text for Search/GoTo
                const selectedText = window.getSelection().toString().trim();
                const isUrl = selectedText && /^(http|https):\/\/[^ "]+$/.test(selectedText);

                // Toggle items based on context
                const isEditMode = document.body.classList.contains('edit-mode');
                
                // Helper to show/hide
                const setDisplay = (id, show) => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = show ? 'flex' : 'none';
                };

                // Store target info
                contextMenu.dataset.targetType = isImage ? 'image' : (isInput ? 'input' : 'output');
                if (isImage) {
                    contextMenu.dataset.imageSrc = e.target.src;
                    contextMenu.currentElement = e.target;
                    
                    // 获取图片ID以便正确删除
                    const item = e.target.closest('.image-preview-item');
                    if (item && item.dataset.id) {
                        contextMenu.dataset.imageId = item.dataset.id;
                    } else {
                        delete contextMenu.dataset.imageId;
                    }
                } else {
                    contextMenu.currentElement = null;
                    delete contextMenu.dataset.imageId;
                }

                if (isImage) {
                    // Image Context
                    setDisplay('ctxSearch', false);
                    setDisplay('ctxSearchSep', false);
                    setDisplay('ctxGoTo', false);
                    
                    // Cut/Delete: Only in Input (Left Panel)
                    // For images, the image itself is the selection target
                    const isInputImage = isInput || e.target.closest('.image-preview-item');
                    
                    setDisplay('ctxCut', isInputImage);
                    setDisplay('ctxDelete', isInputImage);
                    
                    setDisplay('ctxCopy', true); // Copy Image
                    setDisplay('ctxSaveAs', true); // Save Image
                    
                    // Paste: Allow pasting in image context (Left Panel)
                    setDisplay('ctxPaste', isInputImage);
                    
                    setDisplay('ctxPastePlain', false);
                    setDisplay('ctxAddImage', false);
                    setDisplay('ctxSelectAll', false);
                    
                    // Hide format groups
                    const formatGroups = contextMenu.querySelectorAll('.ctx-format-group');
                    formatGroups.forEach(el => el.style.display = 'none');

                } else {
                    // Text Context
                    // Search & GoTo
                    if (selectedText) {
                        const displayContent = selectedText.length > 16 ? selectedText.substring(0, 16) + '...' : selectedText;
                        document.getElementById('ctxSearchText').textContent = displayContent;
                        
                        if (isUrl) {
                            document.getElementById('ctxGoToUrl').textContent = displayContent;
                            setDisplay('ctxGoTo', true);
                        } else {
                            setDisplay('ctxGoTo', false);
                        }
                        
                        setDisplay('ctxSearch', true);
                        setDisplay('ctxSearchSep', true);
                    } else {
                        setDisplay('ctxSearch', false);
                        setDisplay('ctxGoTo', false);
                        setDisplay('ctxSearchSep', false);
                    }

                    // Cut/Delete: Only in Input AND when text is selected
                    setDisplay('ctxCut', isInput && !!selectedText);
                    setDisplay('ctxDelete', isInput && !!selectedText);

                    // Save As: Only for images
                    setDisplay('ctxSaveAs', false);

                    // Copy (Always show if text selected)
                    setDisplay('ctxCopy', !!selectedText);

                    // Paste & Format (Only for Input)
                    setDisplay('ctxPaste', isInput);
                    setDisplay('ctxPastePlain', isInput);
                    setDisplay('ctxAddImage', isInput);
                    
                    // Format Groups (Only for Input + Edit Mode)
                    const formatGroups = contextMenu.querySelectorAll('.ctx-format-group');
                    formatGroups.forEach(el => {
                        el.style.display = (isInput && isEditMode) ? (el.classList.contains('context-menu-separator') ? 'block' : 'flex') : 'none';
                    });

                    // Select All
                    setDisplay('ctxSelectAll', true);
                    const selectAllItem = document.getElementById('ctxSelectAll');
                    if (isInput) {
                        const textInput = document.getElementById('textInput');
                        const hasContent = textInput.innerText.trim().length > 0 || textInput.querySelector('img');
                        if (!hasContent) {
                            selectAllItem.classList.add('disabled');
                        } else {
                            selectAllItem.classList.remove('disabled');
                        }
                    } else {
                        selectAllItem.classList.remove('disabled');
                    }
                }

                // Position menu (Smart Positioning)
                const x = e.clientX;
                const y = e.clientY;
                const winWidth = window.innerWidth;
                const winHeight = window.innerHeight;
                
                // Reset max-height before measuring
                contextMenu.style.maxHeight = '';
                contextMenu.style.overflowY = '';

                // Measure height
                contextMenu.style.visibility = 'hidden';
                contextMenu.classList.add('active');
                const menuHeight = contextMenu.offsetHeight;
                const menuWidth = contextMenu.offsetWidth;
                contextMenu.classList.remove('active');
                contextMenu.style.visibility = 'visible';

                let top = y;
                let left = x;

                // Flip vertically if near bottom
                if (y + menuHeight > winHeight) {
                    top = y - menuHeight;
                }
                // Flip horizontally if near right
                if (x + menuWidth > winWidth) {
                    left = winWidth - menuWidth - 10;
                }

                // Ensure menu stays within viewport bounds
                // Avoid overlapping with custom title bar (height 32px)
                if (top < 35) top = 35;
                if (left < 10) left = 10;
                
                // Check if it still overflows bottom
                if (top + menuHeight > winHeight) {
                    // If it's too tall, align to bottom or top depending on which has more space
                    if (winHeight - menuHeight > 0) {
                        top = winHeight - menuHeight - 10;
                        if (top < 35) top = 35; // Re-check top bound
                    } else {
                        top = 35; // Pin to top (below title bar)
                        // Enable scrolling
                        contextMenu.style.maxHeight = (winHeight - 45) + 'px'; // 35px top + 10px bottom padding
                        contextMenu.style.overflowY = 'auto';
                    }
                }

                contextMenu.style.left = `${left}px`;
                contextMenu.style.top = `${top}px`;
                contextMenu.classList.add('active');

                // Check clipboard content to update Paste Plain Text state
                if (isInput) {
                    const pastePlainItem = document.getElementById('ctxPastePlain');
                    // Reset state first
                    pastePlainItem.classList.remove('disabled');
                    
                    if (navigator.clipboard && navigator.clipboard.read) {
                        navigator.clipboard.read().then(items => {
                            const hasImage = items.some(item => item.types.some(type => type.startsWith('image/')));
                            if (hasImage) {
                                pastePlainItem.classList.add('disabled');
                            }
                        }).catch(err => {
                            console.warn('Clipboard check failed:', err);
                        });
                    }
                }

                // Check submenu positioning
                const submenus = contextMenu.querySelectorAll('.context-submenu');
                submenus.forEach(submenu => {
                    // Reset first
                    submenu.classList.remove('left-side');
                    
                    // Check if submenu would go off screen
                    // We estimate submenu width as 160px (min-width) + padding
                    const submenuWidth = 180; 
                    const parentRect = contextMenu.getBoundingClientRect();
                    
                    if (parentRect.right + submenuWidth > winWidth) {
                        submenu.classList.add('left-side');
                    }
                });
            });

            // Hide context menu on click elsewhere
            const closeMenus = (e) => {
                // Check if click is inside context menu OR inside the active floating submenu
                const inContextMenu = contextMenu.contains(e.target);
                const inSubmenu = activeSubmenu && activeSubmenu.contains(e.target);
                
                if (!inContextMenu && !inSubmenu) {
                    contextMenu.classList.remove('active');
                    closeSubmenu(); // Close submenu too
                }
                
                const resultContextMenu = document.getElementById('resultContextMenu');
                if (resultContextMenu && !resultContextMenu.contains(e.target)) {
                    resultContextMenu.classList.remove('active');
                }
            };

            document.addEventListener('pointerdown', closeMenus);
            window.addEventListener('blur', () => {
                contextMenu.classList.remove('active');
                const resultContextMenu = document.getElementById('resultContextMenu');
                if (resultContextMenu) resultContextMenu.classList.remove('active');
            });
            window.addEventListener('resize', () => {
                contextMenu.classList.remove('active');
                const resultContextMenu = document.getElementById('resultContextMenu');
                if (resultContextMenu) resultContextMenu.classList.remove('active');
            });

            // Context Menu Actions
            document.getElementById('ctxSearch').addEventListener('click', () => {
                const text = window.getSelection().toString().trim();
                if (text) {
                    // Use default browser search or specific engine
                    const url = `https://www.bing.com/search?q=${encodeURIComponent(text)}`;
                    const useSystemBrowser = localStorage.getItem('useSystemBrowser') === 'true';
                    
                    if (useSystemBrowser && window.electronAPI && window.electronAPI.openExternal) {
                        // Open in external browser (System Default)
                        window.electronAPI.openExternal(url);
                    } else {
                        // Open in internal browser (New Window)
                        window.open(url, '_blank');
                    }
                }
                contextMenu.classList.remove('active');
            });

            document.getElementById('ctxGoTo').addEventListener('click', () => {
                const text = window.getSelection().toString().trim();
                if (text) {
                    const useSystemBrowser = localStorage.getItem('useSystemBrowser') === 'true';
                    if (useSystemBrowser && window.electronAPI && window.electronAPI.openExternal) {
                        window.electronAPI.openExternal(text);
                    } else {
                        window.open(text, '_blank');
                    }
                }
                contextMenu.classList.remove('active');
            });

            document.getElementById('ctxCopy').addEventListener('click', async () => {
                if (contextMenu.dataset.targetType === 'image') {
                     const src = contextMenu.dataset.imageSrc;
                     if (window.electronAPI) {
                         window.electronAPI.send('copy-image', src);
                         showToast('图片已复制', 'success');
                     }
                } else {
                    const text = window.getSelection().toString();
                    if (text) {
                        await navigator.clipboard.writeText(text);
                        showToast('已复制到剪贴板', 'success');
                    }
                }
                contextMenu.classList.remove('active');
            });

            document.getElementById('ctxCut').addEventListener('click', () => {
                if (contextMenu.dataset.targetType === 'image') {
                    // Copy Image then Delete
                    const src = contextMenu.dataset.imageSrc;
                    if (window.electronAPI) window.electronAPI.send('copy-image', src);
                    
                    // Delete logic
                    const id = contextMenu.dataset.imageId;
                    if (id) {
                        deleteImage(parseFloat(id));
                    } else if (contextMenu.currentElement) {
                        contextMenu.currentElement.remove();
                    }
                } else {
                    document.execCommand('cut');
                }
                contextMenu.classList.remove('active');
            });

            document.getElementById('ctxDelete').addEventListener('click', () => {
                if (contextMenu.dataset.targetType === 'image') {
                    const id = contextMenu.dataset.imageId;
                    if (id) {
                        deleteImage(parseFloat(id));
                    } else if (contextMenu.currentElement) {
                        contextMenu.currentElement.remove();
                    }
                } else {
                    document.execCommand('delete');
                }
                contextMenu.classList.remove('active');
            });

            document.getElementById('ctxSaveAs').addEventListener('click', () => {
                const src = contextMenu.dataset.imageSrc;
                if (src && window.electronAPI) {
                    window.electronAPI.send('download-image', src);
                }
                contextMenu.classList.remove('active');
            });

            document.getElementById('ctxSelectAll').addEventListener('click', () => {
                const targetType = contextMenu.dataset.targetType;
                if (targetType === 'input') {
                    const textInput = document.getElementById('textInput');
                    const range = document.createRange();
                    range.selectNodeContents(textInput);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                } else {
                    // Select right panel content (parsedText)
                    const content = document.getElementById('parsedText');
                    if (content && content.style.display !== 'none') {
                        const range = document.createRange();
                        range.selectNodeContents(content);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }
                contextMenu.classList.remove('active');
            });

            document.getElementById('ctxPaste').addEventListener('click', async () => {
                handlePaste();
                contextMenu.classList.remove('active');
            });

            document.getElementById('ctxPastePlain').addEventListener('click', async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    document.execCommand('insertText', false, text);
                } catch (err) {
                    showToast('无法访问剪贴板', 'error');
                }
                contextMenu.classList.remove('active');
            });

            document.getElementById('ctxAddImage').addEventListener('click', () => {
                document.getElementById('fileInput').click();
                contextMenu.classList.remove('active');
            });

            // Submenu actions
            contextMenu.querySelectorAll('[data-cmd]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const cmd = item.dataset.cmd;
                    const val = item.dataset.val || null;
                    document.execCommand(cmd, false, val);
                    contextMenu.classList.remove('active');
                });
            });
        }

        // 渲染图片
        function renderImages() {
            const imagePreview = document.getElementById('imagePreview');
            
            // If we are dragging, we don't want to full re-render as it kills the drag state
            // But we need to update selection styles
            if (draggedItem) {
                const items = imagePreview.querySelectorAll('.image-preview-item');
                items.forEach(item => {
                    const id = parseFloat(item.dataset.id);
                    if (selectedImages.has(id)) item.classList.add('selected');
                    else item.classList.remove('selected');
                });
                return;
            }

            imagePreview.innerHTML = '';
            uploadedImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                if (selectedImages.has(image.id)) {
                    item.classList.add('selected');
                }
                item.draggable = true;
                item.dataset.id = image.id;
                item.dataset.index = index;

                item.innerHTML = `
                    <img src="${image.url}" alt="${image.name}">
                    <button class="image-delete-btn" data-id="${image.id}">×</button>
                `;
                
                // Click to select
                item.addEventListener('click', function(e) {
                    if (e.target.classList.contains('image-delete-btn')) return;
                    
                    // Hide tooltip if active
                    hideTooltip();
                    
                    // Stop propagation to prevent document click handler from clearing selection
                    e.stopPropagation();

                    if (e.ctrlKey || e.metaKey) {
                        if (selectedImages.has(image.id)) selectedImages.delete(image.id);
                        else selectedImages.add(image.id);
                        renderImages();
                    } else {
                        selectedImages.clear();
                        selectedImages.add(image.id);
                        renderImages();
                        showImageModal(image.url);
                    }
                });
                
                item.querySelector('.image-delete-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteImage(image.id);
                });

                // Drag events
                item.addEventListener('dragstart', function(e) {
                    draggedItem = image;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', image.id);
                    
                    // Select if not selected
                    if (!selectedImages.has(image.id)) {
                        selectedImages.clear();
                        selectedImages.add(image.id);
                        // Update styles manually to avoid re-render
                        document.querySelectorAll('.image-preview-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                    }

                    // Create placeholder immediately
                    setTimeout(() => {
                        item.style.display = 'none';
                        createPlaceholder(index);
                    }, 0);
                });

                item.addEventListener('dragend', function() {
                    draggedItem = null;
                    item.classList.remove('dragging');
                    item.style.display = '';
                    removePlaceholder();
                    renderImages(); // Re-render to ensure clean state
                });

                imagePreview.appendChild(item);
            });
            updateEditorStats();
        }

        // Placeholder helpers
        function createPlaceholder(index) {
            const imagePreview = document.getElementById('imagePreview');
            let placeholder = document.getElementById('dragPlaceholder');
            if (!placeholder) {
                placeholder = document.createElement('div');
                placeholder.id = 'dragPlaceholder';
                placeholder.className = 'image-placeholder';
            }
            
            const items = Array.from(imagePreview.children).filter(el => el.style.display !== 'none');
            if (index < items.length) {
                imagePreview.insertBefore(placeholder, items[index]);
            } else {
                imagePreview.appendChild(placeholder);
            }
        }

        function removePlaceholder() {
            const placeholder = document.getElementById('dragPlaceholder');
            if (placeholder) placeholder.remove();
        }

        // 粘贴处理逻辑
        async function handlePaste() {
            // 优先使用 Electron API 触发系统粘贴，这样可以利用 document 的 paste 事件处理文件
            if (window.electronAPI) {
                window.electronAPI.send('perform-paste');
                return;
            }

            // 降级处理：尝试使用 execCommand
            document.getElementById('textInput').focus();
            const success = document.execCommand('paste');
            if (success) return;

            // 如果 execCommand 失败，尝试使用 Clipboard API (仅支持文本和截图，不支持文件系统文件)
            if (!navigator.clipboard || !window.ClipboardItem) {
                showToast('当前浏览器不支持剪贴板API', 'error');
                return;
            }

            try {
                const items = await navigator.clipboard.read();
                let hasHandled = false;

                for (const item of items) {
                    // 1. 优先处理图片
                    const imageType = item.types.find(type => type.startsWith('image/'));
                    if (imageType) {
                        if (uploadedImages.length >= maxImages) {
                            showToast(`最多只能上传${maxImages}张图片`, 'warning');
                            return;
                        }
                        
                        const blob = await item.getType(imageType);
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const imageData = {
                                id: Date.now() + Math.random(),
                                url: e.target.result,
                                name: '剪贴板图片'
                            };
                            uploadedImages.push(imageData);
                            renderImages();
                            showToast('剪贴板图片已上传', 'success');
                        };
                        reader.readAsDataURL(blob);
                        hasHandled = true;
                        break;
                    }
                    
                    // 2. 优先处理纯文本 (避免 HTML 格式破坏)
                    if (item.types.includes('text/plain')) {
                        const blob = await item.getType('text/plain');
                        const text = await blob.text();
                        document.execCommand('insertText', false, text);
                        hasHandled = true;
                        break;
                    }
                }

                if (!hasHandled) {
                    showToast('剪贴板中没有可粘贴的图片或文本', 'warning');
                }

            } catch (err) {
                console.error(err);
                // 降级处理：尝试直接读取文本
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        document.execCommand('insertText', false, text);
                    } else {
                        showToast('无法访问剪贴板内容', 'error');
                    }
                } catch (e) {
                    showToast('无法访问剪贴板', 'error');
                }
            }
        }

        // 删除图片
        function deleteImage(id) {
            uploadedImages = uploadedImages.filter(img => img.id !== id);
            selectedImages.delete(id);
            renderImages();
            showToast('图片已删除', 'success');
        }

        // 图片上传
        function initImageUpload() {
            const leftPanel = document.getElementById('leftPanel');
            const fileInput = document.getElementById('fileInput');
            const imagePreview = document.getElementById('imagePreview');
            const imageBtn = document.getElementById('imageBtn');

            // Container Drag Events for Reordering
            imagePreview.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (!draggedItem) return;

                const placeholder = document.getElementById('dragPlaceholder');
                if (!placeholder) return;

                // Get all items except placeholder and hidden dragged item
                const items = Array.from(imagePreview.children).filter(el => 
                    el !== placeholder && el.style.display !== 'none' && el.classList.contains('image-preview-item')
                );
                
                // Find the element under cursor
                const target = e.target.closest('.image-preview-item');
                
                if (target && target !== placeholder && target.style.display !== 'none') {
                    const box = target.getBoundingClientRect();
                    const next = (e.clientX - box.left) > (box.width / 2);
                    
                    if (next) {
                        imagePreview.insertBefore(placeholder, target.nextSibling);
                    } else {
                        imagePreview.insertBefore(placeholder, target);
                    }
                } else if (items.length === 0) {
                    imagePreview.appendChild(placeholder);
                } else {
                    // If not over any item, check if we are at the end
                    const lastItem = items[items.length - 1];
                    const lastBox = lastItem.getBoundingClientRect();
                    if (e.clientY > lastBox.bottom || (e.clientY > lastBox.top && e.clientX > lastBox.right)) {
                        imagePreview.appendChild(placeholder);
                    }
                }
            });

            imagePreview.addEventListener('drop', function(e) {
                e.preventDefault();
                if (!draggedItem) return;
                
                const placeholder = document.getElementById('dragPlaceholder');
                if (placeholder) {
                    // Reconstruct uploadedImages based on DOM order
                    const newOrder = [];
                    const allChildren = Array.from(imagePreview.children);
                    
                    allChildren.forEach(child => {
                        if (child === placeholder) {
                            newOrder.push(draggedItem);
                        } else if (child.classList.contains('image-preview-item') && child.style.display !== 'none') {
                            const id = parseFloat(child.dataset.id);
                            const img = uploadedImages.find(i => i.id === id);
                            if (img) newOrder.push(img);
                        }
                    });
                    
                    uploadedImages = newOrder;
                }
                // dragend will handle cleanup
            });

            // 图片按钮点击
            imageBtn.addEventListener('click', function() {
                if (uploadedImages.length >= maxImages) {
                    showToast(`最多只能上传${maxImages}张图片`, 'warning');
                    return;
                }
                fileInput.click();
            });

            // 文件选择
            fileInput.addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });

            // 拖拽上传 - 绑定到左侧面板
            const dragOverlay = document.getElementById('dragOverlay');
            leftPanel.addEventListener('dragover', function(e) {
                e.preventDefault();
                // If dragging an internal item, don't show overlay
                if (draggedItem) return;

                // 检查是否为文件或图片链接
                let isFile = false;
                let isImage = false;
                
                if (e.dataTransfer.types) {
                    const types = Array.from(e.dataTransfer.types);
                    if (types.includes('Files')) isFile = true;
                    if (types.includes('text/uri-list')) isImage = true;
                }

                // 进一步检查文件类型
                let hasNonImageFile = false;
                if (e.dataTransfer.items) {
                    for (let i = 0; i < e.dataTransfer.items.length; i++) {
                        const item = e.dataTransfer.items[i];
                        const t = item.type || '';
                        if (t.startsWith('image/')) {
                            isImage = true;
                        } else if (item.kind === 'file' && t) {
                            hasNonImageFile = true;
                        }
                    }
                }

                // 如果既不是文件也不是图片链接（例如纯文本），则不显示遮罩
                if (!isFile && !isImage) {
                    dragOverlay.classList.remove('active');
                    return;
                }

                dragOverlay.classList.add('active');
                dragOverlay.classList.remove('error', 'success', 'full');
                
                if (!isImage && hasNonImageFile) {
                    dragOverlay.classList.add('error');
                    dragOverlay.textContent = '不支持的内容';
                } else if (uploadedImages.length >= maxImages) {
                    dragOverlay.classList.add('full');
                    dragOverlay.textContent = '最多只能上传4张图片';
                } else if (isImage || isFile) {
                    dragOverlay.classList.add('success');
                    dragOverlay.textContent = '拖入图片以添加';
                } else {
                    dragOverlay.classList.add('error');
                    dragOverlay.textContent = '不支持的内容';
                }
            });
            leftPanel.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dragOverlay.classList.remove('active', 'error', 'success', 'full');
                dragOverlay.textContent = '拖入图片以添加';
            });
            leftPanel.addEventListener('drop', function(e) {
                e.preventDefault();
                // If dragging internal item, handle reorder
                if (draggedItem) {
                    return;
                }

                dragOverlay.classList.remove('active', 'error', 'success', 'full');
                
                // 优先处理文件
                if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    const hasImage = Array.from(e.dataTransfer.files).some(f => f.type.startsWith('image/'));
                    if (!hasImage) {
                        showToast('不支持的内容', 'error');
                        return;
                    }

                    if (uploadedImages.length >= maxImages) {
                        showToast(`最多只能上传${maxImages}张图片`, 'warning');
                        return;
                    }
                    handleFiles(e.dataTransfer.files);
                    return;
                }

                // 处理 URL
                let url = '';
                try {
                    if (e.dataTransfer) {
                        // 优先使用 uri-list
                        url = e.dataTransfer.getData('text/uri-list');
                        
                        // 如果没有 uri-list，检查 text/plain 是否像 URL
                        if (!url) {
                            const text = e.dataTransfer.getData('text/plain');
                            // 简单的 URL 校验，避免普通文本被误认
                            if (text && (text.startsWith('http://') || text.startsWith('https://') || text.startsWith('data:image'))) {
                                url = text;
                            }
                        }
                    }
                } catch (err) {
                    url = '';
                }

                if (url) {
                    if (uploadedImages.length >= maxImages) {
                        showToast(`最多只能上传${maxImages}张图片`, 'warning');
                        return;
                    }
                    // 简单判断是否为图片链接
                    const lower = url.toLowerCase();
                    const isLikelyImage = lower.startsWith('data:') || /(\.png|\.jpe?g|\.gif|\.webp|\.bmp|\.svg)(\?.*)?$/.test(lower) || /^https?:\/\/.+\.(png|jpe?g|gif|webp|bmp|svg)(\?.*)?$/i.test(url);
                    
                    const imagePreview = document.getElementById('imagePreview');
                    const nameFromUrl = url.split('/').pop().split('?')[0];
                    const imageData = {
                        id: Date.now() + Math.random(),
                        url: url,
                        name: nameFromUrl || '远程图片'
                    };
                    // 如果不是显然为图片，也允许加入（浏览器会根据 src 显示或失败）
                    uploadedImages.push(imageData);
                    // 使用已有渲染函数更新 UI
                    renderImages();
                    showToast('图片已从右侧添加', 'success');
                    return;
                }

                showToast('无可用图片或不支持的拖放内容', 'error');
            });

            // 粘贴上传
            document.addEventListener('paste', function(e) {
                let hasHandled = false;

                // 1. 优先检查 files 列表（支持从文件管理器复制的文件）
                if (e.clipboardData.files && e.clipboardData.files.length > 0) {
                    const imageFiles = Array.from(e.clipboardData.files).filter(file => file.type.startsWith('image/'));
                    if (imageFiles.length > 0) {
                        e.preventDefault();
                        handleFiles(imageFiles);
                        hasHandled = true;
                    }
                }

                // 2. 检查 items（支持截图等）
                if (!hasHandled) {
                    const items = e.clipboardData.items;
                    for (let item of items) {
                        if (item.type.indexOf('image') !== -1) {
                            e.preventDefault();
                            const file = item.getAsFile();
                            if (file) {
                                handleFiles([file]);
                                hasHandled = true;
                            }
                            break;
                        }
                    }
                }

                // 3. 如果焦点不在输入框，尝试处理纯文本
                if (!hasHandled && document.activeElement !== document.getElementById('textInput')) {
                    const text = e.clipboardData.getData('text/plain');
                    if (text) {
                        e.preventDefault();
                        const textInput = document.getElementById('textInput');
                        textInput.focus();
                        document.execCommand('insertText', false, text);
                        hasHandled = true;
                    }
                }

                if (!hasHandled) {
                    showToast('剪贴板中没有可粘贴的图片或文本', 'warning');
                }
            });

            // 处理文件
            function handleFiles(files) {
                // 新增：只允许添加剩余数量的图片
                const remain = maxImages - uploadedImages.length;
                if (remain <= 0) {
                    showToast(`最多只能上传${maxImages}张图片`, 'warning');
                    return;
                }
                let addedCount = 0;
                let validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                // 只取剩余数量的图片
                validFiles = validFiles.slice(0, remain);
                validFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            id: Date.now() + Math.random(),
                            url: e.target.result,
                            name: file.name
                        };
                        uploadedImages.push(imageData);
                        renderImages();
                        showToast('图片上传成功', 'success');
                    };
                    reader.readAsDataURL(file);
                    addedCount++;
                });
                if (files.length > 0 && addedCount === 0) {
                    showToast('不支持的内容', 'error');
                }
            }

            // Context Menu
            imagePreview.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                const item = e.target.closest('.image-preview-item');
                if (item) {
                    const id = parseFloat(item.dataset.id);
                    // If right clicking an item not in selection, select it (and deselect others)
                    if (!selectedImages.has(id)) {
                        selectedImages.clear();
                        selectedImages.add(id);
                        renderImages();
                    }
                    
                    // const image = uploadedImages.find(img => img.id === id);
                    // if (image && window.electronAPI) {
                    //     window.electronAPI.send('show-image-context-menu', { src: image.url, type: 'left-side' });
                    // }
                }
            });

            // Right side images context menu
            const parsedImages = document.getElementById('parsedImages');
            if (parsedImages) {
                parsedImages.addEventListener('contextmenu', function(e) {
                    const item = e.target.closest('.parsed-image-item');
                    if (item) {
                        e.preventDefault();
                        // e.stopPropagation(); // 阻止冒泡，防止触发全局图片右键菜单
                        // const img = item.querySelector('img');
                        // if (img && window.electronAPI) {
                        //     window.electronAPI.send('show-image-context-menu', { src: img.src, type: 'right-side' });
                        // }
                    }
                });
            }

            // IPC Listener for delete
            if (window.electronAPI) {
                window.electronAPI.on('menu-action-delete-selected', () => {
                    if (selectedImages.size > 0) {
                        uploadedImages = uploadedImages.filter(img => !selectedImages.has(img.id));
                        selectedImages.clear();
                        renderImages();
                        showToast('已删除选中图片', 'success');
                    }
                });
                
                window.electronAPI.on('menu-action-paste', () => {
                    handlePaste();
                });
            }
        }

        // 自定义弹窗逻辑
        function showCustomModal(options) {
            if (typeof options === 'function') {
                options = {
                    onConfirm: options,
                    onCancel: arguments[1],
                    title: '确认操作',
                    message: '确定要清空所有内容吗？',
                    confirmText: '确定',
                    cancelText: '取消'
                };
            }

            const modal = document.getElementById('customModal');
            const titleEl = modal.querySelector('.custom-modal-title');
            const messageEl = modal.querySelector('.custom-modal-message');
            const confirmBtn = document.getElementById('modalConfirm');
            const cancelBtn = document.getElementById('modalCancel');
            
            // 查找或创建第三个按钮
            let optionBtn = document.getElementById('modalOption');
            if (!optionBtn) {
                optionBtn = document.createElement('button');
                optionBtn.id = 'modalOption';
                optionBtn.className = 'custom-modal-btn secondary';
                optionBtn.style.display = 'none';
                confirmBtn.parentNode.insertBefore(optionBtn, confirmBtn);
            }

            titleEl.textContent = options.title || '确认操作';
            messageEl.textContent = options.message || '确定要清空所有内容吗？';
            confirmBtn.textContent = options.confirmText || '确定';
            cancelBtn.textContent = options.cancelText || '取消';

            if (options.optionText) {
                optionBtn.textContent = options.optionText;
                optionBtn.style.display = 'inline-block';
                optionBtn.onclick = function() {
                    modal.classList.remove('active');
                    if (options.onOption) options.onOption();
                };
            } else {
                optionBtn.style.display = 'none';
            }

            modal.classList.add('active');
            
            // 解绑旧事件
            confirmBtn.onclick = function() {
                modal.classList.remove('active');
                if (options.onConfirm) options.onConfirm();
            };
            cancelBtn.onclick = function() {
                modal.classList.remove('active');
                if (options.onCancel) options.onCancel();
            };
        }

        // 按钮功能
        function initButtons() {
            // Ripple Effect (排除更多按钮)
            document.querySelectorAll('.toolbar-btn:not(.more-menu), .detect-btn, .custom-modal-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    ripple.classList.add('ripple');
                    this.appendChild(ripple);
                    
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    
                    ripple.style.width = ripple.style.height = `${size}px`;
                    ripple.style.left = `${e.clientX - rect.left - size/2}px`;
                    ripple.style.top = `${e.clientY - rect.top - size/2}px`;
                    
                    ripple.addEventListener('animationend', () => {
                        ripple.remove();
                    });
                });
            });

            // 页面预览功能
            document.getElementById('previewBtn').addEventListener('click', function() {
                const btn = this;
                const text = document.getElementById('textInput').innerHTML; // Use innerHTML to preserve formatting
                
                if (!document.getElementById('textInput').innerText.trim() && uploadedImages.length === 0) {
                    showToast('没有可预览的内容', 'warning');
                    return;
                }

                // Disable button to prevent multiple clicks
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.pointerEvents = 'none';

                if (isURL(document.getElementById('textInput').innerText.trim())) {
                    // URL Preview
                    extractContent(document.getElementById('textInput').innerText.trim(), true);
                } else {
                    // Local Preview
                    renderPreview(text, uploadedImages);
                    showToast('已生成本地预览', 'success');
                    
                    // Re-enable after a short delay for local preview
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                    }, 500);
                }
            });

            // 清空按钮
            document.getElementById('clearBtn').addEventListener('click', function() {
                showCustomModal(() => {
                    document.getElementById('textInput').innerText = '';
                    uploadedImages = [];
                    detectedUrls = [];
                    document.getElementById('imagePreview').innerHTML = '';
                    updateEditorStats();
                    document.getElementById('initialState').style.display = 'flex';
                    const resultItem = document.getElementById('resultItem');
                    resultItem.classList.remove('active');
                    resultItem.style.display = 'none';
                    document.getElementById('errorState').classList.remove('active');
                    document.getElementById('loadingState').classList.remove('active');
                    
                    // Disable export button
                    const exportBtn = document.getElementById('exportBtn');
                    if (exportBtn) exportBtn.disabled = true;

                    showToast('内容已清空', 'success');
                });
            });

            // 检测按钮
            let lastTextContent = '';
            let lastImages = [];
            document.getElementById('detectBtn').addEventListener('click', function() {
                const textContent = document.getElementById('textInput').innerText.trim();
                const htmlContent = document.getElementById('textInput').innerHTML; // Get HTML content
                // 优先判断内容是否为空
                if (!textContent) {
                    if (uploadedImages.length > 0) {
                        showToast('请添加相关的文本内容以进行检测', 'warning');
                    } else {
                        showToast('请输入需要检测的新闻内容', 'warning');
                    }
                    return;
                }
                // 判断内容和图片是否有变化
                const imagesNow = uploadedImages.map(img => img.url).join(',');
                const imagesLast = lastImages.join(',');
                // 检查右侧是否为空（初始状态是否显示）
                const isResultEmpty = document.getElementById('initialState').style.display !== 'none';
                // 检查是否处于错误状态
                const isErrorState = document.getElementById('errorState').classList.contains('active');
                
                // 检查是否处于预览模式（评分区域被隐藏）
                const scoreSection = document.querySelector('.result-score');
                const isPreviewMode = scoreSection && scoreSection.style.display === 'none';
                
                if (textContent === lastTextContent && imagesNow === imagesLast && !isResultEmpty && !isErrorState && !isPreviewMode) {
                    showToast('内容未变化，无需重复检测', 'info');
                    return;
                }
                // 检查是否为URL
                if (isURL(textContent)) {
                    if (uploadedImages.length > 0) {
                        // 弹出询问对话框
                        showCustomModal({
                            title: '检测到链接和图片',
                            message: '您输入了链接同时也上传了图片，请选择处理方式：',
                            confirmText: '仅提取链接内容', // 对应 extractContent
                            optionText: '图文混合分析', // 对应 analyzeContent
                            cancelText: '取消',
                            onConfirm: () => {
                                window.lastExtractedUrl = textContent;
                                extractContent(textContent);
                            },
                            onOption: () => {
                                window.lastExtractedUrl = null;
                                analyzeContent(textContent, uploadedImages, false, htmlContent);
                            },
                            onCancel: () => {
                                // 取消，不做任何事
                            }
                        });
                        return;
                    }
                    
                    window.lastExtractedUrl = textContent;
                    extractContent(textContent);
                } else {
                    window.lastExtractedUrl = null;
                    analyzeContent(textContent, uploadedImages, false, htmlContent);
                }
                // 记录本次内容和图片
                lastTextContent = textContent;
                lastImages = uploadedImages.map(img => img.url);
            });
        }

        // 检查是否为URL
        function isURL(text) {
            try {
                new URL(text);
                return true;
            } catch {
                return false;
            }
        }

        // 内容提取功能
        function extractContent(url, isPreview = false) {
            const detectBtn = document.getElementById('detectBtn');
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const progressBar = document.getElementById('progressBar');
            const loadingText = document.getElementById('loadingText');
            const cancelBtn = document.getElementById('cancelExtractBtn');

            // 重置状态
            initialState.style.display = 'none';
            resultItem.classList.remove('active');
            resultItem.style.display = 'none'; // Ensure hidden during loading
            errorState.classList.remove('active');
            loadingState.classList.add('active');
            
            // 显示取消按钮
            if (cancelBtn) cancelBtn.style.display = 'block';
            
            // Disable export button
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) exportBtn.disabled = true;

            // 初始化进度条
            progressBar.style.width = '0%';
            loadingText.textContent = isPreview ? '正在解析网页以预览...' : '正在解析网页内容...';

            detectBtn.classList.add('loading');
            detectBtn.innerHTML = isPreview ? '预览中...' : '提取中...';

            // 模拟进度增长
            let progress = 10;
            const progressInterval = setInterval(() => {
                if (progress < 45) {
                    progress += 1;
                    progressBar.style.width = progress + '%';
                }
            }, 200);

            let timeoutId;
            let finished = false;
            
            // 取消处理逻辑
            function handleCancel() {
                if (finished) return;
                finished = true;
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                
                loadingState.classList.remove('active');
                detectBtn.classList.remove('loading');
                detectBtn.innerHTML = '开始检测';
                if (cancelBtn) cancelBtn.style.display = 'none';
                
                // Re-enable preview button
                const previewBtn = document.getElementById('previewBtn');
                if (previewBtn) {
                    previewBtn.disabled = false;
                    previewBtn.style.opacity = '1';
                    previewBtn.style.pointerEvents = 'auto';
                }
                
                // 恢复初始状态
                initialState.style.display = 'flex';
                
                showToast('用户已取消', 'info');
            }

            // 绑定取消按钮事件
            if (cancelBtn) {
                cancelBtn.onclick = function() {
                    if (finished) return;
                    if (window.electronAPI) {
                        window.electronAPI.send('cancel-extraction');
                    } else {
                        handleCancel();
                    }
                };
            }

            // 超时处理函数
            function handleTimeout() {
                if (finished) return;
                finished = true;
                clearInterval(progressInterval);
                loadingState.classList.remove('active');
                detectBtn.classList.remove('loading');
                detectBtn.innerHTML = '开始检测';
                if (cancelBtn) cancelBtn.style.display = 'none';
                showError('网页内容提取超时，请稍后重试');
                showToast('提取失败：超时', 'error');
            }
            timeoutId = setTimeout(handleTimeout, 10000);

            // 调用主进程的内容提取功能
            if (window.electronAPI) {
                window.electronAPI.send('extract-content', url);
                
                // 监听一次性结果（防止多次触发）
                const handler = function(event, result) {
                    if (finished) return;
                    finished = true;
                    clearTimeout(timeoutId);
                    clearInterval(progressInterval);
                    if (cancelBtn) cancelBtn.style.display = 'none';
                    
                    // Re-enable preview button if it was a preview
                    const previewBtn = document.getElementById('previewBtn');
                    if (previewBtn) {
                        previewBtn.disabled = false;
                        previewBtn.style.opacity = '1';
                        previewBtn.style.pointerEvents = 'auto';
                    }
                    
                    if (result.success) {
                        if (isPreview) {
                            progressBar.style.width = '100%';
                            loadingState.classList.remove('active');
                            detectBtn.classList.remove('loading');
                            detectBtn.innerHTML = '开始检测';
                            renderPreview(result.content, result.images, result.title);
                            showToast('网页预览已生成', 'success');
                        } else {
                            // 提取成功，进度设为50%
                            progressBar.style.width = '50%';
                            loadingText.textContent = '正在分析新闻中...';
                            
                            // showExtractedResult(result);
                            showToast('提取完成，正在进行AI分析...', 'success');
                            // 传递 true 表示从提取流程进入
                            // 优先使用纯文本进行分析，如果没有则使用HTML内容
                            analyzeContent(result.textContent || result.content, result.images, true);
                        }
                    } else {
                        if (result.error === '提取已取消') return; // 由 cancelled 事件处理
                        
                        detectBtn.classList.remove('loading');
                        detectBtn.innerHTML = '开始检测';
                        showError(result.error);
                        showToast('提取失败: ' + result.error, 'error');
                    }
                    window.electronAPI.off && window.electronAPI.off('extract-content-result', handler);
                    window.electronAPI.off && window.electronAPI.off('extraction-cancelled', cancelListener);
                };
                
                const cancelListener = function() {
                    handleCancel();
                    window.electronAPI.off && window.electronAPI.off('extract-content-result', handler);
                    window.electronAPI.off && window.electronAPI.off('extraction-cancelled', cancelListener);
                };

                // 兼容性：如无off方法则不解绑
                window.electronAPI.on('extract-content-result', handler);
                window.electronAPI.once('extraction-cancelled', cancelListener);
            } else {
                // 模拟提取结果
                setTimeout(() => {
                    if (finished) return;
                    finished = true;
                    clearTimeout(timeoutId);
                    clearInterval(progressInterval);
                    if (cancelBtn) cancelBtn.style.display = 'none';
                    
                    // Re-enable preview button
                    const previewBtn = document.getElementById('previewBtn');
                    if (previewBtn) {
                        previewBtn.disabled = false;
                        previewBtn.style.opacity = '1';
                        previewBtn.style.pointerEvents = 'auto';
                    }
                    
                    // 模拟数据
                    const mockResult = {
                        success: true,
                        title: '示例新闻标题',
                        content: '这是一个模拟的新闻内容提取结果。这里会显示从网页解析出来的正文内容。',
                        images: ['https://via.placeholder.com/300'],
                        url: url
                    };
                    
                    if (isPreview) {
                        progressBar.style.width = '100%';
                        loadingState.classList.remove('active');
                        detectBtn.classList.remove('loading');
                        detectBtn.innerHTML = '开始检测';
                        renderPreview(mockResult.content, mockResult.images, mockResult.title);
                        showToast('网页预览已生成', 'success');
                    } else {
                        progressBar.style.width = '50%';
                        loadingText.textContent = '正在分析新闻中...';
                        
                        showToast('提取完成', 'success');
                        analyzeContent(mockResult.content, mockResult.images, true);
                    }
                }, 2000);
            }
        }

        // 渲染预览内容（隐藏评分和观点）
        function renderPreview(text, images, title = null) {
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            // Hide Score and Analysis
            const scoreSection = resultItem.querySelector('.result-score');
            const analysisSection = resultItem.querySelector('.result-analysis');
            if(scoreSection) scoreSection.style.display = 'none';
            if(analysisSection) analysisSection.style.display = 'none';

            // Show Content
            parsedContent.style.display = 'block';
            
            // Enable export button
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) exportBtn.disabled = false;

            parsedTitle.textContent = title || '';
            parsedTitle.style.display = title ? 'block' : 'none';
            parsedText.innerHTML = text || ''; // Use innerHTML
            parsedText.classList.add('is-html'); // Add class for HTML content
            
            // Render Images
            parsedImages.innerHTML = '';
            let imagesToRender = [];
            if (images && images.length > 0) {
                 const limitedImages = images.slice(0, 4);
                 imagesToRender = limitedImages.map(img => typeof img === 'string' ? {url: img, name: 'Image'} : img);
            }
            
            if (imagesToRender.length > 0) {
                const container = document.createElement('div');
                container.className = 'parsed-images';
                
                imagesToRender.forEach(img => {
                    const item = document.createElement('div');
                    item.className = 'parsed-image-item';
                    item.innerHTML = `<img src="${img.url}" alt="${img.name}">`;
                    item.addEventListener('click', () => showImageModal(img.url));
                    container.appendChild(item);
                });
                parsedImages.appendChild(container);
            }
            
            initialState.style.display = 'none';
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            if (loadingState) loadingState.classList.remove('active');
            if (errorState) errorState.classList.remove('active');
            
            resultItem.classList.add('active');
            resultItem.style.display = 'block'; // Ensure visible
        }

        // 初始化导出功能
        function initExport() {
            // Export Button
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportResult);
            }

            // Context Menu
            const rightPanel = document.getElementById('rightPanel');
            const resultContextMenu = document.getElementById('resultContextMenu');
            const ctxExportResult = document.getElementById('ctxExportResult');
            const ctxResultCopy = document.getElementById('ctxResultCopy');
            const ctxResultSelectAll = document.getElementById('ctxResultSelectAll');
            const ctxResultSearch = document.getElementById('ctxResultSearch');
            const ctxResultGoTo = document.getElementById('ctxResultGoTo');
            const ctxResultSearchSep = document.getElementById('ctxResultSearchSep');

            if (rightPanel && resultContextMenu) {
                // Use capture phase to intercept event before it bubbles up or is handled by others
                rightPanel.addEventListener('contextmenu', function(e) {
                    const resultItem = document.getElementById('resultItem');
                    const isResultActive = resultItem && resultItem.classList.contains('active');
                    const isFullscreen = document.body.classList.contains('detection-fullscreen');
                    
                    // Show menu if result is active OR if in fullscreen mode (even if showing initial state)
                    if (isResultActive || isFullscreen) {
                        // 如果是图片，不拦截，让全局右键菜单处理（显示图片相关菜单）
                        if (e.target.tagName === 'IMG') {
                            return;
                        }

                        e.preventDefault();
                        e.stopPropagation(); // Stop propagation
                        
                        // Position menu
                        let x = e.clientX;
                        let y = e.clientY;
                        
                        // Measure height
                        resultContextMenu.style.visibility = 'hidden';
                        resultContextMenu.classList.add('active');
                        const menuWidth = resultContextMenu.offsetWidth;
                        const menuHeight = resultContextMenu.offsetHeight;
                        resultContextMenu.classList.remove('active');
                        resultContextMenu.style.visibility = 'visible';
                        
                        const winWidth = window.innerWidth;
                        const winHeight = window.innerHeight;
                        
                        // Adjust X
                        if (x + menuWidth > winWidth) {
                            x = winWidth - menuWidth - 5;
                        }
                        
                        // Adjust Y
                        if (y + menuHeight > winHeight) {
                            y = winHeight - menuHeight - 5;
                        }
                        
                        // Avoid overlapping with custom title bar
                        if (y < 35) y = 35;

                        // Check for selection to toggle Copy/Search/GoTo options
                        const selection = window.getSelection();
                        const selectedText = selection.toString().trim();
                        const hasSelection = selectedText.length > 0;
                        const isUrl = selectedText && /^(http|https):\/\/[^ "]+$/.test(selectedText);

                        if (ctxResultCopy) {
                            ctxResultCopy.style.display = hasSelection ? 'flex' : 'none';
                        }

                        // Search & GoTo Logic

                        if (hasSelection) {
                            // 最多显示8个字，超出用省略号
                            const displayContent = selectedText.length > 8 ? selectedText.substring(0, 8) + '...' : selectedText;
                            if (ctxResultSearch) {
                                ctxResultSearch.style.display = 'flex';
                                const hint = document.getElementById('ctxResultSearchText');
                                if (hint) hint.textContent = displayContent;
                            }
                            if (ctxResultGoTo) {
                                if (isUrl) {
                                    ctxResultGoTo.style.display = 'flex';
                                    const hint = document.getElementById('ctxResultGoToUrl');
                                    if (hint) hint.textContent = displayContent;
                                } else {
                                    ctxResultGoTo.style.display = 'none';
                                }
                            }
                            if (ctxResultSearchSep) ctxResultSearchSep.style.display = 'block';
                        } else {
                            if (ctxResultSearch) ctxResultSearch.style.display = 'none';
                            if (ctxResultGoTo) ctxResultGoTo.style.display = 'none';
                            if (ctxResultSearchSep) ctxResultSearchSep.style.display = 'none';
                        }

                        resultContextMenu.style.left = `${x}px`;
                        resultContextMenu.style.top = `${y}px`;
                        resultContextMenu.classList.add('active');
                        
                        // Close other menus
                        const editContextMenu = document.getElementById('editContextMenu');
                        if (editContextMenu) editContextMenu.classList.remove('active');
                    }
                }, true); // Capture phase
            }

            if (ctxResultSearch) {
                ctxResultSearch.addEventListener('click', () => {
                    const text = window.getSelection().toString().trim();
                    if (text) {
                        const url = `https://www.bing.com/search?q=${encodeURIComponent(text)}`;
                        const useSystemBrowser = localStorage.getItem('useSystemBrowser') === 'true';
                        
                        if (useSystemBrowser && window.electronAPI && window.electronAPI.openExternal) {
                            window.electronAPI.openExternal(url);
                        } else {
                            window.open(url, '_blank');
                        }
                    }
                    if (resultContextMenu) resultContextMenu.classList.remove('active');
                });
            }

            if (ctxResultGoTo) {
                ctxResultGoTo.addEventListener('click', () => {
                    const text = window.getSelection().toString().trim();
                    if (text) {
                        const useSystemBrowser = localStorage.getItem('useSystemBrowser') === 'true';
                        if (useSystemBrowser && window.electronAPI && window.electronAPI.openExternal) {
                            window.electronAPI.openExternal(text);
                        } else {
                            window.open(text, '_blank');
                        }
                    }
                    if (resultContextMenu) resultContextMenu.classList.remove('active');
                });
            }

            if (ctxExportResult) {
                ctxExportResult.addEventListener('click', function() {
                    exportResult();
                    if (resultContextMenu) resultContextMenu.classList.remove('active');
                });
            }

            if (ctxResultCopy) {
                ctxResultCopy.addEventListener('click', function() {
                    document.execCommand('copy');
                    if (resultContextMenu) resultContextMenu.classList.remove('active');
                });
            }

            if (ctxResultSelectAll) {
                ctxResultSelectAll.addEventListener('click', function() {
                    const parsedText = document.getElementById('parsedText');
                    if (parsedText) {
                        const range = document.createRange();
                        range.selectNodeContents(parsedText);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                    if (resultContextMenu) resultContextMenu.classList.remove('active');
                });
            }

            // Close menu on click
            document.addEventListener('click', function(e) {
                if (resultContextMenu && resultContextMenu.classList.contains('active')) {
                    resultContextMenu.classList.remove('active');
                }
            });
        }

        async function exportResult() {
             const resultItem = document.getElementById('resultItem');
            if (!resultItem || !resultItem.classList.contains('active')) {
                showToast('暂无检测结果可导出', 'warning');
                return;
            }
            
            showToast('正在准备导出...', 'info');

            // Clone the result item to modify it for export if needed
            const clone = resultItem.cloneNode(true);
            
            // Remove export button from clone
            const exportBtnInClone = clone.querySelector('#exportBtn');
            if (exportBtnInClone) {
                exportBtnInClone.remove();
            }
            
            // Convert images to Base64 to ensure they display correctly in exported file
            if (window.electronAPI) {
                const images = clone.querySelectorAll('img');
                for (let img of images) {
                    try {
                        const src = img.src;
                        // Skip if already base64 or empty
                        if (src && !src.startsWith('data:')) {
                            const response = await window.electronAPI.invoke('convert-image-to-base64', src);
                            if (response.success) {
                                img.src = response.data;
                            } else {
                                console.warn('Image conversion failed:', response.error);
                            }
                        }
                    } catch (e) {
                        console.error('Failed to convert image:', e);
                    }
                }
            }
            
            // Get styles
            let styles = '';
            document.querySelectorAll('style').forEach(style => {
                styles += style.outerHTML;
            });
            
            // Construct HTML
            const html = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>检测报告</title>
    ${styles}
    <style>
        body { 
            background: var(--bg-primary); 
            padding: 40px; 
            height: auto; 
            overflow: visible;
            animation: none !important;
            transform: none !important;
        }
        .container { 
            display: block; 
            height: auto; 
        }
        .right-panel { 
            width: 100%; 
            max-width: 800px; 
            margin: 0 auto; 
            background: transparent; 
            display: block;
        }
        .result-content {
            padding: 0;
            overflow: visible;
        }
        .result-item {
            display: block !important;
            opacity: 1 !important;
            transform: none !important;
            animation: none !important;
        }
        .result-title {
            font-size: 32px !important;
            margin-bottom: 20px !important;
            text-align: center !important;
        }
        /* Hide scrollbars in export */
        ::-webkit-scrollbar { display: none; }
        html { overflow: auto !important; height: auto !important; }
        
        /* Ensure modal is hidden by default */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        .image-modal.active {
            display: flex;
        }
        .modal-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .modal-close {
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: none;
            border: none;
            z-index: 10002;
        }
        
        /* Tooltip styles */
        .custom-tooltip {
            position: absolute !important;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            max-width: 300px;
            z-index: 10001;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            display: none;
        }
        .custom-tooltip.active {
            opacity: 1;
            display: block;
        }
        .fake-highlight {
            cursor: pointer;
            position: relative;
        }
        .fake-highlight.active {
            background-color: rgba(231, 29, 54, 0.3); /* Darker highlight when active */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="right-panel">
            <div class="result-header" style="justify-content: center; margin-bottom: 20px;">
                <h2 class="result-title">检测结果报告</h2>
            </div>
            <div class="result-content">
                ${clone.outerHTML}
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal">
        <button class="modal-close" id="modalClose">×</button>
        <img class="modal-image" id="modalImage" src="" alt="预览图片">
    </div>

    <!-- Tooltip -->
    <div id="customTooltip" class="custom-tooltip"></div>

    <script>
        // Image Modal Logic
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalClose = document.getElementById('modalClose');

        function showImageModal(url) {
            modalImage.src = url;
            modal.classList.add('active');
        }

        if (modalClose) {
            modalClose.addEventListener('click', () => {
                modal.classList.remove('active');
            });
        }

        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        }

        // Re-bind click events to images
        document.querySelectorAll('.parsed-image-item img').forEach(img => {
            img.style.cursor = 'pointer';
            img.onclick = function() {
                showImageModal(this.src);
            };
        });

        // Tooltip Logic
        let activeTooltipElement = null;
        let tooltipUpdateRaf = null;

        function updateTooltipPosition() {
            const tooltip = document.getElementById('customTooltip');
            if (!tooltip || !tooltip.classList.contains('active') || !activeTooltipElement) return;

            const rect = activeTooltipElement.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            const scrollX = window.scrollX || window.pageXOffset;
            const scrollY = window.scrollY || window.pageYOffset;

            let top = rect.bottom + scrollY + 10;
            let left = rect.left + scrollX + (rect.width / 2) - (tooltipRect.width / 2);

            const padding = 16;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            if (left < scrollX + padding) {
                left = scrollX + padding;
            } else if (left + tooltipRect.width > scrollX + viewportWidth - padding) {
                left = scrollX + viewportWidth - tooltipRect.width - padding;
            }
            
            if (rect.bottom + 10 + tooltipRect.height > viewportHeight - padding) {
                top = rect.top + scrollY - tooltipRect.height - 10;
            }

            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
        }

        // Expose to global scope for onclick attribute
        window.showReasonTooltip = function(event, element) {
            event.stopPropagation();
            
            if (activeTooltipElement) {
                activeTooltipElement.classList.remove('active');
            }

            const reason = element.getAttribute('data-reason');
            if (!reason) return;

            activeTooltipElement = element;
            activeTooltipElement.classList.add('active');

            const tooltip = document.getElementById('customTooltip');
            tooltip.textContent = reason;
            tooltip.classList.add('active');

            updateTooltipPosition();
        };

        function hideTooltip() {
            const tooltip = document.getElementById('customTooltip');
            if (tooltip) {
                tooltip.classList.remove('active');
            }
            if (activeTooltipElement) {
                activeTooltipElement.classList.remove('active');
                activeTooltipElement = null;
            }
        }

        document.addEventListener('click', function(e) {
            const tooltip = document.getElementById('customTooltip');
            if (tooltip && tooltip.contains(e.target)) return;
            if (e.target.classList.contains('fake-highlight')) return;
            hideTooltip();
        });

        window.addEventListener('scroll', function() {
            if (activeTooltipElement) {
                if (tooltipUpdateRaf) cancelAnimationFrame(tooltipUpdateRaf);
                tooltipUpdateRaf = requestAnimationFrame(updateTooltipPosition);
            }
        }, true);

        window.addEventListener('resize', function() {
            if (activeTooltipElement) {
                updateTooltipPosition();
            }
        });
    <\/script>
</body>
</html>`;

            if (window.electronAPI) {
                window.electronAPI.invoke('export-result', html).then(res => {
                    if (res.success) {
                        showToast('导出成功', 'success');
                    } else if (res.error !== '已取消导出') {
                        showToast('导出失败: ' + res.error, 'error');
                    }
                });
            } else {
                console.log(html);
                showToast('导出功能仅在客户端可用', 'warning');
            }
        }

        // 初始化IPC通信
        function initIPC() {
            if (window.electronAPI) {
                // 监听内容提取结果 - 已移至 extractContent 函数中单独处理，避免冲突
                /*
                window.electronAPI.on('extract-content-result', function(event, result) {
                    const detectBtn = document.getElementById('detectBtn');
                    detectBtn.classList.remove('loading');
                    detectBtn.innerHTML = '开始检测';

                    if (result.success) {
                        // 显示提取结果
                        showExtractedResult(result);
                        showToast('提取完成', 'success');
                    } else {
                        showError(result.error);
                        showToast('提取失败: ' + result.error, 'error');
                    }
                });
                */

                // 监听导出操作
                window.electronAPI.on('menu-action-export', function() {
                    exportResult();
                });

                // 监听清除内容（直接清空）事件，保留以兼容旧逻辑
                window.electronAPI.on('clear-results', function() {
                    document.getElementById('initialState').style.display = 'flex';
                    document.getElementById('resultItem').classList.remove('active');
                    document.getElementById('errorState').classList.remove('active');
                    document.getElementById('loadingState').classList.remove('active');
                    
                    // Disable export button
                    const exportBtn = document.getElementById('exportBtn');
                    if (exportBtn) exportBtn.disabled = true;
                });

                // 监听主进程请求显示清空确认弹窗（来自右键菜单）
                window.electronAPI.on('request-clear', function() {
                    showCustomModal(() => {
                        // 确认后执行同样的清空逻辑
                        document.getElementById('textInput').innerText = '';
                        uploadedImages = [];
                        detectedUrls = [];
                        document.getElementById('imagePreview').innerHTML = '';
                        updateEditorStats();
                        document.getElementById('initialState').style.display = 'flex';
                        document.getElementById('resultItem').classList.remove('active');
                        document.getElementById('errorState').classList.remove('active');
                        document.getElementById('loadingState').classList.remove('active');
                        
                        // Disable export button
                        const exportBtn = document.getElementById('exportBtn');
                        if (exportBtn) exportBtn.disabled = true;

                        showToast('内容已清空', 'success');
                    }, () => {
                        // 取消时不作操作
                    });
                });
            }
        }

        // 显示检测结果
        function showResult() {
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            // 获取输入内容
            const textContent = document.getElementById('textInput').innerText.trim();
            
            // 随机生成分数
            const score = Math.floor(Math.random() * 40) + 20;
            const scoreText = document.getElementById('scoreText');
            const scoreValue = document.getElementById('scoreValue');
            const scoreDescription = document.getElementById('scoreDescription');
            const scoreProgress = document.getElementById('scoreProgress');
            const scoreContainer = document.getElementById('scoreCircleContainer');
            
            scoreText.textContent = score + '%';
            scoreValue.textContent = score + '%';
            
            // Reset classes
            scoreContainer.className = 'score-circle-container';
            
            if (score >= 80) {
                scoreContainer.classList.add('real');
                scoreDescription.textContent = '该内容具有较高的可信度';
            } else if (score >= 60) {
                scoreContainer.classList.add('uncertain');
                scoreDescription.textContent = '该内容存在一定的不确定性';
            } else {
                scoreContainer.classList.add('fake');
                scoreDescription.textContent = '该内容可能存在虚假信息';
            }
            
            // Animate Progress
            const circumference = 2 * Math.PI * 45; // r=45
            const offset = circumference - (score / 100) * circumference;
            scoreProgress.style.strokeDashoffset = circumference; // Reset first
            setTimeout(() => {
                scoreProgress.style.strokeDashoffset = offset;
            }, 100);
            
            // 显示输入内容
            parsedContent.style.display = 'block';
            parsedTitle.style.display = 'none'; // 纯文本输入无标题
            parsedText.textContent = textContent;
            
            // 渲染上传的图片
            parsedImages.innerHTML = '';
            if (uploadedImages.length > 0) {
                uploadedImages.forEach(img => {
                    const item = document.createElement('div');
                    item.className = 'parsed-image-item';
                    item.innerHTML = `<img src="${img.url}" alt="${img.name}">`;
                    // 允许从解析区域拖动到左侧（传递图片 URL）
                    item.setAttribute('draggable', 'true');
                    item.addEventListener('dragstart', (ev) => {
                        try {
                            ev.dataTransfer.setData('text/uri-list', img.url);
                            ev.dataTransfer.setData('text/plain', img.url);
                            ev.dataTransfer.effectAllowed = 'copy';
                        } catch (e) {}
                    });
                    item.addEventListener('click', () => showImageModal(img.url));
                    parsedImages.appendChild(item);
                });
            }
            
            initialState.style.display = 'none';
            resultItem.classList.add('active');
            
            // Enable export button
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) exportBtn.disabled = false;
        }

        // 显示提取结果
        function showExtractedResult(result) {
            const loadingState = document.getElementById('loadingState');
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            loadingState.classList.remove('active');
            
            // 更新结果显示
            const scoreText = document.getElementById('scoreText');
            const scoreValue = document.getElementById('scoreValue');
            const scoreDescription = document.getElementById('scoreDescription');
            const scoreProgress = document.getElementById('scoreProgress');
            const scoreContainer = document.getElementById('scoreCircleContainer');
            
            // 使用随机分数作为示例
            const score = Math.floor(Math.random() * 40) + 60;
            scoreText.textContent = score + '%';
            scoreValue.textContent = score + '%';
            
            // Reset classes
            scoreContainer.className = 'score-circle-container';
            
            if (score >= 80) {
                scoreContainer.classList.add('real');
                scoreDescription.textContent = '该内容具有较高的可信度';
            } else if (score >= 60) {
                scoreContainer.classList.add('uncertain');
                scoreDescription.textContent = '该内容存在一定的不确定性';
            } else {
                scoreContainer.classList.add('fake');
                scoreDescription.textContent = '该内容可能存在虚假信息';
            }
            
            // Animate Progress
            const circumference = 2 * Math.PI * 45; // r=45
            const offset = circumference - (score / 100) * circumference;
            scoreProgress.style.strokeDashoffset = circumference; // Reset first
            setTimeout(() => {
                scoreProgress.style.strokeDashoffset = offset;
            }, 100);
            
            // 显示解析内容
            parsedContent.style.display = 'block';
            parsedTitle.textContent = result.title || '无标题';
            parsedTitle.style.display = result.title ? 'block' : 'none';
            parsedText.textContent = result.content || '';
            
            // 渲染图片
            parsedImages.innerHTML = '';
            if (result.images && result.images.length > 0) {
                result.images.forEach(imgUrl => {
                    const item = document.createElement('div');
                    item.className = 'parsed-image-item';
                    item.innerHTML = `<img src="${imgUrl}" alt="解析图片">`;
                    // 允许从解析区域拖动到左侧（传递图片 URL）
                    item.setAttribute('draggable', 'true');
                    item.addEventListener('dragstart', (ev) => {
                        try {
                            ev.dataTransfer.setData('text/uri-list', imgUrl);
                            ev.dataTransfer.setData('text/plain', imgUrl);
                            ev.dataTransfer.effectAllowed = 'copy';
                        } catch (e) {}
                    });
                    item.addEventListener('click', () => showImageModal(imgUrl));
                    parsedImages.appendChild(item);
                });
            }
            
            resultItem.classList.add('active');
            resultItem.style.display = 'block'; // Ensure visible
            
            // Enable export button
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) exportBtn.disabled = false;
        }

        function showError(message) {
            const errorState = document.getElementById('errorState');
            const errorDetail = document.getElementById('errorDetail');
            const loadingState = document.getElementById('loadingState');
            const resultItem = document.getElementById('resultItem');
            const initialState = document.getElementById('initialState');
            const detectBtn = document.getElementById('detectBtn');
            
            // Disable export button
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) exportBtn.disabled = true;

            if (initialState) initialState.style.display = 'none';
            if (resultItem) resultItem.style.display = 'none';
            loadingState.classList.remove('active');
            detectBtn.classList.remove('loading');
            detectBtn.innerHTML = '开始检测';
            
            errorDetail.textContent = message || '无法获取网页内容，请检查链接是否有效';
            errorState.classList.add('active');
        }

        // 图片模态框
        function initModal() {
            const modal = document.getElementById('imageModal');
            const modalClose = document.getElementById('modalClose');
            const modalImage = document.getElementById('modalImage');

            modalClose.addEventListener('click', function() {
                modal.classList.remove('active');
            });

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        }

        function showImageModal(url) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = url;
            modal.classList.add('active');
        }

        // Toast 提示
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

     
        // AI分析功能
        async function analyzeContent(text, images, fromExtraction = false, htmlContent = null) {
            const detectBtn = document.getElementById('detectBtn');
            const loadingState = document.getElementById('loadingState');
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const errorState = document.getElementById('errorState');
            const progressBar = document.getElementById('progressBar');
            const loadingText = document.getElementById('loadingText');

            // UI Loading State
            initialState.style.display = 'none';
            resultItem.classList.remove('active');
            resultItem.style.display = 'none'; // Ensure hidden during loading
            errorState.classList.remove('active');
            loadingState.classList.add('active');
            detectBtn.classList.add('loading');
            detectBtn.innerHTML = 'AI分析中...';
            
            // 设置进度条初始状态
            if (fromExtraction) {
                progressBar.style.width = '50%';
            } else {
                progressBar.style.width = '0%';
                // 快速动画到 50%
                setTimeout(() => {
                    progressBar.style.width = '50%';
                }, 100);
            }
            loadingText.textContent = '正在分析新闻中...';

            // 模拟分析阶段的进度增长 (50% -> 90%)
            let progress = 50;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += 0.5; // 慢一点
                    progressBar.style.width = progress + '%';
                }
            }, 100);

            try {
                let imageUrls = [];
                if (images && images.length > 0) {
                    // 限制最多4张图片
                    const limitedImages = images.slice(0, 4);
                    imageUrls = limitedImages.map(img => typeof img === 'string' ? img : img.url);
                }

                let result;
                // 检查是否是URL提取的内容，如果是，尝试获取URL
                let sourceUrl = '';
                if (fromExtraction && window.lastExtractedUrl) {
                    sourceUrl = window.lastExtractedUrl;
                } else if (isURL(text)) {
                    sourceUrl = text;
                }

                if (window.electronAPI) {
                    const response = await window.electronAPI.invoke('analyze-content', { text, imageUrls, url: sourceUrl });
                    if (response.success) {
                        result = response.data;
                    } else {
                        throw new Error(response.error);
                    }
                } else {
                    // Mock for dev
                    await new Promise(r => setTimeout(r, 2000));
                    result = {
                        probability: 0.15,
                        type: 3,
                        explanation: "这是一个模拟的AI分析结果（假新闻）。",
                        fake_parts: [{ text: text.substring(0, 10), reason: "模拟原因" }]
                    };
                }

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                // 稍微延迟一下让用户看到100%
                setTimeout(() => {
                    showAnalysisResult(result, htmlContent || text, images, !!htmlContent);
                    showToast('分析完成', 'success');
                    loadingState.classList.remove('active');
                    detectBtn.classList.remove('loading');
                    detectBtn.innerHTML = '开始检测';
                    
                    // 保存到历史记录
                    saveToHistory(htmlContent || text, result, images, !!htmlContent);

                    // Enable export button
                    const exportBtn = document.getElementById('exportBtn');
                    if (exportBtn) exportBtn.disabled = false;
                }, 500);

            } catch (error) {
                clearInterval(progressInterval);
                console.error(error);
                showError('AI分析失败: ' + error.message);
                showToast('分析失败', 'error');
                loadingState.classList.remove('active');
                detectBtn.classList.remove('loading');
                detectBtn.innerHTML = '开始检测';
            }
        }

        function showAnalysisResult(result, originalText, originalImages, isHtml = false) {
            const resultItem = document.getElementById('resultItem');
            const initialState = document.getElementById('initialState');
            if (initialState) initialState.style.display = 'none';
            resultItem.style.display = 'block'; // Ensure visible
            resultItem.classList.add('active'); // Ensure active class
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            // Ensure Score and Analysis are visible (in case they were hidden by preview)
            const scoreSection = resultItem.querySelector('.result-score');
            const analysisSection = resultItem.querySelector('.result-analysis');
            if(scoreSection) scoreSection.style.display = 'flex';
            if(analysisSection) analysisSection.style.display = 'block';

            const scoreText = document.getElementById('scoreText');
            const scoreValue = document.getElementById('scoreValue');
            const scoreDescription = document.getElementById('scoreDescription');
            const scoreProgress = document.getElementById('scoreProgress');
            const scoreContainer = document.getElementById('scoreCircleContainer');
            
            // Probability to Percentage
            const percentage = Math.round(result.probability * 100);
            scoreText.textContent = percentage + '%';
            scoreValue.textContent = percentage + '%';
            
            // Reset classes
            scoreContainer.className = 'score-circle-container';
            
            // Color logic based on percentage
            if (percentage >= 75) {
                scoreContainer.classList.add('real');
            } else if (percentage >= 50) {
                scoreContainer.classList.add('uncertain');
            } else {
                scoreContainer.classList.add('fake');
            }
            
            // Animate Progress
            const circumference = 2 * Math.PI * 45; // r=45
            const offset = circumference - (percentage / 100) * circumference;
            scoreProgress.style.strokeDashoffset = circumference; // Reset first
            setTimeout(() => {
                scoreProgress.style.strokeDashoffset = offset;
            }, 100);
            
            // Type handling for description
            if (result.type === 1) { // True
                scoreDescription.innerHTML = `<strong>可信度高</strong><br>${result.explanation}`;
            } else if (result.type === 2) { // Partial
                scoreDescription.innerHTML = `<strong>部分存疑</strong><br>${result.explanation}`;
            } else { // Fake
                scoreDescription.innerHTML = `<strong>疑似虚假</strong><br>${result.explanation}`;
            }
            
            // Update Analysis Points
            const analysisContainer = document.querySelector('.result-analysis');
            // 清空旧的静态内容（保留标题）
            const analysisTitle = analysisContainer.querySelector('.analysis-title');
            analysisContainer.innerHTML = '';
            analysisContainer.appendChild(analysisTitle);

            if (result.analysis_points && Array.isArray(result.analysis_points)) {
                result.analysis_points.forEach(point => {
                    const item = document.createElement('div');
                    item.className = 'analysis-item';
                    
                    let icon = '✓';
                    let iconClass = 'positive';
                    
                    if (point.status === 'warning') {
                        icon = '!';
                        iconClass = 'warning';
                    } else if (point.status === 'negative') {
                        icon = '✕';
                        iconClass = 'negative';
                    }
                    
                    item.innerHTML = `
                        <div class="analysis-icon ${iconClass}">${icon}</div>
                        <div class="analysis-text">${point.description}</div>
                    `;
                    analysisContainer.appendChild(item);
                });
            } else {
                // Fallback if no analysis points provided
                analysisContainer.innerHTML += `<div class="analysis-item"><div class="analysis-text">暂无详细分析点</div></div>`;
            }
            
            // Display Content
            parsedContent.style.display = 'block';
            if (result.title) {
                parsedTitle.textContent = result.title;
                parsedTitle.style.display = 'block';
            } else {
                parsedTitle.style.display = 'none';
            }
            
            if (isHtml) {
                parsedText.classList.add('is-html');
            } else {
                parsedText.classList.remove('is-html');
            }

            // Highlight fake parts
            let displayText = originalText;
            if ((result.type === 2 || result.type === 3) && result.fake_parts) {
                if (isHtml) {
                    let safeText = displayText;
                    const sortedParts = [...result.fake_parts].sort((a, b) => b.text.length - a.text.length);
                    sortedParts.forEach(part => {
                        if (part.text) {
                            const highlight = `<span class="fake-highlight" data-reason="${part.reason.replace(/"/g, '&quot;')}" onclick="showReasonTooltip(event, this)">${part.text}</span>`;
                            safeText = safeText.replace(part.text, highlight);
                        }
                    });
                    parsedText.innerHTML = safeText;
                } else {
                    let safeText = displayText.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    
                    // Sort fake parts by length descending to avoid nested replacement issues
                    const sortedParts = [...result.fake_parts].sort((a, b) => b.text.length - a.text.length);

                    sortedParts.forEach(part => {
                        if (part.text) {
                            const safePart = part.text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                            // 使用 CSS 类控制样式
                            const highlight = `<span class="fake-highlight" data-reason="${part.reason.replace(/"/g, '&quot;')}" onclick="showReasonTooltip(event, this)">${safePart}</span>`;
                            // Replace only the first occurrence to avoid over-replacing
                            safeText = safeText.replace(safePart, highlight);
                        }
                    });
                    parsedText.innerHTML = safeText;
                }
            } else {
                if (isHtml) {
                    parsedText.innerHTML = originalText;
                } else {
                    parsedText.textContent = originalText;
                }
            }
            
            // Render Images
            parsedImages.innerHTML = '';
            let imagesToRender = [];
            if (originalImages && originalImages.length > 0) {
                 // 限制最多显示4张图片
                 const limitedImages = originalImages.slice(0, 4);
                 imagesToRender = limitedImages.map(img => typeof img === 'string' ? {url: img, name: 'Image'} : img);
            }
            
            if (imagesToRender.length > 0) {
                // 添加标题
                const title = document.createElement('div');
                title.className = 'parsed-images-title';
                title.textContent = '引用的图片';
                parsedImages.appendChild(title);

                // 添加分隔线
                const separator = document.createElement('div');
                separator.style.height = '1px';
                separator.style.backgroundColor = 'var(--border-color)';
                separator.style.margin = '8px 0 12px 0';
                separator.style.width = '100%';
                parsedImages.appendChild(separator);
                
                // 创建图片容器
                const container = document.createElement('div');
                container.className = 'parsed-images';
                
                imagesToRender.forEach(img => {
                    const item = document.createElement('div');
                    item.className = 'parsed-image-item';
                    item.innerHTML = `<img src="${img.url}" alt="${img.name}">`;
                    item.addEventListener('click', () => showImageModal(img.url));
                    container.appendChild(item);
                });
                
                parsedImages.appendChild(container);
            }
            
            resultItem.classList.add('active');
        }

        // Tooltip Logic
        let activeTooltipElement = null;
        let tooltipUpdateRaf = null;

        function updateTooltipPosition() {
            const tooltip = document.getElementById('customTooltip');
            if (!tooltip || !tooltip.classList.contains('active') || !activeTooltipElement) return;

            const rect = activeTooltipElement.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            // Calculate position (centered horizontally, below element)
            let top = rect.bottom + 10;
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

            // Viewport boundary checks
            const padding = 16;
            
            // Horizontal check
            if (left < padding) {
                left = padding;
            } else if (left + tooltipRect.width > window.innerWidth - padding) {
                left = window.innerWidth - tooltipRect.width - padding;
            }
            
            // Vertical check (flip to top if not enough space below)
            if (top + tooltipRect.height > window.innerHeight - padding) {
                top = rect.top - tooltipRect.height - 10;
            }

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        }

        function showReasonTooltip(event, element) {
            event.stopPropagation();
            
            // Remove active class from previous highlight
            if (activeTooltipElement) {
                activeTooltipElement.classList.remove('active');
            }

            const reason = element.getAttribute('data-reason');
            if (!reason) return;

            activeTooltipElement = element;
            activeTooltipElement.classList.add('active');

            let tooltip = document.getElementById('customTooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'customTooltip';
                tooltip.className = 'custom-tooltip';
                document.body.appendChild(tooltip);
            }

            tooltip.textContent = reason;
            tooltip.classList.add('active');

            // Initial position update
            updateTooltipPosition();
        }

        function hideTooltip() {
            const tooltip = document.getElementById('customTooltip');
            if (tooltip) {
                tooltip.classList.remove('active');
            }
            if (activeTooltipElement) {
                activeTooltipElement.classList.remove('active');
                activeTooltipElement = null;
            }
        }

        // Global event listeners for tooltip management
        document.addEventListener('click', function(e) {
            // Clear image selection if clicking outside
            if (selectedImages.size > 0) {
                // Since image click stops propagation, any click reaching here is outside an image
                // (or on an element that bubbled up, but not an image item)
                selectedImages.clear();
                renderImages();
            }

            const tooltip = document.getElementById('customTooltip');
            // If clicking inside tooltip, do nothing
            if (tooltip && tooltip.contains(e.target)) {
                return;
            }
            // If clicking a highlight, it's handled by onclick
            if (e.target.classList.contains('fake-highlight')) {
                return;
            }
            
            hideTooltip();
        });

        // Update position on scroll and resize
        // Use capture to catch scroll events from any container
        window.addEventListener('scroll', function() {
            if (activeTooltipElement) {
                if (tooltipUpdateRaf) cancelAnimationFrame(tooltipUpdateRaf);
                tooltipUpdateRaf = requestAnimationFrame(updateTooltipPosition);
            }
        }, true);

        window.addEventListener('resize', function() {
            if (activeTooltipElement) {
                updateTooltipPosition();
            }
        });
        // Sidebar Toggle Logic
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const historyBtn = document.getElementById('historyBtn');
        const leftSidebar = document.getElementById('leftSidebar');
        
        function toggleSidebar(forceState) {
            if (!leftSidebar) return;
            
            const isExpanded = typeof forceState === 'boolean' 
                ? forceState 
                : !leftSidebar.classList.contains('expanded');
                
            if (isExpanded) {
                leftSidebar.classList.add('expanded');
                document.body.classList.add('sidebar-expanded');
            } else {
                leftSidebar.classList.remove('expanded');
                document.body.classList.remove('sidebar-expanded');
            }
        }

        if (sidebarToggleBtn) {
            sidebarToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleSidebar();
            });
        }

        if (historyBtn) {
            historyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // History button reuses expand function
                toggleSidebar(true);
            });
        }

        // New Chat Button Logic
        const newChatBtn = document.getElementById('newChatBtn');
        if (newChatBtn) {
            newChatBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // Reset UI to initial state without clearing text input
                const resultItem = document.getElementById('resultItem');
                const initialState = document.getElementById('initialState');
                const loadingState = document.getElementById('loadingState');
                const errorState = document.getElementById('errorState');
                const progressBar = document.getElementById('progressBar');
                const statusText = document.getElementById('statusText');
                const imagePreview = document.getElementById('imagePreview');
                const urlInput = document.getElementById('urlInput');
                
                if (resultItem) resultItem.style.display = 'none';
                if (initialState) initialState.style.display = 'flex';
                if (loadingState) loadingState.classList.remove('active');
                if (errorState) errorState.classList.remove('active');
                
                if (progressBar) {
                    progressBar.style.width = '0%';
                    // 不要隐藏 parentElement，否则下次加载时进度条会丢失
                    // progressBar.parentElement.style.display = 'none'; 
                }
                
                if (statusText) statusText.textContent = '';
                
                if (imagePreview) {
                    // 修正：不要隐藏容器，而是清空内容
                    imagePreview.innerHTML = '';
                    // 重置上传图片数组
                    uploadedImages = [];
                    selectedImages.clear();
                    updateEditorStats();
                    // 清除文件输入框的值
                    const fileInput = document.getElementById('fileInput');
                    if (fileInput) fileInput.value = '';
                }
                
                if (urlInput) urlInput.value = '';
                
                // Reset current history item tracking
                currentHistoryItem = null;
            });
        }

        // Global listener to collapse when clicking outside (left or right click)
        function handleOutsideClick(e) {
            if (!leftSidebar || !leftSidebar.classList.contains('expanded')) return;
            
            // Check if click is inside sidebar or toggle button
            const isInsideSidebar = leftSidebar.contains(e.target);
            const isToggleButton = sidebarToggleBtn && sidebarToggleBtn.contains(e.target);
            
            if (!isInsideSidebar && !isToggleButton) {
                toggleSidebar(false);
            }
        }

        document.addEventListener('mousedown', handleOutsideClick);
        document.addEventListener('contextmenu', handleOutsideClick);

        // --- History Management ---
        let allHistory = [];
        let currentHistoryPage = 1;
        const historyItemsPerPage = 10;
        let currentHistoryItem = null; // For context menu

        async function loadHistory() {
            if (!window.electronAPI) return;
            try {
                const history = await window.electronAPI.invoke('get-history');
                allHistory = history || [];
                renderHistory();
            } catch (err) {
                console.error('Failed to load history:', err);
            }
        }

        function renderHistory() {
            const historyList = document.getElementById('historyList');
            
            if (!historyList) return;
            
            historyList.innerHTML = '';
            
            if (allHistory.length === 0) {
                historyList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 13px;">暂无历史记录</div>';
                return;
            }

            allHistory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                
                const date = new Date(item.timestamp);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                div.innerHTML = `
                    <div class="history-item-title">${item.result.title || '未命名分析'}</div>
                    <div class="history-item-meta">
                        <span>${dateStr}</span>
                        <span class="history-item-preview">${item.content.replace(/<[^>]*>/g, '').substring(0, 30)}...</span>
                    </div>
                `;
                
                div.addEventListener('click', () => {
                    restoreHistoryItem(item);
                });

                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    currentHistoryItem = item;
                    showHistoryContextMenu(e);
                });
                
                historyList.appendChild(div);
            });
        }

        function showHistoryContextMenu(e) {
            const menu = document.getElementById('historyContextMenu');
            if (!menu) return;
            
            menu.style.visibility = 'hidden';
            menu.classList.add('active');
            const menuWidth = menu.offsetWidth;
            const menuHeight = menu.offsetHeight;
            menu.classList.remove('active');
            menu.style.visibility = 'visible';
            
            let x = e.clientX;
            let y = e.clientY;
            
            const winWidth = window.innerWidth;
            const winHeight = window.innerHeight;
            
            if (x + menuWidth > winWidth) x = winWidth - menuWidth - 5;
            if (y + menuHeight > winHeight) y = winHeight - menuHeight - 5;
            
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');
            
            // Close other menus
            document.querySelectorAll('.context-menu.active').forEach(m => {
                if (m !== menu) m.classList.remove('active');
            });
        }

        // History Context Menu Actions
        document.getElementById('ctxHistoryView')?.addEventListener('click', () => {
            if (currentHistoryItem) restoreHistoryItem(currentHistoryItem);
            document.getElementById('historyContextMenu').classList.remove('active');
        });

        document.getElementById('ctxHistoryDelete')?.addEventListener('click', () => {
            if (currentHistoryItem) deleteHistoryItem(currentHistoryItem);
            document.getElementById('historyContextMenu').classList.remove('active');
        });

        // Close context menu on click outside
        document.addEventListener('pointerdown', (e) => {
            const menu = document.getElementById('historyContextMenu');
            if (menu && menu.classList.contains('active') && !menu.contains(e.target)) {
                menu.classList.remove('active');
            }
        });

        // Close on blur/resize like other menus
        window.addEventListener('blur', () => {
            const menu = document.getElementById('historyContextMenu');
            if (menu) menu.classList.remove('active');
        });
        
        window.addEventListener('resize', () => {
            const menu = document.getElementById('historyContextMenu');
            if (menu) menu.classList.remove('active');
        });

        async function deleteHistoryItem(item) {
            if (!window.electronAPI) return;
            try {
                const response = await window.electronAPI.invoke('delete-history', item.timestamp);
                if (response.success) {
                    allHistory = response.data;
                    renderHistory();
                    showToast('已删除历史记录', 'success');
                } else {
                    showError('删除失败: ' + response.error);
                }
            } catch (err) {
                console.error('Failed to delete history:', err);
            }
        }

        function restoreHistoryItem(item) {
            // Restore text input
            const textInput = document.getElementById('textInput');
            if (textInput) {
                // 优先使用 originalInput (新版逻辑)
                if (item.originalInput !== undefined) {
                    textInput.innerHTML = item.originalInput;
                } else {
                    // 兼容旧版逻辑
                    // Use innerText or textContent for contenteditable div
                    // If content is HTML, use innerHTML, otherwise textContent
                    if (item.isHtml) {
                        textInput.innerHTML = item.content;
                    } else {
                        textInput.innerText = item.content.replace(/<[^>]*>/g, ''); 
                    }
                }
                // Trigger input event to update word count etc.
                textInput.dispatchEvent(new Event('input'));
            }

            // Restore images in left panel
            const restoredText = textInput ? textInput.innerText.trim() : '';
            if (item.images && item.images.length > 0 && !isURL(restoredText)) {
                // Normalize images to match uploadedImages structure
                uploadedImages = item.images.map(img => {
                    if (typeof img === 'string') {
                        return {
                            id: Date.now() + Math.random(),
                            url: img,
                            name: 'Restored Image'
                        };
                    } else {
                        return {
                            ...img,
                            // Ensure ID is unique if needed, or keep it
                            id: img.id || (Date.now() + Math.random())
                        };
                    }
                });
                renderImages();
            } else {
                uploadedImages = [];
                renderImages();
            }
            
            // Hide Initial State & Show Result Item
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const loadingState = document.getElementById('loadingState');
            
            if (loadingState) loadingState.classList.remove('active');
            if (initialState) {
                initialState.style.display = 'none';
                initialState.classList.remove('active'); // Just in case
            }
            
            if (resultItem) {
                resultItem.classList.add('active');
                resultItem.style.display = 'block'; // Ensure it's visible
                
                // Ensure Score and Analysis are visible
                const scoreSection = resultItem.querySelector('.result-score');
                const analysisSection = resultItem.querySelector('.result-analysis');
                if(scoreSection) scoreSection.style.display = 'flex';
                if(analysisSection) analysisSection.style.display = 'block';
            }
            
            // Show result content
            showAnalysisResult(item.result, item.content, item.images || [], item.isHtml || false);
            
            // Collapse sidebar on mobile
            if (window.innerWidth < 768) {
                toggleSidebar(false);
            }
            
            showToast('已恢复历史记录', 'success');
        }

        async function saveToHistory(content, result, images, isHtml) {
            if (!window.electronAPI) return;
            try {
                // 获取当前文本框的内容
                const textInput = document.getElementById('textInput');
                const originalInput = textInput ? textInput.innerHTML : '';

                const historyItem = {
                    content,
                    result,
                    images,
                    isHtml,
                    originalInput, // 保存原始输入框内容
                    timestamp: Date.now()
                };
                await window.electronAPI.invoke('save-history', historyItem);
                await loadHistory(); // Reload list
            } catch (err) {
                console.error('Failed to save history:', err);
            }
        }



        // Clear History Button Logic
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        if (clearHistoryBtn) {
            clearHistoryBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showCustomModal({
                    title: '清空历史记录',
                    message: '确定要删除所有历史记录吗？此操作不可恢复。',
                    confirmText: '清空',
                    cancelText: '取消',
                    onConfirm: async () => {
                        if (window.electronAPI) {
                            try {
                                const res = await window.electronAPI.invoke('clear-history');
                                if (res.success) {
                                    showToast('历史记录已清空', 'success');
                                    loadHistory();
                                } else {
                                    showError('清空失败: ' + res.error);
                                }
                            } catch (err) {
                                console.error(err);
                                showError('清空失败');
                            }
                        }
                    }
                });
            });
        }

        // Initial load
        loadHistory();

        // 监听 initialState 的显示状态，控制 newChatBtn 的可用性
        (function() {
            const initialState = document.getElementById('initialState');
            const newChatBtn = document.getElementById('newChatBtn');

            if (initialState && newChatBtn) {
                const updateBtnState = () => {
                    const isVisible = getComputedStyle(initialState).display !== 'none';
                    newChatBtn.disabled = isVisible;
                    if (typeof updateClearButtonState === 'function') {
                        updateClearButtonState();
                    }
                };

                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && (mutation.attributeName === 'style' || mutation.attributeName === 'class')) {
                            updateBtnState();
                        }
                    });
                });

                observer.observe(initialState, { attributes: true, attributeFilter: ['style', 'class'] });

                // 初始化检查
                // 使用 requestAnimationFrame 确保在下一帧渲染前执行，或者直接执行
                // 直接执行即可，因为脚本在底部
                updateBtnState();
            }
        })();
    </script>
</body>
</html>
