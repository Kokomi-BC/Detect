<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÅáÊñ∞ÈóªÊ£ÄÊµãÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Color Palette - Refined */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f1f3f5;
            --text-primary: #1a1d20;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            
            --accent-color: #4361ee;
            --accent-hover: #3a56d4;
            --accent-light: rgba(67, 97, 238, 0.1);
            
            --success-color: #2ec4b6;
            --warning-color: #ff9f1c;
            --danger-color: #e71d36;
            
            /* Shadows - Smoother */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.12);
            
            /* Transitions */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        [data-theme="dark"] {
            --bg-primary: #111315;
            --bg-secondary: #1a1d20;
            --bg-tertiary: #212529;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --border-color: #2d3238;
            
            --accent-color: #4cc9f0;
            --accent-hover: #48bfe3;
            --accent-light: rgba(76, 201, 240, 0.15);
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.3);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            user-select: none; /* Á¶ÅÊ≠¢ÈÄâ‰∏≠ */
            -webkit-user-select: none;
        }

        /* ÂÖÅËÆ∏ÈÄâ‰∏≠ÁöÑÂå∫Âüü */
        .text-input, .parsed-text, .parsed-title, .analysis-text, .custom-tooltip {
            user-select: text;
            -webkit-user-select: text;
        }

        /* Ê≤âÊµ∏ÂºèÊªöÂä®Êù°Ê†∑Âºè */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
            transition: background 0.3s;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        ::-webkit-scrollbar-corner {
            background: transparent;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Â∑¶‰æßÈù¢Êùø */
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            min-width: 300px;
            max-width: 70%;
            transition: background-color 0.3s;
            position: relative;
        }

        /* ÊãñÊãΩÈÅÆÁΩ©Â±Ç */
        .drag-overlay {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            bottom: 16px;
            background: rgba(67, 97, 238, 0.15);
            border: 2px dashed var(--accent-color);
            border-radius: var(--radius-lg);
            z-index: 99;
            pointer-events: none;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-color);
            backdrop-filter: blur(8px);
            transition: all 0.2s ease;
        }
        .drag-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .drag-overlay.error {
            border-color: var(--danger-color);
            background: rgba(231, 29, 54, 0.15);
            color: var(--danger-color);
        }
        .drag-overlay.success {
            border-color: var(--success-color);
            background: rgba(46, 196, 182, 0.15);
            color: var(--success-color);
        }
        .drag-overlay.full {
            border-color: var(--warning-color);
            background: rgba(255, 159, 28, 0.15);
            color: var(--warning-color);
        }

        /* Â∑•ÂÖ∑Ê†è */
        .toolbar {
            display: flex;
            align-items: center;
            height: 64px;
            padding: 0 20px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
            position: relative;
            z-index: 20;
        }

        .toolbar-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .toolbar-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .toolbar-btn:active {
            transform: translateY(0) scale(0.95);
        }

        .toolbar-btn.active {
            background: var(--accent-light);
            color: var(--accent-color);
        }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        @keyframes ripple {
            to { transform: scale(4); opacity: 0; }
        }

        .toolbar-separator {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 8px;
        }

        /* Dropdown Menu */
        .more-menu .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 180px;
            display: none;
            background: var(--bg-primary);
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius-md);
            padding: 8px;
            z-index: 999;
            border: 1px solid var(--border-color);
            animation: slideDown 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .more-menu .dropdown-menu.show {
            display: block;
        }

        .more-menu .dropdown-item {
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: background 0.2s;
        }

        .more-menu .dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        /* Edit Options */
        .edit-options {
            display: none;
            padding: 12px 20px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            gap: 8px;
            animation: slideDown 0.3s ease;
        }
        .edit-options.active { display: flex; }

        .edit-btn {
            width: 32px;
            height: 32px;
            padding: 6px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .edit-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            overflow-y: auto;
            gap: 24px;
        }

        .text-input {
            flex: 1;
            min-height: 200px;
            padding: 24px;
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.8;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            outline: none;
        }

        .text-input:focus {
            border-color: var(--accent-color);
            box-shadow: var(--shadow-md);
        }
        
        .text-input:empty:before {
            content: attr(placeholder);
            color: var(--text-secondary);
            opacity: 0.6;
        }

        /* Image Preview */
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 16px;
            padding: 4px;
        }

        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            overflow: hidden;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: var(--transition-bounce);
            box-shadow: var(--shadow-sm);
        }

        .image-preview-item:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-md);
        }

        .image-delete-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition-fast);
            backdrop-filter: blur(4px);
        }

        .image-preview-item:hover .image-delete-btn {
            opacity: 1;
        }
        .image-delete-btn:hover {
            background: var(--danger-color);
            transform: scale(1.1);
        }

        /* Drag and Drop States */
        .image-preview-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .image-preview-item.drag-over {
            border: 2px solid var(--accent-color);
            background: var(--accent-light);
        }

        .image-preview-item {
            transition: all 0.2s ease;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            padding: 8px 0;
            z-index: 10000;
            min-width: 180px;
            display: none;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition-fast);
            user-select: none;
        }

        .context-menu-item:hover {
            background: var(--bg-tertiary);
            color: var(--accent-color);
        }

        .context-menu-item:active {
            background: var(--accent-light);
        }

        .context-menu-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Bottom Area */
        .bottom-area {
            padding: 20px 24px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
        }

        .detect-btn {
            width: 100%;
            padding: 16px;
            background: rgba(67, 97, 238, 0.1); /* var(--accent-light) */
            color: var(--accent-color);
            border: 1px solid rgba(67, 97, 238, 0.2);
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            backdrop-filter: blur(8px);
        }

        .detect-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3);
            border-color: var(--accent-color);
        }

        .detect-btn:active {
            transform: translateY(0);
        }

        /* Resizer */
        .resizer {
            width: 5px;
            background: var(--bg-tertiary);
            cursor: col-resize;
            position: relative;
            z-index: 30;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        .resizer::after {
            content: '';
            width: 3px;
            height: 32px;
            background: var(--text-secondary);
            border-radius: 2px;
            opacity: 0.3;
            transition: all 0.3s;
        }
        .resizer:hover {
            background: var(--accent-light);
            border-color: var(--accent-light);
        }
        .resizer:hover::after {
            background: var(--accent-color);
            opacity: 1;
            height: 48px;
        }

        /* Right Panel */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            min-width: 300px;
        }

        .result-header {
            height: 64px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .result-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .result-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        /* Initial State */
        .initial-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-secondary);
            animation: scaleIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .initial-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.5;
            filter: grayscale(100%);
            transition: var(--transition);
        }
        .initial-state:hover .initial-icon {
            opacity: 1;
            filter: grayscale(0%);
            transform: scale(1.1);
        }

        .initial-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .initial-description {
            font-size: 15px;
            line-height: 1.6;
            max-width: 420px;
        }

        /* Result Item */
        .result-item {
            display: none;
            animation: slideInRight 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .result-item.active { display: block; }

        .result-score {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 24px;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        /* SVG Score Circle */
        .score-circle-container {
            position: relative;
            width: 100px;
            height: 100px;
        }
        .score-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .score-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 8;
        }
        .score-progress {
            fill: none;
            stroke: var(--accent-color);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 283; /* 2 * PI * 45 */
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1.5s cubic-bezier(0.2, 0.8, 0.2, 1), stroke 0.3s;
        }
        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Score Colors */
        .score-circle-container.real .score-progress { stroke: var(--success-color); }
        .score-circle-container.fake .score-progress { stroke: var(--danger-color); }
        .score-circle-container.uncertain .score-progress { stroke: var(--warning-color); }

        .score-details { flex: 1; }

        .score-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .score-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -1px;
        }

        .score-description {
            font-size: 15px;
            color: var(--text-secondary);
            margin-top: 6px;
            line-height: 1.5;
        }

        /* Analysis List */
        .result-analysis {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .analysis-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .analysis-title::before {
            content: '';
            width: 4px;
            height: 18px;
            background: var(--accent-color);
            border-radius: 2px;
        }

        .analysis-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .analysis-item:hover {
            transform: translateX(4px);
            background: var(--bg-primary);
            box-shadow: var(--shadow-sm);
        }

        .analysis-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
            font-weight: bold;
        }

        /* Analysis Status Styles */
        .analysis-item.positive { border-left-color: var(--success-color); }
        .analysis-item.positive .analysis-icon { color: var(--success-color); background: rgba(46, 196, 182, 0.1); }
        
        .analysis-item.negative { border-left-color: var(--danger-color); }
        .analysis-item.negative .analysis-icon { color: var(--danger-color); background: rgba(231, 29, 54, 0.1); }
        
        .analysis-item.warning { border-left-color: var(--warning-color); }
        .analysis-item.warning .analysis-icon { color: var(--warning-color); background: rgba(255, 159, 28, 0.1); }

        .analysis-text {
            flex: 1;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        .image-modal.active { display: flex; }

        .modal-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            animation: zoomIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .modal-close {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 28px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }

        /* Custom Modal */
        .custom-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        .custom-modal.active { display: flex; }
        
        .custom-modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 32px;
            min-width: 360px;
            max-width: 90vw;
            text-align: center;
            animation: zoomIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            border: 1px solid var(--border-color);
        }
        
        .custom-modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .custom-modal-message {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.5;
        }
        
        .custom-modal-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }
        
        .custom-modal-btn {
            padding: 10px 32px;
            border-radius: var(--radius-md);
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: var(--accent-color);
            color: #fff;
            transition: var(--transition-fast);
        }
        .custom-modal-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }
        
        .custom-modal-btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid transparent;
        }
        .custom-modal-btn.secondary:hover {
            background: var(--border-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        /* Loading State */
        .loading-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            animation: fadeIn 0.3s ease;
        }
        .loading-state.active { display: flex; }

        .loading-spinner-large {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        .progress-container {
            width: 240px;
            height: 6px;
            background-color: var(--bg-tertiary);
            border-radius: 3px;
            margin-top: 16px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        /* Parsed Content */
        .parsed-content {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
            animation: slideInRight 0.5s ease;
        }

        .parsed-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .parsed-text {
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
            text-align: justify;
        }

        /* Fake Highlight */
        .fake-highlight {
            background-color: rgba(255, 159, 28, 0.2);
            border-bottom: 2px solid var(--warning-color);
            color: inherit;
            cursor: pointer;
            border-radius: 4px;
            padding: 0 2px;
            transition: background-color 0.2s;
        }
        .fake-highlight:hover {
            background-color: rgba(255, 159, 28, 0.4);
        }
        .fake-highlight.active {
            background-color: rgba(255, 159, 28, 0.5);
            box-shadow: 0 0 0 2px rgba(255, 159, 28, 0.3);
        }

        /* Animations */
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .left-panel, .right-panel { max-width: 100%; min-width: 100%; }
            .resizer { display: none; }
            .image-preview-container { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
        }

        /* ËôöÂÅáÂÜÖÂÆπÈ´ò‰∫ÆÊ†∑Âºè */
        .fake-highlight {
            background-color: rgba(255, 190, 11, 0.3);
            border-bottom: 2px solid var(--warning-color);
            color: inherit;
            cursor: pointer;
            border-radius: 4px;
            padding: 0 2px;
            transition: background-color 0.2s;
        }
        
        .fake-highlight:hover {
            background-color: rgba(255, 190, 11, 0.5);
        }

        .fake-highlight.active {
            background-color: rgba(255, 190, 11, 0.6);
        }

        /* ËØ¶ÁªÜÂàÜÊûêÂàóË°®È°πÊ†∑Âºè */
        .analysis-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            transition: var(--transition);
        }

        .analysis-item:hover {
            transform: translateX(4px);
        }

        .analysis-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-weight: bold;
            font-size: 14px;
        }

        .analysis-icon.positive {
            background: rgba(6, 255, 165, 0.15);
            color: var(--success-color);
        }

        .analysis-icon.warning {
            background: rgba(255, 190, 11, 0.15);
            color: var(--warning-color);
        }

        .analysis-icon.negative {
            background: rgba(251, 86, 7, 0.15);
            color: var(--danger-color);
        }

        .analysis-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
        }

        /* ÈîôËØØÁä∂ÊÄÅ */
        .error-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--danger-color);
            animation: fadeIn 0.3s ease;
        }

        .error-state.active {
            display: flex;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .error-message {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .error-detail {
            font-size: 14px;
            color: var(--text-secondary);
            max-width: 300px;
        }
        /* ÂÖ•Âú∫Âä®Áîª‰ºòÂåñ */
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); filter: blur(5px); }
            to { opacity: 1; transform: translateX(0); filter: blur(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); filter: blur(5px); }
            to { opacity: 1; transform: translateX(0); filter: blur(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); filter: blur(5px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .left-panel {
            animation: slideInLeft 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .right-panel {
            animation: slideInRight 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .toolbar {
            opacity: 0;
            animation: fadeInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) 0.1s forwards;
        }

        .content-area {
            opacity: 0;
            animation: fadeInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) 0.2s forwards;
        }

        .bottom-area {
            opacity: 0;
            animation: fadeInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) 0.3s forwards;
        }

        .result-header {
            opacity: 0;
            animation: fadeInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) 0.2s forwards;
        }

        .initial-state {
            opacity: 0;
            animation: scaleIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) 0.4s forwards;
        }

        /* --- ‰øÆÂ§ç‰∏é‰ºòÂåñÊ†∑Âºè --- */

        /* 1. ‰øÆÂ§çÊõ¥Â§öËèúÂçïË¢´ÈÅÆÊå°ÁöÑÈóÆÈ¢ò */
        .toolbar-btn.more-menu {
            overflow: visible; /* ÂÖÅËÆ∏‰∏ãÊãâËèúÂçïË∂ÖÂá∫ÊåâÈíÆËåÉÂõ¥ */
        }

        /* ‰ºòÂåñ‰∏ãÊãâËèúÂçïÊ†∑Âºè */
        .more-menu .dropdown-menu {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 6px;
            min-width: 200px;
            border-radius: 12px;
            transform-origin: top right;
        }
        
        [data-theme="dark"] .more-menu .dropdown-menu {
            background: rgba(30, 30, 30, 0.95);
            border-color: rgba(255,255,255,0.1);
        }

        .more-menu .dropdown-item {
            border-radius: 8px;
            margin-bottom: 2px;
            font-weight: 500;
        }

        /* 2. ‰øÆÂ§çÂ∑¶‰æßÁº©Áï•ÂõæÊòæÁ§∫ÈóÆÈ¢ò */
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* ‰øùÊåÅÊØî‰æãÂ°´ÂÖÖÔºåË£ÅÂâ™Â§ö‰ΩôÈÉ®ÂàÜ */
            display: block;
            transition: transform 0.3s;
        }
        .image-preview-item:hover img {
            transform: scale(1.1);
        }

        /* 3. ‰øÆÂ§çÂè≥‰æßÁªìÊûúÂõæÁâáËøáÂ§ßÈóÆÈ¢ò (‰ΩøÁî®ÁΩëÊ†ºÂ∏ÉÂ±Ä) */
        .parsed-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .parsed-image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            transition: var(--transition);
        }
        
        .parsed-image-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-color);
        }

        .parsed-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* 4. ‰ºòÂåñÂÅúÊ≠¢ÊåâÈíÆÊ†∑Âºè */
        .cancel-extract-btn {
            margin-top: 20px;
            padding: 10px 28px;
            background: transparent;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            border-radius: 30px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .cancel-extract-btn:hover {
            background: var(--danger-color);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 29, 54, 0.3);
            transform: translateY(-1px);
        }
        
        .cancel-extract-btn:active {
            transform: translateY(0);
        }
        
        .cancel-extract-btn::before {
            content: '';
            display: inline-block;
            width: 10px;
            height: 10px;
            background: currentColor;
            border-radius: 2px;
        }

        /* Ëá™ÂÆö‰πâ Tooltip Ê†∑Âºè */
        .custom-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            max-width: 300px;
            z-index: 3000;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s, transform 0.2s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            backdrop-filter: blur(4px);
        }
        .custom-tooltip.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 32px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            z-index: 10000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            pointer-events: none;
            box-shadow: var(--shadow-lg);
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: auto;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Toast Variants - Transparent Background */
        .toast.success { 
            background: rgba(46, 196, 182, 0.15); 
            color: var(--success-color);
            border-color: rgba(46, 196, 182, 0.2);
        }
        .toast.error { 
            background: rgba(231, 29, 54, 0.15); 
            color: var(--danger-color);
            border-color: rgba(231, 29, 54, 0.2);
        }
        .toast.warning { 
            background: rgba(255, 159, 28, 0.15); 
            color: var(--warning-color);
            border-color: rgba(255, 159, 28, 0.2);
        }
        .toast.info { 
            background: rgba(67, 97, 238, 0.15); 
            color: var(--accent-color);
            border-color: rgba(67, 97, 238, 0.2);
        }

        @media (prefers-reduced-motion: reduce) {
            .left-panel, .right-panel, .toolbar, .content-area, .bottom-area, .result-header, .initial-state {
                animation: none;
                opacity: 1;
                transform: none;
                transition: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Â∑¶‰æßÈù¢Êùø -->
        <div class="left-panel" id="leftPanel">
                        <div class="drag-overlay" id="dragOverlay">ÊãñÂÖ•ÂõæÁâá‰ª•Ê∑ªÂä†</div>
            <!-- Â∑•ÂÖ∑Ê†è -->
            <div class="toolbar">
                <button class="toolbar-btn" id="imageBtn" title="Ê∑ªÂä†ÂõæÁâá">
                    <!-- Material Icons: add_photo_alternate -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="14" rx="2" fill="none"/>
                        <path d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11" stroke="currentColor" fill="none"/>
                        <circle cx="8.5" cy="8.5" r="1.5" fill="none"/>
                        <path d="M21 15l-5-6-4 5-3-4-4 6" stroke="currentColor" fill="none"/>
                        <path d="M22 19h-6m3 3v-6" stroke="currentColor" fill="none"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="clipboardBtn" title="Ââ™Ë¥¥ÊùøËé∑Âèñ">
                    <!-- Material Icons: content_paste -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="5" y="5" width="14" height="16" rx="2" fill="none"/>
                        <rect x="9" y="2" width="6" height="4" rx="1" fill="none"/>
                        <path d="M19 7v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7" stroke="currentColor" fill="none"/>
                        <path d="M9 4V2h6v2" stroke="currentColor" fill="none"/>
                    </svg>
                </button>
                <div class="toolbar-separator"></div>
                <button class="toolbar-btn" id="editBtn" title="ÁºñËæëÈÄâÈ°π">
                    <!-- Material Icons: edit -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 17.25V21h3.75l11.06-11.06a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0L3 17.25z" fill="none"/>
                        <path d="M14.06 6.19l3.75 3.75" stroke="currentColor" fill="none"/>
                    </svg>
                </button>
                 <button class="toolbar-btn" id="previewBtn" title="È°µÈù¢È¢ÑËßà">
                    <!-- Material Icons: visibility -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12c2.73-5 7.27-8 11-8s8.27 3 11 8c-2.73 5-7.27 8-11 8S3.73 17 1 12z" fill="none"/>
                        <circle cx="12" cy="12" r="3" fill="none"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="themeBtn" title="ÂàáÊç¢‰∏ªÈ¢ò">
                    <!-- Material Icons: light_mode / dark_modeÔºåÂä®ÊÄÅÂàáÊç¢ -->
                    <span id="themeIconWrapper">
                        <svg id="themeIconLight" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                            <circle cx="12" cy="12" r="5"/>
                            <path d="M12 1v2"/>
                            <path d="M12 21v2"/>
                            <path d="M4.22 4.22l1.42 1.42"/>
                            <path d="M18.36 18.36l1.42 1.42"/>
                            <path d="M1 12h2"/>
                            <path d="M21 12h2"/>
                            <path d="M4.22 19.78l1.42-1.42"/>
                            <path d="M18.36 5.64l1.42-1.42"/>
                        </svg>
                        <svg id="themeIconDark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                            <path d="M9.37 5.51A7 7 0 1 0 18.49 14.63 9 9 0 0 1 9.37 5.51z"/>
                        </svg>
                    </span>
                </button>
                <button class="toolbar-btn" id="clearBtn" title="Ê∏ÖÁ©∫ÂÜÖÂÆπ">
                    <!-- Material Icons: delete -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12z" fill="none"/>
                        <path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="none"/>
                        <path d="M10 11v6"/>
                        <path d="M14 11v6"/>
                    </svg>
                </button>
                <div class="toolbar-separator"></div>
                <div class="toolbar-btn more-menu" id="moreBtn" title="Êõ¥Â§öÊìç‰Ωú" tabindex="0">
                    <!-- Material Icons: more_vert -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="6" r="1.5"/>
                        <circle cx="12" cy="12" r="1.5"/>
                        <circle cx="12" cy="18" r="1.5"/>
                    </svg>
                    <div class="dropdown-menu" id="moreDropdown">
                        <div class="dropdown-item" id="clearBrowserDataBtn">Ê∏ÖÈô§ÊµèËßàÂô®Êï∞ÊçÆ</div>
                    </div>
                </div>
            </div>

            <!-- ÁºñËæëÈÄâÈ°π -->
            <div class="edit-options" id="editOptions">
                <button class="edit-btn" data-command="bold" title="Âä†Á≤ó">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 8h6a3 3 0 0 1 0 6H7zm0 6h7a2.5 2.5 0 0 1 0 5H7z"/></svg>
                </button>
                <button class="edit-btn" data-command="italic" title="Êñú‰Ωì">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><line x1="17" y1="6" x2="9" y2="24"/></svg>
                </button>
                <button class="edit-btn" data-command="underline" title="‰∏ãÂàíÁ∫ø">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 6v8a6 6 0 0 0 12 0V6"/><line x1="4" y1="26" x2="20" y2="26"/></svg>
                </button>
                <button class="edit-btn" data-command="insertUnorderedList" title="Êó†Â∫èÂàóË°®">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="9" r="1.5"/><circle cx="6" cy="16" r="1.5"/><circle cx="6" cy="23" r="1.5"/><line x1="10" y1="9" x2="18" y2="9"/><line x1="10" y1="16" x2="18" y2="16"/><line x1="10" y1="23" x2="18" y2="23"/></svg>
                </button>
                <button class="edit-btn" data-command="insertOrderedList" title="ÊúâÂ∫èÂàóË°®">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><text x="3" y="11" font-size="8">1</text><line x1="10" y1="9" x2="18" y2="9"/><text x="3" y="18" font-size="8">2</text><line x1="10" y1="16" x2="18" y2="16"/><text x="3" y="25" font-size="8">3</text><line x1="10" y1="23" x2="18" y2="23"/></svg>
                </button>
                <button class="edit-btn" data-command="justifyLeft" title="Â∑¶ÂØπÈΩê">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="16" x2="14" y2="16"/><line x1="4" y1="23" x2="20" y2="23"/></svg>
                </button>
                <button class="edit-btn" data-command="justifyCenter" title="Â±Ö‰∏≠">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><line x1="6" y1="9" x2="18" y2="9"/><line x1="8" y1="16" x2="16" y2="16"/><line x1="4" y1="23" x2="20" y2="23"/></svg>
                </button>
                <button class="edit-btn" data-command="justifyRight" title="Âè≥ÂØπÈΩê">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="20" y2="9"/><line x1="10" y1="16" x2="20" y2="16"/><line x1="4" y1="23" x2="20" y2="23"/></svg>
                </button>
            </div>

            <!-- ÂÜÖÂÆπÂå∫Âüü -->
            <div class="content-area">
                <!-- ÊñáÊú¨ËæìÂÖ• -->
                <div contenteditable="true" class="text-input" id="textInput" placeholder="ËØ∑ËæìÂÖ•Ë¶ÅÊ£ÄÊµãÁöÑÊñ∞ÈóªÂÜÖÂÆπ..."></div>

                <!-- ÂõæÁâá‰∏ä‰º†Âå∫Âüü (Â∑≤ÁßªÈô§) -->
                <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">

                <!-- ÂõæÁâáÈ¢ÑËßà -->
                <div class="image-preview-container" id="imagePreview"></div>
            </div>

            <!-- Â∫ïÈÉ®Êìç‰ΩúÂå∫ -->
            <div class="bottom-area">
                <!-- Ê£ÄÊµãÊåâÈíÆ -->
                <button class="detect-btn" id="detectBtn">ÂºÄÂßãÊ£ÄÊµã</button>
            </div>
        </div>

        <!-- ÂàÜÈöîÁ∫ø -->
        <div class="resizer" id="resizer"></div>

        <!-- Âè≥‰æßÈù¢Êùø -->
        <div class="right-panel" id="rightPanel">
            <div class="result-header">
                <h2 class="result-title">Ê£ÄÊµãÁªìÊûú</h2>
            </div>
            <div class="result-content">
                <!-- ÂàùÂßãÁä∂ÊÄÅ -->
                <div class="initial-state" id="initialState">
                    <div class="initial-icon">üîç</div>
                    <div class="initial-title">ÂáÜÂ§áÂ∞±Áª™</div>
                    <div class="initial-description">
                        Âú®Â∑¶‰æßËæìÂÖ•Êñ∞ÈóªÂÜÖÂÆπÊàñ‰∏ä‰º†Áõ∏ÂÖ≥ÂõæÁâáÔºåÁÇπÂáª"ÂºÄÂßãÊ£ÄÊµã"ÊåâÈíÆÂç≥ÂèØËøõË°åÂÅáÊñ∞ÈóªÂàÜÊûê„ÄÇ
                        Á≥ªÁªüÂ∞ÜÁªºÂêàËØÑ‰º∞ÂÜÖÂÆπÁöÑÁúüÂÆûÊÄßÔºå‰∏∫ÊÇ®Êèê‰æõËØ¶ÁªÜÁöÑÊ£ÄÊµãÊä•Âëä„ÄÇ
                    </div>
                </div>

                <!-- Ê£ÄÊµãÁªìÊûú -->
                <div class="result-item" id="resultItem">
                    <div class="result-score">
                        <div class="score-circle-container" id="scoreCircleContainer">
                            <svg class="score-svg" viewBox="0 0 100 100">
                                <circle class="score-bg" cx="50" cy="50" r="45"></circle>
                                <circle class="score-progress" id="scoreProgress" cx="50" cy="50" r="45"></circle>
                            </svg>
                            <div class="score-text" id="scoreText">0%</div>
                        </div>
                        <div class="score-details">
                            <div class="score-label">ÁúüÂÆûÊÄßËØÑÂàÜ</div>
                            <div class="score-value" id="scoreValue">0%</div>
                            <div class="score-description" id="scoreDescription">Á≠âÂæÖÊ£ÄÊµã...</div>
                        </div>
                    </div>

                    <div class="result-analysis">
                        <div class="analysis-title">ËØ¶ÁªÜÂàÜÊûê</div>
                        <div class="analysis-item">
                            <div class="analysis-icon positive">‚úì</div>
                            <div class="analysis-text">ÂÜÖÂÆπÊù•Ê∫êÂèØÈù†ÔºåÂºïÁî®‰∫ÜÊùÉÂ®ÅÂ™í‰ΩìÁöÑÊï∞ÊçÆ</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-icon positive">‚úì</div>
                            <div class="analysis-text">ËØ≠Ë®ÄË°®ËææÂÆ¢ËßÇÔºåÊó†ÊòéÊòæÊÉÖÁª™ÂåñÂÄæÂêë</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-icon neutral">!</div>
                            <div class="analysis-text">ÈÉ®ÂàÜ‰ø°ÊÅØÈúÄË¶ÅËøõ‰∏ÄÊ≠•Ê†∏ÂÆû</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-icon positive">‚úì</div>
                            <div class="analysis-text">ÂõæÁâáÂÜÖÂÆπ‰∏éÊñáÂ≠óÊèèËø∞Áõ∏Á¨¶</div>
                        </div>
                    </div>

                    <!-- Ëß£ÊûêÂÜÖÂÆπ -->
                    <div class="parsed-content" id="parsedContent" style="display: none;">
                        <h3 class="parsed-title" id="parsedTitle"></h3>
                        <div class="parsed-images" id="parsedImages"></div>
                        <div class="parsed-text" id="parsedText"></div>
                    </div>
                </div>

                <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner-large"></div>
                    <div class="loading-text" id="loadingText">Ê≠£Âú®Ëß£ÊûêÁΩëÈ°µÂÜÖÂÆπ...</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <button class="cancel-extract-btn" id="cancelExtractBtn" style="display: none;"></button>
                </div>

                <!-- ÈîôËØØÁä∂ÊÄÅ -->
                <div class="error-state" id="errorState">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-message">Ëß£ÊûêÂ§±Ë¥•</div>
                    <div class="error-detail" id="errorDetail">Êó†Ê≥ïËé∑ÂèñÁΩëÈ°µÂÜÖÂÆπÔºåËØ∑Ê£ÄÊü•ÈìæÊé•ÊòØÂê¶ÊúâÊïà</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
    <div class="image-modal" id="imageModal">
        <button class="modal-close" id="modalClose">√ó</button>
        <img class="modal-image" id="modalImage" src="" alt="È¢ÑËßàÂõæÁâá">
    </div>

    <!-- Toast ÊèêÁ§∫ -->
    <div class="toast" id="toast"></div>

    <!-- ÂõæÁâáÂè≥ÈîÆËèúÂçï -->
    <div class="context-menu" id="imageContextMenu">
        <div class="context-menu-item" id="contextCopyImage">
            <span class="context-menu-icon">üìã</span>
            <span>Â§çÂà∂ÂõæÁâá</span>
        </div>
        <div class="context-menu-item" id="contextSaveImage">
            <span class="context-menu-icon">üíæ</span>
            <span>Âè¶Â≠ò‰∏∫</span>
        </div>
    </div>

    <!-- Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂºπÁ™ó -->
    <div class="custom-modal" id="customModal">
        <div class="custom-modal-content">
            <div class="custom-modal-title">Á°ÆËÆ§Êìç‰Ωú</div>
            <div class="custom-modal-message">Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂÜÖÂÆπÂêóÔºü</div>
            <div class="custom-modal-actions">
                <button class="custom-modal-btn" id="modalConfirm">Á°ÆÂÆö</button>
                <button class="custom-modal-btn" id="modalCancel">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <script>
                // Êõ¥Â§öÊåâÈíÆ‰∏ãÊãâËèúÂçïÈÄªËæë
                (function initMoreMenu() {
                    const moreBtn = document.getElementById('moreBtn');
                    const dropdown = document.getElementById('moreDropdown');

                    function toggleDropdown(forceState) {
                        const shouldShow = typeof forceState === 'boolean' ? forceState : !dropdown.classList.contains('show');
                        dropdown.classList.toggle('show', shouldShow);
                    }

                    moreBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleDropdown();
                    });

                    moreBtn.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            toggleDropdown();
                        } else if (e.key === 'Escape') {
                            toggleDropdown(false);
                        }
                    });

                    document.addEventListener('pointerdown', function(e) {
                        if (!moreBtn.contains(e.target)) {
                            toggleDropdown(false);
                        }
                    });

                    // Êö¥Èú≤ÂÖ≥Èó≠ÊñπÊ≥ï‰æõÂÖ∂‰ªñÈÄªËæëÂ§çÁî®
                    window.__hideMoreDropdown = () => toggleDropdown(false);
                })();

                // Ê∏ÖÈô§ÊµèËßàÂô®Êï∞ÊçÆÂäüËÉΩ
                document.getElementById('clearBrowserDataBtn').addEventListener('click', async function() {
                    if (window.electronAPI) {
                        const res = await window.electronAPI.invoke('clear-browser-data');
                        if (res && res.success) {
                            showToast('ÊµèËßàÂô®Êï∞ÊçÆÂ∑≤Ê∏ÖÈô§', 'success');
                        } else {
                            showToast('Ê∏ÖÈô§Â§±Ë¥•: ' + (res && res.error ? res.error : 'Êú™Áü•ÈîôËØØ'), 'error');
                        }
                    } else {
                        showToast('ÂΩìÂâçÁéØÂ¢É‰∏çÊîØÊåÅÊ∏ÖÈô§ÊµèËßàÂô®Êï∞ÊçÆ', 'warning');
                    }
                    window.__hideMoreDropdown && window.__hideMoreDropdown();
                });
        // ÂÖ®Â±ÄÂèòÈáè
        let isResizing = false;
        let uploadedImages = [];
        const maxImages = 4;
        let detectedUrls = [];

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            initResizable();
            initTextEditor();
            initImageUpload();
            initButtons();
            initModal();
            initIPC();
            initClipboardBtn();
        });

        // ‰∏ªÈ¢òÂàáÊç¢
        function initTheme() {
            const themeBtn = document.getElementById('themeBtn');
            const themeIconLight = document.getElementById('themeIconLight');
            const themeIconDark = document.getElementById('themeIconDark');
            
            // Ê£ÄÊü•Á≥ªÁªü‰∏ªÈ¢òÂÅèÂ•Ω
            const systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            // ‰ºòÂÖà‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®ÁöÑ‰∏ªÈ¢òÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôË∑üÈöèÁ≥ªÁªü
            const savedTheme = localStorage.getItem('theme');
            const isDark = savedTheme ? (savedTheme === 'dark') : systemDark;

            function updateThemeIcon(isDark) {
                if (isDark) {
                    themeIconLight.style.display = 'none';
                    themeIconDark.style.display = 'inline';
                } else {
                    themeIconLight.style.display = 'inline';
                    themeIconDark.style.display = 'none';
                }
            }

            // Â∫îÁî®ÂàùÂßã‰∏ªÈ¢ò
            if (isDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon(true);
                if (window.electronAPI) {
                    window.electronAPI.invoke('set-theme', true);
                }
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                updateThemeIcon(false);
                if (window.electronAPI) {
                    window.electronAPI.invoke('set-theme', false);
                }
            }

            // ÁõëÂê¨Á≥ªÁªü‰∏ªÈ¢òÂèòÂåñ
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    // Âè™ÊúâÂú®Áî®Êà∑Ê≤°ÊúâÊâãÂä®ËÆæÁΩÆËøá‰∏ªÈ¢òÁöÑÊÉÖÂÜµ‰∏ãÊâçË∑üÈöèÁ≥ªÁªüÂèòÂåñ
                    if (!localStorage.getItem('theme')) {
                        const newIsDark = e.matches;
                        if (newIsDark) {
                            document.documentElement.setAttribute('data-theme', 'dark');
                            updateThemeIcon(true);
                        } else {
                            document.documentElement.setAttribute('data-theme', 'light');
                            updateThemeIcon(false);
                        }
                        if (window.electronAPI) {
                            window.electronAPI.invoke('set-theme', newIsDark);
                        }
                    }
                });
            }

            themeBtn.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                const isDarkMode = newTheme === 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(isDarkMode);

                if (window.electronAPI) {
                    window.electronAPI.invoke('set-theme', isDarkMode)
                        .then(result => {
                            if (!result.success) {
                                console.error('‰∏ªÈ¢òËÆæÁΩÆÂ§±Ë¥•:', result.error);
                            }
                        });
                }

                showToast(`Â∑≤ÂàáÊç¢Âà∞${isDarkMode ? 'Ê∑±Ëâ≤' : 'ÊµÖËâ≤'}Ê®°Âºè`, 'success');
            });
        }

        // ÂèØË∞ÉÊï¥Â§ßÂ∞èÁöÑÂàÜÈöîÁ∫ø
        function initResizable() {
            const resizer = document.getElementById('resizer');
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const container = document.querySelector('.container');

            function handleResizeMove(clientX) {
                const containerRect = container.getBoundingClientRect();
                const percentage = ((clientX - containerRect.left) / containerRect.width) * 100;
                
                const minPercent = 30;
                const maxPercent = 65;
                
                if (percentage > minPercent && percentage < maxPercent) {
                    leftPanel.style.flex = `0 0 ${percentage}%`;
                    rightPanel.style.flex = `0 0 ${100 - percentage}%`;
                } else if (percentage <= minPercent) {
                    leftPanel.style.flex = `0 0 ${minPercent}%`;
                    rightPanel.style.flex = `0 0 ${100 - minPercent}%`;
                } else if (percentage >= maxPercent) {
                    leftPanel.style.flex = `0 0 ${maxPercent}%`;
                    rightPanel.style.flex = `0 0 ${100 - maxPercent}%`;
                }
            }

            // Mouse Events
            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                e.preventDefault();
                handleResizeMove(e.clientX);
            });

            document.addEventListener('mouseup', function() {
                isResizing = false;
                document.body.style.cursor = 'default';
            });

            // Touch Events (Â§çÁî®ÈÄªËæë)
            resizer.addEventListener('touchstart', function(e) {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            }, { passive: false });

            document.addEventListener('touchmove', function(e) {
                if (!isResizing) return;
                e.preventDefault();
                handleResizeMove(e.touches[0].clientX);
            }, { passive: false });

            document.addEventListener('touchend', function() {
                isResizing = false;
                document.body.style.cursor = 'default';
            });
        }

        // ÊñáÊú¨ÁºñËæëÂô®
        function initTextEditor() {
            const textInput = document.getElementById('textInput');
            const editBtn = document.getElementById('editBtn');
            const editOptions = document.getElementById('editOptions');

            // Ëá™Âä®ËØÜÂà´ÈìæÊé•
            textInput.addEventListener('input', function() {
                const text = this.innerText;
                const urlRegex = /(https?:\/\/|www\.)[^\s<]+/g;
                const matches = text.match(urlRegex);
                
                if (matches && matches.length > 0) {
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞ÁöÑÈìæÊé•
                    const newUrls = matches.filter(url => !detectedUrls.includes(url));
                    if (newUrls.length > 0) {
                        detectedUrls = [...detectedUrls, ...newUrls];
                        showToast(`Ê£ÄÊµãÂà∞ ${newUrls.length} ‰∏™ÁΩëÂùÄÈìæÊé•`, 'info');
                    }
                }
            });

            // ÁºñËæëÈÄâÈ°πÂàáÊç¢
            editBtn.addEventListener('click', function() {
                editOptions.classList.toggle('active');
                this.classList.toggle('active');
            });

            // ÁºñËæëÊåâÈíÆÂäüËÉΩ
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const command = this.dataset.command;
                    document.execCommand(command, false, null);
                    textInput.focus();
                });
            });
        }

        // ÂõæÁâá‰∏ä‰º†
        function initImageUpload() {
            const leftPanel = document.getElementById('leftPanel');
            const fileInput = document.getElementById('fileInput');
            const imagePreview = document.getElementById('imagePreview');
            const imageBtn = document.getElementById('imageBtn');

            // ÂõæÁâáÊåâÈíÆÁÇπÂáª
            imageBtn.addEventListener('click', function() {
                if (uploadedImages.length >= maxImages) {
                    showToast(`ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†${maxImages}Âº†ÂõæÁâá`, 'warning');
                    return;
                }
                fileInput.click();
            });

            // Êñá‰ª∂ÈÄâÊã©
            fileInput.addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });

            // ÊãñÊãΩ‰∏ä‰º† - ÁªëÂÆöÂà∞Â∑¶‰æßÈù¢Êùø
            const dragOverlay = document.getElementById('dragOverlay');
            leftPanel.addEventListener('dragover', function(e) {
                e.preventDefault();
                // Ê£ÄÊü•ÊãñÂÖ•ÁöÑÊñá‰ª∂Á±ªÂûãÊàñURL
                let isAllImage = false;
                if (e.dataTransfer) {
                    // ‰ºòÂÖàÊ£ÄÊµãÊñá‰ª∂ÂàóË°®
                    if (e.dataTransfer.items) {
                        for (let i = 0; i < e.dataTransfer.items.length; i++) {
                            const t = e.dataTransfer.items[i].type || '';
                            if (t.startsWith('image/')) {
                                isAllImage = true;
                                break;
                            }
                            // ÊîØÊåÅÊãñÂä®ÂõæÁâá URLÔºàÂÖ∂‰ªñÂÖÉÁ¥†‰º†ÈÄí‰∏∫ text/uri-list Êàñ text/plainÔºâ
                            if (t === 'text/uri-list' || t === 'text/plain') {
                                isAllImage = true;
                                break;
                            }
                        }
                    }
                }
                dragOverlay.classList.add('active');
                dragOverlay.classList.remove('error', 'success', 'full');
                if (uploadedImages.length >= maxImages) {
                    dragOverlay.classList.add('full');
                    dragOverlay.textContent = 'ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†4Âº†ÂõæÁâá';
                } else if (isAllImage) {
                    dragOverlay.classList.add('success');
                    dragOverlay.textContent = 'ÊãñÂÖ•ÂõæÁâá‰ª•Ê∑ªÂä†';
                } else {
                    dragOverlay.classList.add('error');
                    dragOverlay.textContent = '‰ªÖÊîØÊåÅÂõæÁâáÊñá‰ª∂';
                }
            });
            leftPanel.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dragOverlay.classList.remove('active', 'error', 'success', 'full');
                dragOverlay.textContent = 'ÊãñÂÖ•ÂõæÁâá‰ª•Ê∑ªÂä†';
            });
            leftPanel.addEventListener('drop', function(e) {
                e.preventDefault();
                dragOverlay.classList.remove('active', 'error', 'success', 'full');
                dragOverlay.textContent = 'ÊãñÂÖ•ÂõæÁâá‰ª•Ê∑ªÂä†';
                // Ê£ÄÊü•ÊòØÂê¶ÂÖ®ÈÉ®‰∏∫ÂõæÁâá
                // ‰ºòÂÖàÂ§ÑÁêÜÊñá‰ª∂
                if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    // Â¶ÇÊûúÂåÖÂê´Êñá‰ª∂ÔºåÊåâÂéüÈÄªËæëÂ§ÑÁêÜ
                    if (uploadedImages.length >= maxImages) {
                        showToast(`ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†${maxImages}Âº†ÂõæÁâá`, 'warning');
                        return;
                    }
                    handleFiles(e.dataTransfer.files);
                    return;
                }

                // Â¶ÇÊûúÊ≤°ÊúâÊñá‰ª∂ÔºåÂ∞ùËØïËØªÂèñ URLÔºàtext/uri-list Êàñ text/plainÔºâ
                let url = '';
                try {
                    if (e.dataTransfer) {
                        url = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain') || '';
                    }
                } catch (err) {
                    url = '';
                }

                if (url) {
                    if (uploadedImages.length >= maxImages) {
                        showToast(`ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†${maxImages}Âº†ÂõæÁâá`, 'warning');
                        return;
                    }
                    // ÁÆÄÂçïÂà§Êñ≠ÊòØÂê¶‰∏∫ÂõæÁâáÈìæÊé•ÔºàÊâ©Â±ïÂêçÊàñ data:Ôºâ
                    const lower = url.toLowerCase();
                    const isLikelyImage = lower.startsWith('data:') || /(\.png|\.jpe?g|\.gif|\.webp|\.bmp|\.svg)(\?.*)?$/.test(lower) || /^https?:\/\/.+\.(png|jpe?g|gif|webp|bmp|svg)(\?.*)?$/i.test(url);
                    const imagePreview = document.getElementById('imagePreview');
                    const nameFromUrl = url.split('/').pop().split('?')[0];
                    const imageData = {
                        id: Date.now() + Math.random(),
                        url: url,
                        name: nameFromUrl || 'ËøúÁ®ãÂõæÁâá'
                    };
                    // Â¶ÇÊûú‰∏çÊòØÊòæÁÑ∂‰∏∫ÂõæÁâáÔºå‰πüÂÖÅËÆ∏Âä†ÂÖ•ÔºàÊµèËßàÂô®‰ºöÊ†πÊçÆ src ÊòæÁ§∫ÊàñÂ§±Ë¥•Ôºâ
                    uploadedImages.push(imageData);
                    // ‰ΩøÁî®Â∑≤ÊúâÊ∏≤ÊüìÂáΩÊï∞Êõ¥Êñ∞ UI
                    renderImages();
                    showToast('ÂõæÁâáÂ∑≤‰ªéÂè≥‰æßÊ∑ªÂä†', 'success');
                    return;
                }

                showToast('Êó†ÂèØÁî®ÂõæÁâáÊàñ‰∏çÊîØÊåÅÁöÑÊãñÊîæÂÜÖÂÆπ', 'error');
            });

            // Á≤òË¥¥‰∏ä‰º†
            document.addEventListener('paste', function(e) {
                const items = e.clipboardData.items;
                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (uploadedImages.length < maxImages) {
                            handleFiles([file]);
                        } else {
                            showToast(`ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†${maxImages}Âº†ÂõæÁâá`, 'warning');
                        }
                    }
                }
            });

            // Â§ÑÁêÜÊñá‰ª∂
            function handleFiles(files) {
                // Êñ∞Â¢ûÔºöÂè™ÂÖÅËÆ∏Ê∑ªÂä†Ââ©‰ΩôÊï∞ÈáèÁöÑÂõæÁâá
                const remain = maxImages - uploadedImages.length;
                if (remain <= 0) {
                    showToast(`ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†${maxImages}Âº†ÂõæÁâá`, 'warning');
                    return;
                }
                let addedCount = 0;
                let validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                // Âè™ÂèñÂâ©‰ΩôÊï∞ÈáèÁöÑÂõæÁâá
                validFiles = validFiles.slice(0, remain);
                validFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            id: Date.now() + Math.random(),
                            url: e.target.result,
                            name: file.name
                        };
                        uploadedImages.push(imageData);
                        renderImages();
                        showToast('ÂõæÁâá‰∏ä‰º†ÊàêÂäü', 'success');
                    };
                    reader.readAsDataURL(file);
                    addedCount++;
                });
                if (files.length > 0 && addedCount === 0) {
                    showToast(`ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†${maxImages}Âº†ÂõæÁâá`, 'warning');
                }
            }

            // Ê∏≤ÊüìÂõæÁâá
            function renderImages() {
                imagePreview.innerHTML = '';
                uploadedImages.forEach((image, index) => {
                    const item = document.createElement('div');
                    item.className = 'image-preview-item';
                    item.setAttribute('draggable', 'true');
                    item.setAttribute('data-id', image.id);
                    item.setAttribute('data-index', index);
                    item.innerHTML = `
                        <img src="${image.url}" alt="${image.name}">
                        <button class="image-delete-btn" data-id="${image.id}">√ó</button>
                    `;
                    
                    const imgElement = item.querySelector('img');
                    
                    // Click to view
                    imgElement.addEventListener('click', function(e) {
                        if (!item.classList.contains('dragging')) {
                            showImageModal(image.url);
                        }
                    });
                    
                    // Delete button
                    item.querySelector('.image-delete-btn').addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteImage(image.id);
                    });
                    
                    // Drag and drop for reordering
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragend', handleDragEnd);
                    item.addEventListener('dragover', handleDragOver);
                    item.addEventListener('drop', handleDrop);
                    item.addEventListener('dragleave', handleDragLeave);
                    
                    // Context menu (right-click)
                    item.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        showImageContextMenu(e, image);
                    });
                    
                    // Touch events
                    setupTouchEvents(item, image);
                    
                    imagePreview.appendChild(item);
                });
            }

            // Âà†Èô§ÂõæÁâá
            function deleteImage(id) {
                uploadedImages = uploadedImages.filter(img => img.id !== id);
                renderImages();
                showToast('ÂõæÁâáÂ∑≤Âà†Èô§', 'success');
            }

            // Drag and drop handlers for reordering
            let draggedItem = null;
            let draggedIndex = null;

            function handleDragStart(e) {
                draggedItem = this;
                draggedIndex = parseInt(this.getAttribute('data-index'));
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
            }

            function handleDragEnd(e) {
                this.classList.remove('dragging');
                // Remove all drag-over classes
                document.querySelectorAll('.image-preview-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
                draggedItem = null;
                draggedIndex = null;
            }

            function handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                
                const targetItem = this;
                if (targetItem !== draggedItem && targetItem.classList.contains('image-preview-item')) {
                    targetItem.classList.add('drag-over');
                }
                
                return false;
            }

            function handleDragLeave(e) {
                this.classList.remove('drag-over');
            }

            function handleDrop(e) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                
                const targetItem = this;
                const targetIndex = parseInt(targetItem.getAttribute('data-index'));
                
                if (draggedItem && draggedItem !== targetItem && draggedIndex !== null) {
                    // Reorder the array
                    const draggedImage = uploadedImages[draggedIndex];
                    uploadedImages.splice(draggedIndex, 1);
                    uploadedImages.splice(targetIndex, 0, draggedImage);
                    
                    // Re-render
                    renderImages();
                    showToast('ÂõæÁâáÈ°∫Â∫èÂ∑≤Ë∞ÉÊï¥', 'success');
                }
                
                return false;
            }

            // Context menu for images
            let currentContextImage = null;

            function showImageContextMenu(e, image) {
                const menu = document.getElementById('imageContextMenu');
                currentContextImage = image;
                
                // Position the menu
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
                menu.classList.add('active');
                
                // Close menu on click outside
                setTimeout(() => {
                    document.addEventListener('click', closeContextMenu);
                }, 0);
            }

            function closeContextMenu() {
                const menu = document.getElementById('imageContextMenu');
                menu.classList.remove('active');
                document.removeEventListener('click', closeContextMenu);
                currentContextImage = null;
            }

            // Context menu actions
            function initContextMenu() {
                const copyBtn = document.getElementById('contextCopyImage');
                const saveBtn = document.getElementById('contextSaveImage');
                
                copyBtn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    if (!currentContextImage) return;
                    
                    try {
                        // For data URLs, we can copy directly
                        if (currentContextImage.url.startsWith('data:')) {
                            const response = await fetch(currentContextImage.url);
                            const blob = await response.blob();
                            await navigator.clipboard.write([
                                new ClipboardItem({ [blob.type]: blob })
                            ]);
                            showToast('ÂõæÁâáÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
                        } else {
                            // For remote URLs, we need to fetch first
                            const response = await fetch(currentContextImage.url);
                            const blob = await response.blob();
                            await navigator.clipboard.write([
                                new ClipboardItem({ [blob.type]: blob })
                            ]);
                            showToast('ÂõæÁâáÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
                        }
                    } catch (err) {
                        console.error('Failed to copy image:', err);
                        showToast('Â§çÂà∂ÂõæÁâáÂ§±Ë¥•', 'error');
                    }
                    
                    closeContextMenu();
                });
                
                saveBtn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    if (!currentContextImage) return;
                    
                    try {
                        // Create a temporary link to download
                        const link = document.createElement('a');
                        link.href = currentContextImage.url;
                        link.download = currentContextImage.name || 'image.jpg';
                        
                        // For data URLs, we can download directly
                        if (currentContextImage.url.startsWith('data:')) {
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            showToast('ÂõæÁâáÂ∑≤‰øùÂ≠ò', 'success');
                        } else {
                            // For remote URLs, fetch and create blob URL
                            const response = await fetch(currentContextImage.url);
                            const blob = await response.blob();
                            const blobUrl = URL.createObjectURL(blob);
                            link.href = blobUrl;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(blobUrl);
                            showToast('ÂõæÁâáÂ∑≤‰øùÂ≠ò', 'success');
                        }
                    } catch (err) {
                        console.error('Failed to save image:', err);
                        showToast('‰øùÂ≠òÂõæÁâáÂ§±Ë¥•', 'error');
                    }
                    
                    closeContextMenu();
                });
            }

            // Touch events support
            function setupTouchEvents(item, image) {
                let touchStartTime = 0;
                let longPressTimer = null;
                let touchStartX = 0;
                let touchStartY = 0;
                let isDragging = false;
                let touchMoved = false;
                const longPressDuration = 500; // 500ms for long press
                
                item.addEventListener('touchstart', function(e) {
                    touchStartTime = Date.now();
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    touchMoved = false;
                    isDragging = false;
                    
                    // Start long press timer for context menu
                    longPressTimer = setTimeout(() => {
                        if (!touchMoved) {
                            // Long press detected - show context menu
                            e.preventDefault();
                            showImageContextMenu({
                                pageX: touchStartX,
                                pageY: touchStartY
                            }, image);
                            
                            // Vibrate if supported
                            if (navigator.vibrate) {
                                navigator.vibrate(50);
                            }
                        }
                    }, longPressDuration);
                }, { passive: false });
                
                item.addEventListener('touchmove', function(e) {
                    const touchX = e.touches[0].clientX;
                    const touchY = e.touches[0].clientY;
                    const deltaX = Math.abs(touchX - touchStartX);
                    const deltaY = Math.abs(touchY - touchStartY);
                    
                    // If moved more than 10px, consider it as moving
                    if (deltaX > 10 || deltaY > 10) {
                        touchMoved = true;
                        clearTimeout(longPressTimer);
                        
                        // Start drag operation if long press was initiated
                        if (Date.now() - touchStartTime > longPressDuration && !isDragging) {
                            isDragging = true;
                            item.classList.add('dragging');
                        }
                        
                        // If dragging, find the drop target
                        if (isDragging) {
                            e.preventDefault();
                            const targetElement = document.elementFromPoint(touchX, touchY);
                            const targetItem = targetElement?.closest('.image-preview-item');
                            
                            // Remove drag-over from all items
                            document.querySelectorAll('.image-preview-item').forEach(el => {
                                if (el !== item) el.classList.remove('drag-over');
                            });
                            
                            // Add drag-over to current target
                            if (targetItem && targetItem !== item) {
                                targetItem.classList.add('drag-over');
                            }
                        }
                    }
                }, { passive: false });
                
                item.addEventListener('touchend', function(e) {
                    clearTimeout(longPressTimer);
                    
                    // If it was a drag operation, handle drop
                    if (isDragging) {
                        const touchX = e.changedTouches[0].clientX;
                        const touchY = e.changedTouches[0].clientY;
                        const targetElement = document.elementFromPoint(touchX, touchY);
                        const targetItem = targetElement?.closest('.image-preview-item');
                        
                        if (targetItem && targetItem !== item) {
                            const sourceIndex = parseInt(item.getAttribute('data-index'));
                            const targetIndex = parseInt(targetItem.getAttribute('data-index'));
                            
                            // Reorder the array
                            const draggedImage = uploadedImages[sourceIndex];
                            uploadedImages.splice(sourceIndex, 1);
                            uploadedImages.splice(targetIndex, 0, draggedImage);
                            
                            // Re-render
                            renderImages();
                            showToast('ÂõæÁâáÈ°∫Â∫èÂ∑≤Ë∞ÉÊï¥', 'success');
                        }
                        
                        item.classList.remove('dragging');
                        document.querySelectorAll('.image-preview-item').forEach(el => {
                            el.classList.remove('drag-over');
                        });
                        
                        e.preventDefault();
                    } else if (!touchMoved && Date.now() - touchStartTime < longPressDuration) {
                        // Short tap - show image modal
                        // Check if not clicking the delete button
                        if (!e.target.classList.contains('image-delete-btn')) {
                            showImageModal(image.url);
                        }
                    }
                    
                    isDragging = false;
                }, { passive: false });
                
                item.addEventListener('touchcancel', function(e) {
                    clearTimeout(longPressTimer);
                    item.classList.remove('dragging');
                    document.querySelectorAll('.image-preview-item').forEach(el => {
                        el.classList.remove('drag-over');
                    });
                    isDragging = false;
                });
            }

            // Initialize context menu
            initContextMenu();
        }

        // Ëá™ÂÆö‰πâÂºπÁ™óÈÄªËæë
        function showCustomModal(options) {
            // ÂÖºÂÆπÊóßÁî®Ê≥ï: showCustomModal(onConfirm, onCancel)
            if (typeof options === 'function') {
                options = {
                    onConfirm: options,
                    onCancel: arguments[1],
                    title: 'Á°ÆËÆ§Êìç‰Ωú',
                    message: 'Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂÜÖÂÆπÂêóÔºü',
                    confirmText: 'Á°ÆÂÆö',
                    cancelText: 'ÂèñÊ∂à'
                };
            }

            const modal = document.getElementById('customModal');
            const titleEl = modal.querySelector('.custom-modal-title');
            const messageEl = modal.querySelector('.custom-modal-message');
            const confirmBtn = document.getElementById('modalConfirm');
            const cancelBtn = document.getElementById('modalCancel');
            
            // Êü•ÊâæÊàñÂàõÂª∫Á¨¨‰∏â‰∏™ÊåâÈíÆ
            let optionBtn = document.getElementById('modalOption');
            if (!optionBtn) {
                optionBtn = document.createElement('button');
                optionBtn.id = 'modalOption';
                optionBtn.className = 'custom-modal-btn secondary';
                optionBtn.style.display = 'none';
                // ÊèíÂÖ•Âà∞ confirmBtn ‰πãÂâç
                confirmBtn.parentNode.insertBefore(optionBtn, confirmBtn);
            }

            titleEl.textContent = options.title || 'Á°ÆËÆ§Êìç‰Ωú';
            messageEl.textContent = options.message || 'Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂÜÖÂÆπÂêóÔºü';
            confirmBtn.textContent = options.confirmText || 'Á°ÆÂÆö';
            cancelBtn.textContent = options.cancelText || 'ÂèñÊ∂à';

            if (options.optionText) {
                optionBtn.textContent = options.optionText;
                optionBtn.style.display = 'inline-block';
                optionBtn.onclick = function() {
                    modal.classList.remove('active');
                    if (options.onOption) options.onOption();
                };
            } else {
                optionBtn.style.display = 'none';
            }

            modal.classList.add('active');
            
            // Ëß£ÁªëÊóß‰∫ã‰ª∂
            confirmBtn.onclick = function() {
                modal.classList.remove('active');
                if (options.onConfirm) options.onConfirm();
            };
            cancelBtn.onclick = function() {
                modal.classList.remove('active');
                if (options.onCancel) options.onCancel();
            };
        }

        // ÊåâÈíÆÂäüËÉΩ
        function initButtons() {
            // Ripple Effect (ÊéíÈô§Êõ¥Â§öÊåâÈíÆ)
            document.querySelectorAll('.toolbar-btn:not(.more-menu), .detect-btn, .custom-modal-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    ripple.classList.add('ripple');
                    this.appendChild(ripple);
                    
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    
                    ripple.style.width = ripple.style.height = `${size}px`;
                    ripple.style.left = `${e.clientX - rect.left - size/2}px`;
                    ripple.style.top = `${e.clientY - rect.top - size/2}px`;
                    
                    ripple.addEventListener('animationend', () => {
                        ripple.remove();
                    });
                });
            });

            // È°µÈù¢È¢ÑËßàÂäüËÉΩ
            document.getElementById('previewBtn').addEventListener('click', function() {
                const text = document.getElementById('textInput').innerText.trim();
                
                if (!text && uploadedImages.length === 0) {
                    showToast('Ê≤°ÊúâÂèØÈ¢ÑËßàÁöÑÂÜÖÂÆπ', 'warning');
                    return;
                }

                if (isURL(text)) {
                    // URL Preview
                    extractContent(text, true);
                } else {
                    // Local Preview
                    renderPreview(text, uploadedImages);
                    showToast('Â∑≤ÁîüÊàêÊú¨Âú∞È¢ÑËßà', 'success');
                }
            });

            // Ê∏ÖÁ©∫ÊåâÈíÆ
            document.getElementById('clearBtn').addEventListener('click', function() {
                showCustomModal(() => {
                    document.getElementById('textInput').innerText = '';
                    uploadedImages = [];
                    detectedUrls = [];
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('initialState').style.display = 'flex';
                    document.getElementById('resultItem').classList.remove('active');
                    document.getElementById('errorState').classList.remove('active');
                    document.getElementById('loadingState').classList.remove('active');
                    showToast('ÂÜÖÂÆπÂ∑≤Ê∏ÖÁ©∫', 'success');
                });
            });

            // Ê£ÄÊµãÊåâÈíÆ
            let lastTextContent = '';
            let lastImages = [];
            document.getElementById('detectBtn').addEventListener('click', function() {
                const textContent = document.getElementById('textInput').innerText.trim();
                // ‰ºòÂÖàÂà§Êñ≠ÂÜÖÂÆπÊòØÂê¶‰∏∫Á©∫
                if (!textContent) {
                    if (uploadedImages.length > 0) {
                        showToast('ËØ∑Ê∑ªÂä†Áõ∏ÂÖ≥ÁöÑÊñáÊú¨ÂÜÖÂÆπ‰ª•ËøõË°åÊ£ÄÊµã', 'warning');
                    } else {
                        showToast('ËØ∑ËæìÂÖ•ÈúÄË¶ÅÊ£ÄÊµãÁöÑÊñ∞ÈóªÂÜÖÂÆπ', 'warning');
                    }
                    return;
                }
                // Âà§Êñ≠ÂÜÖÂÆπÂíåÂõæÁâáÊòØÂê¶ÊúâÂèòÂåñ
                const imagesNow = uploadedImages.map(img => img.url).join(',');
                const imagesLast = lastImages.join(',');
                // Ê£ÄÊü•Âè≥‰æßÊòØÂê¶‰∏∫Á©∫ÔºàÂàùÂßãÁä∂ÊÄÅÊòØÂê¶ÊòæÁ§∫Ôºâ
                const isResultEmpty = document.getElementById('initialState').style.display !== 'none';
                // Ê£ÄÊü•ÊòØÂê¶Â§Ñ‰∫éÈîôËØØÁä∂ÊÄÅ
                const isErrorState = document.getElementById('errorState').classList.contains('active');
                
                if (textContent === lastTextContent && imagesNow === imagesLast && !isResultEmpty && !isErrorState) {
                    showToast('ÂÜÖÂÆπÊú™ÂèòÂåñÔºåÊó†ÈúÄÈáçÂ§çÊ£ÄÊµã', 'info');
                    return;
                }
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫URL
                if (isURL(textContent)) {
                    if (uploadedImages.length > 0) {
                        // ÂºπÂá∫ËØ¢ÈóÆÂØπËØùÊ°Ü
                        showCustomModal({
                            title: 'Ê£ÄÊµãÂà∞ÈìæÊé•ÂíåÂõæÁâá',
                            message: 'ÊÇ®ËæìÂÖ•‰∫ÜÈìæÊé•ÂêåÊó∂‰πü‰∏ä‰º†‰∫ÜÂõæÁâáÔºåËØ∑ÈÄâÊã©Â§ÑÁêÜÊñπÂºèÔºö',
                            confirmText: '‰ªÖÊèêÂèñÈìæÊé•ÂÜÖÂÆπ', // ÂØπÂ∫î extractContent
                            optionText: 'ÂõæÊñáÊ∑∑ÂêàÂàÜÊûê', // ÂØπÂ∫î analyzeContent
                            cancelText: 'ÂèñÊ∂à',
                            onConfirm: () => {
                                window.lastExtractedUrl = textContent;
                                extractContent(textContent);
                            },
                            onOption: () => {
                                window.lastExtractedUrl = null;
                                analyzeContent(textContent, uploadedImages);
                            },
                            onCancel: () => {
                                // ÂèñÊ∂àÔºå‰∏çÂÅö‰ªª‰Ωï‰∫ã
                            }
                        });
                        return;
                    }
                    
                    window.lastExtractedUrl = textContent;
                    extractContent(textContent);
                } else {
                    window.lastExtractedUrl = null;
                    analyzeContent(textContent, uploadedImages);
                }
                // ËÆ∞ÂΩïÊú¨Ê¨°ÂÜÖÂÆπÂíåÂõæÁâá
                lastTextContent = textContent;
                lastImages = uploadedImages.map(img => img.url);
            });
        }

        // Ê£ÄÊü•ÊòØÂê¶‰∏∫URL
        function isURL(text) {
            try {
                new URL(text);
                return true;
            } catch {
                return false;
            }
        }

        // ÂÜÖÂÆπÊèêÂèñÂäüËÉΩ
        function extractContent(url, isPreview = false) {
            const detectBtn = document.getElementById('detectBtn');
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const progressBar = document.getElementById('progressBar');
            const loadingText = document.getElementById('loadingText');
            const cancelBtn = document.getElementById('cancelExtractBtn');

            // ÈáçÁΩÆÁä∂ÊÄÅ
            initialState.style.display = 'none';
            resultItem.classList.remove('active');
            errorState.classList.remove('active');
            loadingState.classList.add('active');
            
            // ÊòæÁ§∫ÂèñÊ∂àÊåâÈíÆ
            if (cancelBtn) cancelBtn.style.display = 'block';
            
            // ÂàùÂßãÂåñËøõÂ∫¶Êù°
            progressBar.style.width = '0%';
            loadingText.textContent = isPreview ? 'Ê≠£Âú®Ëß£ÊûêÁΩëÈ°µ‰ª•È¢ÑËßà...' : 'Ê≠£Âú®Ëß£ÊûêÁΩëÈ°µÂÜÖÂÆπ...';

            detectBtn.classList.add('loading');
            detectBtn.innerHTML = isPreview ? 'È¢ÑËßà‰∏≠...' : 'ÊèêÂèñ‰∏≠...';

            // Ê®°ÊãüËøõÂ∫¶Â¢ûÈïø
            let progress = 10;
            const progressInterval = setInterval(() => {
                if (progress < 45) {
                    progress += 1;
                    progressBar.style.width = progress + '%';
                }
            }, 200);

            let timeoutId;
            let finished = false;
            
            // ÂèñÊ∂àÂ§ÑÁêÜÈÄªËæë
            function handleCancel() {
                if (finished) return;
                finished = true;
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                
                loadingState.classList.remove('active');
                detectBtn.classList.remove('loading');
                detectBtn.innerHTML = 'ÂºÄÂßãÊ£ÄÊµã';
                if (cancelBtn) cancelBtn.style.display = 'none';
                
                // ÊÅ¢Â§çÂàùÂßãÁä∂ÊÄÅ
                initialState.style.display = 'flex';
                
                showToast('Áî®Êà∑Â∑≤ÂèñÊ∂à', 'info');
            }

            // ÁªëÂÆöÂèñÊ∂àÊåâÈíÆ‰∫ã‰ª∂
            if (cancelBtn) {
                cancelBtn.onclick = function() {
                    if (finished) return;
                    if (window.electronAPI) {
                        window.electronAPI.send('cancel-extraction');
                    } else {
                        handleCancel();
                    }
                };
            }

            // Ë∂ÖÊó∂Â§ÑÁêÜÂáΩÊï∞
            function handleTimeout() {
                if (finished) return;
                finished = true;
                clearInterval(progressInterval);
                loadingState.classList.remove('active');
                detectBtn.classList.remove('loading');
                detectBtn.innerHTML = 'ÂºÄÂßãÊ£ÄÊµã';
                if (cancelBtn) cancelBtn.style.display = 'none';
                showError('ÁΩëÈ°µÂÜÖÂÆπÊèêÂèñË∂ÖÊó∂ÔºåËØ∑Á®çÂêéÈáçËØï');
                showToast('ÊèêÂèñÂ§±Ë¥•ÔºöË∂ÖÊó∂', 'error');
            }
            timeoutId = setTimeout(handleTimeout, 10000);

            // Ë∞ÉÁî®‰∏ªËøõÁ®ãÁöÑÂÜÖÂÆπÊèêÂèñÂäüËÉΩ
            if (window.electronAPI) {
                window.electronAPI.send('extract-content', url);
                
                // ÁõëÂê¨‰∏ÄÊ¨°ÊÄßÁªìÊûúÔºàÈò≤Ê≠¢Â§öÊ¨°Ëß¶ÂèëÔºâ
                const handler = function(event, result) {
                    if (finished) return;
                    finished = true;
                    clearTimeout(timeoutId);
                    clearInterval(progressInterval);
                    if (cancelBtn) cancelBtn.style.display = 'none';
                    
                    if (result.success) {
                        if (isPreview) {
                            progressBar.style.width = '100%';
                            loadingState.classList.remove('active');
                            detectBtn.classList.remove('loading');
                            detectBtn.innerHTML = 'ÂºÄÂßãÊ£ÄÊµã';
                            renderPreview(result.content, result.images, result.title);
                            showToast('ÁΩëÈ°µÈ¢ÑËßàÂ∑≤ÁîüÊàê', 'success');
                        } else {
                            // ÊèêÂèñÊàêÂäüÔºåËøõÂ∫¶ËÆæ‰∏∫50%
                            progressBar.style.width = '50%';
                            loadingText.textContent = 'Ê≠£Âú®ÂàÜÊûêÊñ∞Èóª‰∏≠...';
                            
                            // showExtractedResult(result);
                            showToast('ÊèêÂèñÂÆåÊàêÔºåÊ≠£Âú®ËøõË°åAIÂàÜÊûê...', 'success');
                            // ‰º†ÈÄí true Ë°®Á§∫‰ªéÊèêÂèñÊµÅÁ®ãËøõÂÖ•
                            analyzeContent(result.content, result.images, true);
                        }
                    } else {
                        if (result.error === 'ÊèêÂèñÂ∑≤ÂèñÊ∂à') return; // Áî± cancelled ‰∫ã‰ª∂Â§ÑÁêÜ
                        
                        detectBtn.classList.remove('loading');
                        detectBtn.innerHTML = 'ÂºÄÂßãÊ£ÄÊµã';
                        showError(result.error);
                        showToast('ÊèêÂèñÂ§±Ë¥•: ' + result.error, 'error');
                    }
                    window.electronAPI.off && window.electronAPI.off('extract-content-result', handler);
                    window.electronAPI.off && window.electronAPI.off('extraction-cancelled', cancelListener);
                };
                
                const cancelListener = function() {
                    handleCancel();
                    window.electronAPI.off && window.electronAPI.off('extract-content-result', handler);
                    window.electronAPI.off && window.electronAPI.off('extraction-cancelled', cancelListener);
                };

                // ÂÖºÂÆπÊÄßÔºöÂ¶ÇÊó†offÊñπÊ≥ïÂàô‰∏çËß£Áªë
                window.electronAPI.on('extract-content-result', handler);
                window.electronAPI.once('extraction-cancelled', cancelListener);
            } else {
                // Ê®°ÊãüÊèêÂèñÁªìÊûú
                setTimeout(() => {
                    if (finished) return;
                    finished = true;
                    clearTimeout(timeoutId);
                    clearInterval(progressInterval);
                    if (cancelBtn) cancelBtn.style.display = 'none';
                    
                    // Ê®°ÊãüÊï∞ÊçÆ
                    const mockResult = {
                        success: true,
                        title: 'Á§∫‰æãÊñ∞ÈóªÊ†áÈ¢ò',
                        content: 'ËøôÊòØ‰∏Ä‰∏™Ê®°ÊãüÁöÑÊñ∞ÈóªÂÜÖÂÆπÊèêÂèñÁªìÊûú„ÄÇËøôÈáå‰ºöÊòæÁ§∫‰ªéÁΩëÈ°µËß£ÊûêÂá∫Êù•ÁöÑÊ≠£ÊñáÂÜÖÂÆπ„ÄÇ',
                        images: ['https://via.placeholder.com/300'],
                        url: url
                    };
                    
                    if (isPreview) {
                        progressBar.style.width = '100%';
                        loadingState.classList.remove('active');
                        detectBtn.classList.remove('loading');
                        detectBtn.innerHTML = 'ÂºÄÂßãÊ£ÄÊµã';
                        renderPreview(mockResult.content, mockResult.images, mockResult.title);
                        showToast('ÁΩëÈ°µÈ¢ÑËßàÂ∑≤ÁîüÊàê', 'success');
                    } else {
                        progressBar.style.width = '50%';
                        loadingText.textContent = 'Ê≠£Âú®ÂàÜÊûêÊñ∞Èóª‰∏≠...';
                        
                        showToast('ÊèêÂèñÂÆåÊàê', 'success');
                        analyzeContent(mockResult.content, mockResult.images, true);
                    }
                }, 2000);
            }
        }

        // Ê∏≤ÊüìÈ¢ÑËßàÂÜÖÂÆπÔºàÈöêËóèËØÑÂàÜÂíåËßÇÁÇπÔºâ
        function renderPreview(text, images, title = null) {
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            // Hide Score and Analysis
            const scoreSection = resultItem.querySelector('.result-score');
            const analysisSection = resultItem.querySelector('.result-analysis');
            if(scoreSection) scoreSection.style.display = 'none';
            if(analysisSection) analysisSection.style.display = 'none';

            // Show Content
            parsedContent.style.display = 'block';
            parsedTitle.textContent = title || '';
            parsedTitle.style.display = title ? 'block' : 'none';
            parsedText.textContent = text || '';
            
            // Render Images
            parsedImages.innerHTML = '';
            let imagesToRender = [];
            if (images && images.length > 0) {
                 const limitedImages = images.slice(0, 4);
                 imagesToRender = limitedImages.map(img => typeof img === 'string' ? {url: img, name: 'Image'} : img);
            }
            
            imagesToRender.forEach(img => {
                const item = document.createElement('div');
                item.className = 'parsed-image-item';
                item.innerHTML = `<img src="${img.url}" alt="${img.name}">`;
                item.addEventListener('click', () => showImageModal(img.url));
                parsedImages.appendChild(item);
            });
            
            initialState.style.display = 'none';
            resultItem.classList.add('active');
        }

        // ÂàùÂßãÂåñIPCÈÄö‰ø°
        function initIPC() {
            if (window.electronAPI) {
                // ÁõëÂê¨ÂÜÖÂÆπÊèêÂèñÁªìÊûú - Â∑≤ÁßªËá≥ extractContent ÂáΩÊï∞‰∏≠ÂçïÁã¨Â§ÑÁêÜÔºåÈÅøÂÖçÂÜ≤Á™Å
                /*
                window.electronAPI.on('extract-content-result', function(event, result) {
                    const detectBtn = document.getElementById('detectBtn');
                    detectBtn.classList.remove('loading');
                    detectBtn.innerHTML = 'ÂºÄÂßãÊ£ÄÊµã';

                    if (result.success) {
                        // ÊòæÁ§∫ÊèêÂèñÁªìÊûú
                        showExtractedResult(result);
                        showToast('ÊèêÂèñÂÆåÊàê', 'success');
                    } else {
                        showError(result.error);
                        showToast('ÊèêÂèñÂ§±Ë¥•: ' + result.error, 'error');
                    }
                });
                */

                // ÁõëÂê¨Ê∏ÖÈô§ÂÜÖÂÆπÔºàÁõ¥Êé•Ê∏ÖÁ©∫Ôºâ‰∫ã‰ª∂Ôºå‰øùÁïô‰ª•ÂÖºÂÆπÊóßÈÄªËæë
                window.electronAPI.on('clear-results', function() {
                    document.getElementById('initialState').style.display = 'flex';
                    document.getElementById('resultItem').classList.remove('active');
                    document.getElementById('errorState').classList.remove('active');
                    document.getElementById('loadingState').classList.remove('active');
                });

                // ÁõëÂê¨‰∏ªËøõÁ®ãËØ∑Ê±ÇÊòæÁ§∫Ê∏ÖÁ©∫Á°ÆËÆ§ÂºπÁ™óÔºàÊù•Ëá™Âè≥ÈîÆËèúÂçïÔºâ
                window.electronAPI.on('request-clear', function() {
                    showCustomModal(() => {
                        // Á°ÆËÆ§ÂêéÊâßË°åÂêåÊ†∑ÁöÑÊ∏ÖÁ©∫ÈÄªËæë
                        document.getElementById('textInput').innerText = '';
                        uploadedImages = [];
                        detectedUrls = [];
                        document.getElementById('imagePreview').innerHTML = '';
                        document.getElementById('initialState').style.display = 'flex';
                        document.getElementById('resultItem').classList.remove('active');
                        document.getElementById('errorState').classList.remove('active');
                        document.getElementById('loadingState').classList.remove('active');
                        showToast('ÂÜÖÂÆπÂ∑≤Ê∏ÖÁ©∫', 'success');
                    }, () => {
                        // ÂèñÊ∂àÊó∂‰∏ç‰ΩúÊìç‰Ωú
                    });
                });
            }
        }

        // ÊòæÁ§∫Ê£ÄÊµãÁªìÊûú
        function showResult() {
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            // Ëé∑ÂèñËæìÂÖ•ÂÜÖÂÆπ
            const textContent = document.getElementById('textInput').innerText.trim();
            
            // ÈöèÊú∫ÁîüÊàêÂàÜÊï∞
            const score = Math.floor(Math.random() * 40) + 20;
            const scoreText = document.getElementById('scoreText');
            const scoreValue = document.getElementById('scoreValue');
            const scoreDescription = document.getElementById('scoreDescription');
            const scoreProgress = document.getElementById('scoreProgress');
            const scoreContainer = document.getElementById('scoreCircleContainer');
            
            scoreText.textContent = score + '%';
            scoreValue.textContent = score + '%';
            
            // Reset classes
            scoreContainer.className = 'score-circle-container';
            
            if (score >= 80) {
                scoreContainer.classList.add('real');
                scoreDescription.textContent = 'ËØ•ÂÜÖÂÆπÂÖ∑ÊúâËæÉÈ´òÁöÑÂèØ‰ø°Â∫¶';
            } else if (score >= 60) {
                scoreContainer.classList.add('uncertain');
                scoreDescription.textContent = 'ËØ•ÂÜÖÂÆπÂ≠òÂú®‰∏ÄÂÆöÁöÑ‰∏çÁ°ÆÂÆöÊÄß';
            } else {
                scoreContainer.classList.add('fake');
                scoreDescription.textContent = 'ËØ•ÂÜÖÂÆπÂèØËÉΩÂ≠òÂú®ËôöÂÅá‰ø°ÊÅØ';
            }
            
            // Animate Progress
            const circumference = 2 * Math.PI * 45; // r=45
            const offset = circumference - (score / 100) * circumference;
            scoreProgress.style.strokeDashoffset = circumference; // Reset first
            setTimeout(() => {
                scoreProgress.style.strokeDashoffset = offset;
            }, 100);
            
            // ÊòæÁ§∫ËæìÂÖ•ÂÜÖÂÆπ
            parsedContent.style.display = 'block';
            parsedTitle.style.display = 'none'; // Á∫ØÊñáÊú¨ËæìÂÖ•Êó†Ê†áÈ¢ò
            parsedText.textContent = textContent;
            
            // Ê∏≤Êüì‰∏ä‰º†ÁöÑÂõæÁâá
            parsedImages.innerHTML = '';
            if (uploadedImages.length > 0) {
                uploadedImages.forEach(img => {
                    const item = document.createElement('div');
                    item.className = 'parsed-image-item';
                    item.innerHTML = `<img src="${img.url}" alt="${img.name}">`;
                    // ÂÖÅËÆ∏‰ªéËß£ÊûêÂå∫ÂüüÊãñÂä®Âà∞Â∑¶‰æßÔºà‰º†ÈÄíÂõæÁâá URLÔºâ
                    item.setAttribute('draggable', 'true');
                    item.addEventListener('dragstart', (ev) => {
                        try {
                            ev.dataTransfer.setData('text/uri-list', img.url);
                            ev.dataTransfer.setData('text/plain', img.url);
                            ev.dataTransfer.effectAllowed = 'copy';
                        } catch (e) {}
                    });
                    item.addEventListener('click', () => showImageModal(img.url));
                    parsedImages.appendChild(item);
                });
            }
            
            initialState.style.display = 'none';
            resultItem.classList.add('active');
        }

        // ÊòæÁ§∫ÊèêÂèñÁªìÊûú
        function showExtractedResult(result) {
            const loadingState = document.getElementById('loadingState');
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            loadingState.classList.remove('active');
            
            // Êõ¥Êñ∞ÁªìÊûúÊòæÁ§∫
            const scoreText = document.getElementById('scoreText');
            const scoreValue = document.getElementById('scoreValue');
            const scoreDescription = document.getElementById('scoreDescription');
            const scoreProgress = document.getElementById('scoreProgress');
            const scoreContainer = document.getElementById('scoreCircleContainer');
            
            // ‰ΩøÁî®ÈöèÊú∫ÂàÜÊï∞‰Ωú‰∏∫Á§∫‰æã
            const score = Math.floor(Math.random() * 40) + 60;
            scoreText.textContent = score + '%';
            scoreValue.textContent = score + '%';
            
            // Reset classes
            scoreContainer.className = 'score-circle-container';
            
            if (score >= 80) {
                scoreContainer.classList.add('real');
                scoreDescription.textContent = 'ËØ•ÂÜÖÂÆπÂÖ∑ÊúâËæÉÈ´òÁöÑÂèØ‰ø°Â∫¶';
            } else if (score >= 60) {
                scoreContainer.classList.add('uncertain');
                scoreDescription.textContent = 'ËØ•ÂÜÖÂÆπÂ≠òÂú®‰∏ÄÂÆöÁöÑ‰∏çÁ°ÆÂÆöÊÄß';
            } else {
                scoreContainer.classList.add('fake');
                scoreDescription.textContent = 'ËØ•ÂÜÖÂÆπÂèØËÉΩÂ≠òÂú®ËôöÂÅá‰ø°ÊÅØ';
            }
            
            // Animate Progress
            const circumference = 2 * Math.PI * 45; // r=45
            const offset = circumference - (score / 100) * circumference;
            scoreProgress.style.strokeDashoffset = circumference; // Reset first
            setTimeout(() => {
                scoreProgress.style.strokeDashoffset = offset;
            }, 100);
            
            // ÊòæÁ§∫Ëß£ÊûêÂÜÖÂÆπ
            parsedContent.style.display = 'block';
            parsedTitle.textContent = result.title || 'Êó†Ê†áÈ¢ò';
            parsedTitle.style.display = result.title ? 'block' : 'none';
            parsedText.textContent = result.content || '';
            
            // Ê∏≤ÊüìÂõæÁâá
            parsedImages.innerHTML = '';
            if (result.images && result.images.length > 0) {
                result.images.forEach(imgUrl => {
                    const item = document.createElement('div');
                    item.className = 'parsed-image-item';
                    item.innerHTML = `<img src="${imgUrl}" alt="Ëß£ÊûêÂõæÁâá">`;
                    // ÂÖÅËÆ∏‰ªéËß£ÊûêÂå∫ÂüüÊãñÂä®Âà∞Â∑¶‰æßÔºà‰º†ÈÄíÂõæÁâá URLÔºâ
                    item.setAttribute('draggable', 'true');
                    item.addEventListener('dragstart', (ev) => {
                        try {
                            ev.dataTransfer.setData('text/uri-list', imgUrl);
                            ev.dataTransfer.setData('text/plain', imgUrl);
                            ev.dataTransfer.effectAllowed = 'copy';
                        } catch (e) {}
                    });
                    item.addEventListener('click', () => showImageModal(imgUrl));
                    parsedImages.appendChild(item);
                });
            }
            
            resultItem.classList.add('active');
        }

        function showError(message) {
            const errorState = document.getElementById('errorState');
            const errorDetail = document.getElementById('errorDetail');
            const loadingState = document.getElementById('loadingState');
            const detectBtn = document.getElementById('detectBtn');
            
            loadingState.classList.remove('active');
            detectBtn.classList.remove('loading');
            detectBtn.innerHTML = 'ÂºÄÂßãÊ£ÄÊµã';
            
            errorDetail.textContent = message || 'Êó†Ê≥ïËé∑ÂèñÁΩëÈ°µÂÜÖÂÆπÔºåËØ∑Ê£ÄÊü•ÈìæÊé•ÊòØÂê¶ÊúâÊïà';
            errorState.classList.add('active');
        }

        // ÂõæÁâáÊ®°ÊÄÅÊ°Ü
        function initModal() {
            const modal = document.getElementById('imageModal');
            const modalClose = document.getElementById('modalClose');
            const modalImage = document.getElementById('modalImage');

            modalClose.addEventListener('click', function() {
                modal.classList.remove('active');
            });

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        }

        function showImageModal(url) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = url;
            modal.classList.add('active');
        }

        // Toast ÊèêÁ§∫
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Ââ™Ë¥¥ÊùøÊåâÈíÆÂäüËÉΩ
        function initClipboardBtn() {
            const clipboardBtn = document.getElementById('clipboardBtn');
            clipboardBtn.addEventListener('click', async function() {
                // ‰ºòÂÖàÂ∞ùËØïËØªÂèñÂõæÁâá
                if (navigator.clipboard && window.ClipboardItem) {
                    try {
                        const items = await navigator.clipboard.read();
                        let foundImage = false;
                        for (const item of items) {
                            for (const type of item.types) {
                                if (type.startsWith('image/')) {
                                    foundImage = true;
                                    const blob = await item.getType(type);
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        if (uploadedImages.length < maxImages) {
                                            const imageData = {
                                                id: Date.now() + Math.random(),
                                                url: e.target.result,
                                                name: 'Ââ™Ë¥¥ÊùøÂõæÁâá'
                                            };
                                            uploadedImages.push(imageData);
                                            document.getElementById('imagePreview').innerHTML = '';
                                            // ÈáçÊñ∞Ê∏≤ÊüìÂõæÁâá
                                            const imagePreview = document.getElementById('imagePreview');
                                            uploadedImages.forEach(image => {
                                                const item = document.createElement('div');
                                                item.className = 'image-preview-item';
                                                item.innerHTML = `<img src="${image.url}" alt="${image.name}"><button class="image-delete-btn" data-id="${image.id}">√ó</button>`;
                                                item.querySelector('img').addEventListener('click', function() {
                                                    showImageModal(image.url);
                                                });
                                                item.querySelector('.image-delete-btn').addEventListener('click', function(e) {
                                                    e.stopPropagation();
                                                    uploadedImages = uploadedImages.filter(img => img.id !== image.id);
                                                    imagePreview.removeChild(item);
                                                    showToast('ÂõæÁâáÂ∑≤Âà†Èô§', 'success');
                                                });
                                                imagePreview.appendChild(item);
                                            });
                                            showToast('Ââ™Ë¥¥ÊùøÂõæÁâáÂ∑≤‰∏ä‰º†', 'success');
                                        } else {
                                            showToast(`ÊúÄÂ§öÂè™ËÉΩ‰∏ä‰º†${maxImages}Âº†ÂõæÁâá`, 'warning');
                                        }
                                    };
                                    reader.readAsDataURL(blob);
                                    return;
                                }
                            }
                        }
                        if (!foundImage) {
                            // Ê≤°ÊúâÂõæÁâáÂàôÂ∞ùËØïËØªÂèñÊñáÊú¨
                            const text = await navigator.clipboard.readText();
                            if (text) {
                                document.getElementById('textInput').innerText = text;
                                showToast('Ââ™Ë¥¥ÊùøÊñáÊú¨Â∑≤Á≤òË¥¥', 'success');
                            } else {
                                showToast('Ââ™Ë¥¥ÊùøÊó†ÂèØÁî®ÂÜÖÂÆπ', 'warning');
                            }
                        }
                    } catch (err) {
                        showToast('Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥ÊùøÂÜÖÂÆπ', 'error');
                    }
                } else if (navigator.clipboard) {
                    // ÂÖºÂÆπÂè™ÊîØÊåÅÊñáÊú¨ÁöÑÊµèËßàÂô®
                    try {
                        const text = await navigator.clipboard.readText();
                        if (text) {
                            document.getElementById('textInput').innerText = text;
                            showToast('Ââ™Ë¥¥ÊùøÊñáÊú¨Â∑≤Á≤òË¥¥', 'success');
                        } else {
                            showToast('Ââ™Ë¥¥ÊùøÊó†ÂèØÁî®ÂÜÖÂÆπ', 'warning');
                        }
                    } catch (err) {
                        showToast('Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥ÊùøÂÜÖÂÆπ', 'error');
                    }
                } else {
                    showToast('ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅÂâ™Ë¥¥ÊùøAPI', 'error');
                }
            });
        }
        // AIÂàÜÊûêÂäüËÉΩ
        async function analyzeContent(text, images, fromExtraction = false) {
            const detectBtn = document.getElementById('detectBtn');
            const loadingState = document.getElementById('loadingState');
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const errorState = document.getElementById('errorState');
            const progressBar = document.getElementById('progressBar');
            const loadingText = document.getElementById('loadingText');

            // UI Loading State
            initialState.style.display = 'none';
            resultItem.classList.remove('active');
            errorState.classList.remove('active');
            loadingState.classList.add('active');
            detectBtn.classList.add('loading');
            detectBtn.innerHTML = 'AIÂàÜÊûê‰∏≠...';
            
            // ËÆæÁΩÆËøõÂ∫¶Êù°ÂàùÂßãÁä∂ÊÄÅ
            if (fromExtraction) {
                progressBar.style.width = '50%';
            } else {
                progressBar.style.width = '0%';
                // Âø´ÈÄüÂä®ÁîªÂà∞ 50%
                setTimeout(() => {
                    progressBar.style.width = '50%';
                }, 100);
            }
            loadingText.textContent = 'Ê≠£Âú®ÂàÜÊûêÊñ∞Èóª‰∏≠...';

            // Ê®°ÊãüÂàÜÊûêÈò∂ÊÆµÁöÑËøõÂ∫¶Â¢ûÈïø (50% -> 90%)
            let progress = 50;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += 0.5; // ÊÖ¢‰∏ÄÁÇπ
                    progressBar.style.width = progress + '%';
                }
            }, 100);

            try {
                let imageUrls = [];
                if (images && images.length > 0) {
                    // ÈôêÂà∂ÊúÄÂ§ö4Âº†ÂõæÁâá
                    const limitedImages = images.slice(0, 4);
                    imageUrls = limitedImages.map(img => typeof img === 'string' ? img : img.url);
                }

                let result;
                // Ê£ÄÊü•ÊòØÂê¶ÊòØURLÊèêÂèñÁöÑÂÜÖÂÆπÔºåÂ¶ÇÊûúÊòØÔºåÂ∞ùËØïËé∑ÂèñURL
                let sourceUrl = '';
                if (fromExtraction && window.lastExtractedUrl) {
                    sourceUrl = window.lastExtractedUrl;
                } else if (isURL(text)) {
                    sourceUrl = text;
                }

                if (window.electronAPI) {
                    const response = await window.electronAPI.invoke('analyze-content', { text, imageUrls, url: sourceUrl });
                    if (response.success) {
                        result = response.data;
                    } else {
                        throw new Error(response.error);
                    }
                } else {
                    // Mock for dev
                    await new Promise(r => setTimeout(r, 2000));
                    result = {
                        probability: 0.15,
                        type: 3,
                        explanation: "ËøôÊòØ‰∏Ä‰∏™Ê®°ÊãüÁöÑAIÂàÜÊûêÁªìÊûúÔºàÂÅáÊñ∞ÈóªÔºâ„ÄÇ",
                        fake_parts: [{ text: text.substring(0, 10), reason: "Ê®°ÊãüÂéüÂõ†" }]
                    };
                }

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                // Á®çÂæÆÂª∂Ëøü‰∏Ä‰∏ãËÆ©Áî®Êà∑ÁúãÂà∞100%
                setTimeout(() => {
                    showAnalysisResult(result, text, images);
                    showToast('ÂàÜÊûêÂÆåÊàê', 'success');
                    loadingState.classList.remove('active');
                    detectBtn.classList.remove('loading');
                    detectBtn.innerHTML = 'ÂºÄÂßãÊ£ÄÊµã';
                }, 500);

            } catch (error) {
                clearInterval(progressInterval);
                console.error(error);
                showError('AIÂàÜÊûêÂ§±Ë¥•: ' + error.message);
                showToast('ÂàÜÊûêÂ§±Ë¥•', 'error');
                loadingState.classList.remove('active');
                detectBtn.classList.remove('loading');
                detectBtn.innerHTML = 'ÂºÄÂßãÊ£ÄÊµã';
            }
        }

        function showAnalysisResult(result, originalText, originalImages) {
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            // Ensure Score and Analysis are visible (in case they were hidden by preview)
            const scoreSection = resultItem.querySelector('.result-score');
            const analysisSection = resultItem.querySelector('.result-analysis');
            if(scoreSection) scoreSection.style.display = 'flex';
            if(analysisSection) analysisSection.style.display = 'block';

            const scoreText = document.getElementById('scoreText');
            const scoreValue = document.getElementById('scoreValue');
            const scoreDescription = document.getElementById('scoreDescription');
            const scoreProgress = document.getElementById('scoreProgress');
            const scoreContainer = document.getElementById('scoreCircleContainer');
            
            // Probability to Percentage
            const percentage = Math.round(result.probability * 100);
            scoreText.textContent = percentage + '%';
            scoreValue.textContent = percentage + '%';
            
            // Reset classes
            scoreContainer.className = 'score-circle-container';
            
            // Color logic based on percentage
            if (percentage >= 75) {
                scoreContainer.classList.add('real');
            } else if (percentage >= 50) {
                scoreContainer.classList.add('uncertain');
            } else {
                scoreContainer.classList.add('fake');
            }
            
            // Animate Progress
            const circumference = 2 * Math.PI * 45; // r=45
            const offset = circumference - (percentage / 100) * circumference;
            scoreProgress.style.strokeDashoffset = circumference; // Reset first
            setTimeout(() => {
                scoreProgress.style.strokeDashoffset = offset;
            }, 100);
            
            // Type handling for description
            if (result.type === 1) { // True
                scoreDescription.innerHTML = `<strong>ÂèØ‰ø°Â∫¶È´ò</strong><br>${result.explanation}`;
            } else if (result.type === 2) { // Partial
                scoreDescription.innerHTML = `<strong>ÈÉ®ÂàÜÂ≠òÁñë</strong><br>${result.explanation}`;
            } else { // Fake
                scoreDescription.innerHTML = `<strong>Áñë‰ººËôöÂÅá</strong><br>${result.explanation}`;
            }
            
            // Update Analysis Points
            const analysisContainer = document.querySelector('.result-analysis');
            // Ê∏ÖÁ©∫ÊóßÁöÑÈùôÊÄÅÂÜÖÂÆπÔºà‰øùÁïôÊ†áÈ¢òÔºâ
            const analysisTitle = analysisContainer.querySelector('.analysis-title');
            analysisContainer.innerHTML = '';
            analysisContainer.appendChild(analysisTitle);

            if (result.analysis_points && Array.isArray(result.analysis_points)) {
                result.analysis_points.forEach(point => {
                    const item = document.createElement('div');
                    item.className = 'analysis-item';
                    
                    let icon = '‚úì';
                    let iconClass = 'positive';
                    
                    if (point.status === 'warning') {
                        icon = '!';
                        iconClass = 'warning';
                    } else if (point.status === 'negative') {
                        icon = '‚úï';
                        iconClass = 'negative';
                    }
                    
                    item.innerHTML = `
                        <div class="analysis-icon ${iconClass}">${icon}</div>
                        <div class="analysis-text">${point.description}</div>
                    `;
                    analysisContainer.appendChild(item);
                });
            } else {
                // Fallback if no analysis points provided
                analysisContainer.innerHTML += `<div class="analysis-item"><div class="analysis-text">ÊöÇÊó†ËØ¶ÁªÜÂàÜÊûêÁÇπ</div></div>`;
            }
            
            // Display Content
            parsedContent.style.display = 'block';
            parsedTitle.style.display = 'none'; 
            
            // Highlight fake parts
            let displayText = originalText;
            if ((result.type === 2 || result.type === 3) && result.fake_parts) {
                let safeText = displayText.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                
                // Sort fake parts by length descending to avoid nested replacement issues
                const sortedParts = [...result.fake_parts].sort((a, b) => b.text.length - a.text.length);

                sortedParts.forEach(part => {
                    if (part.text) {
                        const safePart = part.text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        // ‰ΩøÁî® CSS Á±ªÊéßÂà∂Ê†∑Âºè
                        const highlight = `<span class="fake-highlight" data-reason="${part.reason.replace(/"/g, '&quot;')}" onclick="showReasonTooltip(event, this)">${safePart}</span>`;
                        // Replace only the first occurrence to avoid over-replacing
                        safeText = safeText.replace(safePart, highlight);
                    }
                });
                parsedText.innerHTML = safeText;
            } else {
                parsedText.textContent = originalText;
            }
            
            // Render Images
            parsedImages.innerHTML = '';
            let imagesToRender = [];
            if (originalImages && originalImages.length > 0) {
                 // ÈôêÂà∂ÊúÄÂ§öÊòæÁ§∫4Âº†ÂõæÁâá
                 const limitedImages = originalImages.slice(0, 4);
                 imagesToRender = limitedImages.map(img => typeof img === 'string' ? {url: img, name: 'Image'} : img);
            }
            
            imagesToRender.forEach(img => {
                const item = document.createElement('div');
                item.className = 'parsed-image-item';
                item.innerHTML = `<img src="${img.url}" alt="${img.name}">`;
                item.addEventListener('click', () => showImageModal(img.url));
                parsedImages.appendChild(item);
            });
            
            resultItem.classList.add('active');
        }

        // Tooltip Logic
        let activeTooltipElement = null;
        let tooltipUpdateRaf = null;

        function updateTooltipPosition() {
            const tooltip = document.getElementById('customTooltip');
            if (!tooltip || !tooltip.classList.contains('active') || !activeTooltipElement) return;

            const rect = activeTooltipElement.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            // Calculate position (centered horizontally, below element)
            let top = rect.bottom + 10;
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

            // Viewport boundary checks
            const padding = 16;
            
            // Horizontal check
            if (left < padding) {
                left = padding;
            } else if (left + tooltipRect.width > window.innerWidth - padding) {
                left = window.innerWidth - tooltipRect.width - padding;
            }
            
            // Vertical check (flip to top if not enough space below)
            if (top + tooltipRect.height > window.innerHeight - padding) {
                top = rect.top - tooltipRect.height - 10;
            }

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        }

        function showReasonTooltip(event, element) {
            event.stopPropagation();
            
            // Remove active class from previous highlight
            if (activeTooltipElement) {
                activeTooltipElement.classList.remove('active');
            }

            const reason = element.getAttribute('data-reason');
            if (!reason) return;

            activeTooltipElement = element;
            activeTooltipElement.classList.add('active');

            let tooltip = document.getElementById('customTooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'customTooltip';
                tooltip.className = 'custom-tooltip';
                document.body.appendChild(tooltip);
            }

            tooltip.textContent = reason;
            tooltip.classList.add('active');

            // Initial position update
            updateTooltipPosition();
        }

        function hideTooltip() {
            const tooltip = document.getElementById('customTooltip');
            if (tooltip) {
                tooltip.classList.remove('active');
            }
            if (activeTooltipElement) {
                activeTooltipElement.classList.remove('active');
                activeTooltipElement = null;
            }
        }

        // Global event listeners for tooltip management
        document.addEventListener('click', function(e) {
            const tooltip = document.getElementById('customTooltip');
            // If clicking inside tooltip, do nothing
            if (tooltip && tooltip.contains(e.target)) {
                return;
            }
            // If clicking a highlight, it's handled by onclick
            if (e.target.classList.contains('fake-highlight')) {
                return;
            }
            
            hideTooltip();
        });

        // Update position on scroll and resize
        // Use capture to catch scroll events from any container
        window.addEventListener('scroll', function() {
            if (activeTooltipElement) {
                if (tooltipUpdateRaf) cancelAnimationFrame(tooltipUpdateRaf);
                tooltipUpdateRaf = requestAnimationFrame(updateTooltipPosition);
            }
        }, true);

        window.addEventListener('resize', function() {
            if (activeTooltipElement) {
                updateTooltipPosition();
            }
        });
    </script>
</body>
</html>
