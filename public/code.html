<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>假新闻检测系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Color Palette - Refined */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f1f3f5;
            --text-primary: #1a1d20;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            
            --accent-color: #4361ee;
            --accent-hover: #3a56d4;
            --accent-light: rgba(67, 97, 238, 0.1);
            
            --success-color: #2ec4b6;
            --warning-color: #ff9f1c;
            --danger-color: #e71d36;
            
            /* Shadows - Smoother */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.12);
            
            /* Transitions */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        [data-theme="dark"] {
            --bg-primary: #111315;
            --bg-secondary: #1a1d20;
            --bg-tertiary: #212529;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --border-color: #2d3238;
            
            --accent-color: #4cc9f0;
            --accent-hover: #48bfe3;
            --accent-light: rgba(76, 201, 240, 0.15);
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.3);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            user-select: none; /* 禁止选中 */
            -webkit-user-select: none;
        }

        /* 允许选中的区域 */
        .text-input, .parsed-text, .parsed-title, .analysis-text, .custom-tooltip {
            user-select: text;
            -webkit-user-select: text;
        }

        /* 沉浸式滚动条样式 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
            transition: background 0.3s;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        ::-webkit-scrollbar-corner {
            background: transparent;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* 左侧面板 */
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            min-width: 300px;
            max-width: 70%;
            transition: background-color 0.3s;
            position: relative;
        }

        /* 拖拽遮罩层 */
        .drag-overlay {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            bottom: 16px;
            background: rgba(67, 97, 238, 0.15);
            border: 2px dashed var(--accent-color);
            border-radius: var(--radius-lg);
            z-index: 99;
            pointer-events: none;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-color);
            backdrop-filter: blur(8px);
            transition: all 0.2s ease;
        }
        .drag-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .drag-overlay.error {
            border-color: var(--danger-color);
            background: rgba(231, 29, 54, 0.15);
            color: var(--danger-color);
        }
        .drag-overlay.success {
            border-color: var(--success-color);
            background: rgba(46, 196, 182, 0.15);
            color: var(--success-color);
        }
        .drag-overlay.full {
            border-color: var(--warning-color);
            background: rgba(255, 159, 28, 0.15);
            color: var(--warning-color);
        }

        /* 工具栏 */
        .toolbar {
            display: flex;
            align-items: center;
            height: 64px;
            padding: 0 20px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
            position: relative;
            z-index: 20;
        }

        .toolbar-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .toolbar-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .toolbar-btn:active {
            transform: translateY(0) scale(0.95);
        }

        .toolbar-btn.active {
            background: var(--accent-light);
            color: var(--accent-color);
        }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        @keyframes ripple {
            to { transform: scale(4); opacity: 0; }
        }

        .toolbar-separator {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 8px;
        }

        /* Dropdown Menu */
        .more-menu .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 180px;
            display: none;
            background: var(--bg-primary);
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius-md);
            padding: 8px;
            z-index: 999;
            border: 1px solid var(--border-color);
            animation: slideDown 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .more-menu .dropdown-menu.show {
            display: block;
        }

        .more-menu .dropdown-item {
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: background 0.2s;
        }

        .more-menu .dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        /* Edit Options */
        .edit-options {
            display: none;
            padding: 12px 20px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            gap: 8px;
            animation: slideDown 0.3s ease;
        }
        .edit-options.active { display: flex; }

        .edit-btn {
            width: 32px;
            height: 32px;
            padding: 6px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .edit-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            overflow-y: auto;
            gap: 24px;
        }

        .text-input {
            flex: 1;
            min-height: 200px;
            padding: 24px;
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.8;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            outline: none;
        }

        .text-input:focus {
            border-color: var(--accent-color);
            box-shadow: var(--shadow-md);
        }
        
        .text-input:empty:before {
            content: attr(placeholder);
            color: var(--text-secondary);
            opacity: 0.6;
        }

        /* Image Preview */
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 16px;
            padding: 4px;
        }

        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            overflow: hidden;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: var(--transition-bounce);
            box-shadow: var(--shadow-sm);
        }

        .image-preview-item:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-md);
        }

        .image-preview-item.selected {
            border: 2px solid var(--accent-color);
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-md);
        }
        
        .image-preview-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--accent-color);
        }

        .image-placeholder {
            border: 2px dashed var(--accent-color);
            background: rgba(67, 97, 238, 0.1);
            border-radius: var(--radius-md);
            aspect-ratio: 1;
            transition: all 0.1s;
            box-sizing: border-box;
        }

        .image-delete-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition-fast);
            backdrop-filter: blur(4px);
        }

        .image-preview-item:hover .image-delete-btn {
            opacity: 1;
        }
        .image-delete-btn:hover {
            background: var(--danger-color);
            transform: scale(1.1);
        }

        /* Bottom Area */
        .bottom-area {
            padding: 20px 24px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
        }

        .detect-btn {
            width: 100%;
            padding: 16px;
            background: rgba(67, 97, 238, 0.1); /* var(--accent-light) */
            color: var(--accent-color);
            border: 1px solid rgba(67, 97, 238, 0.2);
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            backdrop-filter: blur(8px);
        }

        .detect-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3);
            border-color: var(--accent-color);
        }

        .detect-btn:active {
            transform: translateY(0);
        }

        /* Resizer */
        .resizer {
            width: 5px;
            background: var(--bg-tertiary);
            cursor: col-resize;
            position: relative;
            z-index: 30;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        .resizer::after {
            content: '';
            width: 3px;
            height: 32px;
            background: var(--text-secondary);
            border-radius: 2px;
            opacity: 0.3;
            transition: all 0.3s;
        }
        .resizer:hover {
            background: var(--accent-light);
            border-color: var(--accent-light);
        }
        .resizer:hover::after {
            background: var(--accent-color);
            opacity: 1;
            height: 48px;
        }

        /* Right Panel */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            min-width: 300px;
        }

        .result-header {
            height: 64px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .result-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .result-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        /* Initial State */
        .initial-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-secondary);
            animation: scaleIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .initial-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.5;
            filter: grayscale(100%);
            transition: var(--transition);
        }
        .initial-state:hover .initial-icon {
            opacity: 1;
            filter: grayscale(0%);
            transform: scale(1.1);
        }

        .initial-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .initial-description {
            font-size: 15px;
            line-height: 1.6;
            max-width: 420px;
        }

        /* Result Item */
        .result-item {
            display: none;
            animation: slideInRight 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .result-item.active { display: block; }

        .result-score {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 24px;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        /* SVG Score Circle */
        .score-circle-container {
            position: relative;
            width: 100px;
            height: 100px;
        }
        .score-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .score-bg {
            fill: none;
            stroke: var(--bg-tertiary);
            stroke-width: 8;
        }
        .score-progress {
            fill: none;
            stroke: var(--accent-color);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 283; /* 2 * PI * 45 */
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1.5s cubic-bezier(0.2, 0.8, 0.2, 1), stroke 0.3s;
        }
        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Score Colors */
        .score-circle-container.real .score-progress { stroke: var(--success-color); }
        .score-circle-container.fake .score-progress { stroke: var(--danger-color); }
        .score-circle-container.uncertain .score-progress { stroke: var(--warning-color); }

        .score-details { flex: 1; }

        .score-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .score-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -1px;
        }

        .score-description {
            font-size: 15px;
            color: var(--text-secondary);
            margin-top: 6px;
            line-height: 1.5;
        }

        /* Analysis List */
        .result-analysis {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .analysis-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .analysis-title::before {
            content: '';
            width: 4px;
            height: 18px;
            background: var(--accent-color);
            border-radius: 2px;
        }

        .analysis-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .analysis-item:hover {
            transform: translateX(4px);
            background: var(--bg-primary);
            box-shadow: var(--shadow-sm);
        }

        .analysis-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
            font-weight: bold;
        }

        /* Analysis Status Styles */
        .analysis-item.positive { border-left-color: var(--success-color); }
        .analysis-item.positive .analysis-icon { color: var(--success-color); background: rgba(46, 196, 182, 0.1); }
        
        .analysis-item.negative { border-left-color: var(--danger-color); }
        .analysis-item.negative .analysis-icon { color: var(--danger-color); background: rgba(231, 29, 54, 0.1); }
        
        .analysis-item.warning { border-left-color: var(--warning-color); }
        .analysis-item.warning .analysis-icon { color: var(--warning-color); background: rgba(255, 159, 28, 0.1); }

        .analysis-text {
            flex: 1;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        .image-modal.active { display: flex; }

        .modal-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            animation: zoomIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .modal-close {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 28px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }

        /* Custom Modal */
        .custom-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        .custom-modal.active { display: flex; }
        
        .custom-modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 32px;
            min-width: 360px;
            max-width: 90vw;
            text-align: center;
            animation: zoomIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            border: 1px solid var(--border-color);
        }
        
        .custom-modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .custom-modal-message {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.5;
        }
        
        .custom-modal-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }
        
        .custom-modal-btn {
            padding: 10px 32px;
            border-radius: var(--radius-md);
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: var(--accent-color);
            color: #fff;
            transition: var(--transition-fast);
        }
        .custom-modal-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }
        
        .custom-modal-btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid transparent;
        }
        .custom-modal-btn.secondary:hover {
            background: var(--border-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        /* Loading State */
        .loading-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            animation: fadeIn 0.3s ease;
        }
        .loading-state.active { display: flex; }

        .loading-spinner-large {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        .progress-container {
            width: 240px;
            height: 6px;
            background-color: var(--bg-tertiary);
            border-radius: 3px;
            margin-top: 16px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        /* Parsed Content */
        .parsed-content {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
            animation: slideInRight 0.5s ease;
        }

        .parsed-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .parsed-text {
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
            text-align: justify;
        }

        /* Fake Highlight */
        .fake-highlight {
            background-color: rgba(255, 159, 28, 0.2);
            border-bottom: 2px solid var(--warning-color);
            color: inherit;
            cursor: pointer;
            border-radius: 4px;
            padding: 0 2px;
            transition: background-color 0.2s;
        }
        .fake-highlight:hover {
            background-color: rgba(255, 159, 28, 0.4);
        }
        .fake-highlight.active {
            background-color: rgba(255, 159, 28, 0.5);
            box-shadow: 0 0 0 2px rgba(255, 159, 28, 0.3);
        }

        /* Animations */
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .left-panel, .right-panel { max-width: 100%; min-width: 100%; }
            .resizer { display: none; }
            .image-preview-container { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
        }

        /* 虚假内容高亮样式 */
        .fake-highlight {
            background-color: rgba(255, 190, 11, 0.3);
            border-bottom: 2px solid var(--warning-color);
            color: inherit;
            cursor: pointer;
            border-radius: 4px;
            padding: 0 2px;
            transition: background-color 0.2s;
        }
        
        .fake-highlight:hover {
            background-color: rgba(255, 190, 11, 0.5);
        }

        .fake-highlight.active {
            background-color: rgba(255, 190, 11, 0.6);
        }

        /* 详细分析列表项样式 */
        .analysis-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            transition: var(--transition);
        }

        .analysis-item:hover {
            transform: translateX(4px);
        }

        .analysis-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-weight: bold;
            font-size: 14px;
        }

        .analysis-icon.positive {
            background: rgba(6, 255, 165, 0.15);
            color: var(--success-color);
        }

        .analysis-icon.warning {
            background: rgba(255, 190, 11, 0.15);
            color: var(--warning-color);
        }

        .analysis-icon.negative {
            background: rgba(251, 86, 7, 0.15);
            color: var(--danger-color);
        }

        .analysis-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
        }

        /* 错误状态 */
        .error-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--danger-color);
            animation: fadeIn 0.3s ease;
        }

        .error-state.active {
            display: flex;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .error-message {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .error-detail {
            font-size: 14px;
            color: var(--text-secondary);
            max-width: 300px;
        }

        .toolbar-btn.more-menu {
            overflow: visible; /* 允许下拉菜单超出按钮范围 */
        }

        /* 优化下拉菜单样式 */
        .more-menu .dropdown-menu {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 6px;
            min-width: 200px;
            border-radius: 12px;
            transform-origin: top right;
        }
        
        [data-theme="dark"] .more-menu .dropdown-menu {
            background: rgba(30, 30, 30, 0.95);
            border-color: rgba(255,255,255,0.1);
        }

        .more-menu .dropdown-item {
            border-radius: 8px;
            margin-bottom: 2px;
            font-weight: 500;
        }

        /* 2. 修复左侧缩略图显示问题 */
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 保持比例填充，裁剪多余部分 */
            display: block;
            transition: transform 0.3s;
        }
        .image-preview-item:hover img {
            transform: scale(1.1);
        }

        /* 3. 修复右侧结果图片过大问题 (使用网格布局) */
        .parsed-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .parsed-image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            transition: var(--transition);
        }
        
        .parsed-image-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-color);
        }

        .parsed-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* 4. 优化停止按钮样式 */
        .cancel-extract-btn {
            margin-top: 20px;
            padding: 10px 28px;
            background: transparent;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            border-radius: 30px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .cancel-extract-btn:hover {
            background: var(--danger-color);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 29, 54, 0.3);
            transform: translateY(-1px);
        }
        
        .cancel-extract-btn:active {
            transform: translateY(0);
        }
        
        .cancel-extract-btn::before {
            content: '';
            display: inline-block;
            width: 10px;
            height: 10px;
            background: currentColor;
            border-radius: 2px;
        }

        /* 自定义 Tooltip 样式 */
        .custom-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            max-width: 300px;
            z-index: 3000;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s, transform 0.2s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            backdrop-filter: blur(4px);
        }
        .custom-tooltip.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 32px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            z-index: 10000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            pointer-events: none;
            box-shadow: var(--shadow-lg);
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: auto;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Toast Variants - Transparent Background */
        .toast.success { 
            background: rgba(46, 196, 182, 0.15); 
            color: var(--success-color);
            border-color: rgba(46, 196, 182, 0.2);
        }
        .toast.error { 
            background: rgba(231, 29, 54, 0.15); 
            color: var(--danger-color);
            border-color: rgba(231, 29, 54, 0.2);
        }
        .toast.warning { 
            background: rgba(255, 159, 28, 0.15); 
            color: var(--warning-color);
            border-color: rgba(255, 159, 28, 0.2);
        }
        .toast.info { 
            background: rgba(67, 97, 238, 0.15); 
            color: var(--accent-color);
            border-color: rgba(67, 97, 238, 0.2);
        }

        @media (prefers-reduced-motion: reduce) {
            .left-panel, .right-panel, .toolbar, .content-area, .bottom-area, .result-header, .initial-state {
                animation: none;
                opacity: 1;
                transform: none;
                transition: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 左侧面板 -->
        <div class="left-panel" id="leftPanel">
                        <div class="drag-overlay" id="dragOverlay">拖入图片以添加</div>
            <!-- 工具栏 -->
            <div class="toolbar">
                <button class="toolbar-btn" id="imageBtn" title="添加图片">
                    <!-- Material Icons: add_photo_alternate -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="14" rx="2" fill="none"/>
                        <path d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11" stroke="currentColor" fill="none"/>
                        <circle cx="8.5" cy="8.5" r="1.5" fill="none"/>
                        <path d="M21 15l-5-6-4 5-3-4-4 6" stroke="currentColor" fill="none"/>
                        <path d="M22 19h-6m3 3v-6" stroke="currentColor" fill="none"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="clipboardBtn" title="剪贴板获取">
                    <!-- Material Icons: content_paste -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="5" y="5" width="14" height="16" rx="2" fill="none"/>
                        <rect x="9" y="2" width="6" height="4" rx="1" fill="none"/>
                        <path d="M19 7v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7" stroke="currentColor" fill="none"/>
                        <path d="M9 4V2h6v2" stroke="currentColor" fill="none"/>
                    </svg>
                </button>
                <div class="toolbar-separator"></div>
                <button class="toolbar-btn" id="editBtn" title="编辑选项">
                    <!-- Material Icons: edit -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 17.25V21h3.75l11.06-11.06a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0L3 17.25z" fill="none"/>
                        <path d="M14.06 6.19l3.75 3.75" stroke="currentColor" fill="none"/>
                    </svg>
                </button>
                 <button class="toolbar-btn" id="previewBtn" title="页面预览">
                    <!-- Material Icons: visibility -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12c2.73-5 7.27-8 11-8s8.27 3 11 8c-2.73 5-7.27 8-11 8S3.73 17 1 12z" fill="none"/>
                        <circle cx="12" cy="12" r="3" fill="none"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="themeBtn" title="切换主题">
                    <!-- Material Icons: light_mode / dark_mode，动态切换 -->
                    <span id="themeIconWrapper">
                        <svg id="themeIconLight" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                            <circle cx="12" cy="12" r="5"/>
                            <path d="M12 1v2"/>
                            <path d="M12 21v2"/>
                            <path d="M4.22 4.22l1.42 1.42"/>
                            <path d="M18.36 18.36l1.42 1.42"/>
                            <path d="M1 12h2"/>
                            <path d="M21 12h2"/>
                            <path d="M4.22 19.78l1.42-1.42"/>
                            <path d="M18.36 5.64l1.42-1.42"/>
                        </svg>
                        <svg id="themeIconDark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                            <path d="M9.37 5.51A7 7 0 1 0 18.49 14.63 9 9 0 0 1 9.37 5.51z"/>
                        </svg>
                    </span>
                </button>
                <button class="toolbar-btn" id="clearBtn" title="清空内容">
                    <!-- Material Icons: delete -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12z" fill="none"/>
                        <path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="none"/>
                        <path d="M10 11v6"/>
                        <path d="M14 11v6"/>
                    </svg>
                </button>
                <div class="toolbar-separator"></div>
                <div class="toolbar-btn more-menu" id="moreBtn" title="更多操作" tabindex="0">
                    <!-- Material Icons: more_vert -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="6" r="1.5"/>
                        <circle cx="12" cy="12" r="1.5"/>
                        <circle cx="12" cy="18" r="1.5"/>
                    </svg>
                    <div class="dropdown-menu" id="moreDropdown">
                        <div class="dropdown-item" id="clearBrowserDataBtn">清除浏览器数据</div>
                    </div>
                </div>
            </div>

            <!-- 编辑选项 -->
            <div class="edit-options" id="editOptions">
                <button class="edit-btn" data-command="bold" title="加粗">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 8h6a3 3 0 0 1 0 6H7zm0 6h7a2.5 2.5 0 0 1 0 5H7z"/></svg>
                </button>
                <button class="edit-btn" data-command="italic" title="斜体">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><line x1="17" y1="6" x2="9" y2="24"/></svg>
                </button>
                <button class="edit-btn" data-command="underline" title="下划线">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 6v8a6 6 0 0 0 12 0V6"/><line x1="4" y1="26" x2="20" y2="26"/></svg>
                </button>
                <button class="edit-btn" data-command="insertUnorderedList" title="无序列表">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="9" r="1.5"/><circle cx="6" cy="16" r="1.5"/><circle cx="6" cy="23" r="1.5"/><line x1="10" y1="9" x2="18" y2="9"/><line x1="10" y1="16" x2="18" y2="16"/><line x1="10" y1="23" x2="18" y2="23"/></svg>
                </button>
                <button class="edit-btn" data-command="insertOrderedList" title="有序列表">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><text x="3" y="11" font-size="8">1</text><line x1="10" y1="9" x2="18" y2="9"/><text x="3" y="18" font-size="8">2</text><line x1="10" y1="16" x2="18" y2="16"/><text x="3" y="25" font-size="8">3</text><line x1="10" y1="23" x2="18" y2="23"/></svg>
                </button>
                <button class="edit-btn" data-command="justifyLeft" title="左对齐">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="16" x2="14" y2="16"/><line x1="4" y1="23" x2="20" y2="23"/></svg>
                </button>
                <button class="edit-btn" data-command="justifyCenter" title="居中">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><line x1="6" y1="9" x2="18" y2="9"/><line x1="8" y1="16" x2="16" y2="16"/><line x1="4" y1="23" x2="20" y2="23"/></svg>
                </button>
                <button class="edit-btn" data-command="justifyRight" title="右对齐">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="20" y2="9"/><line x1="10" y1="16" x2="20" y2="16"/><line x1="4" y1="23" x2="20" y2="23"/></svg>
                </button>
            </div>

            <!-- 内容区域 -->
            <div class="content-area">
                <!-- 文本输入 -->
                <div contenteditable="true" class="text-input" id="textInput" placeholder="请输入要检测的新闻内容..."></div>

                <!-- 图片上传区域 (已移除) -->
                <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">

                <!-- 图片预览 -->
                <div class="image-preview-container" id="imagePreview"></div>
            </div>

            <!-- 底部操作区 -->
            <div class="bottom-area">
                <!-- 检测按钮 -->
                <button class="detect-btn" id="detectBtn">开始检测</button>
            </div>
        </div>

        <!-- 分隔线 -->
        <div class="resizer" id="resizer"></div>

        <!-- 右侧面板 -->
        <div class="right-panel" id="rightPanel">
            <div class="result-header">
                <h2 class="result-title">检测结果</h2>
            </div>
            <div class="result-content">
                <!-- 初始状态 -->
                <div class="initial-state" id="initialState">
                    <div class="initial-icon">
                        <!-- 彩色放大镜SVG -->
                                                <!-- 在线彩色放大镜图标，线性风格，主色蓝辅色黄 -->
                                                <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <circle cx="28" cy="28" r="16" stroke="#2196f3" stroke-width="3" fill="#e3f6fd"/>
                                                    <circle cx="28" cy="28" r="8" stroke="#2196f3" stroke-width="2" fill="#fff"/>
                                                    <circle cx="28" cy="28" r="3" fill="#4fc3f7"/>
                                                    <rect x="38" y="38" width="12" height="5" rx="2.5" transform="rotate(45 38 38)" fill="#fffde7" stroke="#ffc107" stroke-width="2"/>
                                                    <line x1="36" y1="36" x2="48" y2="48" stroke="#2196f3" stroke-width="2.5" stroke-linecap="round"/>
                                                </svg>
                    </div>
                    <div class="initial-title">准备就绪</div>
                    <div class="initial-description">
                        在左侧输入新闻内容或上传相关图片，点击"开始检测"按钮即可进行假新闻分析。
                        系统将综合评估内容的真实性，为您提供详细的检测报告。
                    </div>
                </div>

                <!-- 检测结果 -->
                <div class="result-item" id="resultItem">
                    <div class="result-score">
                        <div class="score-circle-container" id="scoreCircleContainer">
                            <svg class="score-svg" viewBox="0 0 100 100">
                                <circle class="score-bg" cx="50" cy="50" r="45"></circle>
                                <circle class="score-progress" id="scoreProgress" cx="50" cy="50" r="45"></circle>
                            </svg>
                            <div class="score-text" id="scoreText">0%</div>
                        </div>
                        <div class="score-details">
                            <div class="score-label">真实性评分</div>
                            <div class="score-value" id="scoreValue">0%</div>
                            <div class="score-description" id="scoreDescription">等待检测...</div>
                        </div>
                    </div>

                    <div class="result-analysis">
                        <div class="analysis-title">详细分析</div>
                        <div class="analysis-item">
                            <div class="analysis-icon positive">✓</div>
                            <div class="analysis-text">内容来源可靠，引用了权威媒体的数据</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-icon positive">✓</div>
                            <div class="analysis-text">语言表达客观，无明显情绪化倾向</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-icon neutral">!</div>
                            <div class="analysis-text">部分信息需要进一步核实</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-icon positive">✓</div>
                            <div class="analysis-text">图片内容与文字描述相符</div>
                        </div>
                    </div>

                    <!-- 解析内容 -->
                    <div class="parsed-content" id="parsedContent" style="display: none;">
                        <h3 class="parsed-title" id="parsedTitle"></h3>
                        <div class="parsed-images" id="parsedImages"></div>
                        <div class="parsed-text" id="parsedText"></div>
                    </div>
                </div>

                <!-- 加载状态 -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner-large"></div>
                    <div class="loading-text" id="loadingText">正在解析网页内容...</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <button class="cancel-extract-btn" id="cancelExtractBtn" style="display: none;"></button>
                </div>

                <!-- 错误状态 -->
                <div class="error-state" id="errorState">
                    <div class="error-icon">⚠️</div>
                    <div class="error-message">解析失败</div>
                    <div class="error-detail" id="errorDetail">无法获取网页内容，请检查链接是否有效</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div class="image-modal" id="imageModal">
        <button class="modal-close" id="modalClose">×</button>
        <img class="modal-image" id="modalImage" src="" alt="预览图片">
    </div>

    <!-- Toast 提示 -->
    <div class="toast" id="toast"></div>

    <!-- 自定义确认弹窗 -->
    <div class="custom-modal" id="customModal">
        <div class="custom-modal-content">
            <div class="custom-modal-title">确认操作</div>
            <div class="custom-modal-message">确定要清空所有内容吗？</div>
            <div class="custom-modal-actions">
                <button class="custom-modal-btn" id="modalConfirm">确定</button>
                <button class="custom-modal-btn" id="modalCancel">取消</button>
            </div>
        </div>
    </div>

    <script>
                // 更多按钮下拉菜单逻辑
                (function initMoreMenu() {
                    const moreBtn = document.getElementById('moreBtn');
                    const dropdown = document.getElementById('moreDropdown');

                    function toggleDropdown(forceState) {
                        const shouldShow = typeof forceState === 'boolean' ? forceState : !dropdown.classList.contains('show');
                        dropdown.classList.toggle('show', shouldShow);
                    }

                    moreBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleDropdown();
                    });

                    moreBtn.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            toggleDropdown();
                        } else if (e.key === 'Escape') {
                            toggleDropdown(false);
                        }
                    });

                    document.addEventListener('pointerdown', function(e) {
                        if (!moreBtn.contains(e.target)) {
                            toggleDropdown(false);
                        }
                    });

                    // 暴露关闭方法供其他逻辑复用
                    window.__hideMoreDropdown = () => toggleDropdown(false);
                })();

                // 清除浏览器数据功能
                document.getElementById('clearBrowserDataBtn').addEventListener('click', async function() {
                    if (window.electronAPI) {
                        const res = await window.electronAPI.invoke('clear-browser-data');
                        if (res && res.success) {
                            showToast('浏览器数据已清除', 'success');
                        } else {
                            showToast('清除失败: ' + (res && res.error ? res.error : '未知错误'), 'error');
                        }
                    } else {
                        showToast('当前环境不支持清除浏览器数据', 'warning');
                    }
                    window.__hideMoreDropdown && window.__hideMoreDropdown();
                });
        // 全局变量
        let isResizing = false;
        let uploadedImages = [];
        let selectedImages = new Set();
        let draggedItem = null;
        const maxImages = 4;
        let detectedUrls = [];

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            initResizable();
            initTextEditor();
            initImageUpload();
            initButtons();
            initModal();
            initIPC();
            initClipboardBtn();

            // Global context menu for images
            document.addEventListener('contextmenu', function(e) {
                if (e.target.tagName === 'IMG') {
                    // Check if it's in left panel (already handled)
                    if (e.target.closest('.image-preview-item')) return;
                    // Check if it's in right panel (already handled)
                    if (e.target.closest('.parsed-image-item')) return;
                    
                    e.preventDefault();
                    if (window.electronAPI) {
                        window.electronAPI.send('show-image-context-menu', { src: e.target.src, type: 'normal' });
                    }
                }
            });
        });

        // 主题切换
        function initTheme() {
            const themeBtn = document.getElementById('themeBtn');
            const themeIconLight = document.getElementById('themeIconLight');
            const themeIconDark = document.getElementById('themeIconDark');
            
            // 检查系统主题偏好
            const systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            // 优先使用本地存储的主题，如果没有则跟随系统
            const savedTheme = localStorage.getItem('theme');
            const isDark = savedTheme ? (savedTheme === 'dark') : systemDark;

            function updateThemeIcon(isDark) {
                if (isDark) {
                    themeIconLight.style.display = 'none';
                    themeIconDark.style.display = 'inline';
                } else {
                    themeIconLight.style.display = 'inline';
                    themeIconDark.style.display = 'none';
                }
            }

            // 应用初始主题
            if (isDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon(true);
                if (window.electronAPI) {
                    window.electronAPI.invoke('set-theme', true);
                }
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                updateThemeIcon(false);
                if (window.electronAPI) {
                    window.electronAPI.invoke('set-theme', false);
                }
            }

            // 监听系统主题变化
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    // 只有在用户没有手动设置过主题的情况下才跟随系统变化
                    if (!localStorage.getItem('theme')) {
                        const newIsDark = e.matches;
                        if (newIsDark) {
                            document.documentElement.setAttribute('data-theme', 'dark');
                            updateThemeIcon(true);
                        } else {
                            document.documentElement.setAttribute('data-theme', 'light');
                            updateThemeIcon(false);
                        }
                        if (window.electronAPI) {
                            window.electronAPI.invoke('set-theme', newIsDark);
                        }
                    }
                });
            }

            themeBtn.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                const isDarkMode = newTheme === 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(isDarkMode);

                if (window.electronAPI) {
                    window.electronAPI.invoke('set-theme', isDarkMode)
                        .then(result => {
                            if (!result.success) {
                                console.error('主题设置失败:', result.error);
                            }
                        });
                }

                showToast(`已切换到${isDarkMode ? '深色' : '浅色'}模式`, 'success');
            });
        }

        // 可调整大小的分隔线
        function initResizable() {
            const resizer = document.getElementById('resizer');
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const container = document.querySelector('.container');

            function handleResizeMove(clientX) {
                const containerRect = container.getBoundingClientRect();
                const percentage = ((clientX - containerRect.left) / containerRect.width) * 100;
                
                const minPercent = 30;
                const maxPercent = 65;
                
                if (percentage > minPercent && percentage < maxPercent) {
                    leftPanel.style.flex = `0 0 ${percentage}%`;
                    rightPanel.style.flex = `0 0 ${100 - percentage}%`;
                } else if (percentage <= minPercent) {
                    leftPanel.style.flex = `0 0 ${minPercent}%`;
                    rightPanel.style.flex = `0 0 ${100 - minPercent}%`;
                } else if (percentage >= maxPercent) {
                    leftPanel.style.flex = `0 0 ${maxPercent}%`;
                    rightPanel.style.flex = `0 0 ${100 - maxPercent}%`;
                }
            }

            // Mouse Events
            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                e.preventDefault();
                handleResizeMove(e.clientX);
            });

            document.addEventListener('mouseup', function() {
                isResizing = false;
                document.body.style.cursor = 'default';
            });

            // Touch Events (复用逻辑)
            resizer.addEventListener('touchstart', function(e) {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            }, { passive: false });

            document.addEventListener('touchmove', function(e) {
                if (!isResizing) return;
                e.preventDefault();
                handleResizeMove(e.touches[0].clientX);
            }, { passive: false });

            document.addEventListener('touchend', function() {
                isResizing = false;
                document.body.style.cursor = 'default';
            });
        }

        // 文本编辑器
        function initTextEditor() {
            const textInput = document.getElementById('textInput');
            const editBtn = document.getElementById('editBtn');
            const editOptions = document.getElementById('editOptions');

            // 自动识别链接
            textInput.addEventListener('input', function() {
                const text = this.innerText;
                const urlRegex = /(https?:\/\/|www\.)[^\s<]+/g;
                const matches = text.match(urlRegex);
                
                if (matches && matches.length > 0) {
                    // 检查是否有新的链接
                    const newUrls = matches.filter(url => !detectedUrls.includes(url));
                    if (newUrls.length > 0) {
                        detectedUrls = [...detectedUrls, ...newUrls];
                        showToast(`检测到 ${newUrls.length} 个网址链接`, 'info');
                    }
                }
            });

            // 编辑选项切换
            editBtn.addEventListener('click', function() {
                editOptions.classList.toggle('active');
                this.classList.toggle('active');
            });

            // 编辑按钮功能
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const command = this.dataset.command;
                    document.execCommand(command, false, null);
                    textInput.focus();
                });
            });
        }

        // 渲染图片
        function renderImages() {
            const imagePreview = document.getElementById('imagePreview');
            
            // If we are dragging, we don't want to full re-render as it kills the drag state
            // But we need to update selection styles
            if (draggedItem) {
                const items = imagePreview.querySelectorAll('.image-preview-item');
                items.forEach(item => {
                    const id = parseFloat(item.dataset.id);
                    if (selectedImages.has(id)) item.classList.add('selected');
                    else item.classList.remove('selected');
                });
                return;
            }

            imagePreview.innerHTML = '';
            uploadedImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                if (selectedImages.has(image.id)) {
                    item.classList.add('selected');
                }
                item.draggable = true;
                item.dataset.id = image.id;
                item.dataset.index = index;

                item.innerHTML = `
                    <img src="${image.url}" alt="${image.name}">
                    <button class="image-delete-btn" data-id="${image.id}">×</button>
                `;
                
                // Click to select
                item.addEventListener('click', function(e) {
                    if (e.target.classList.contains('image-delete-btn')) return;
                    if (e.ctrlKey || e.metaKey) {
                        if (selectedImages.has(image.id)) selectedImages.delete(image.id);
                        else selectedImages.add(image.id);
                    } else {
                        selectedImages.clear();
                        selectedImages.add(image.id);
                    }
                    renderImages();
                });

                item.addEventListener('dblclick', () => showImageModal(image.url));
                
                item.querySelector('.image-delete-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteImage(image.id);
                });

                // Drag events
                item.addEventListener('dragstart', function(e) {
                    draggedItem = image;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', image.id);
                    
                    // Select if not selected
                    if (!selectedImages.has(image.id)) {
                        selectedImages.clear();
                        selectedImages.add(image.id);
                        // Update styles manually to avoid re-render
                        document.querySelectorAll('.image-preview-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                    }

                    // Create placeholder immediately
                    setTimeout(() => {
                        item.style.display = 'none';
                        createPlaceholder(index);
                    }, 0);
                });

                item.addEventListener('dragend', function() {
                    draggedItem = null;
                    item.classList.remove('dragging');
                    item.style.display = '';
                    removePlaceholder();
                    renderImages(); // Re-render to ensure clean state
                });

                imagePreview.appendChild(item);
            });
        }

        // Placeholder helpers
        function createPlaceholder(index) {
            const imagePreview = document.getElementById('imagePreview');
            let placeholder = document.getElementById('dragPlaceholder');
            if (!placeholder) {
                placeholder = document.createElement('div');
                placeholder.id = 'dragPlaceholder';
                placeholder.className = 'image-placeholder';
            }
            
            const items = Array.from(imagePreview.children).filter(el => el.style.display !== 'none');
            if (index < items.length) {
                imagePreview.insertBefore(placeholder, items[index]);
            } else {
                imagePreview.appendChild(placeholder);
            }
        }

        function removePlaceholder() {
            const placeholder = document.getElementById('dragPlaceholder');
            if (placeholder) placeholder.remove();
        }

        // 粘贴处理逻辑
        async function handlePaste() {
            if (uploadedImages.length >= maxImages) {
                showToast(`最多只能上传${maxImages}张图片`, 'warning');
                return;
            }

            if (navigator.clipboard && window.ClipboardItem) {
                try {
                    const items = await navigator.clipboard.read();
                    let foundImage = false;
                    for (const item of items) {
                        for (const type of item.types) {
                            if (type.startsWith('image/')) {
                                foundImage = true;
                                const blob = await item.getType(type);
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const imageData = {
                                        id: Date.now() + Math.random(),
                                        url: e.target.result,
                                        name: '剪贴板图片'
                                    };
                                    uploadedImages.push(imageData);
                                    renderImages();
                                    showToast('剪贴板图片已上传', 'success');
                                };
                                reader.readAsDataURL(blob);
                                return;
                            }
                        }
                    }
                    if (!foundImage) {
                        showToast('剪贴板中没有图片', 'warning');
                    }
                } catch (err) {
                    console.error(err);
                    showToast('无法访问剪贴板内容', 'error');
                }
            } else {
                showToast('当前浏览器不支持剪贴板API', 'error');
            }
        }

        // 删除图片
        function deleteImage(id) {
            uploadedImages = uploadedImages.filter(img => img.id !== id);
            selectedImages.delete(id);
            renderImages();
            showToast('图片已删除', 'success');
        }

        // 图片上传
        function initImageUpload() {
            const leftPanel = document.getElementById('leftPanel');
            const fileInput = document.getElementById('fileInput');
            const imagePreview = document.getElementById('imagePreview');
            const imageBtn = document.getElementById('imageBtn');

            // Container Drag Events for Reordering
            imagePreview.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (!draggedItem) return;

                const placeholder = document.getElementById('dragPlaceholder');
                if (!placeholder) return;

                // Get all items except placeholder and hidden dragged item
                const items = Array.from(imagePreview.children).filter(el => 
                    el !== placeholder && el.style.display !== 'none' && el.classList.contains('image-preview-item')
                );
                
                // Find the element under cursor
                const target = e.target.closest('.image-preview-item');
                
                if (target && target !== placeholder && target.style.display !== 'none') {
                    const box = target.getBoundingClientRect();
                    const next = (e.clientX - box.left) > (box.width / 2);
                    
                    if (next) {
                        imagePreview.insertBefore(placeholder, target.nextSibling);
                    } else {
                        imagePreview.insertBefore(placeholder, target);
                    }
                } else if (items.length === 0) {
                    imagePreview.appendChild(placeholder);
                } else {
                    // If not over any item, check if we are at the end
                    const lastItem = items[items.length - 1];
                    const lastBox = lastItem.getBoundingClientRect();
                    if (e.clientY > lastBox.bottom || (e.clientY > lastBox.top && e.clientX > lastBox.right)) {
                        imagePreview.appendChild(placeholder);
                    }
                }
            });

            imagePreview.addEventListener('drop', function(e) {
                e.preventDefault();
                if (!draggedItem) return;
                
                const placeholder = document.getElementById('dragPlaceholder');
                if (placeholder) {
                    // Reconstruct uploadedImages based on DOM order
                    const newOrder = [];
                    const allChildren = Array.from(imagePreview.children);
                    
                    allChildren.forEach(child => {
                        if (child === placeholder) {
                            newOrder.push(draggedItem);
                        } else if (child.classList.contains('image-preview-item') && child.style.display !== 'none') {
                            const id = parseFloat(child.dataset.id);
                            const img = uploadedImages.find(i => i.id === id);
                            if (img) newOrder.push(img);
                        }
                    });
                    
                    uploadedImages = newOrder;
                }
                // dragend will handle cleanup
            });

            // 图片按钮点击
            imageBtn.addEventListener('click', function() {
                if (uploadedImages.length >= maxImages) {
                    showToast(`最多只能上传${maxImages}张图片`, 'warning');
                    return;
                }
                fileInput.click();
            });

            // 文件选择
            fileInput.addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });

            // 拖拽上传 - 绑定到左侧面板
            const dragOverlay = document.getElementById('dragOverlay');
            leftPanel.addEventListener('dragover', function(e) {
                e.preventDefault();
                // If dragging an internal item, don't show overlay
                if (draggedItem) return;

                // 检查是否为文件或图片链接
                let isFile = false;
                let isImage = false;
                
                if (e.dataTransfer.types) {
                    const types = Array.from(e.dataTransfer.types);
                    if (types.includes('Files')) isFile = true;
                    if (types.includes('text/uri-list')) isImage = true;
                }

                // 进一步检查文件类型
                if (e.dataTransfer.items) {
                    for (let i = 0; i < e.dataTransfer.items.length; i++) {
                        const t = e.dataTransfer.items[i].type || '';
                        if (t.startsWith('image/')) {
                            isImage = true;
                        }
                    }
                }

                // 如果既不是文件也不是图片链接（例如纯文本），则不显示遮罩
                if (!isFile && !isImage) {
                    dragOverlay.classList.remove('active');
                    return;
                }

                dragOverlay.classList.add('active');
                dragOverlay.classList.remove('error', 'success', 'full');
                
                if (uploadedImages.length >= maxImages) {
                    dragOverlay.classList.add('full');
                    dragOverlay.textContent = '最多只能上传4张图片';
                } else if (isImage || (isFile && isImage)) {
                    dragOverlay.classList.add('success');
                    dragOverlay.textContent = '拖入图片以添加';
                } else if (isFile) {
                    dragOverlay.classList.add('success');
                    dragOverlay.textContent = '拖入图片以添加';
                } else {
                    dragOverlay.classList.add('error');
                    dragOverlay.textContent = '不支持的内容';
                }
            });
            leftPanel.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dragOverlay.classList.remove('active', 'error', 'success', 'full');
                dragOverlay.textContent = '拖入图片以添加';
            });
            leftPanel.addEventListener('drop', function(e) {
                e.preventDefault();
                // If dragging internal item, handle reorder
                if (draggedItem) {
                    return;
                }

                dragOverlay.classList.remove('active', 'error', 'success', 'full');
                
                // 优先处理文件
                if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    if (uploadedImages.length >= maxImages) {
                        showToast(`最多只能上传${maxImages}张图片`, 'warning');
                        return;
                    }
                    handleFiles(e.dataTransfer.files);
                    return;
                }

                // 处理 URL
                let url = '';
                try {
                    if (e.dataTransfer) {
                        // 优先使用 uri-list
                        url = e.dataTransfer.getData('text/uri-list');
                        
                        // 如果没有 uri-list，检查 text/plain 是否像 URL
                        if (!url) {
                            const text = e.dataTransfer.getData('text/plain');
                            // 简单的 URL 校验，避免普通文本被误认
                            if (text && (text.startsWith('http://') || text.startsWith('https://') || text.startsWith('data:image'))) {
                                url = text;
                            }
                        }
                    }
                } catch (err) {
                    url = '';
                }

                if (url) {
                    if (uploadedImages.length >= maxImages) {
                        showToast(`最多只能上传${maxImages}张图片`, 'warning');
                        return;
                    }
                    // 简单判断是否为图片链接
                    const lower = url.toLowerCase();
                    const isLikelyImage = lower.startsWith('data:') || /(\.png|\.jpe?g|\.gif|\.webp|\.bmp|\.svg)(\?.*)?$/.test(lower) || /^https?:\/\/.+\.(png|jpe?g|gif|webp|bmp|svg)(\?.*)?$/i.test(url);
                    
                    const imagePreview = document.getElementById('imagePreview');
                    const nameFromUrl = url.split('/').pop().split('?')[0];
                    const imageData = {
                        id: Date.now() + Math.random(),
                        url: url,
                        name: nameFromUrl || '远程图片'
                    };
                    // 如果不是显然为图片，也允许加入（浏览器会根据 src 显示或失败）
                    uploadedImages.push(imageData);
                    // 使用已有渲染函数更新 UI
                    renderImages();
                    showToast('图片已从右侧添加', 'success');
                    return;
                }

                showToast('无可用图片或不支持的拖放内容', 'error');
            });

            // 粘贴上传
            document.addEventListener('paste', function(e) {
                const items = e.clipboardData.items;
                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (uploadedImages.length < maxImages) {
                            handleFiles([file]);
                        } else {
                            showToast(`最多只能上传${maxImages}张图片`, 'warning');
                        }
                    }
                }
            });

            // 处理文件
            function handleFiles(files) {
                // 新增：只允许添加剩余数量的图片
                const remain = maxImages - uploadedImages.length;
                if (remain <= 0) {
                    showToast(`最多只能上传${maxImages}张图片`, 'warning');
                    return;
                }
                let addedCount = 0;
                let validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                // 只取剩余数量的图片
                validFiles = validFiles.slice(0, remain);
                validFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            id: Date.now() + Math.random(),
                            url: e.target.result,
                            name: file.name
                        };
                        uploadedImages.push(imageData);
                        renderImages();
                        showToast('图片上传成功', 'success');
                    };
                    reader.readAsDataURL(file);
                    addedCount++;
                });
                if (files.length > 0 && addedCount === 0) {
                    showToast(`最多只能上传${maxImages}张图片`, 'warning');
                }
            }

            // Context Menu
            imagePreview.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                const item = e.target.closest('.image-preview-item');
                if (item) {
                    const id = parseFloat(item.dataset.id);
                    // If right clicking an item not in selection, select it (and deselect others)
                    if (!selectedImages.has(id)) {
                        selectedImages.clear();
                        selectedImages.add(id);
                        renderImages();
                    }
                    
                    const image = uploadedImages.find(img => img.id === id);
                    if (image && window.electronAPI) {
                        window.electronAPI.send('show-image-context-menu', { src: image.url, type: 'left-side' });
                    }
                }
            });

            // Right side images context menu
            const parsedImages = document.getElementById('parsedImages');
            if (parsedImages) {
                parsedImages.addEventListener('contextmenu', function(e) {
                    const item = e.target.closest('.parsed-image-item');
                    if (item) {
                        e.preventDefault();
                        e.stopPropagation(); // 阻止冒泡，防止触发全局图片右键菜单
                        const img = item.querySelector('img');
                        if (img && window.electronAPI) {
                            window.electronAPI.send('show-image-context-menu', { src: img.src, type: 'right-side' });
                        }
                    }
                });
            }

            // IPC Listener for delete
            if (window.electronAPI) {
                window.electronAPI.on('menu-action-delete-selected', () => {
                    if (selectedImages.size > 0) {
                        uploadedImages = uploadedImages.filter(img => !selectedImages.has(img.id));
                        selectedImages.clear();
                        renderImages();
                        showToast('已删除选中图片', 'success');
                    }
                });
                
                window.electronAPI.on('menu-action-paste', () => {
                    handlePaste();
                });
            }
        }

        // 自定义弹窗逻辑
        function showCustomModal(options) {
            // 兼容旧用法: showCustomModal(onConfirm, onCancel)
            if (typeof options === 'function') {
                options = {
                    onConfirm: options,
                    onCancel: arguments[1],
                    title: '确认操作',
                    message: '确定要清空所有内容吗？',
                    confirmText: '确定',
                    cancelText: '取消'
                };
            }

            const modal = document.getElementById('customModal');
            const titleEl = modal.querySelector('.custom-modal-title');
            const messageEl = modal.querySelector('.custom-modal-message');
            const confirmBtn = document.getElementById('modalConfirm');
            const cancelBtn = document.getElementById('modalCancel');
            
            // 查找或创建第三个按钮
            let optionBtn = document.getElementById('modalOption');
            if (!optionBtn) {
                optionBtn = document.createElement('button');
                optionBtn.id = 'modalOption';
                optionBtn.className = 'custom-modal-btn secondary';
                optionBtn.style.display = 'none';
                // 插入到 confirmBtn 之前
                confirmBtn.parentNode.insertBefore(optionBtn, confirmBtn);
            }

            titleEl.textContent = options.title || '确认操作';
            messageEl.textContent = options.message || '确定要清空所有内容吗？';
            confirmBtn.textContent = options.confirmText || '确定';
            cancelBtn.textContent = options.cancelText || '取消';

            if (options.optionText) {
                optionBtn.textContent = options.optionText;
                optionBtn.style.display = 'inline-block';
                optionBtn.onclick = function() {
                    modal.classList.remove('active');
                    if (options.onOption) options.onOption();
                };
            } else {
                optionBtn.style.display = 'none';
            }

            modal.classList.add('active');
            
            // 解绑旧事件
            confirmBtn.onclick = function() {
                modal.classList.remove('active');
                if (options.onConfirm) options.onConfirm();
            };
            cancelBtn.onclick = function() {
                modal.classList.remove('active');
                if (options.onCancel) options.onCancel();
            };
        }

        // 按钮功能
        function initButtons() {
            // Ripple Effect (排除更多按钮)
            document.querySelectorAll('.toolbar-btn:not(.more-menu), .detect-btn, .custom-modal-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    ripple.classList.add('ripple');
                    this.appendChild(ripple);
                    
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    
                    ripple.style.width = ripple.style.height = `${size}px`;
                    ripple.style.left = `${e.clientX - rect.left - size/2}px`;
                    ripple.style.top = `${e.clientY - rect.top - size/2}px`;
                    
                    ripple.addEventListener('animationend', () => {
                        ripple.remove();
                    });
                });
            });

            // 页面预览功能
            document.getElementById('previewBtn').addEventListener('click', function() {
                const text = document.getElementById('textInput').innerText.trim();
                
                if (!text && uploadedImages.length === 0) {
                    showToast('没有可预览的内容', 'warning');
                    return;
                }

                if (isURL(text)) {
                    // URL Preview
                    extractContent(text, true);
                } else {
                    // Local Preview
                    renderPreview(text, uploadedImages);
                    showToast('已生成本地预览', 'success');
                }
            });

            // 清空按钮
            document.getElementById('clearBtn').addEventListener('click', function() {
                showCustomModal(() => {
                    document.getElementById('textInput').innerText = '';
                    uploadedImages = [];
                    detectedUrls = [];
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('initialState').style.display = 'flex';
                    document.getElementById('resultItem').classList.remove('active');
                    document.getElementById('errorState').classList.remove('active');
                    document.getElementById('loadingState').classList.remove('active');
                    showToast('内容已清空', 'success');
                });
            });

            // 检测按钮
            let lastTextContent = '';
            let lastImages = [];
            document.getElementById('detectBtn').addEventListener('click', function() {
                const textContent = document.getElementById('textInput').innerText.trim();
                // 优先判断内容是否为空
                if (!textContent) {
                    if (uploadedImages.length > 0) {
                        showToast('请添加相关的文本内容以进行检测', 'warning');
                    } else {
                        showToast('请输入需要检测的新闻内容', 'warning');
                    }
                    return;
                }
                // 判断内容和图片是否有变化
                const imagesNow = uploadedImages.map(img => img.url).join(',');
                const imagesLast = lastImages.join(',');
                // 检查右侧是否为空（初始状态是否显示）
                const isResultEmpty = document.getElementById('initialState').style.display !== 'none';
                // 检查是否处于错误状态
                const isErrorState = document.getElementById('errorState').classList.contains('active');
                
                if (textContent === lastTextContent && imagesNow === imagesLast && !isResultEmpty && !isErrorState) {
                    showToast('内容未变化，无需重复检测', 'info');
                    return;
                }
                // 检查是否为URL
                if (isURL(textContent)) {
                    if (uploadedImages.length > 0) {
                        // 弹出询问对话框
                        showCustomModal({
                            title: '检测到链接和图片',
                            message: '您输入了链接同时也上传了图片，请选择处理方式：',
                            confirmText: '仅提取链接内容', // 对应 extractContent
                            optionText: '图文混合分析', // 对应 analyzeContent
                            cancelText: '取消',
                            onConfirm: () => {
                                window.lastExtractedUrl = textContent;
                                extractContent(textContent);
                            },
                            onOption: () => {
                                window.lastExtractedUrl = null;
                                analyzeContent(textContent, uploadedImages);
                            },
                            onCancel: () => {
                                // 取消，不做任何事
                            }
                        });
                        return;
                    }
                    
                    window.lastExtractedUrl = textContent;
                    extractContent(textContent);
                } else {
                    window.lastExtractedUrl = null;
                    analyzeContent(textContent, uploadedImages);
                }
                // 记录本次内容和图片
                lastTextContent = textContent;
                lastImages = uploadedImages.map(img => img.url);
            });
        }

        // 检查是否为URL
        function isURL(text) {
            try {
                new URL(text);
                return true;
            } catch {
                return false;
            }
        }

        // 内容提取功能
        function extractContent(url, isPreview = false) {
            const detectBtn = document.getElementById('detectBtn');
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const progressBar = document.getElementById('progressBar');
            const loadingText = document.getElementById('loadingText');
            const cancelBtn = document.getElementById('cancelExtractBtn');

            // 重置状态
            initialState.style.display = 'none';
            resultItem.classList.remove('active');
            errorState.classList.remove('active');
            loadingState.classList.add('active');
            
            // 显示取消按钮
            if (cancelBtn) cancelBtn.style.display = 'block';
            
            // 初始化进度条
            progressBar.style.width = '0%';
            loadingText.textContent = isPreview ? '正在解析网页以预览...' : '正在解析网页内容...';

            detectBtn.classList.add('loading');
            detectBtn.innerHTML = isPreview ? '预览中...' : '提取中...';

            // 模拟进度增长
            let progress = 10;
            const progressInterval = setInterval(() => {
                if (progress < 45) {
                    progress += 1;
                    progressBar.style.width = progress + '%';
                }
            }, 200);

            let timeoutId;
            let finished = false;
            
            // 取消处理逻辑
            function handleCancel() {
                if (finished) return;
                finished = true;
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                
                loadingState.classList.remove('active');
                detectBtn.classList.remove('loading');
                detectBtn.innerHTML = '开始检测';
                if (cancelBtn) cancelBtn.style.display = 'none';
                
                // 恢复初始状态
                initialState.style.display = 'flex';
                
                showToast('用户已取消', 'info');
            }

            // 绑定取消按钮事件
            if (cancelBtn) {
                cancelBtn.onclick = function() {
                    if (finished) return;
                    if (window.electronAPI) {
                        window.electronAPI.send('cancel-extraction');
                    } else {
                        handleCancel();
                    }
                };
            }

            // 超时处理函数
            function handleTimeout() {
                if (finished) return;
                finished = true;
                clearInterval(progressInterval);
                loadingState.classList.remove('active');
                detectBtn.classList.remove('loading');
                detectBtn.innerHTML = '开始检测';
                if (cancelBtn) cancelBtn.style.display = 'none';
                showError('网页内容提取超时，请稍后重试');
                showToast('提取失败：超时', 'error');
            }
            timeoutId = setTimeout(handleTimeout, 10000);

            // 调用主进程的内容提取功能
            if (window.electronAPI) {
                window.electronAPI.send('extract-content', url);
                
                // 监听一次性结果（防止多次触发）
                const handler = function(event, result) {
                    if (finished) return;
                    finished = true;
                    clearTimeout(timeoutId);
                    clearInterval(progressInterval);
                    if (cancelBtn) cancelBtn.style.display = 'none';
                    
                    if (result.success) {
                        if (isPreview) {
                            progressBar.style.width = '100%';
                            loadingState.classList.remove('active');
                            detectBtn.classList.remove('loading');
                            detectBtn.innerHTML = '开始检测';
                            renderPreview(result.content, result.images, result.title);
                            showToast('网页预览已生成', 'success');
                        } else {
                            // 提取成功，进度设为50%
                            progressBar.style.width = '50%';
                            loadingText.textContent = '正在分析新闻中...';
                            
                            // showExtractedResult(result);
                            showToast('提取完成，正在进行AI分析...', 'success');
                            // 传递 true 表示从提取流程进入
                            analyzeContent(result.content, result.images, true);
                        }
                    } else {
                        if (result.error === '提取已取消') return; // 由 cancelled 事件处理
                        
                        detectBtn.classList.remove('loading');
                        detectBtn.innerHTML = '开始检测';
                        showError(result.error);
                        showToast('提取失败: ' + result.error, 'error');
                    }
                    window.electronAPI.off && window.electronAPI.off('extract-content-result', handler);
                    window.electronAPI.off && window.electronAPI.off('extraction-cancelled', cancelListener);
                };
                
                const cancelListener = function() {
                    handleCancel();
                    window.electronAPI.off && window.electronAPI.off('extract-content-result', handler);
                    window.electronAPI.off && window.electronAPI.off('extraction-cancelled', cancelListener);
                };

                // 兼容性：如无off方法则不解绑
                window.electronAPI.on('extract-content-result', handler);
                window.electronAPI.once('extraction-cancelled', cancelListener);
            } else {
                // 模拟提取结果
                setTimeout(() => {
                    if (finished) return;
                    finished = true;
                    clearTimeout(timeoutId);
                    clearInterval(progressInterval);
                    if (cancelBtn) cancelBtn.style.display = 'none';
                    
                    // 模拟数据
                    const mockResult = {
                        success: true,
                        title: '示例新闻标题',
                        content: '这是一个模拟的新闻内容提取结果。这里会显示从网页解析出来的正文内容。',
                        images: ['https://via.placeholder.com/300'],
                        url: url
                    };
                    
                    if (isPreview) {
                        progressBar.style.width = '100%';
                        loadingState.classList.remove('active');
                        detectBtn.classList.remove('loading');
                        detectBtn.innerHTML = '开始检测';
                        renderPreview(mockResult.content, mockResult.images, mockResult.title);
                        showToast('网页预览已生成', 'success');
                    } else {
                        progressBar.style.width = '50%';
                        loadingText.textContent = '正在分析新闻中...';
                        
                        showToast('提取完成', 'success');
                        analyzeContent(mockResult.content, mockResult.images, true);
                    }
                }, 2000);
            }
        }

        // 渲染预览内容（隐藏评分和观点）
        function renderPreview(text, images, title = null) {
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            // Hide Score and Analysis
            const scoreSection = resultItem.querySelector('.result-score');
            const analysisSection = resultItem.querySelector('.result-analysis');
            if(scoreSection) scoreSection.style.display = 'none';
            if(analysisSection) analysisSection.style.display = 'none';

            // Show Content
            parsedContent.style.display = 'block';
            parsedTitle.textContent = title || '';
            parsedTitle.style.display = title ? 'block' : 'none';
            parsedText.textContent = text || '';
            
            // Render Images
            parsedImages.innerHTML = '';
            let imagesToRender = [];
            if (images && images.length > 0) {
                 const limitedImages = images.slice(0, 4);
                 imagesToRender = limitedImages.map(img => typeof img === 'string' ? {url: img, name: 'Image'} : img);
            }
            
            imagesToRender.forEach(img => {
                const item = document.createElement('div');
                item.className = 'parsed-image-item';
                item.innerHTML = `<img src="${img.url}" alt="${img.name}">`;
                item.addEventListener('click', () => showImageModal(img.url));
                parsedImages.appendChild(item);
            });
            
            initialState.style.display = 'none';
            resultItem.classList.add('active');
        }

        // 初始化IPC通信
        function initIPC() {
            if (window.electronAPI) {
                // 监听内容提取结果 - 已移至 extractContent 函数中单独处理，避免冲突
                /*
                window.electronAPI.on('extract-content-result', function(event, result) {
                    const detectBtn = document.getElementById('detectBtn');
                    detectBtn.classList.remove('loading');
                    detectBtn.innerHTML = '开始检测';

                    if (result.success) {
                        // 显示提取结果
                        showExtractedResult(result);
                        showToast('提取完成', 'success');
                    } else {
                        showError(result.error);
                        showToast('提取失败: ' + result.error, 'error');
                    }
                });
                */

                // 监听清除内容（直接清空）事件，保留以兼容旧逻辑
                window.electronAPI.on('clear-results', function() {
                    document.getElementById('initialState').style.display = 'flex';
                    document.getElementById('resultItem').classList.remove('active');
                    document.getElementById('errorState').classList.remove('active');
                    document.getElementById('loadingState').classList.remove('active');
                });

                // 监听主进程请求显示清空确认弹窗（来自右键菜单）
                window.electronAPI.on('request-clear', function() {
                    showCustomModal(() => {
                        // 确认后执行同样的清空逻辑
                        document.getElementById('textInput').innerText = '';
                        uploadedImages = [];
                        detectedUrls = [];
                        document.getElementById('imagePreview').innerHTML = '';
                        document.getElementById('initialState').style.display = 'flex';
                        document.getElementById('resultItem').classList.remove('active');
                        document.getElementById('errorState').classList.remove('active');
                        document.getElementById('loadingState').classList.remove('active');
                        showToast('内容已清空', 'success');
                    }, () => {
                        // 取消时不作操作
                    });
                });
            }
        }

        // 显示检测结果
        function showResult() {
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            // 获取输入内容
            const textContent = document.getElementById('textInput').innerText.trim();
            
            // 随机生成分数
            const score = Math.floor(Math.random() * 40) + 20;
            const scoreText = document.getElementById('scoreText');
            const scoreValue = document.getElementById('scoreValue');
            const scoreDescription = document.getElementById('scoreDescription');
            const scoreProgress = document.getElementById('scoreProgress');
            const scoreContainer = document.getElementById('scoreCircleContainer');
            
            scoreText.textContent = score + '%';
            scoreValue.textContent = score + '%';
            
            // Reset classes
            scoreContainer.className = 'score-circle-container';
            
            if (score >= 80) {
                scoreContainer.classList.add('real');
                scoreDescription.textContent = '该内容具有较高的可信度';
            } else if (score >= 60) {
                scoreContainer.classList.add('uncertain');
                scoreDescription.textContent = '该内容存在一定的不确定性';
            } else {
                scoreContainer.classList.add('fake');
                scoreDescription.textContent = '该内容可能存在虚假信息';
            }
            
            // Animate Progress
            const circumference = 2 * Math.PI * 45; // r=45
            const offset = circumference - (score / 100) * circumference;
            scoreProgress.style.strokeDashoffset = circumference; // Reset first
            setTimeout(() => {
                scoreProgress.style.strokeDashoffset = offset;
            }, 100);
            
            // 显示输入内容
            parsedContent.style.display = 'block';
            parsedTitle.style.display = 'none'; // 纯文本输入无标题
            parsedText.textContent = textContent;
            
            // 渲染上传的图片
            parsedImages.innerHTML = '';
            if (uploadedImages.length > 0) {
                uploadedImages.forEach(img => {
                    const item = document.createElement('div');
                    item.className = 'parsed-image-item';
                    item.innerHTML = `<img src="${img.url}" alt="${img.name}">`;
                    // 允许从解析区域拖动到左侧（传递图片 URL）
                    item.setAttribute('draggable', 'true');
                    item.addEventListener('dragstart', (ev) => {
                        try {
                            ev.dataTransfer.setData('text/uri-list', img.url);
                            ev.dataTransfer.setData('text/plain', img.url);
                            ev.dataTransfer.effectAllowed = 'copy';
                        } catch (e) {}
                    });
                    item.addEventListener('click', () => showImageModal(img.url));
                    parsedImages.appendChild(item);
                });
            }
            
            initialState.style.display = 'none';
            resultItem.classList.add('active');
        }

        // 显示提取结果
        function showExtractedResult(result) {
            const loadingState = document.getElementById('loadingState');
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            loadingState.classList.remove('active');
            
            // 更新结果显示
            const scoreText = document.getElementById('scoreText');
            const scoreValue = document.getElementById('scoreValue');
            const scoreDescription = document.getElementById('scoreDescription');
            const scoreProgress = document.getElementById('scoreProgress');
            const scoreContainer = document.getElementById('scoreCircleContainer');
            
            // 使用随机分数作为示例
            const score = Math.floor(Math.random() * 40) + 60;
            scoreText.textContent = score + '%';
            scoreValue.textContent = score + '%';
            
            // Reset classes
            scoreContainer.className = 'score-circle-container';
            
            if (score >= 80) {
                scoreContainer.classList.add('real');
                scoreDescription.textContent = '该内容具有较高的可信度';
            } else if (score >= 60) {
                scoreContainer.classList.add('uncertain');
                scoreDescription.textContent = '该内容存在一定的不确定性';
            } else {
                scoreContainer.classList.add('fake');
                scoreDescription.textContent = '该内容可能存在虚假信息';
            }
            
            // Animate Progress
            const circumference = 2 * Math.PI * 45; // r=45
            const offset = circumference - (score / 100) * circumference;
            scoreProgress.style.strokeDashoffset = circumference; // Reset first
            setTimeout(() => {
                scoreProgress.style.strokeDashoffset = offset;
            }, 100);
            
            // 显示解析内容
            parsedContent.style.display = 'block';
            parsedTitle.textContent = result.title || '无标题';
            parsedTitle.style.display = result.title ? 'block' : 'none';
            parsedText.textContent = result.content || '';
            
            // 渲染图片
            parsedImages.innerHTML = '';
            if (result.images && result.images.length > 0) {
                result.images.forEach(imgUrl => {
                    const item = document.createElement('div');
                    item.className = 'parsed-image-item';
                    item.innerHTML = `<img src="${imgUrl}" alt="解析图片">`;
                    // 允许从解析区域拖动到左侧（传递图片 URL）
                    item.setAttribute('draggable', 'true');
                    item.addEventListener('dragstart', (ev) => {
                        try {
                            ev.dataTransfer.setData('text/uri-list', imgUrl);
                            ev.dataTransfer.setData('text/plain', imgUrl);
                            ev.dataTransfer.effectAllowed = 'copy';
                        } catch (e) {}
                    });
                    item.addEventListener('click', () => showImageModal(imgUrl));
                    parsedImages.appendChild(item);
                });
            }
            
            resultItem.classList.add('active');
        }

        function showError(message) {
            const errorState = document.getElementById('errorState');
            const errorDetail = document.getElementById('errorDetail');
            const loadingState = document.getElementById('loadingState');
            const detectBtn = document.getElementById('detectBtn');
            
            loadingState.classList.remove('active');
            detectBtn.classList.remove('loading');
            detectBtn.innerHTML = '开始检测';
            
            errorDetail.textContent = message || '无法获取网页内容，请检查链接是否有效';
            errorState.classList.add('active');
        }

        // 图片模态框
        function initModal() {
            const modal = document.getElementById('imageModal');
            const modalClose = document.getElementById('modalClose');
            const modalImage = document.getElementById('modalImage');

            modalClose.addEventListener('click', function() {
                modal.classList.remove('active');
            });

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        }

        function showImageModal(url) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = url;
            modal.classList.add('active');
        }

        // Toast 提示
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 剪贴板按钮功能
        function initClipboardBtn() {
            const clipboardBtn = document.getElementById('clipboardBtn');
            clipboardBtn.addEventListener('click', async function() {
                // 优先尝试读取图片
                if (navigator.clipboard && window.ClipboardItem) {
                    try {
                        const items = await navigator.clipboard.read();
                        let foundImage = false;
                        for (const item of items) {
                            for (const type of item.types) {
                                if (type.startsWith('image/')) {
                                    foundImage = true;
                                    const blob = await item.getType(type);
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        if (uploadedImages.length < maxImages) {
                                            const imageData = {
                                                id: Date.now() + Math.random(),
                                                url: e.target.result,
                                                name: '剪贴板图片'
                                            };
                                            uploadedImages.push(imageData);
                                            renderImages();
                                            showToast('剪贴板图片已上传', 'success');
                                        } else {
                                            showToast(`最多只能上传${maxImages}张图片`, 'warning');
                                        }
                                    };
                                    reader.readAsDataURL(blob);
                                    return;
                                }
                            }
                        }
                        if (!foundImage) {
                            // 没有图片则尝试读取文本
                            const text = await navigator.clipboard.readText();
                            if (text) {
                                document.getElementById('textInput').innerText = text;
                                showToast('剪贴板文本已粘贴', 'success');
                            } else {
                                showToast('剪贴板无可用内容', 'warning');
                            }
                        }
                    } catch (err) {
                        showToast('无法访问剪贴板内容', 'error');
                    }
                } else if (navigator.clipboard) {
                    // 兼容只支持文本的浏览器
                    try {
                        const text = await navigator.clipboard.readText();
                        if (text) {
                            document.getElementById('textInput').innerText = text;
                            showToast('剪贴板文本已粘贴', 'success');
                        } else {
                            showToast('剪贴板无可用内容', 'warning');
                        }
                    } catch (err) {
                        showToast('无法访问剪贴板内容', 'error');
                    }
                } else {
                    showToast('当前浏览器不支持剪贴板API', 'error');
                }
            });
        }
        // AI分析功能
        async function analyzeContent(text, images, fromExtraction = false) {
            const detectBtn = document.getElementById('detectBtn');
            const loadingState = document.getElementById('loadingState');
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const errorState = document.getElementById('errorState');
            const progressBar = document.getElementById('progressBar');
            const loadingText = document.getElementById('loadingText');

            // UI Loading State
            initialState.style.display = 'none';
            resultItem.classList.remove('active');
            errorState.classList.remove('active');
            loadingState.classList.add('active');
            detectBtn.classList.add('loading');
            detectBtn.innerHTML = 'AI分析中...';
            
            // 设置进度条初始状态
            if (fromExtraction) {
                progressBar.style.width = '50%';
            } else {
                progressBar.style.width = '0%';
                // 快速动画到 50%
                setTimeout(() => {
                    progressBar.style.width = '50%';
                }, 100);
            }
            loadingText.textContent = '正在分析新闻中...';

            // 模拟分析阶段的进度增长 (50% -> 90%)
            let progress = 50;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += 0.5; // 慢一点
                    progressBar.style.width = progress + '%';
                }
            }, 100);

            try {
                let imageUrls = [];
                if (images && images.length > 0) {
                    // 限制最多4张图片
                    const limitedImages = images.slice(0, 4);
                    imageUrls = limitedImages.map(img => typeof img === 'string' ? img : img.url);
                }

                let result;
                // 检查是否是URL提取的内容，如果是，尝试获取URL
                let sourceUrl = '';
                if (fromExtraction && window.lastExtractedUrl) {
                    sourceUrl = window.lastExtractedUrl;
                } else if (isURL(text)) {
                    sourceUrl = text;
                }

                if (window.electronAPI) {
                    const response = await window.electronAPI.invoke('analyze-content', { text, imageUrls, url: sourceUrl });
                    if (response.success) {
                        result = response.data;
                    } else {
                        throw new Error(response.error);
                    }
                } else {
                    // Mock for dev
                    await new Promise(r => setTimeout(r, 2000));
                    result = {
                        probability: 0.15,
                        type: 3,
                        explanation: "这是一个模拟的AI分析结果（假新闻）。",
                        fake_parts: [{ text: text.substring(0, 10), reason: "模拟原因" }]
                    };
                }

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                // 稍微延迟一下让用户看到100%
                setTimeout(() => {
                    showAnalysisResult(result, text, images);
                    showToast('分析完成', 'success');
                    loadingState.classList.remove('active');
                    detectBtn.classList.remove('loading');
                    detectBtn.innerHTML = '开始检测';
                }, 500);

            } catch (error) {
                clearInterval(progressInterval);
                console.error(error);
                showError('AI分析失败: ' + error.message);
                showToast('分析失败', 'error');
                loadingState.classList.remove('active');
                detectBtn.classList.remove('loading');
                detectBtn.innerHTML = '开始检测';
            }
        }

        function showAnalysisResult(result, originalText, originalImages) {
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            // Ensure Score and Analysis are visible (in case they were hidden by preview)
            const scoreSection = resultItem.querySelector('.result-score');
            const analysisSection = resultItem.querySelector('.result-analysis');
            if(scoreSection) scoreSection.style.display = 'flex';
            if(analysisSection) analysisSection.style.display = 'block';

            const scoreText = document.getElementById('scoreText');
            const scoreValue = document.getElementById('scoreValue');
            const scoreDescription = document.getElementById('scoreDescription');
            const scoreProgress = document.getElementById('scoreProgress');
            const scoreContainer = document.getElementById('scoreCircleContainer');
            
            // Probability to Percentage
            const percentage = Math.round(result.probability * 100);
            scoreText.textContent = percentage + '%';
            scoreValue.textContent = percentage + '%';
            
            // Reset classes
            scoreContainer.className = 'score-circle-container';
            
            // Color logic based on percentage
            if (percentage >= 75) {
                scoreContainer.classList.add('real');
            } else if (percentage >= 50) {
                scoreContainer.classList.add('uncertain');
            } else {
                scoreContainer.classList.add('fake');
            }
            
            // Animate Progress
            const circumference = 2 * Math.PI * 45; // r=45
            const offset = circumference - (percentage / 100) * circumference;
            scoreProgress.style.strokeDashoffset = circumference; // Reset first
            setTimeout(() => {
                scoreProgress.style.strokeDashoffset = offset;
            }, 100);
            
            // Type handling for description
            if (result.type === 1) { // True
                scoreDescription.innerHTML = `<strong>可信度高</strong><br>${result.explanation}`;
            } else if (result.type === 2) { // Partial
                scoreDescription.innerHTML = `<strong>部分存疑</strong><br>${result.explanation}`;
            } else { // Fake
                scoreDescription.innerHTML = `<strong>疑似虚假</strong><br>${result.explanation}`;
            }
            
            // Update Analysis Points
            const analysisContainer = document.querySelector('.result-analysis');
            // 清空旧的静态内容（保留标题）
            const analysisTitle = analysisContainer.querySelector('.analysis-title');
            analysisContainer.innerHTML = '';
            analysisContainer.appendChild(analysisTitle);

            if (result.analysis_points && Array.isArray(result.analysis_points)) {
                result.analysis_points.forEach(point => {
                    const item = document.createElement('div');
                    item.className = 'analysis-item';
                    
                    let icon = '✓';
                    let iconClass = 'positive';
                    
                    if (point.status === 'warning') {
                        icon = '!';
                        iconClass = 'warning';
                    } else if (point.status === 'negative') {
                        icon = '✕';
                        iconClass = 'negative';
                    }
                    
                    item.innerHTML = `
                        <div class="analysis-icon ${iconClass}">${icon}</div>
                        <div class="analysis-text">${point.description}</div>
                    `;
                    analysisContainer.appendChild(item);
                });
            } else {
                // Fallback if no analysis points provided
                analysisContainer.innerHTML += `<div class="analysis-item"><div class="analysis-text">暂无详细分析点</div></div>`;
            }
            
            // Display Content
            parsedContent.style.display = 'block';
            parsedTitle.style.display = 'none'; 
            
            // Highlight fake parts
            let displayText = originalText;
            if ((result.type === 2 || result.type === 3) && result.fake_parts) {
                let safeText = displayText.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                
                // Sort fake parts by length descending to avoid nested replacement issues
                const sortedParts = [...result.fake_parts].sort((a, b) => b.text.length - a.text.length);

                sortedParts.forEach(part => {
                    if (part.text) {
                        const safePart = part.text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        // 使用 CSS 类控制样式
                        const highlight = `<span class="fake-highlight" data-reason="${part.reason.replace(/"/g, '&quot;')}" onclick="showReasonTooltip(event, this)">${safePart}</span>`;
                        // Replace only the first occurrence to avoid over-replacing
                        safeText = safeText.replace(safePart, highlight);
                    }
                });
                parsedText.innerHTML = safeText;
            } else {
                parsedText.textContent = originalText;
            }
            
            // Render Images
            parsedImages.innerHTML = '';
            let imagesToRender = [];
            if (originalImages && originalImages.length > 0) {
                 // 限制最多显示4张图片
                 const limitedImages = originalImages.slice(0, 4);
                 imagesToRender = limitedImages.map(img => typeof img === 'string' ? {url: img, name: 'Image'} : img);
            }
            
            imagesToRender.forEach(img => {
                const item = document.createElement('div');
                item.className = 'parsed-image-item';
                item.innerHTML = `<img src="${img.url}" alt="${img.name}">`;
                item.addEventListener('click', () => showImageModal(img.url));
                parsedImages.appendChild(item);
            });
            
            resultItem.classList.add('active');
        }

        // Tooltip Logic
        let activeTooltipElement = null;
        let tooltipUpdateRaf = null;

        function updateTooltipPosition() {
            const tooltip = document.getElementById('customTooltip');
            if (!tooltip || !tooltip.classList.contains('active') || !activeTooltipElement) return;

            const rect = activeTooltipElement.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            // Calculate position (centered horizontally, below element)
            let top = rect.bottom + 10;
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

            // Viewport boundary checks
            const padding = 16;
            
            // Horizontal check
            if (left < padding) {
                left = padding;
            } else if (left + tooltipRect.width > window.innerWidth - padding) {
                left = window.innerWidth - tooltipRect.width - padding;
            }
            
            // Vertical check (flip to top if not enough space below)
            if (top + tooltipRect.height > window.innerHeight - padding) {
                top = rect.top - tooltipRect.height - 10;
            }

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        }

        function showReasonTooltip(event, element) {
            event.stopPropagation();
            
            // Remove active class from previous highlight
            if (activeTooltipElement) {
                activeTooltipElement.classList.remove('active');
            }

            const reason = element.getAttribute('data-reason');
            if (!reason) return;

            activeTooltipElement = element;
            activeTooltipElement.classList.add('active');

            let tooltip = document.getElementById('customTooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'customTooltip';
                tooltip.className = 'custom-tooltip';
                document.body.appendChild(tooltip);
            }

            tooltip.textContent = reason;
            tooltip.classList.add('active');

            // Initial position update
            updateTooltipPosition();
        }

        function hideTooltip() {
            const tooltip = document.getElementById('customTooltip');
            if (tooltip) {
                tooltip.classList.remove('active');
            }
            if (activeTooltipElement) {
                activeTooltipElement.classList.remove('active');
                activeTooltipElement = null;
            }
        }

        // Global event listeners for tooltip management
        document.addEventListener('click', function(e) {
            const tooltip = document.getElementById('customTooltip');
            // If clicking inside tooltip, do nothing
            if (tooltip && tooltip.contains(e.target)) {
                return;
            }
            // If clicking a highlight, it's handled by onclick
            if (e.target.classList.contains('fake-highlight')) {
                return;
            }
            
            hideTooltip();
        });

        // Update position on scroll and resize
        // Use capture to catch scroll events from any container
        window.addEventListener('scroll', function() {
            if (activeTooltipElement) {
                if (tooltipUpdateRaf) cancelAnimationFrame(tooltipUpdateRaf);
                tooltipUpdateRaf = requestAnimationFrame(updateTooltipPosition);
            }
        }, true);

        window.addEventListener('resize', function() {
            if (activeTooltipElement) {
                updateTooltipPosition();
            }
        });
    </script>
</body>
</html>
