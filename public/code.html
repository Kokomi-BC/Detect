<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡æ–°é—»æ£€æµ‹ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #4361ee;
            --accent-hover: #3651d4;
            --success-color: #06ffa5;
            --warning-color: #ffbe0b;
            --danger-color: #fb5607;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1d23;
            --bg-secondary: #22262e;
            --bg-tertiary: #2a2f38;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --border-color: #3a3f47;
            --accent-color: #5a7fff;
            --accent-hover: #4a6fe8;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            /* transition: var(--transition); Removed for performance */
        }
            /* æ²‰æµ¸å¼æ»šåŠ¨æ¡æ ·å¼ */
            ::-webkit-scrollbar {
                width: 8px;
                background: var(--bg-tertiary);
            }
            ::-webkit-scrollbar-thumb {
                background: var(--border-color);
                border-radius: 8px;
                transition: background 0.3s;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: var(--accent-color);
            }
            ::-webkit-scrollbar-corner {
                background: var(--bg-tertiary);
            }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* å·¦ä¾§é¢æ¿ */
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            min-width: 300px;
            max-width: 70%;
            transition: background-color 0.3s, border-color 0.3s; /* Optimized transition */
            position: relative;
                /* æ‹–æ‹½é®ç½©å±‚ */
                .drag-overlay {
                    position: absolute;
                    top: 12px;
                    left: 12px;
                    right: 12px;
                    bottom: 12px;
                    background: rgba(67, 97, 238, 0.08);
                    border: 2px dashed var(--accent-color);
                    border-radius: 24px;
                    z-index: 99;
                    pointer-events: none;
                    display: none;
                    align-items: center;
                    justify-content: center;
                    font-size: 22px;
                    color: var(--accent-color);
                    transition: border-color 0.2s, background 0.2s, color 0.2s;
                }
                .drag-overlay.active {
                    display: flex;
                }
                .drag-overlay.error {
                    border-color: var(--danger-color);
                    background: rgba(251, 86, 7, 0.08);
                    color: var(--danger-color);
                }
                .drag-overlay.success {
                    border-color: var(--success-color);
                    background: rgba(6, 255, 165, 0.08);
                    color: var(--success-color);
                }
                .drag-overlay.full {
                    border-color: var(--warning-color);
                    background: rgba(255, 190, 11, 0.08);
                    color: var(--warning-color);
                }
        }

        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            gap: 8px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .toolbar-btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
        }

        .toolbar-btn.active {
            background: var(--accent-color);
            color: white;
        }

        .toolbar-separator {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 4px;
        }

        /* ç¼–è¾‘é€‰é¡¹é¢æ¿ */
        .edit-options {
            display: none;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            gap: 4px;
            flex-wrap: wrap;
            animation: slideDown 0.3s ease;
        }

        .edit-options.active {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .edit-btn {
            padding: 6px 12px;
            border: none;
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-btn svg {
            height: 100%;
            width: 20px;
            display: block;
        }
        

        .edit-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.05);
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            overflow-y: auto;
            gap: 16px;
        }

        /* åº•éƒ¨æ“ä½œåŒº */
        .bottom-area {
            padding: 16px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 10;
        }

        .text-input {
            flex: 1;
            min-height: 200px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.6;
            /* resize: none; Removed invalid property for div */
            transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;
            font-family: inherit;
            overflow-y: auto;
            word-break: break-word;
            white-space: pre-wrap;
            padding: 17px 17px 17px 17px;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
            .text-input:hover {
                cursor: text;
            }

        /* å›¾ç‰‡é¢„è§ˆåŒºåŸŸ */
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 0;
            max-height: 240px; /* é™åˆ¶é«˜åº¦ */
            overflow-y: auto; /* è¶…å‡ºæ»šåŠ¨ */
            padding: 4px; /* é˜²æ­¢é˜´å½±è¢«åˆ‡ */
            align-items: start;
        }
        @media (max-width: 768px) {
            .image-preview-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: var(--transition);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .image-preview-item:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(251, 86, 7, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .image-preview-item:hover .image-delete-btn {
            display: flex;
        }

        .image-delete-btn:hover {
            background: #d94606;
            transform: scale(1.1);
        }

        /* æ£€æµ‹æŒ‰é’® */
        .detect-btn {
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .detect-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .detect-btn:active {
            transform: translateY(0);
        }

        .detect-btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .detect-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            left: 50%;
            top: 50%;
            margin-left: -10px;
            margin-top: -10px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* åˆ†éš”çº¿ */
        .resizer {
            width: 6px;
            background: var(--bg-tertiary);
            cursor: col-resize;
            position: relative;
            transition: var(--transition);
        }

        .resizer:hover {
            background: var(--accent-color);
        }

        .resizer::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background: var(--text-secondary);
            border-radius: 2px;
            opacity: 0.5;
        }

        /* å³ä¾§é¢æ¿ */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            min-width: 300px;
            transition: background-color 0.3s; /* Optimized transition */
        }

        .result-header {
            padding: 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .result-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .result-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* åˆå§‹çŠ¶æ€ */
        .initial-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-secondary);
        }

        .initial-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .initial-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .initial-description {
            font-size: 14px;
            line-height: 1.6;
            max-width: 400px;
        }

        /* æ£€æµ‹ç»“æœ */
        .result-item {
            display: none;
            animation: slideIn 0.5s ease;
        }

        .result-item.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .result-score {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: var(--bg-primary);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            position: relative;
        }

        .score-circle.real {
            background: linear-gradient(135deg, #06ffa5, #00d084);
        }

        .score-circle.fake {
            background: linear-gradient(135deg, #fb5607, #d94606);
        }

        .score-circle.uncertain {
            background: linear-gradient(135deg, #ffbe0b, #f59e0b);
        }

        .score-details {
            flex: 1;
        }

        .score-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .score-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .score-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .result-analysis {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analysis-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .analysis-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            transition: var(--transition);
        }

        .analysis-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .analysis-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 12px;
            color: white;
        }

        .analysis-icon.positive {
            background: var(--success-color);
        }

        .analysis-icon.negative {
            background: var(--danger-color);
        }

        .analysis-icon.neutral {
            background: var(--warning-color);
        }

        .analysis-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .image-modal.active {
            display: flex;
        }

        .modal-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            animation: zoomIn 0.3s ease;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        /* è‡ªå®šä¹‰å¼¹çª—æ ·å¼ */
        .custom-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.18);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .custom-modal.active {
            display: flex;
        }
        .custom-modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            padding: 32px 28px 24px 28px;
            min-width: 320px;
            max-width: 90vw;
            text-align: center;
            animation: fadeInUp 0.4s;
        }
        .custom-modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent-color);
        }
        .custom-modal-message {
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 24px;
        }
        .custom-modal-actions {
            display: flex;
            gap: 18px;
            justify-content: center;
        }
        .custom-modal-btn {
            padding: 8px 28px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            background: var(--accent-color);
            color: #fff;
            transition: background 0.2s;
        }
        .custom-modal-btn:hover {
            background: var(--accent-hover);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .left-panel, .right-panel {
                max-width: 100%;
                min-width: 100%;
            }

            .resizer {
                display: none;
            }

            .image-preview-container {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        /* é“¾æ¥æ ·å¼ */
        .text-input a {
            color: var(--accent-color);
            text-decoration: underline;
            cursor: pointer;
        }

        .text-input a:hover {
            color: var(--accent-hover);
        }

        /* æ²‰æµ¸å¼çª—å£æ ·å¼ */
        .titlebar {
            -webkit-app-region: drag;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: nowrap;
            justify-content: flex-start;
        }

        .no-drag {
            -webkit-app-region: no-drag;
        }

        /* è‡ªå®šä¹‰åŸç”Ÿæ ‡é¢˜æ å›ºå®šåœ¨é¡¶éƒ¨ï¼Œä¸å‚ä¸ flex å¸ƒå±€ - å·²ç§»é™¤ */
        /* .native-titlebar { ... } */

        /* ç»™å†…å®¹å®¹å™¨ç•™å‡ºæ ‡é¢˜æ é«˜åº¦ï¼Œé˜²æ­¢è¢«é®æŒ¡ */
        .container {
            /* padding-top: 36px; */
            height: 100vh;
        }

        /* çª—å£æ§åˆ¶æ ·å¼ï¼ˆç”¨äºæ— æ¡†çª—å£ï¼‰ - å·²ç§»é™¤ */
        /* .window-controls { ... } */
        .window-controls .window-btn,
        .window-btn {
            background: transparent;
            border: none;
            color: var(--text-primary);
            width: 34px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
        }
        .window-controls .window-btn:hover,
        .window-btn:hover {
            background-color: var(--bg-tertiary);
        }

        /* ç¦æ­¢é€‰æ‹©æ–‡æœ¬ï¼ˆç”¨äºæ ‡é¢˜æ ã€æŒ‰é’®ç­‰äº¤äº’å…ƒç´ ï¼‰ */
        .no-select,
        .native-titlebar,
        .titlebar,
        .window-btn,
        .control-btn,
        .dropdown-item,
        .start-detect-btn {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            opacity: 0;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .toast.error {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .toast.warning {
            color: var(--warning-color);
            border-color: var(--warning-color);
        }

        .toast.info {
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        /* è§£æå†…å®¹åŒºåŸŸ */
        .parsed-content {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            animation: slideIn 0.5s ease;
        }

        .parsed-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .parsed-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .parsed-image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: var(--transition);
            animation: fadeIn 0.3s ease;
        }

        .parsed-image-item:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .parsed-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .parsed-text {
            font-size: 15px;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
            text-align: justify;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            animation: fadeIn 0.3s ease;
        }

        .loading-state.active {
            display: flex;
        }

        .loading-spinner-large {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        .progress-container {
            width: 80%;
            max-width: 300px;
            height: 6px;
            background-color: var(--bg-tertiary);
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* è‡ªå®šä¹‰ Tooltip (åœ†è§’èƒ¶å›Š) */
        .custom-tooltip {
            position: absolute;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            z-index: 1000;
            max-width: 300px;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s, transform 0.2s;
        }

        .custom-tooltip.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* è¯¦ç»†åˆ†æåˆ—è¡¨é¡¹æ ·å¼ */
        .analysis-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            transition: var(--transition);
        }

        .analysis-item:hover {
            transform: translateX(4px);
        }

        .analysis-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-weight: bold;
            font-size: 14px;
        }

        .analysis-icon.positive {
            background: rgba(6, 255, 165, 0.15);
            color: var(--success-color);
        }

        .analysis-icon.warning {
            background: rgba(255, 190, 11, 0.15);
            color: var(--warning-color);
        }

        .analysis-icon.negative {
            background: rgba(251, 86, 7, 0.15);
            color: var(--danger-color);
        }

        .analysis-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
        }

        /* é”™è¯¯çŠ¶æ€ */
        .error-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--danger-color);
            animation: fadeIn 0.3s ease;
        }

        .error-state.active {
            display: flex;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .error-message {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .error-detail {
            font-size: 14px;
            color: var(--text-secondary);
            max-width: 300px;
        }
        /* å…¥åœºåŠ¨ç”» */
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .left-panel {
            animation: slideInLeft 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .right-panel {
            animation: slideInRight 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .toolbar {
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.2s forwards;
        }

        .content-area {
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.3s forwards;
        }

        .bottom-area {
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.4s forwards;
        }

        .result-header {
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.3s forwards;
        }

        .initial-state {
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.5s forwards;
        }

        @media (prefers-reduced-motion: reduce) {
            .left-panel, .right-panel, .toolbar, .content-area, .bottom-area, .result-header, .initial-state {
                animation: none;
                opacity: 1;
                transform: none;
                transition: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel" id="leftPanel">
                        <div class="drag-overlay" id="dragOverlay">æ‹–å…¥å›¾ç‰‡ä»¥æ·»åŠ </div>
            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <button class="toolbar-btn" id="editBtn" title="ç¼–è¾‘é€‰é¡¹">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="toolbar-btn" id="clipboardBtn" title="å‰ªè´´æ¿è·å–">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="5" y="4" width="10" height="13" rx="2"/>
                        <rect x="7" y="2" width="6" height="3" rx="1"/>
                        <path d="M7 7h6"/>
                    </svg>
                </button>
                <div class="toolbar-separator"></div>
                <button class="toolbar-btn" id="imageBtn" title="æ·»åŠ å›¾ç‰‡">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                </button>
                <button class="toolbar-btn" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <button class="toolbar-btn" id="clearBtn" title="æ¸…ç©ºå†…å®¹">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>

            <!-- ç¼–è¾‘é€‰é¡¹ -->
            <div class="edit-options" id="editOptions">
                <button class="edit-btn" data-command="bold" title="åŠ ç²—">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 8h6a3 3 0 0 1 0 6H7zm0 6h7a2.5 2.5 0 0 1 0 5H7z"/></svg>
                </button>
                <button class="edit-btn" data-command="italic" title="æ–œä½“">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><line x1="17" y1="6" x2="9" y2="24"/></svg>
                </button>
                <button class="edit-btn" data-command="underline" title="ä¸‹åˆ’çº¿">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 6v8a6 6 0 0 0 12 0V6"/><line x1="4" y1="26" x2="20" y2="26"/></svg>
                </button>
                <button class="edit-btn" data-command="insertUnorderedList" title="æ— åºåˆ—è¡¨">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="9" r="1.5"/><circle cx="6" cy="16" r="1.5"/><circle cx="6" cy="23" r="1.5"/><line x1="10" y1="9" x2="18" y2="9"/><line x1="10" y1="16" x2="18" y2="16"/><line x1="10" y1="23" x2="18" y2="23"/></svg>
                </button>
                <button class="edit-btn" data-command="insertOrderedList" title="æœ‰åºåˆ—è¡¨">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><text x="3" y="11" font-size="8">1</text><line x1="10" y1="9" x2="18" y2="9"/><text x="3" y="18" font-size="8">2</text><line x1="10" y1="16" x2="18" y2="16"/><text x="3" y="25" font-size="8">3</text><line x1="10" y1="23" x2="18" y2="23"/></svg>
                </button>
                <button class="edit-btn" data-command="justifyLeft" title="å·¦å¯¹é½">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="16" x2="14" y2="16"/><line x1="4" y1="23" x2="20" y2="23"/></svg>
                </button>
                <button class="edit-btn" data-command="justifyCenter" title="å±…ä¸­">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><line x1="6" y1="9" x2="18" y2="9"/><line x1="8" y1="16" x2="16" y2="16"/><line x1="4" y1="23" x2="20" y2="23"/></svg>
                </button>
                <button class="edit-btn" data-command="justifyRight" title="å³å¯¹é½">
                    <svg width="24" height="28" viewBox="0 0 24 28" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="20" y2="9"/><line x1="10" y1="16" x2="20" y2="16"/><line x1="4" y1="23" x2="20" y2="23"/></svg>
                </button>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content-area">
                <!-- æ–‡æœ¬è¾“å…¥ -->
                <div contenteditable="true" class="text-input" id="textInput" placeholder="è¯·è¾“å…¥è¦æ£€æµ‹çš„æ–°é—»å†…å®¹..."></div>

                <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ (å·²ç§»é™¤) -->
                <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">

                <!-- å›¾ç‰‡é¢„è§ˆ -->
                <div class="image-preview-container" id="imagePreview"></div>
            </div>

            <!-- åº•éƒ¨æ“ä½œåŒº -->
            <div class="bottom-area">
                <!-- æ£€æµ‹æŒ‰é’® -->
                <button class="detect-btn" id="detectBtn">å¼€å§‹æ£€æµ‹</button>
            </div>
        </div>

        <!-- åˆ†éš”çº¿ -->
        <div class="resizer" id="resizer"></div>

        <!-- å³ä¾§é¢æ¿ -->
        <div class="right-panel" id="rightPanel">
            <div class="result-header">
                <h2 class="result-title">æ£€æµ‹ç»“æœ</h2>
            </div>
            <div class="result-content">
                <!-- åˆå§‹çŠ¶æ€ -->
                <div class="initial-state" id="initialState">
                    <div class="initial-icon">ğŸ”</div>
                    <div class="initial-title">å‡†å¤‡å°±ç»ª</div>
                    <div class="initial-description">
                        åœ¨å·¦ä¾§è¾“å…¥æ–°é—»å†…å®¹æˆ–ä¸Šä¼ ç›¸å…³å›¾ç‰‡ï¼Œç‚¹å‡»"å¼€å§‹æ£€æµ‹"æŒ‰é’®å³å¯è¿›è¡Œå‡æ–°é—»åˆ†æã€‚
                        ç³»ç»Ÿå°†ç»¼åˆè¯„ä¼°å†…å®¹çš„çœŸå®æ€§ï¼Œä¸ºæ‚¨æä¾›è¯¦ç»†çš„æ£€æµ‹æŠ¥å‘Šã€‚
                    </div>
                </div>

                <!-- æ£€æµ‹ç»“æœ -->
                <div class="result-item" id="resultItem">
                    <div class="result-score">
                        <div class="score-circle" id="scoreCircle">85%</div>
                        <div class="score-details">
                            <div class="score-label">çœŸå®æ€§è¯„åˆ†</div>
                            <div class="score-value" id="scoreValue">85%</div>
                            <div class="score-description" id="scoreDescription">è¯¥å†…å®¹å…·æœ‰è¾ƒé«˜çš„å¯ä¿¡åº¦</div>
                        </div>
                    </div>

                    <div class="result-analysis">
                        <div class="analysis-title">è¯¦ç»†åˆ†æ</div>
                        <div class="analysis-item">
                            <div class="analysis-icon positive">âœ“</div>
                            <div class="analysis-text">å†…å®¹æ¥æºå¯é ï¼Œå¼•ç”¨äº†æƒå¨åª’ä½“çš„æ•°æ®</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-icon positive">âœ“</div>
                            <div class="analysis-text">è¯­è¨€è¡¨è¾¾å®¢è§‚ï¼Œæ— æ˜æ˜¾æƒ…ç»ªåŒ–å€¾å‘</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-icon neutral">!</div>
                            <div class="analysis-text">éƒ¨åˆ†ä¿¡æ¯éœ€è¦è¿›ä¸€æ­¥æ ¸å®</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-icon positive">âœ“</div>
                            <div class="analysis-text">å›¾ç‰‡å†…å®¹ä¸æ–‡å­—æè¿°ç›¸ç¬¦</div>
                        </div>
                    </div>

                    <!-- è§£æå†…å®¹ -->
                    <div class="parsed-content" id="parsedContent" style="display: none;">
                        <h3 class="parsed-title" id="parsedTitle"></h3>
                        <div class="parsed-images" id="parsedImages"></div>
                        <div class="parsed-text" id="parsedText"></div>
                    </div>
                </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner-large"></div>
                    <div class="loading-text" id="loadingText">æ­£åœ¨è§£æç½‘é¡µå†…å®¹...</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>

                <!-- é”™è¯¯çŠ¶æ€ -->
                <div class="error-state" id="errorState">
                    <div class="error-icon">âš ï¸</div>
                    <div class="error-message">è§£æå¤±è´¥</div>
                    <div class="error-detail" id="errorDetail">æ— æ³•è·å–ç½‘é¡µå†…å®¹ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="image-modal" id="imageModal">
        <button class="modal-close" id="modalClose">Ã—</button>
        <img class="modal-image" id="modalImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
    </div>

    <!-- Toast æç¤º -->
    <div class="toast" id="toast"></div>

    <!-- è‡ªå®šä¹‰ç¡®è®¤å¼¹çª— -->
    <div class="custom-modal" id="customModal">
        <div class="custom-modal-content">
            <div class="custom-modal-title">ç¡®è®¤æ“ä½œ</div>
            <div class="custom-modal-message">ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ</div>
            <div class="custom-modal-actions">
                <button class="custom-modal-btn" id="modalConfirm">ç¡®å®š</button>
                <button class="custom-modal-btn" id="modalCancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let isResizing = false;
        let uploadedImages = [];
        const maxImages = 4;
        let detectedUrls = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            initResizable();
            initTextEditor();
            initImageUpload();
            initButtons();
            initModal();
            initIPC();
            initClipboardBtn();
        });

        // ä¸»é¢˜åˆ‡æ¢
        function initTheme() {
            const themeBtn = document.getElementById('themeBtn');
            const savedTheme = localStorage.getItem('theme') || 'light';
            
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                // åŒæ­¥ç»™ä¸»è¿›ç¨‹
                if (window.electronAPI) {
                    window.electronAPI.invoke('set-theme', true);
                }
            }

            themeBtn.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                const isDarkMode = newTheme === 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // è°ƒç”¨ä¸»è¿›ç¨‹è®¾ç½®åŸç”Ÿä¸»é¢˜
                if (window.electronAPI) {
                    window.electronAPI.invoke('set-theme', isDarkMode)
                        .then(result => {
                            if (!result.success) {
                                console.error('ä¸»é¢˜è®¾ç½®å¤±è´¥:', result.error);
                            }
                        });
                }
                
                showToast(`å·²åˆ‡æ¢åˆ°${isDarkMode ? 'æ·±è‰²' : 'æµ…è‰²'}æ¨¡å¼`, 'success');
            });
        }

        // å¯è°ƒæ•´å¤§å°çš„åˆ†éš”çº¿
        function initResizable() {
            const resizer = document.getElementById('resizer');
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const container = document.querySelector('.container');

            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                const containerRect = container.getBoundingClientRect();
                const percentage = ((e.clientX - containerRect.left) / containerRect.width) * 100;
                    // é™åˆ¶åˆ†å‰²çº¿æ‹–åŠ¨èŒƒå›´ï¼Œå·¦ä¾§æœ€å°30%ï¼Œæœ€å¤§65%
                    const minPercent = 30;
                    const maxPercent = 65;
                    if (percentage > minPercent && percentage < maxPercent) {
                        leftPanel.style.flex = `0 0 ${percentage}%`;
                        rightPanel.style.flex = `0 0 ${100 - percentage}%`;
                    } else if (percentage <= minPercent) {
                        leftPanel.style.flex = `0 0 ${minPercent}%`;
                        rightPanel.style.flex = `0 0 ${100 - minPercent}%`;
                    } else if (percentage >= maxPercent) {
                        leftPanel.style.flex = `0 0 ${maxPercent}%`;
                        rightPanel.style.flex = `0 0 ${100 - maxPercent}%`;
                    }
            });

            document.addEventListener('mouseup', function() {
                isResizing = false;
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
            });
        }

        // æ–‡æœ¬ç¼–è¾‘å™¨
        function initTextEditor() {
            const textInput = document.getElementById('textInput');
            const editBtn = document.getElementById('editBtn');
            const editOptions = document.getElementById('editOptions');

            // è‡ªåŠ¨è¯†åˆ«é“¾æ¥
            textInput.addEventListener('input', function() {
                const text = this.innerText;
                const urlRegex = /(https?:\/\/|www\.)[^\s<]+/g;
                const matches = text.match(urlRegex);
                
                if (matches && matches.length > 0) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„é“¾æ¥
                    const newUrls = matches.filter(url => !detectedUrls.includes(url));
                    if (newUrls.length > 0) {
                        detectedUrls = [...detectedUrls, ...newUrls];
                        showToast(`æ£€æµ‹åˆ° ${newUrls.length} ä¸ªç½‘å€é“¾æ¥`, 'info');
                    }
                }
            });

            // ç¼–è¾‘é€‰é¡¹åˆ‡æ¢
            editBtn.addEventListener('click', function() {
                editOptions.classList.toggle('active');
                this.classList.toggle('active');
            });

            // ç¼–è¾‘æŒ‰é’®åŠŸèƒ½
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const command = this.dataset.command;
                    document.execCommand(command, false, null);
                    textInput.focus();
                });
            });
        }

        // å›¾ç‰‡ä¸Šä¼ 
        function initImageUpload() {
            const leftPanel = document.getElementById('leftPanel');
            const fileInput = document.getElementById('fileInput');
            const imagePreview = document.getElementById('imagePreview');
            const imageBtn = document.getElementById('imageBtn');

            // å›¾ç‰‡æŒ‰é’®ç‚¹å‡»
            imageBtn.addEventListener('click', function() {
                if (uploadedImages.length >= maxImages) {
                    showToast(`æœ€å¤šåªèƒ½ä¸Šä¼ ${maxImages}å¼ å›¾ç‰‡`, 'warning');
                    return;
                }
                fileInput.click();
            });

            // æ–‡ä»¶é€‰æ‹©
            fileInput.addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });

            // æ‹–æ‹½ä¸Šä¼  - ç»‘å®šåˆ°å·¦ä¾§é¢æ¿
            const dragOverlay = document.getElementById('dragOverlay');
            leftPanel.addEventListener('dragover', function(e) {
                e.preventDefault();
                // æ£€æŸ¥æ‹–å…¥çš„æ–‡ä»¶ç±»å‹æˆ–URL
                let isAllImage = false;
                if (e.dataTransfer) {
                    // ä¼˜å…ˆæ£€æµ‹æ–‡ä»¶åˆ—è¡¨
                    if (e.dataTransfer.items) {
                        for (let i = 0; i < e.dataTransfer.items.length; i++) {
                            const t = e.dataTransfer.items[i].type || '';
                            if (t.startsWith('image/')) {
                                isAllImage = true;
                                break;
                            }
                            // æ”¯æŒæ‹–åŠ¨å›¾ç‰‡ URLï¼ˆå…¶ä»–å…ƒç´ ä¼ é€’ä¸º text/uri-list æˆ– text/plainï¼‰
                            if (t === 'text/uri-list' || t === 'text/plain') {
                                isAllImage = true;
                                break;
                            }
                        }
                    }
                }
                dragOverlay.classList.add('active');
                dragOverlay.classList.remove('error', 'success', 'full');
                if (uploadedImages.length >= maxImages) {
                    dragOverlay.classList.add('full');
                    dragOverlay.textContent = 'æœ€å¤šåªèƒ½ä¸Šä¼ 4å¼ å›¾ç‰‡';
                } else if (isAllImage) {
                    dragOverlay.classList.add('success');
                    dragOverlay.textContent = 'æ‹–å…¥å›¾ç‰‡ä»¥æ·»åŠ ';
                } else {
                    dragOverlay.classList.add('error');
                    dragOverlay.textContent = 'ä»…æ”¯æŒå›¾ç‰‡æ–‡ä»¶';
                }
            });
            leftPanel.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dragOverlay.classList.remove('active', 'error', 'success', 'full');
                dragOverlay.textContent = 'æ‹–å…¥å›¾ç‰‡ä»¥æ·»åŠ ';
            });
            leftPanel.addEventListener('drop', function(e) {
                e.preventDefault();
                dragOverlay.classList.remove('active', 'error', 'success', 'full');
                dragOverlay.textContent = 'æ‹–å…¥å›¾ç‰‡ä»¥æ·»åŠ ';
                // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨ä¸ºå›¾ç‰‡
                // ä¼˜å…ˆå¤„ç†æ–‡ä»¶
                if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    // å¦‚æœåŒ…å«æ–‡ä»¶ï¼ŒæŒ‰åŸé€»è¾‘å¤„ç†
                    if (uploadedImages.length >= maxImages) {
                        showToast(`æœ€å¤šåªèƒ½ä¸Šä¼ ${maxImages}å¼ å›¾ç‰‡`, 'warning');
                        return;
                    }
                    handleFiles(e.dataTransfer.files);
                    return;
                }

                // å¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼Œå°è¯•è¯»å– URLï¼ˆtext/uri-list æˆ– text/plainï¼‰
                let url = '';
                try {
                    if (e.dataTransfer) {
                        url = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain') || '';
                    }
                } catch (err) {
                    url = '';
                }

                if (url) {
                    if (uploadedImages.length >= maxImages) {
                        showToast(`æœ€å¤šåªèƒ½ä¸Šä¼ ${maxImages}å¼ å›¾ç‰‡`, 'warning');
                        return;
                    }
                    // ç®€å•åˆ¤æ–­æ˜¯å¦ä¸ºå›¾ç‰‡é“¾æ¥ï¼ˆæ‰©å±•åæˆ– data:ï¼‰
                    const lower = url.toLowerCase();
                    const isLikelyImage = lower.startsWith('data:') || /(\.png|\.jpe?g|\.gif|\.webp|\.bmp|\.svg)(\?.*)?$/.test(lower) || /^https?:\/\/.+\.(png|jpe?g|gif|webp|bmp|svg)(\?.*)?$/i.test(url);
                    const imagePreview = document.getElementById('imagePreview');
                    const nameFromUrl = url.split('/').pop().split('?')[0];
                    const imageData = {
                        id: Date.now() + Math.random(),
                        url: url,
                        name: nameFromUrl || 'è¿œç¨‹å›¾ç‰‡'
                    };
                    // å¦‚æœä¸æ˜¯æ˜¾ç„¶ä¸ºå›¾ç‰‡ï¼Œä¹Ÿå…è®¸åŠ å…¥ï¼ˆæµè§ˆå™¨ä¼šæ ¹æ® src æ˜¾ç¤ºæˆ–å¤±è´¥ï¼‰
                    uploadedImages.push(imageData);
                    // ä½¿ç”¨å·²æœ‰æ¸²æŸ“å‡½æ•°æ›´æ–° UI
                    renderImages();
                    showToast('å›¾ç‰‡å·²ä»å³ä¾§æ·»åŠ ', 'success');
                    return;
                }

                showToast('æ— å¯ç”¨å›¾ç‰‡æˆ–ä¸æ”¯æŒçš„æ‹–æ”¾å†…å®¹', 'error');
            });

            // ç²˜è´´ä¸Šä¼ 
            document.addEventListener('paste', function(e) {
                const items = e.clipboardData.items;
                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (uploadedImages.length < maxImages) {
                            handleFiles([file]);
                        } else {
                            showToast(`æœ€å¤šåªèƒ½ä¸Šä¼ ${maxImages}å¼ å›¾ç‰‡`, 'warning');
                        }
                    }
                }
            });

            // å¤„ç†æ–‡ä»¶
            function handleFiles(files) {
                // æ–°å¢ï¼šåªå…è®¸æ·»åŠ å‰©ä½™æ•°é‡çš„å›¾ç‰‡
                const remain = maxImages - uploadedImages.length;
                if (remain <= 0) {
                    showToast(`æœ€å¤šåªèƒ½ä¸Šä¼ ${maxImages}å¼ å›¾ç‰‡`, 'warning');
                    return;
                }
                let addedCount = 0;
                let validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                // åªå–å‰©ä½™æ•°é‡çš„å›¾ç‰‡
                validFiles = validFiles.slice(0, remain);
                validFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            id: Date.now() + Math.random(),
                            url: e.target.result,
                            name: file.name
                        };
                        uploadedImages.push(imageData);
                        renderImages();
                        showToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
                    };
                    reader.readAsDataURL(file);
                    addedCount++;
                });
                if (files.length > 0 && addedCount === 0) {
                    showToast(`æœ€å¤šåªèƒ½ä¸Šä¼ ${maxImages}å¼ å›¾ç‰‡`, 'warning');
                }
            }

            // æ¸²æŸ“å›¾ç‰‡
            function renderImages() {
                imagePreview.innerHTML = '';
                uploadedImages.forEach(image => {
                    const item = document.createElement('div');
                    item.className = 'image-preview-item';
                    item.innerHTML = `
                        <img src="${image.url}" alt="${image.name}">
                        <button class="image-delete-btn" data-id="${image.id}">Ã—</button>
                    `;
                    
                    item.querySelector('img').addEventListener('click', function() {
                        showImageModal(image.url);
                    });
                    
                    item.querySelector('.image-delete-btn').addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteImage(image.id);
                    });
                    
                    imagePreview.appendChild(item);
                });
            }

            // åˆ é™¤å›¾ç‰‡
            function deleteImage(id) {
                uploadedImages = uploadedImages.filter(img => img.id !== id);
                renderImages();
                showToast('å›¾ç‰‡å·²åˆ é™¤', 'success');
            }
        }

        // è‡ªå®šä¹‰å¼¹çª—é€»è¾‘
        function showCustomModal(onConfirm, onCancel) {
            const modal = document.getElementById('customModal');
            const confirmBtn = document.getElementById('modalConfirm');
            const cancelBtn = document.getElementById('modalCancel');
            modal.classList.add('active');
            // è§£ç»‘æ—§äº‹ä»¶ï¼Œé˜²æ­¢å¤šæ¬¡ç»‘å®š
            confirmBtn.onclick = function() {
                modal.classList.remove('active');
                if (onConfirm) onConfirm();
            };
            cancelBtn.onclick = function() {
                modal.classList.remove('active');
                if (onCancel) onCancel();
            };
        }

        // æŒ‰é’®åŠŸèƒ½
        function initButtons() {
            // æ¸…ç©ºæŒ‰é’®
            document.getElementById('clearBtn').addEventListener('click', function() {
                showCustomModal(() => {
                    document.getElementById('textInput').innerText = '';
                    uploadedImages = [];
                    detectedUrls = [];
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('initialState').style.display = 'flex';
                    document.getElementById('resultItem').classList.remove('active');
                    document.getElementById('errorState').classList.remove('active');
                    document.getElementById('loadingState').classList.remove('active');
                    showToast('å†…å®¹å·²æ¸…ç©º', 'success');
                });
            });

            // æ£€æµ‹æŒ‰é’®
            let lastTextContent = '';
            let lastImages = [];
            document.getElementById('detectBtn').addEventListener('click', function() {
                const textContent = document.getElementById('textInput').innerText.trim();
                // ä¼˜å…ˆåˆ¤æ–­å†…å®¹æ˜¯å¦ä¸ºç©º
                if (!textContent && uploadedImages.length === 0) {
                    showToast('è¯·è¾“å…¥å†…å®¹æˆ–ä¸Šä¼ å›¾ç‰‡', 'warning');
                    return;
                }
                // åˆ¤æ–­å†…å®¹å’Œå›¾ç‰‡æ˜¯å¦æœ‰å˜åŒ–
                const imagesNow = uploadedImages.map(img => img.url).join(',');
                const imagesLast = lastImages.join(',');
                if (textContent === lastTextContent && imagesNow === imagesLast) {
                    showToast('å†…å®¹æœªå˜åŒ–ï¼Œæ— éœ€é‡å¤æ£€æµ‹', 'info');
                    return;
                }
                // æ£€æŸ¥æ˜¯å¦ä¸ºURL
                if (isURL(textContent)) {
                    window.lastExtractedUrl = textContent; // ä¿å­˜URLä¾›åç»­ä½¿ç”¨
                    extractContent(textContent);
                } else {
                    window.lastExtractedUrl = null;
                    analyzeContent(textContent, uploadedImages);
                }
                // è®°å½•æœ¬æ¬¡å†…å®¹å’Œå›¾ç‰‡
                lastTextContent = textContent;
                lastImages = uploadedImages.map(img => img.url);
            });
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºURL
        function isURL(text) {
            try {
                new URL(text);
                return true;
            } catch {
                return false;
            }
        }

        // å†…å®¹æå–åŠŸèƒ½
        function extractContent(url) {
            const detectBtn = document.getElementById('detectBtn');
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const progressBar = document.getElementById('progressBar');
            const loadingText = document.getElementById('loadingText');

            // é‡ç½®çŠ¶æ€
            initialState.style.display = 'none';
            resultItem.classList.remove('active');
            errorState.classList.remove('active');
            loadingState.classList.add('active');
            
            // åˆå§‹åŒ–è¿›åº¦æ¡
            progressBar.style.width = '10%';
            loadingText.textContent = 'æ­£åœ¨è§£æç½‘é¡µå†…å®¹...';

            detectBtn.classList.add('loading');
            detectBtn.innerHTML = 'æå–ä¸­...';

            // æ¨¡æ‹Ÿè¿›åº¦å¢é•¿
            let progress = 10;
            const progressInterval = setInterval(() => {
                if (progress < 45) {
                    progress += 1;
                    progressBar.style.width = progress + '%';
                }
            }, 800);

            let timeoutId;
            let finished = false;
            // è¶…æ—¶å¤„ç†å‡½æ•°
            function handleTimeout() {
                if (finished) return;
                finished = true;
                clearInterval(progressInterval);
                loadingState.classList.remove('active');
                detectBtn.classList.remove('loading');
                detectBtn.innerHTML = 'å¼€å§‹æ£€æµ‹';
                showError('ç½‘é¡µå†…å®¹æå–è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
                showToast('æå–å¤±è´¥ï¼šè¶…æ—¶', 'error');
            }
            timeoutId = setTimeout(handleTimeout, 10000);

            // è°ƒç”¨ä¸»è¿›ç¨‹çš„å†…å®¹æå–åŠŸèƒ½
            if (window.electronAPI) {
                window.electronAPI.send('extract-content', url);
                // ç›‘å¬ä¸€æ¬¡æ€§ç»“æœï¼ˆé˜²æ­¢å¤šæ¬¡è§¦å‘ï¼‰
                const handler = function(event, result) {
                    if (finished) return;
                    finished = true;
                    clearTimeout(timeoutId);
                    clearInterval(progressInterval);
                    
                    if (result.success) {
                        // æå–æˆåŠŸï¼Œè¿›åº¦è®¾ä¸º50%
                        progressBar.style.width = '50%';
                        loadingText.textContent = 'æ­£åœ¨åˆ†ææ–°é—»ä¸­...';
                        
                        // showExtractedResult(result);
                        showToast('æå–å®Œæˆï¼Œæ­£åœ¨è¿›è¡ŒAIåˆ†æ...', 'success');
                        // ä¼ é€’ true è¡¨ç¤ºä»æå–æµç¨‹è¿›å…¥
                        analyzeContent(result.content, result.images, true);
                    } else {
                        detectBtn.classList.remove('loading');
                        detectBtn.innerHTML = 'å¼€å§‹æ£€æµ‹';
                        showError(result.error);
                        showToast('æå–å¤±è´¥: ' + result.error, 'error');
                    }
                    window.electronAPI.off && window.electronAPI.off('extract-content-result', handler);
                };
                // å…¼å®¹æ€§ï¼šå¦‚æ— offæ–¹æ³•åˆ™ä¸è§£ç»‘
                window.electronAPI.on('extract-content-result', handler);
            } else {
                // æ¨¡æ‹Ÿæå–ç»“æœ
                setTimeout(() => {
                    if (finished) return;
                    finished = true;
                    clearTimeout(timeoutId);
                    clearInterval(progressInterval);
                    
                    // æ¨¡æ‹Ÿæ•°æ®
                    const mockResult = {
                        success: true,
                        title: 'ç¤ºä¾‹æ–°é—»æ ‡é¢˜',
                        content: 'è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„æ–°é—»å†…å®¹æå–ç»“æœã€‚è¿™é‡Œä¼šæ˜¾ç¤ºä»ç½‘é¡µè§£æå‡ºæ¥çš„æ­£æ–‡å†…å®¹ã€‚',
                        images: ['https://via.placeholder.com/300'],
                        url: url
                    };
                    
                    progressBar.style.width = '50%';
                    loadingText.textContent = 'æ­£åœ¨åˆ†ææ–°é—»ä¸­...';
                    
                    showToast('æå–å®Œæˆ', 'success');
                    analyzeContent(mockResult.content, mockResult.images, true);
                }, 2000);
            }
        }

        // åˆå§‹åŒ–IPCé€šä¿¡
        function initIPC() {
            if (window.electronAPI) {
                // ç›‘å¬å†…å®¹æå–ç»“æœ
                window.electronAPI.on('extract-content-result', function(event, result) {
                    const detectBtn = document.getElementById('detectBtn');
                    detectBtn.classList.remove('loading');
                    detectBtn.innerHTML = 'å¼€å§‹æ£€æµ‹';

                    if (result.success) {
                        // æ˜¾ç¤ºæå–ç»“æœ
                        showExtractedResult(result);
                        showToast('æå–å®Œæˆ', 'success');
                    } else {
                        showError(result.error);
                        showToast('æå–å¤±è´¥: ' + result.error, 'error');
                    }
                });

                // ç›‘å¬æ¸…é™¤å†…å®¹ï¼ˆç›´æ¥æ¸…ç©ºï¼‰äº‹ä»¶ï¼Œä¿ç•™ä»¥å…¼å®¹æ—§é€»è¾‘
                window.electronAPI.on('clear-results', function() {
                    document.getElementById('initialState').style.display = 'flex';
                    document.getElementById('resultItem').classList.remove('active');
                    document.getElementById('errorState').classList.remove('active');
                    document.getElementById('loadingState').classList.remove('active');
                });

                // ç›‘å¬ä¸»è¿›ç¨‹è¯·æ±‚æ˜¾ç¤ºæ¸…ç©ºç¡®è®¤å¼¹çª—ï¼ˆæ¥è‡ªå³é”®èœå•ï¼‰
                window.electronAPI.on('request-clear', function() {
                    showCustomModal(() => {
                        // ç¡®è®¤åæ‰§è¡ŒåŒæ ·çš„æ¸…ç©ºé€»è¾‘
                        document.getElementById('textInput').innerText = '';
                        uploadedImages = [];
                        detectedUrls = [];
                        document.getElementById('imagePreview').innerHTML = '';
                        document.getElementById('initialState').style.display = 'flex';
                        document.getElementById('resultItem').classList.remove('active');
                        document.getElementById('errorState').classList.remove('active');
                        document.getElementById('loadingState').classList.remove('active');
                        showToast('å†…å®¹å·²æ¸…ç©º', 'success');
                    }, () => {
                        // å–æ¶ˆæ—¶ä¸ä½œæ“ä½œ
                    });
                });
            }
        }

        // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
        function showResult() {
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            // è·å–è¾“å…¥å†…å®¹
            const textContent = document.getElementById('textInput').innerText.trim();
            
            // éšæœºç”Ÿæˆåˆ†æ•°
            const score = Math.floor(Math.random() * 40) + 20;
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreValue = document.getElementById('scoreValue');
            const scoreDescription = document.getElementById('scoreDescription');
            
            scoreCircle.textContent = score + '%';
            scoreValue.textContent = score + '%';
            
            if (score >= 80) {
                scoreCircle.className = 'score-circle real';
                scoreDescription.textContent = 'è¯¥å†…å®¹å…·æœ‰è¾ƒé«˜çš„å¯ä¿¡åº¦';
            } else if (score >= 60) {
                scoreCircle.className = 'score-circle uncertain';
                scoreDescription.textContent = 'è¯¥å†…å®¹å­˜åœ¨ä¸€å®šçš„ä¸ç¡®å®šæ€§';
            } else {
                scoreCircle.className = 'score-circle fake';
                scoreDescription.textContent = 'è¯¥å†…å®¹å¯èƒ½å­˜åœ¨è™šå‡ä¿¡æ¯';
            }
            
            // æ˜¾ç¤ºè¾“å…¥å†…å®¹
            parsedContent.style.display = 'block';
            parsedTitle.style.display = 'none'; // çº¯æ–‡æœ¬è¾“å…¥æ— æ ‡é¢˜
            parsedText.textContent = textContent;
            
            // æ¸²æŸ“ä¸Šä¼ çš„å›¾ç‰‡
            parsedImages.innerHTML = '';
            if (uploadedImages.length > 0) {
                uploadedImages.forEach(img => {
                    const item = document.createElement('div');
                    item.className = 'parsed-image-item';
                    item.innerHTML = `<img src="${img.url}" alt="${img.name}">`;
                    // å…è®¸ä»è§£æåŒºåŸŸæ‹–åŠ¨åˆ°å·¦ä¾§ï¼ˆä¼ é€’å›¾ç‰‡ URLï¼‰
                    item.setAttribute('draggable', 'true');
                    item.addEventListener('dragstart', (ev) => {
                        try {
                            ev.dataTransfer.setData('text/uri-list', img.url);
                            ev.dataTransfer.setData('text/plain', img.url);
                            ev.dataTransfer.effectAllowed = 'copy';
                        } catch (e) {}
                    });
                    item.addEventListener('click', () => showImageModal(img.url));
                    parsedImages.appendChild(item);
                });
            }
            
            initialState.style.display = 'none';
            resultItem.classList.add('active');
        }

        // æ˜¾ç¤ºæå–ç»“æœ
        function showExtractedResult(result) {
            const loadingState = document.getElementById('loadingState');
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            loadingState.classList.remove('active');
            
            // æ›´æ–°ç»“æœæ˜¾ç¤º
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreValue = document.getElementById('scoreValue');
            const scoreDescription = document.getElementById('scoreDescription');
            
            // ä½¿ç”¨éšæœºåˆ†æ•°ä½œä¸ºç¤ºä¾‹
            const score = Math.floor(Math.random() * 40) + 60;
            scoreCircle.textContent = score + '%';
            scoreValue.textContent = score + '%';
            
            if (score >= 80) {
                scoreCircle.className = 'score-circle real';
                scoreDescription.textContent = 'è¯¥å†…å®¹å…·æœ‰è¾ƒé«˜çš„å¯ä¿¡åº¦';
            } else if (score >= 60) {
                scoreCircle.className = 'score-circle uncertain';
                scoreDescription.textContent = 'è¯¥å†…å®¹å­˜åœ¨ä¸€å®šçš„ä¸ç¡®å®šæ€§';
            } else {
                scoreCircle.className = 'score-circle fake';
                scoreDescription.textContent = 'è¯¥å†…å®¹å¯èƒ½å­˜åœ¨è™šå‡ä¿¡æ¯';
            }
            
            // æ˜¾ç¤ºè§£æå†…å®¹
            parsedContent.style.display = 'block';
            parsedTitle.textContent = result.title || 'æ— æ ‡é¢˜';
            parsedTitle.style.display = result.title ? 'block' : 'none';
            parsedText.textContent = result.content || '';
            
            // æ¸²æŸ“å›¾ç‰‡
            parsedImages.innerHTML = '';
            if (result.images && result.images.length > 0) {
                result.images.forEach(imgUrl => {
                    const item = document.createElement('div');
                    item.className = 'parsed-image-item';
                    item.innerHTML = `<img src="${imgUrl}" alt="è§£æå›¾ç‰‡">`;
                    // å…è®¸ä»è§£æåŒºåŸŸæ‹–åŠ¨åˆ°å·¦ä¾§ï¼ˆä¼ é€’å›¾ç‰‡ URLï¼‰
                    item.setAttribute('draggable', 'true');
                    item.addEventListener('dragstart', (ev) => {
                        try {
                            ev.dataTransfer.setData('text/uri-list', imgUrl);
                            ev.dataTransfer.setData('text/plain', imgUrl);
                            ev.dataTransfer.effectAllowed = 'copy';
                        } catch (e) {}
                    });
                    item.addEventListener('click', () => showImageModal(imgUrl));
                    parsedImages.appendChild(item);
                });
            }
            
            resultItem.classList.add('active');
        }

        function showError(message) {
            const errorState = document.getElementById('errorState');
            const errorDetail = document.getElementById('errorDetail');
            const loadingState = document.getElementById('loadingState');
            const detectBtn = document.getElementById('detectBtn');
            
            loadingState.classList.remove('active');
            detectBtn.classList.remove('loading');
            detectBtn.innerHTML = 'å¼€å§‹æ£€æµ‹';
            
            errorDetail.textContent = message || 'æ— æ³•è·å–ç½‘é¡µå†…å®¹ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆ';
            errorState.classList.add('active');
        }

        // å›¾ç‰‡æ¨¡æ€æ¡†
        function initModal() {
            const modal = document.getElementById('imageModal');
            const modalClose = document.getElementById('modalClose');
            const modalImage = document.getElementById('modalImage');

            modalClose.addEventListener('click', function() {
                modal.classList.remove('active');
            });

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        }

        function showImageModal(url) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = url;
            modal.classList.add('active');
        }

        // Toast æç¤º
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // å‰ªè´´æ¿æŒ‰é’®åŠŸèƒ½
        function initClipboardBtn() {
            const clipboardBtn = document.getElementById('clipboardBtn');
            clipboardBtn.addEventListener('click', async function() {
                // ä¼˜å…ˆå°è¯•è¯»å–å›¾ç‰‡
                if (navigator.clipboard && window.ClipboardItem) {
                    try {
                        const items = await navigator.clipboard.read();
                        let foundImage = false;
                        for (const item of items) {
                            for (const type of item.types) {
                                if (type.startsWith('image/')) {
                                    foundImage = true;
                                    const blob = await item.getType(type);
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        if (uploadedImages.length < maxImages) {
                                            const imageData = {
                                                id: Date.now() + Math.random(),
                                                url: e.target.result,
                                                name: 'å‰ªè´´æ¿å›¾ç‰‡'
                                            };
                                            uploadedImages.push(imageData);
                                            document.getElementById('imagePreview').innerHTML = '';
                                            // é‡æ–°æ¸²æŸ“å›¾ç‰‡
                                            const imagePreview = document.getElementById('imagePreview');
                                            uploadedImages.forEach(image => {
                                                const item = document.createElement('div');
                                                item.className = 'image-preview-item';
                                                item.innerHTML = `<img src="${image.url}" alt="${image.name}"><button class="image-delete-btn" data-id="${image.id}">Ã—</button>`;
                                                item.querySelector('img').addEventListener('click', function() {
                                                    showImageModal(image.url);
                                                });
                                                item.querySelector('.image-delete-btn').addEventListener('click', function(e) {
                                                    e.stopPropagation();
                                                    uploadedImages = uploadedImages.filter(img => img.id !== image.id);
                                                    imagePreview.removeChild(item);
                                                    showToast('å›¾ç‰‡å·²åˆ é™¤', 'success');
                                                });
                                                imagePreview.appendChild(item);
                                            });
                                            showToast('å‰ªè´´æ¿å›¾ç‰‡å·²ä¸Šä¼ ', 'success');
                                        } else {
                                            showToast(`æœ€å¤šåªèƒ½ä¸Šä¼ ${maxImages}å¼ å›¾ç‰‡`, 'warning');
                                        }
                                    };
                                    reader.readAsDataURL(blob);
                                    return;
                                }
                            }
                        }
                        if (!foundImage) {
                            // æ²¡æœ‰å›¾ç‰‡åˆ™å°è¯•è¯»å–æ–‡æœ¬
                            const text = await navigator.clipboard.readText();
                            if (text) {
                                document.getElementById('textInput').innerText = text;
                                showToast('å‰ªè´´æ¿æ–‡æœ¬å·²ç²˜è´´', 'success');
                            } else {
                                showToast('å‰ªè´´æ¿æ— å¯ç”¨å†…å®¹', 'warning');
                            }
                        }
                    } catch (err) {
                        showToast('æ— æ³•è®¿é—®å‰ªè´´æ¿å†…å®¹', 'error');
                    }
                } else if (navigator.clipboard) {
                    // å…¼å®¹åªæ”¯æŒæ–‡æœ¬çš„æµè§ˆå™¨
                    try {
                        const text = await navigator.clipboard.readText();
                        if (text) {
                            document.getElementById('textInput').innerText = text;
                            showToast('å‰ªè´´æ¿æ–‡æœ¬å·²ç²˜è´´', 'success');
                        } else {
                            showToast('å‰ªè´´æ¿æ— å¯ç”¨å†…å®¹', 'warning');
                        }
                    } catch (err) {
                        showToast('æ— æ³•è®¿é—®å‰ªè´´æ¿å†…å®¹', 'error');
                    }
                } else {
                    showToast('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå‰ªè´´æ¿API', 'error');
                }
            });
        }
        // AIåˆ†æåŠŸèƒ½
        async function analyzeContent(text, images, fromExtraction = false) {
            const detectBtn = document.getElementById('detectBtn');
            const loadingState = document.getElementById('loadingState');
            const initialState = document.getElementById('initialState');
            const resultItem = document.getElementById('resultItem');
            const errorState = document.getElementById('errorState');
            const progressBar = document.getElementById('progressBar');
            const loadingText = document.getElementById('loadingText');

            // UI Loading State
            initialState.style.display = 'none';
            resultItem.classList.remove('active');
            errorState.classList.remove('active');
            loadingState.classList.add('active');
            detectBtn.classList.add('loading');
            detectBtn.innerHTML = 'AIåˆ†æä¸­...';
            
            // è®¾ç½®è¿›åº¦æ¡åˆå§‹çŠ¶æ€
            if (fromExtraction) {
                progressBar.style.width = '50%';
            } else {
                progressBar.style.width = '0%';
                // å¿«é€ŸåŠ¨ç”»åˆ° 50%
                setTimeout(() => {
                    progressBar.style.width = '50%';
                }, 100);
            }
            loadingText.textContent = 'æ­£åœ¨åˆ†ææ–°é—»ä¸­...';

            // æ¨¡æ‹Ÿåˆ†æé˜¶æ®µçš„è¿›åº¦å¢é•¿ (50% -> 90%)
            let progress = 50;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += 0.5; // æ…¢ä¸€ç‚¹
                    progressBar.style.width = progress + '%';
                }
            }, 600);

            try {
                let imageUrls = [];
                if (images && images.length > 0) {
                    // é™åˆ¶æœ€å¤š4å¼ å›¾ç‰‡
                    const limitedImages = images.slice(0, 4);
                    imageUrls = limitedImages.map(img => typeof img === 'string' ? img : img.url);
                }

                let result;
                // æ£€æŸ¥æ˜¯å¦æ˜¯URLæå–çš„å†…å®¹ï¼Œå¦‚æœæ˜¯ï¼Œå°è¯•è·å–URL
                let sourceUrl = '';
                if (fromExtraction && window.lastExtractedUrl) {
                    sourceUrl = window.lastExtractedUrl;
                } else if (isURL(text)) {
                    sourceUrl = text;
                }

                if (window.electronAPI) {
                    const response = await window.electronAPI.invoke('analyze-content', { text, imageUrls, url: sourceUrl });
                    if (response.success) {
                        result = response.data;
                    } else {
                        throw new Error(response.error);
                    }
                } else {
                    // Mock for dev
                    await new Promise(r => setTimeout(r, 2000));
                    result = {
                        probability: 0.15,
                        type: 3,
                        explanation: "è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„AIåˆ†æç»“æœï¼ˆå‡æ–°é—»ï¼‰ã€‚",
                        fake_parts: [{ text: text.substring(0, 10), reason: "æ¨¡æ‹ŸåŸå› " }]
                    };
                }

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°100%
                setTimeout(() => {
                    showAnalysisResult(result, text, images);
                    showToast('åˆ†æå®Œæˆ', 'success');
                    loadingState.classList.remove('active');
                    detectBtn.classList.remove('loading');
                    detectBtn.innerHTML = 'å¼€å§‹æ£€æµ‹';
                }, 500);

            } catch (error) {
                clearInterval(progressInterval);
                console.error(error);
                showError('AIåˆ†æå¤±è´¥: ' + error.message);
                showToast('åˆ†æå¤±è´¥', 'error');
                loadingState.classList.remove('active');
                detectBtn.classList.remove('loading');
                detectBtn.innerHTML = 'å¼€å§‹æ£€æµ‹';
            }
        }

        function showAnalysisResult(result, originalText, originalImages) {
            const resultItem = document.getElementById('resultItem');
            const parsedContent = document.getElementById('parsedContent');
            const parsedTitle = document.getElementById('parsedTitle');
            const parsedText = document.getElementById('parsedText');
            const parsedImages = document.getElementById('parsedImages');
            
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreValue = document.getElementById('scoreValue');
            const scoreDescription = document.getElementById('scoreDescription');
            
            // Probability to Percentage
            const percentage = Math.round(result.probability * 100);
            scoreCircle.textContent = percentage + '%';
            scoreValue.textContent = percentage + '%';
            
            // Type handling
            if (result.type === 1) { // True
                scoreCircle.className = 'score-circle real';
                scoreDescription.innerHTML = `<strong>å¯ä¿¡åº¦é«˜</strong><br>${result.explanation}`;
            } else if (result.type === 2) { // Partial
                scoreCircle.className = 'score-circle uncertain';
                scoreDescription.innerHTML = `<strong>éƒ¨åˆ†å­˜ç–‘</strong><br>${result.explanation}`;
            } else { // Fake
                scoreCircle.className = 'score-circle fake';
                scoreDescription.innerHTML = `<strong>ç–‘ä¼¼è™šå‡</strong><br>${result.explanation}`;
            }
            
            // Update Analysis Points
            const analysisContainer = document.querySelector('.result-analysis');
            // æ¸…ç©ºæ—§çš„é™æ€å†…å®¹ï¼ˆä¿ç•™æ ‡é¢˜ï¼‰
            const analysisTitle = analysisContainer.querySelector('.analysis-title');
            analysisContainer.innerHTML = '';
            analysisContainer.appendChild(analysisTitle);

            if (result.analysis_points && Array.isArray(result.analysis_points)) {
                result.analysis_points.forEach(point => {
                    const item = document.createElement('div');
                    item.className = 'analysis-item';
                    
                    let icon = 'âœ“';
                    let iconClass = 'positive';
                    
                    if (point.status === 'warning') {
                        icon = '!';
                        iconClass = 'warning';
                    } else if (point.status === 'negative') {
                        icon = 'âœ•';
                        iconClass = 'negative';
                    }
                    
                    item.innerHTML = `
                        <div class="analysis-icon ${iconClass}">${icon}</div>
                        <div class="analysis-text">${point.description}</div>
                    `;
                    analysisContainer.appendChild(item);
                });
            } else {
                // Fallback if no analysis points provided
                analysisContainer.innerHTML += `<div class="analysis-item"><div class="analysis-text">æš‚æ— è¯¦ç»†åˆ†æç‚¹</div></div>`;
            }
            
            // Display Content
            parsedContent.style.display = 'block';
            parsedTitle.style.display = 'none'; 
            
            // Highlight fake parts
            let displayText = originalText;
            if ((result.type === 2 || result.type === 3) && result.fake_parts) {
                let safeText = displayText.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                
                // Sort fake parts by length descending to avoid nested replacement issues
                const sortedParts = [...result.fake_parts].sort((a, b) => b.text.length - a.text.length);

                sortedParts.forEach(part => {
                    if (part.text) {
                        const safePart = part.text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        // ä½¿ç”¨ data-reason å­˜å‚¨åŸå› ï¼Œç§»é™¤ titleï¼Œæ·»åŠ  onclick
                        const highlight = `<span class="fake-highlight" style="background-color: #ffff00; color: #000; cursor: pointer; border-radius: 2px;" data-reason="${part.reason.replace(/"/g, '&quot;')}" onclick="showReasonTooltip(event, this)">${safePart}</span>`;
                        // Replace only the first occurrence to avoid over-replacing
                        safeText = safeText.replace(safePart, highlight);
                    }
                });
                parsedText.innerHTML = safeText;
            } else {
                parsedText.textContent = originalText;
            }
            
            // Render Images
            parsedImages.innerHTML = '';
            let imagesToRender = [];
            if (originalImages && originalImages.length > 0) {
                 // é™åˆ¶æœ€å¤šæ˜¾ç¤º4å¼ å›¾ç‰‡
                 const limitedImages = originalImages.slice(0, 4);
                 imagesToRender = limitedImages.map(img => typeof img === 'string' ? {url: img, name: 'Image'} : img);
            }
            
            imagesToRender.forEach(img => {
                const item = document.createElement('div');
                item.className = 'parsed-image-item';
                item.innerHTML = `<img src="${img.url}" alt="${img.name}">`;
                item.addEventListener('click', () => showImageModal(img.url));
                parsedImages.appendChild(item);
            });
            
            resultItem.classList.add('active');
        }

        // Tooltip Logic
        let tooltipTimeout;
        function showReasonTooltip(event, element) {
            event.stopPropagation();
            const reason = element.getAttribute('data-reason');
            if (!reason) return;

            let tooltip = document.getElementById('customTooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'customTooltip';
                tooltip.className = 'custom-tooltip';
                document.body.appendChild(tooltip);
            }

            tooltip.textContent = reason;
            tooltip.classList.add('active');

            // Position tooltip
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let top = rect.bottom + 8;
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

            // Boundary checks
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top + tooltipRect.height > window.innerHeight - 10) {
                top = rect.top - tooltipRect.height - 8; // Flip to top if no space below
            }

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;

            // Auto hide after 3 seconds or click elsewhere
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(() => {
                tooltip.classList.remove('active');
            }, 3000);
        }

        // Hide tooltip on click elsewhere
        document.addEventListener('click', function(e) {
            const tooltip = document.getElementById('customTooltip');
            if (tooltip && tooltip.classList.contains('active') && !e.target.classList.contains('fake-highlight')) {
                tooltip.classList.remove('active');
            }
        });
    </script>
</body>
</html>
