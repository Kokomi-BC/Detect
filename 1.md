è¾¹æƒ³è¾¹æœä½¿ç”¨ç¤ºä¾‹
ä»¥ä¸‹ä»£ç é€šè¿‡ OpenAI SDK è°ƒç”¨ç«å±±æ–¹èˆŸ Web Search å·¥å…·ï¼Œå®ç° â€œAI æ€è€ƒ - è”ç½‘æœç´¢ - ç­”æ¡ˆç”Ÿæˆâ€ å…¨é“¾è·¯è‡ªåŠ¨åŒ–ï¼Œå¯é’ˆå¯¹æ—¶æ•ˆã€ç›²åŒºã€åŠ¨æ€ä¿¡æ¯ç±»é—®é¢˜è‡ªåŠ¨è§¦å‘å·¥å…·è¡¥æ•°æ®ï¼Œé€šè¿‡æµå¼å“åº”å®æ—¶è¾“å‡ºæ€è€ƒã€æœç´¢ã€å›ç­”è¿‡ç¨‹ï¼Œä¿éšœä¿¡æ¯å¯è¿½æº¯ã€å†³ç­–å¯æ„ŸçŸ¥ã€‚

import os
from openai import OpenAI
from datetime import datetime
def realize_think_while_search():
    # 1. åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯
    client = OpenAI(
        base_url="https://ark.cn-beijing.volces.com/api/v3", 
        api_key=os.getenv("ARK_API_KEY")
    )

    # 2. å®šä¹‰ç³»ç»Ÿæç¤ºè¯ï¼ˆæ ¸å¿ƒï¼šè§„èŒƒâ€œä½•æ—¶æœâ€â€œæ€ä¹ˆæœâ€â€œæ€ä¹ˆå±•ç¤ºæ€è€ƒâ€ï¼‰
    system_prompt = """
    ä½ æ˜¯AIä¸ªäººåŠ©æ‰‹ï¼Œéœ€å®ç°â€œè¾¹æƒ³è¾¹æœè¾¹ç­”â€ï¼Œæ ¸å¿ƒè§„åˆ™å¦‚ä¸‹ï¼š
    ä¸€ã€æ€è€ƒä¸æœç´¢åˆ¤æ–­ï¼ˆå¿…é¡»å®æ—¶è¾“å‡ºæ€è€ƒè¿‡ç¨‹ï¼‰ï¼š
    1. è‹¥é—®é¢˜æ¶‰åŠâ€œæ—¶æ•ˆæ€§ï¼ˆå¦‚è¿‘3å¹´æ•°æ®ï¼‰ã€çŸ¥è¯†ç›²åŒºï¼ˆå¦‚å…·ä½“ä¼ä¸šè–ªèµ„ï¼‰ã€ä¿¡æ¯ä¸è¶³â€ï¼Œå¿…é¡»è°ƒç”¨web_searchï¼›
    2. æ€è€ƒæ—¶éœ€è¯´æ˜â€œæ˜¯å¦éœ€è¦æœç´¢â€â€œä¸ºä»€ä¹ˆæœâ€â€œæœç´¢å…³é”®è¯æ˜¯ä»€ä¹ˆâ€ã€‚

    äºŒã€å›ç­”è§„åˆ™ï¼š
    1. ä¼˜å…ˆä½¿ç”¨æœç´¢åˆ°çš„èµ„æ–™ï¼Œå¼•ç”¨æ ¼å¼ä¸º`[1] (URLåœ°å€)`ï¼›
    2. ç»“æ„æ¸…æ™°ï¼ˆç”¨åºå·ã€åˆ†æ®µï¼‰ï¼Œå¤šä½¿ç”¨ç®€å•æ˜“æ‡‚çš„è¡¨è¿°ï¼›
    3. ç»“å°¾éœ€åˆ—å‡ºæ‰€æœ‰å‚è€ƒèµ„æ–™ï¼ˆæ ¼å¼ï¼š1. [èµ„æ–™æ ‡é¢˜](URL)ï¼‰ã€‚
    """

    # 3. æ„é€ APIè¯·æ±‚ï¼ˆè§¦å‘æ€è€ƒ-æœç´¢-å›ç­”è”åŠ¨ï¼‰
    response = client.responses.create(
        model="doubao-seed-1-6-251015",  
        input=[
            # ç³»ç»Ÿæç¤ºè¯ï¼ˆæŒ‡å¯¼AIè¡Œä¸ºï¼‰
            {"role": "system", "content": [{"type": "input_text", "text": system_prompt}]},
            # ç”¨æˆ·é—®é¢˜ï¼ˆå¯æ›¿æ¢ä¸ºä»»æ„éœ€è¾¹æƒ³è¾¹æœçš„é—®é¢˜ï¼‰
            {"role": "user", "content": [{"type": "input_text", "text": "ä¸–ç•Œ500å¼ºä¼ä¸šåœ¨å›½å†…æ‰€åœ¨çš„åŸå¸‚ï¼Œè¿‘ä¸‰å¹´çš„å¹³å‡å·¥èµ„æ˜¯å¤šå°‘ï¼Ÿ"}]}
        ],
        tools=[
            # é…ç½®Web Searchå·¥å…·å‚æ•°
            {
                "type": "web_search",
                "limit": 10,  # æœ€å¤šè¿”å›10æ¡æœç´¢ç»“æœ
            }
        ],
        stream=True,  # å¯ç”¨æµå¼å“åº”ï¼ˆæ ¸å¿ƒï¼šå®æ—¶è·å–æ€è€ƒã€æœç´¢ã€å›ç­”ç‰‡æ®µï¼‰
        extra_body={"thinking": {"type": "auto"}},  # è‡ªåŠ¨è§¦å‘AIæ€è€ƒï¼ˆæ— éœ€æ‰‹åŠ¨å¹²é¢„ï¼‰
    )

    # 4. å¤„ç†æµå¼å“åº”ï¼ˆå®æ—¶å±•ç¤ºâ€œæ€è€ƒ-æœç´¢-å›ç­”â€è¿‡ç¨‹ï¼‰
    # çŠ¶æ€å˜é‡ï¼šé¿å…é‡å¤æ‰“å°æ ‡é¢˜
    thinking_started = False  # AIæ€è€ƒè¿‡ç¨‹æ˜¯å¦å·²å¼€å§‹æ‰“å°
    answering_started = False  # AIå›ç­”æ˜¯å¦å·²å¼€å§‹æ‰“å°

    print("=== è¾¹æƒ³è¾¹æœå¯åŠ¨ ===")
    for chunk in response:  # éå†æ¯ä¸€ä¸ªå®æ—¶è¿”å›çš„ç‰‡æ®µï¼ˆchunkï¼‰
        chunk_type = getattr(chunk, "type", "")  # è·å–ç‰‡æ®µç±»å‹ï¼ˆæ€è€ƒ/æœç´¢/å›ç­”ï¼‰

        # â‘  å¤„ç†AIæ€è€ƒè¿‡ç¨‹ï¼ˆå®æ—¶æ‰“å°â€œä¸ºä»€ä¹ˆæœã€æœä»€ä¹ˆâ€ï¼‰
        if chunk_type == "response.reasoning_summary_text.delta":
            if not thinking_started:
                print(f"\nğŸ¤” AIæ€è€ƒä¸­ [{datetime.now().strftime('%H:%M:%S')}]:")
                thinking_started = True
            # æ‰“å°æ€è€ƒå†…å®¹ï¼ˆdeltaä¸ºå®æ—¶å¢é‡æ–‡æœ¬ï¼‰
            print(getattr(chunk, "delta", ""), end="", flush=True)

        # â‘¡ å¤„ç†æœç´¢çŠ¶æ€ï¼ˆå¼€å§‹/å®Œæˆæç¤ºï¼‰
        elif "web_search_call" in chunk_type:
            if "in_progress" in chunk_type:
                print(f"\n\nğŸ” å¼€å§‹æœç´¢ [{datetime.now().strftime('%H:%M:%S')}]")
            elif "completed" in chunk_type:
                print(f"\nâœ… æœç´¢å®Œæˆ [{datetime.now().strftime('%H:%M:%S')}]")

        # â‘¢ å¤„ç†æœç´¢å…³é”®è¯ï¼ˆå±•ç¤ºAIå®é™…æœç´¢çš„å†…å®¹ï¼‰
        elif (chunk_type == "response.output_item.done" 
              and hasattr(chunk, "item") 
              and str(getattr(chunk.item, "id", "")).startswith("ws_")):  # ws_ä¸ºæœç´¢ç»“æœæ ‡è¯†
            if hasattr(chunk.item.action, "query"):
                search_keyword = chunk.item.action.query
                print(f"\nğŸ“ æœ¬æ¬¡æœç´¢å…³é”®è¯ï¼š{search_keyword}")

        # â‘£ å¤„ç†æœ€ç»ˆå›ç­”ï¼ˆå®æ—¶æ•´åˆæœç´¢ç»“æœå¹¶è¾“å‡ºï¼‰
        elif chunk_type == "response.output_text.delta":
            if not answering_started:
                print(f"\n\nğŸ’¬ AIå›ç­” [{datetime.now().strftime('%H:%M:%S')}]:")
                print("-" * 50)
                answering_started = True
            # æ‰“å°å›ç­”å†…å®¹ï¼ˆå®æ—¶å¢é‡è¾“å‡ºï¼‰
            print(getattr(chunk, "delta", ""), end="", flush=True)

    # 5. æµç¨‹ç»“æŸ
    print(f"\n\n=== è¾¹æƒ³è¾¹æœå®Œæˆ [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] ===")

# è¿è¡Œå‡½æ•°
if __name__ == "__main__":
    realize_think_while_search()